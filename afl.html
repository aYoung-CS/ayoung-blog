<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;">
    <title>afl</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <nav class="site-nav">
            <a href="./index.html" class="nav-link">/home</a>
            <span class="nav-separator">|</span>
            <a href="./about.html" class="nav-link">/about</a>
        </nav>
        <div class="terminal-prompt">
            <span style="color:#666">[</span><span style="color:#fabd2f">ayoung</span><span style="color:#666">@</span><span style="color:#59adeb">lab</span> <span style="color:#83a598"><a href="./index.html" class="path-link">posts</a></span><span style="color:#666">]$</span> 
            <span class="cmd">cat ./afl.md</span><span class="cursor">█</span>
        </div>
        <h1 class="post-title">afl</h1><div style="color: #666; font-size: 0.8rem; margin-bottom: 20px;">[Last modified: 2025-05-11]</div>
    </header>
    <div class="layout-grid">
                <main><h2 id="ji-chu">基础</h2><p>插桩编译</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">afl-gcc -g -o a a.c
</span><span style="color:#c0c5ce;">./configure CC=&quot;afl-gcc&quot; CXX=&quot;afl-g++&quot; # autoconf
</span><span style="color:#c0c5ce;">./configure --disable-shared CC=&quot;afl-gcc&quot; CXX=&quot;afl-g++&quot; # .so
</span></pre>
<p>开始fuzz</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;"># -i 输入 -o 输出文件夹 从stdin读取输入
</span><span style="color:#c0c5ce;">afl-fuzz -i testcase_dir -o findings_dir ./a
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;"># 从文件读取输入 @@是占位符 表示替换的位置
</span><span style="color:#c0c5ce;">./afl-fuzz -i testcase_dir -o findings_dir /path/to/program @@
</span></pre>
<p>eg <code>afl-fuzz -m 300 -i ./zerotest/fuzz_in -o ./zerotest/fuzz_out ./zerotest/vuln -f</code></p>
<p>常见参数</p>
<blockquote>
<p>-f    testcase的内容会作为afl_test的stdin
-m  分配的内存空间
-i    指定测试样本路径
-o   指定输出结果的路径
-t    设置程序运行超时值，单位为 ms
-M  运行主(Master) Fuzzer
-S   运行从属(Slave) Fuzzer
/dev/null</p>
</blockquote>
<h3 id="qi-dong-wen-jian-xuan-ze">启动文件选择</h3><ul>
<li>文件要小，理想小于1kb</li>
<li>只有当它们在功能上彼此不同时才使用多个测试用例</li>
</ul>
<h3 id="jie-guo-fen-xi">结果分析</h3><p><img src="./images/Pasted%20image%2020250123234808.png" alt="" /></p>
<p>last new path 如果报错要及时修正命令行参数，否则继续fuzz也是徒劳（因为路径不会改变）
cycles done 如果变绿就说明后面即使继续fuzz，出现crash的几率也很低了，可以选择停止
uniq crashes 代表crash的数量</p>
<p>afl-whatsup工具可以查看每个fuzzer的运行状态和总体运行概况，加上-s选项只显示概况，其中的数据都是所有fuzzer的总和
afl-gotcpu工具可以查看每个核心使用状态</p>
<p>停止afl-fuzz时机：</p>
<ul>
<li>状态窗口的cycles done变为绿色</li>
<li>afl-whatsup查看afl-fuzz状态</li>
<li>afl-stat得到类似于afl-whatsup的输出结果</li>
<li>定制afl-whatsup-&gt;在所有代码外面加个循环就好</li>
<li>用afl-plot绘制各种状态指标的直观变化趋势</li>
<li>pythia估算发现新crash和path概率。</li>
</ul>
<p>fuzz结束判断</p>
<ul>
<li>cycles done变为绿色</li>
<li>距上一次发现新路径（或者崩溃）已经过去很长时间</li>
<li>目标程序的代码几乎被测试用例完全覆盖，这种情况很少见</li>
<li>pythia提供的各种数据中，path covera达到99或者correctness的值达到1e-08(含义: 从上次发现path/uniq crash到下一次发现之间大约需要1亿次执行)</li>
</ul>
<p>crash分析</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">ayoung@ay:~/fuzz_learn$ xxd findings_dir/crashes/id\:000000\,sig\:06\,src\:000000\,op\:havoc\,rep\:64 
</span><span style="color:#c0c5ce;">00000000: dabf 1fbf d0a9 bf18 cbda bfbf bfd0 a9bf  ................
</span><span style="color:#c0c5ce;">00000010: 18cb bfda bfdb bfbf bfb4 bfbf bfbf d6bf  ................
</span><span style="color:#c0c5ce;">00000020: ff80 babf bfbf bf86 0000 0100 bfbf bf00  ................
</span><span style="color:#c0c5ce;">00000030: bff5 ffbf bb00 0083 1000 00df aabf bfbf  ................
</span><span style="color:#c0c5ce;">00000040: 4343 4343 4343 4343 4343 43bf dabf dbbf  CCCCCCCCCCC.....
</span><span style="color:#c0c5ce;">00000050: bfbf b4bf bfaa ddbf bfbf bbba bfbf bfba  ................
</span><span style="color:#c0c5ce;">00000060: bfbf bf64 d89f 64bf bbba 0002 bfbf 7f80  ...d..d.........
</span><span style="color:#c0c5ce;">00000070: babf bfbf bf86 0040 0100 bfbf bf00 bff5  .......@........
</span><span style="color:#c0c5ce;">00000080: ffbf bb00 0083 1000 00df 2f              ........../
</span></pre>
<p>gdb内部执行
<code>pwndbg&gt; r &lt; findings_dir/crashes/id:000000,sig:06,src:000000,op:havoc,rep:64</code></p>
<p>简化crash</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">ayoung@ay:~/fuzz_learn$ cat findings_dir/crashes/id\:000000\,sig\:06\,src\:000000\,op\:havoc\,rep\:64 
</span><span style="color:#c0c5ce;">ڿ�Щ��ڿ��Щ�˿ڿۿ�������ֿ�����������������ߪ���CCCCCCCCCCC�ڿۿ������ݿ�����������d؟d������������@����������/
</span><span style="color:#c0c5ce;">ayoung@ay:~/fuzz_learn$ afl-tmin -i findings_dir/crashes/id\:000000\,sig\:06\,src\:000000\,op\:havoc\,rep\:64 -o minimized_crash -- ./a
</span><span style="color:#c0c5ce;">afl-tmin 2.52b by &lt;lcamtuf@google.com&gt;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">[+] Read 139 bytes from &#39;findings_dir/crashes/id:000000,sig:06,src:000000,op:havoc,rep:64&#39;.
</span><span style="color:#c0c5ce;">[*] Performing dry run (mem limit = 50 MB, timeout = 1000 ms)...
</span><span style="color:#c0c5ce;">[+] Program exits with a signal, minimizing in crash mode.
</span><span style="color:#c0c5ce;">[*] Stage #0: One-time block normalization...
</span><span style="color:#c0c5ce;">[+] Block normalization complete, 139 bytes replaced.
</span><span style="color:#c0c5ce;">[*] --- Pass #1 ---
</span><span style="color:#c0c5ce;">[*] Stage #1: Removing blocks of data...
</span><span style="color:#c0c5ce;">    Block length = 8, remaining size = 139
</span><span style="color:#c0c5ce;">    Block length = 4, remaining size = 107
</span><span style="color:#c0c5ce;">    Block length = 2, remaining size = 107
</span><span style="color:#c0c5ce;">    Block length = 1, remaining size = 105
</span><span style="color:#c0c5ce;">[+] Block removal complete, 34 bytes deleted.
</span><span style="color:#c0c5ce;">[*] Stage #2: Minimizing symbols (1 code point)...
</span><span style="color:#c0c5ce;">[+] Symbol minimization finished, 0 symbols (0 bytes) replaced.
</span><span style="color:#c0c5ce;">[*] Stage #3: Character minimization...
</span><span style="color:#c0c5ce;">[+] Character minimization done, 0 bytes replaced.
</span><span style="color:#c0c5ce;">[*] --- Pass #2 ---
</span><span style="color:#c0c5ce;">[*] Stage #1: Removing blocks of data...
</span><span style="color:#c0c5ce;">    Block length = 8, remaining size = 105
</span><span style="color:#c0c5ce;">    Block length = 4, remaining size = 105
</span><span style="color:#c0c5ce;">    Block length = 2, remaining size = 105
</span><span style="color:#c0c5ce;">    Block length = 1, remaining size = 105
</span><span style="color:#c0c5ce;">[+] Block removal complete, 0 bytes deleted.
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">     File size reduced by : 24.46% (to 105 bytes)
</span><span style="color:#c0c5ce;">    Characters simplified : 132.38%
</span><span style="color:#c0c5ce;">     Number of execs done : 57
</span><span style="color:#c0c5ce;">          Fruitless execs : path=16 crash=0 hang=0
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">[*] Writing output to &#39;minimized_crash&#39;...
</span><span style="color:#c0c5ce;">[+] We&#39;re done here. Have a nice day!
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">ayoung@ay:~/fuzz_learn$ cat minimized_crash 
</span><span style="color:#c0c5ce;">000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
</span></pre>
<h3 id="wu-yuan-ma-ce-shi">无源码测试</h3><p>afl qemu-mode编译
gcc编译
afl-fuzz -i fuzz_in -o fuzz_out -Q ./afl_test2</p>
<h3 id="llvm-mode">llvm mode</h3><p>可以获得更快的Fuzzing速度，针对大型项目可以考虑启用</p>
<h3 id="yu-liao-ku-zheng-liu">语料库蒸馏</h3><p>afl-cmin 移除执行相同代码的文件</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">afl-cmin -i input_dir -o output_dir -- /path/to/tested/program [params]
</span><span style="color:#c0c5ce;">afl-cmin -i input_dir -o output_dir -- /path/to/tested/program [params] @@
</span></pre>
<p>afl-tmin 减小单个输入文件的大小
默认instrumented mode</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;"># instrumented mode
</span><span style="color:#c0c5ce;">afl-tmin -i input_file -o output_file -- /path/to/tested/program [params] @@
</span><span style="color:#c0c5ce;"># crash mode 把导致程序非正常退出的文件直接剔除
</span><span style="color:#c0c5ce;">afl-tmin -x -i input_file -o output_file -- /path/to/tested/program [params] @@
</span></pre>
<p>批量处理：</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">for i in id*
</span><span style="color:#c0c5ce;">do
</span><span style="color:#c0c5ce;">    afl-tmin -i $i -o tmin-$i -- ~/path/to/tested/program [params] @@
</span><span style="color:#c0c5ce;">done
</span></pre>
<p>使用完afl-tmin后再次使用afl-cmin，可能可以再过滤掉一些用例</p>
</main>
                <aside class="toc-sidebar">
                    <div class="toc-sticky-container">
                        <div class="toc-header">:: Contents ::</div>
                        <ul class="toc-list"><li class="toc-item toc-h2" data-level="2" style="margin-left:12px"><a href="#ji-chu">基础</a></li><li class="toc-item toc-h3" data-level="3" style="margin-left:12px"><a href="#qi-dong-wen-jian-xuan-ze">启动文件选择</a></li><li class="toc-item toc-h3" data-level="3" style="margin-left:12px"><a href="#jie-guo-fen-xi">结果分析</a></li><li class="toc-item toc-h3" data-level="3" style="margin-left:12px"><a href="#wu-yuan-ma-ce-shi">无源码测试</a></li><li class="toc-item toc-h3" data-level="3" style="margin-left:12px"><a href="#llvm-mode">llvm mode</a></li><li class="toc-item toc-h3" data-level="3" style="margin-left:12px"><a href="#yu-liao-ku-zheng-liu">语料库蒸馏</a></li></ul>
                    </div>
                </aside>
            </div> 
    <footer style="margin-top: 50px; border-top: 1px solid #333; padding-top: 20px; font-size: 0.8rem; color: #555; text-align: center;">
        Built with Rust. <span style="color: #66ed59;">EOF</span>
    </footer>
    <button id="back-to-top" aria-label="Back to Top">^TOP</button>
    <script src="script.js"></script>
</body>
</html>