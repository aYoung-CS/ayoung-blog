<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;">
    <title>fuzzing101</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <header>
        <nav class="site-nav">
            <a href="/index.html" class="nav-link">/home</a>
            <span class="nav-separator">|</span>
            <a href="/about.html" class="nav-link">/about</a>
        </nav>
        <div class="terminal-prompt">
            <span style="color:#666">[</span><span style="color:#fabd2f">ayoung</span><span style="color:#666">@</span><span style="color:#59adeb">lab</span> <span style="color:#83a598"><a href="/index.html" class="path-link">posts</a></span><span style="color:#666">]$</span> 
            <span class="cmd">cat ./fuzzing101.md</span><span class="cursor">█</span>
        </div>
        <h1 class="post-title">fuzzing101</h1><div style="color: #666; font-size: 0.8rem; margin-bottom: 20px;">[Last modified: 2025-05-13]</div>
    </header>
    <div class="layout-grid">
                <main><h2 id="exercise1">exercise1</h2><p>本节学习：</p>
<ul>
<li>编译带检测的目标程序</li>
<li>运行fuzzer</li>
<li>使用gdb分类crash</li>
</ul>
<h3 id="fuzz">fuzz</h3><p>xpdf环境搭好</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">ayoung@ubuntu:~/fuzzing_xpdf/pdf_examples$ $HOME/fuzzing_xpdf/install/bin/pdfinfo -box -meta small-example-pdf-file.pdf 
</span><span style="color:#c0c5ce;">Title:          Document1
</span><span style="color:#c0c5ce;">Subject:        
</span><span style="color:#c0c5ce;">Keywords:       
</span><span style="color:#c0c5ce;">Author:         Administrator
</span><span style="color:#c0c5ce;">Creator:        PDFCreator 2.0.2.0
</span><span style="color:#c0c5ce;">Producer:       PDFCreator 2.0.2.0
</span><span style="color:#c0c5ce;">CreationDate:   Sun Jul 26 00:25:22 2015
</span><span style="color:#c0c5ce;">ModDate:        Sun Jul 26 00:25:22 2015
</span><span style="color:#c0c5ce;">Tagged:         no
</span><span style="color:#c0c5ce;">Pages:          1
</span><span style="color:#c0c5ce;">Encrypted:      no
</span><span style="color:#c0c5ce;">Page size:      595 x 842 pts (A4)
</span><span style="color:#c0c5ce;">MediaBox:           0.00     0.00   595.00   842.00
</span><span style="color:#c0c5ce;">CropBox:            0.00     0.00   595.00   842.00
</span><span style="color:#c0c5ce;">BleedBox:           0.00     0.00   595.00   842.00
</span><span style="color:#c0c5ce;">TrimBox:            0.00     0.00   595.00   842.00
</span><span style="color:#c0c5ce;">ArtBox:             0.00     0.00   595.00   842.00
</span><span style="color:#c0c5ce;">File size:      4107 bytes
</span><span style="color:#c0c5ce;">Optimized:      yes
</span><span style="color:#c0c5ce;">PDF version:    1.4
</span><span style="color:#c0c5ce;">Metadata:
</span><span style="color:#c0c5ce;">&lt;?xpacket begin=&#39;&#39; id=&#39;W5M0MpCehiHzreSzNTczkc9d&#39;?&gt;
</span><span style="color:#c0c5ce;">&lt;?adobe-xap-filters esc=&quot;CRLF&quot;?&gt;
</span><span style="color:#c0c5ce;">&lt;x:xmpmeta xmlns:x=&#39;adobe:ns:meta/&#39; x:xmptk=&#39;XMP toolkit 2.9.1-13, framework 1.6&#39;&gt;
</span><span style="color:#c0c5ce;">&lt;rdf:RDF xmlns:rdf=&#39;http://www.w3.org/1999/02/22-rdf-syntax-ns#&#39; xmlns:iX=&#39;http://ns.adobe.com/iX/1.0/&#39;&gt;
</span><span style="color:#c0c5ce;">&lt;rdf:Description rdf:about=&#39;uuid:7b7ff4e7-3534-11e5-0000-1d06e6d9e022&#39; xmlns:pdf=&#39;http://ns.adobe.com/pdf/1.3/&#39;&gt;&lt;pdf:Producer&gt;PDFCreator 2.0.2.0&lt;/pdf:Producer&gt;
</span><span style="color:#c0c5ce;">&lt;pdf:Keywords&gt;&lt;/pdf:Keywords&gt;
</span><span style="color:#c0c5ce;">&lt;/rdf:Description&gt;
</span><span style="color:#c0c5ce;">&lt;rdf:Description rdf:about=&#39;uuid:7b7ff4e7-3534-11e5-0000-1d06e6d9e022&#39; xmlns:xmp=&#39;http://ns.adobe.com/xap/1.0/&#39;&gt;&lt;xmp:ModifyDate&gt;2015-07-26T00:25:22+10:00&lt;/xmp:ModifyDate&gt;
</span><span style="color:#c0c5ce;">&lt;xmp:CreateDate&gt;2015-07-26T00:25:22+10:00&lt;/xmp:CreateDate&gt;
</span><span style="color:#c0c5ce;">&lt;xmp:CreatorTool&gt;PDFCreator 2.0.2.0&lt;/xmp:CreatorTool&gt;&lt;/rdf:Description&gt;
</span><span style="color:#c0c5ce;">&lt;rdf:Description rdf:about=&#39;uuid:7b7ff4e7-3534-11e5-0000-1d06e6d9e022&#39; xmlns:xapMM=&#39;http://ns.adobe.com/xap/1.0/mm/&#39; xapMM:DocumentID=&#39;uuid:7b7ff4e7-3534-11e5-0000-1d06e6d9e022&#39;/&gt;
</span><span style="color:#c0c5ce;">&lt;rdf:Description rdf:about=&#39;uuid:7b7ff4e7-3534-11e5-0000-1d06e6d9e022&#39; xmlns:dc=&#39;http://purl.org/dc/elements/1.1/&#39; dc:format=&#39;application/pdf&#39;&gt;&lt;dc:title&gt;&lt;rdf:Alt&gt;&lt;rdf:li xml:lang=&#39;x-default&#39;&gt;Document1&lt;/rdf:li&gt;&lt;/rdf:Alt&gt;&lt;/dc:title&gt;&lt;dc:creator&gt;&lt;rdf:Seq&gt;&lt;rdf:li&gt;Administrator&lt;/rdf:li&gt;&lt;/rdf:Seq&gt;&lt;/dc:creator&gt;&lt;dc:description&gt;&lt;rdf:Alt&gt;&lt;rdf:li xml:lang=&#39;x-default&#39;&gt;&lt;/rdf:li&gt;&lt;/rdf:Alt&gt;&lt;/dc:description&gt;&lt;/rdf:Description&gt;
</span><span style="color:#c0c5ce;">&lt;/rdf:RDF&gt;
</span><span style="color:#c0c5ce;">&lt;/x:xmpmeta&gt;
</span><span style="color:#c0c5ce;">                                                                        
</span><span style="color:#c0c5ce;">                                                                        
</span><span style="color:#c0c5ce;">&lt;?xpacket end=&#39;w&#39;?&gt;
</span></pre>
<p>文档写的安装步骤llvm版本过低
使用llvm-13</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">wget https://apt.llvm.org/llvm.sh
</span><span style="color:#c0c5ce;">chmod +x llvm.sh
</span><span style="color:#c0c5ce;">sudo ./llvm.sh 13 all
</span></pre>
<p>踩坑：一直显示llvm mode编译失败，发现报错</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">fatal error: &#39;list&#39; file not found
</span><span style="color:#c0c5ce;">#include &lt;list&gt;
</span><span style="color:#c0c5ce;">         ^~~~~~
</span><span style="color:#c0c5ce;">1 error generated.
</span><span style="color:#c0c5ce;">make[1]: *** [GNUmakefile.llvm:436: instrumentation/afl-llvm-common.o] Error 1
</span><span style="color:#c0c5ce;">make[1]: Leaving directory &#39;/home/ayoung/AFLplusplus&#39;
</span><span style="color:#c0c5ce;">make: [GNUmakefile:347: llvm] Error 2 (ignored)
</span></pre>
<p>缺库
添加源<code>sudo add-apt-repository ppa:ubuntu-toolchain-r/test</code> 并update
安装<code>sudo apt install libstdc++-13-dev</code></p>
<p>开始fuzz</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">afl-fuzz -i $HOME/fuzzing_xpdf/pdf_examples/ -o $HOME/fuzzing_xpdf/out/ -s 123 -- $HOME/fuzzing_xpdf/install/bin/pdftotext @@ $HOME/fuzzing_xpdf/output
</span></pre>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">-i 输入
</span><span style="color:#c0c5ce;">-o 输出
</span><span style="color:#c0c5ce;">-s 使用的静态随机种子
</span><span style="color:#c0c5ce;"> @@ 命令占位符
</span></pre>
<p><img src="/images/Pasted%20image%2020250125232044.png" alt="" /></p>
<p>用<code>afl-tmin</code>缩小一下crash样本</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">afl-tmin -i ../out/default/crashes/id\:000000\,sig\:11\,src\:000000\,time\:126030\,execs\:85533\,op\:havoc\,rep\:2 -o a -- $HOME/fuzzing_xpdf/install/bin/pdftotext @@ $HOME/fuzzing_xpdf/output
</span></pre>
<p>得到</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">ayoung@ubuntu:~/fuzzing_xpdf/xpdf-3.02$ cat a
</span><span style="color:#c0c5ce;">trailer&lt;&lt;/Root 5 0R
</span><span style="color:#c0c5ce;">5 0 obj&lt;&lt;
</span><span style="color:#c0c5ce;">7 0 obj&lt;&lt;/Length 7 0R/&gt;streama
</span></pre>
<h3 id="crashfen-xi">crash分析</h3><p>重新编译debug版本的</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">cd $HOME/fuzzing_xpdf/xpdf-3.02/
</span><span style="color:#c0c5ce;">make clean
</span><span style="color:#c0c5ce;">CFLAGS=&quot;-g -O0&quot; CXXFLAGS=&quot;-g -O0&quot;
</span><span style="color:#c0c5ce;">make
</span></pre>
<p>启动gdb</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">gdb --args $HOME/fuzzing_xpdf/xpdf-3.02/xpdf/pdftotext out/default/crashes/a $HOME/fuzzing_xpdf/output
</span></pre>
<p>bt查看栈回溯 看着就是陷入循环了</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">pwndbg&gt; bt
</span><span style="color:#c0c5ce;">#0  __vfprintf_internal (s=s@entry=0x7fffff7ff590, format=0x507d50 &quot;Error (%d): &quot;, ap=0x7fffff801c50, mode_flags=0) at vfprintf-internal.c:1365
</span><span style="color:#c0c5ce;">#1  0x00007ffff7a43ea2 in buffered_vfprintf (s=s@entry=0x7ffff7bb75c0 &lt;_IO_2_1_stderr_&gt;, format=format@entry=0x507d50 &quot;Error (%d): &quot;, args=args@entry=0x7fffff801c50, mode_flags=mode_flags@entry=0) at vfprintf-internal.c:2377
</span><span style="color:#c0c5ce;">#2  0x00007ffff7a40d24 in __vfprintf_internal (s=0x7ffff7bb75c0 &lt;_IO_2_1_stderr_&gt;, format=0x507d50 &quot;Error (%d): &quot;, ap=ap@entry=0x7fffff801c50, mode_flags=mode_flags@entry=0) at vfprintf-internal.c:1346
</span><span style="color:#c0c5ce;">#3  0x00007ffff7a2bc6a in __fprintf (stream=&lt;optimized out&gt;, format=&lt;optimized out&gt;) at fprintf.c:32
</span><span style="color:#c0c5ce;">#4  0x0000000000418b30 in error (pos=53, msg=0x50f0d0 &quot;Illegal character &#39;&gt;&#39;&quot;) at Error.cc:29
</span><span style="color:#c0c5ce;">#5  0x0000000000495413 in Lexer::getObj (this=0x1eb13b0, obj=0x1eb1388) at Lexer.cc:424
</span><span style="color:#c0c5ce;">#6  0x000000000049f792 in Parser::getObj (this=this@entry=0x1eb1360, obj=&lt;optimized out&gt;, obj@entry=0x7fffff801f68, fileKey=fileKey@entry=0x0, encAlgorithm=encAlgorithm@entry=cryptRC4, keyLength=keyLength@entry=0, objNum=objNum@entry=7, objGen=0) at Parser.cc:226
</span><span style="color:#c0c5ce;">#7  0x000000000049f475 in Parser::getObj (this=0x1eb1360, obj=&lt;optimized out&gt;, fileKey=0x0, encAlgorithm=cryptRC4, keyLength=0, objNum=7, objGen=0) at Parser.cc:85
</span><span style="color:#c0c5ce;">#8  0x00000000004d07c6 in XRef::fetch (this=0x7a25d0, num=7, gen=0, obj=0x7fffff802078) at XRef.cc:823
</span><span style="color:#c0c5ce;">#9  0x000000000049fd14 in Object::dictLookup (this=0x7fffff802208, key=0x25 &lt;error: Cannot access memory at address 0x25&gt;, obj=0x7fffff802078) at ./Object.h:253
</span><span style="color:#c0c5ce;">#10 Parser::makeStream (this=this@entry=0x1eb0ee0, dict=dict@entry=0x7fffff802208, fileKey=fileKey@entry=0x0, encAlgorithm=encAlgorithm@entry=cryptRC4, keyLength=keyLength@entry=0, objNum=objNum@entry=7, objGen=0) at Parser.cc:156
</span><span style="color:#c0c5ce;">#11 0x000000000049f6eb in Parser::getObj (this=0x1eb0ee0, obj=&lt;optimized out&gt;, fileKey=0x0, encAlgorithm=cryptRC4, keyLength=0, objNum=7, objGen=0) at Parser.cc:94
</span><span style="color:#c0c5ce;">#12 0x00000000004d07c6 in XRef::fetch (this=0x7a25d0, num=7, gen=0, obj=0x7fffff802208) at XRef.cc:823
</span><span style="color:#c0c5ce;">#13 0x000000000049fd14 in Object::dictLookup (this=0x7fffff802398, key=0x25 &lt;error: Cannot access memory at address 0x25&gt;, obj=0x7fffff802208) at ./Object.h:253
</span><span style="color:#c0c5ce;">#14 Parser::makeStream (this=this@entry=0x1eb0a60, dict=dict@entry=0x7fffff802398, fileKey=fileKey@entry=0x0, encAlgorithm=encAlgorithm@entry=cryptRC4, keyLength=keyLength@entry=0, objNum=objNum@entry=7, objGen=0) at Parser.cc:156
</span></pre>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">makeStream()-&gt; dictLookup() -&gt; fetch() -&gt; getObj()
</span></pre>
<h1 id="exercise2">exercise2</h1><p>本节学习：</p>
<ul>
<li>使用外部应用来fuzz一个库</li>
<li>使用afl-clang-lto，这是个无冲突检测工具，比afl-clang-fast更快 提供更好的结果</li>
</ul>
<h2 id="fuzz">fuzz</h2><pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">ayoung@ayoung:~/fuzzing_libexif$ ./install/bin/exif exif-samples/jpg/tests/11-tests.jpg 
</span><span style="color:#c0c5ce;">EXIF tags in &#39;exif-samples/jpg/tests/11-tests.jpg&#39; (&#39;Intel&#39; byte order):
</span><span style="color:#c0c5ce;">--------------------+----------------------------------------------------------
</span><span style="color:#c0c5ce;">Tag                 |Value                                                     
</span><span style="color:#c0c5ce;">--------------------+----------------------------------------------------------
</span><span style="color:#c0c5ce;">Manufacturer        |Canon                                                     
</span><span style="color:#c0c5ce;">Model               |Canon DIGITAL IXUS 40                                     
</span><span style="color:#c0c5ce;">Date and Time       |2007:09:03 16:03:45                                       
</span><span style="color:#c0c5ce;">YCbCr Positioning   |centered                                                  
</span><span style="color:#c0c5ce;">RelatedImageWidth   |2272                                                      
</span><span style="color:#c0c5ce;">RelatedImageLength  |1704                                                      
</span><span style="color:#c0c5ce;">Custom Rendered     |Normal process                                            
</span><span style="color:#c0c5ce;">Exposure Mode       |Auto exposure                                             
</span><span style="color:#c0c5ce;">White Balance       |Auto white balance                                        
</span><span style="color:#c0c5ce;">Digital Zoom Ratio  |1.00                                                      
</span><span style="color:#c0c5ce;">Scene Capture Type  |Standard                                                  
</span><span style="color:#c0c5ce;">Exposure Time       |1/500 sec.                                                
</span><span style="color:#c0c5ce;">FNumber             |f/2.8                                                     
</span><span style="color:#c0c5ce;">Exif Version        |Exif Version 2.2                                          
</span><span style="color:#c0c5ce;">Date and Time (origi|2007:09:03 16:03:45                                       
</span><span style="color:#c0c5ce;">Date and Time (digit|2007:09:03 16:03:45                                       
</span><span style="color:#c0c5ce;">ComponentsConfigurat|Y Cb Cr -                                                 
</span><span style="color:#c0c5ce;">Compressed Bits per |3.00                                                      
</span><span style="color:#c0c5ce;">Shutter speed       |8.97 EV (APEX: 22, 1/501 sec.)                            
</span><span style="color:#c0c5ce;">Aperture            |2.97 EV (f/2.8)                                           
</span><span style="color:#c0c5ce;">Exposure Bias       |0.00 EV                                                   
</span><span style="color:#c0c5ce;">MaxApertureValue    |2.97 EV (f/2.8)                                           
</span><span style="color:#c0c5ce;">Metering Mode       |Pattern                                                   
</span><span style="color:#c0c5ce;">Flash               |Flash did not fire, auto mode.                            
</span><span style="color:#c0c5ce;">Focal Length        |5.8 mm                                                    
</span><span style="color:#c0c5ce;">Maker Note          |1176 bytes unknown data                                   
</span><span style="color:#c0c5ce;">User Comment        |                                                          
</span><span style="color:#c0c5ce;">FlashPixVersion     |FlashPix Version 1.0                                      
</span><span style="color:#c0c5ce;">Color Space         |sRGB                                                      
</span><span style="color:#c0c5ce;">PixelXDimension     |2272                                                      
</span><span style="color:#c0c5ce;">PixelYDimension     |1704                                                      
</span><span style="color:#c0c5ce;">Focal Plane x-Resolu|10142.86                                                  
</span><span style="color:#c0c5ce;">Focal Plane y-Resolu|10142.86                                                  
</span><span style="color:#c0c5ce;">Focal Plane Resoluti|Inch                                                      
</span><span style="color:#c0c5ce;">Sensing Method      |One-chip color area sensor                                
</span><span style="color:#c0c5ce;">File Source         |DSC                                                       
</span><span style="color:#c0c5ce;">--------------------+----------------------------------------------------------
</span></pre>
<p>alf-clang-fast和alf-clang-lto区别：
afl-clang-lto 无碰撞检测 比alf-clang-fast更快并提供更好的结果
对于这些编译器在何种情况下使用 给出下面解读</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">+--------------------------------+
</span><span style="color:#c0c5ce;">| clang/clang++ 11+ is available | --&gt; use LTO mode (afl-clang-lto/afl-clang-lto++)
</span><span style="color:#c0c5ce;">+--------------------------------+     see [instrumentation/README.lto.md](instrumentation/README.lto.md)
</span><span style="color:#c0c5ce;">    |
</span><span style="color:#c0c5ce;">    | if not, or if the target fails with LTO afl-clang-lto/++
</span><span style="color:#c0c5ce;">    |
</span><span style="color:#c0c5ce;">    v
</span><span style="color:#c0c5ce;">+---------------------------------+
</span><span style="color:#c0c5ce;">| clang/clang++ 6.0+ is available | --&gt; use LLVM mode (afl-clang-fast/afl-clang-fast++)
</span><span style="color:#c0c5ce;">+---------------------------------+     see [instrumentation/README.llvm.md](instrumentation/README.llvm.md)
</span><span style="color:#c0c5ce;">    |
</span><span style="color:#c0c5ce;">    | if not, or if the target fails with LLVM afl-clang-fast/++
</span><span style="color:#c0c5ce;">    |
</span><span style="color:#c0c5ce;">    v
</span><span style="color:#c0c5ce;"> +--------------------------------+
</span><span style="color:#c0c5ce;"> | gcc 5+ is available            | -&gt; use GCC_PLUGIN mode (afl-gcc-fast/afl-g++-fast)
</span><span style="color:#c0c5ce;"> +--------------------------------+    see [instrumentation/README.gcc_plugin.md](instrumentation/README.gcc_plugin.md) and
</span><span style="color:#c0c5ce;">                                       [instrumentation/README.instrument_list.md](instrumentation/README.instrument_list.md)
</span><span style="color:#c0c5ce;">    |
</span><span style="color:#c0c5ce;">    | if not, or if you do not have a gcc with plugin support
</span><span style="color:#c0c5ce;">    |
</span><span style="color:#c0c5ce;">    v
</span><span style="color:#c0c5ce;">   use GCC mode (afl-gcc/afl-g++) (or afl-clang/afl-clang++ for clang)
</span></pre>
<p>插桩编译</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;"># 重新编译 libexif
</span><span style="color:#c0c5ce;">rm -r $HOME/fuzzing_libexif/install
</span><span style="color:#c0c5ce;">cd $HOME/fuzzing_libexif/libexif-0.6.14/
</span><span style="color:#c0c5ce;">make clean
</span><span style="color:#c0c5ce;">export LLVM_CONFIG=&quot;llvm-config-13&quot;
</span><span style="color:#c0c5ce;">CC=afl-clang-lto ./configure --enable-shared=no --prefix=&quot;$HOME/fuzzing_libexif/install/&quot;
</span><span style="color:#c0c5ce;">make
</span><span style="color:#c0c5ce;">make install
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;"># 重新编译 exif
</span><span style="color:#c0c5ce;">cd $HOME/fuzzing_libexif/exif-0.6.15
</span><span style="color:#c0c5ce;">make clean
</span><span style="color:#c0c5ce;">export LLVM_CONFIG=&quot;llvm-config-11&quot;
</span><span style="color:#c0c5ce;">CC=afl-clang-lto ./configure --enable-shared=no --prefix=&quot;$HOME/fuzzing_libexif/install/&quot; PKG_CONFIG_PATH=$HOME/fuzzing_libexif/install/lib/pkgconfig
</span><span style="color:#c0c5ce;">make
</span><span style="color:#c0c5ce;">make install
</span></pre>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">sudo su
</span><span style="color:#c0c5ce;">echo core &gt;/proc/sys/kernel/core_pattern # 设置core dump文件名为静态core
</span><span style="color:#c0c5ce;">exit
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">afl-fuzz -i $HOME/fuzzing_libexif/exif-samples/jpg/ -o $HOME/fuzzing_libexif/out/ -s 123 -- $HOME/fuzzing_libexif/install/bin/exif @@
</span></pre>
<p>编译带调试信息的程序 源码调试</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;"># libexif
</span><span style="color:#c0c5ce;">rm -r $HOME/fuzzing_libexif/install
</span><span style="color:#c0c5ce;">cd $HOME/fuzzing_libexif/libexif-0.6.14/
</span><span style="color:#c0c5ce;">make clean
</span><span style="color:#c0c5ce;">CFLAGS=&quot;-g -O0&quot; CXXFLAGS=&quot;-g -O0&quot; ./configure --enable-shared=no --prefix=&quot;$HOME/fuzzing_libexif/install/&quot;
</span><span style="color:#c0c5ce;">make
</span><span style="color:#c0c5ce;">make install
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;"># exif
</span><span style="color:#c0c5ce;">cd $HOME/fuzzing_libexif/exif-0.6.15
</span><span style="color:#c0c5ce;">make clean
</span><span style="color:#c0c5ce;">CFLAGS=&quot;-g -O0&quot; CXXFLAGS=&quot;-g -O0&quot; PKG_CONFIG_PATH=$HOME/fuzzing_libexif/install/lib/pkgconfig ./configure --enable-shared=no --prefix=&quot;$HOME/fuzzing_libexif/install/&quot;
</span><span style="color:#c0c5ce;">make
</span><span style="color:#c0c5ce;">make install
</span></pre>
<h2 id="crashfen-xi">crash分析</h2><p>看到两种崩溃点
下面crash样本经过简化处理</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">ayoung@ayoung:~/fuzzing_libexif$ cat out/default/simple/res1  |xxd
</span><span style="color:#c0c5ce;">00000000: e000 1030 3030 3030 3030 3030 3030 3030  ...0000000000000
</span><span style="color:#c0c5ce;">00000010: 30e1 3030 4578 6966 0000 4d4d 002a ffff  0.00Exif..MM.*..
</span><span style="color:#c0c5ce;">00000020: ffff             
</span></pre>
<p>crash1 取值时指针异常</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">pwndbg&gt; x/i $rip
</span><span style="color:#c0c5ce;">=&gt; 0x561d59dc7e54 &lt;exif_get_sshort+47&gt;: movzx  eax,BYTE PTR [rax]
</span><span style="color:#c0c5ce;">pwndbg&gt; p buf
</span><span style="color:#c0c5ce;">$1 = (const unsigned char *) 0x561e5c4f88e5 &lt;error: Cannot access memory at address 0x561e5c4f88e5&gt;
</span><span style="color:#c0c5ce;">pwndbg&gt; bt
</span><span style="color:#c0c5ce;">#0  0x0000561d59dc7e54 in exif_get_sshort (buf=0x561e5c4f88e5 &lt;error: Cannot access memory at address 0x561e5c4f88e5&gt;, order=EXIF_BYTE_ORDER_MOTOROLA) at exif-utils.c:92
</span><span style="color:#c0c5ce;">#1  0x0000561d59dc7ebd in exif_get_short (buf=0x561e5c4f88e5 &lt;error: Cannot access memory at address 0x561e5c4f88e5&gt;, order=EXIF_BYTE_ORDER_MOTOROLA) at exif-utils.c:104
</span><span style="color:#c0c5ce;">#2  0x0000561d59dbedbb in exif_data_load_data (data=0x561d5c4f67b0, d_orig=0x561d5c4f88e0 &quot;Exif&quot;, ds_orig=14) at exif-data.c:819
</span><span style="color:#c0c5ce;">#3  0x0000561d59dc686f in exif_loader_get_data (loader=0x561d5c4f6760) at exif-loader.c:387
</span><span style="color:#c0c5ce;">#4  0x0000561d59dba02c in main (argc=2, argv=0x7fff785329d8) at main.c:438
</span><span style="color:#c0c5ce;">#5  0x00007f3b58bd5d90 in __libc_start_call_main (main=main@entry=0x561d59db9673 &lt;main&gt;, argc=argc@entry=2, argv=argv@entry=0x7fff785329d8) at ../sysdeps/nptl/libc_start_call_main.h:58
</span><span style="color:#c0c5ce;">#6  0x00007f3b58bd5e40 in __libc_start_main_impl (main=0x561d59db9673 &lt;main&gt;, argc=2, argv=0x7fff785329d8, init=&lt;optimized out&gt;, fini=&lt;optimized out&gt;, rtld_fini=&lt;optimized out&gt;, stack_end=0x7fff785329c8) at ../csu/libc-start.c:392
</span><span style="color:#c0c5ce;">#7  0x0000561d59db77a5 in _start ()
</span></pre>
<p>参考现有分析 断点下到exif-data.c:816</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(offset + </span><span style="color:#d08770;">6 </span><span style="color:#c0c5ce;">+ </span><span style="color:#d08770;">2 </span><span style="color:#c0c5ce;">&gt; ds) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">}
</span><span style="color:#c0c5ce;">n = </span><span style="color:#8fa1b3;">exif_get_short </span><span style="color:#c0c5ce;">(d + </span><span style="color:#d08770;">6 </span><span style="color:#c0c5ce;">+ offset, data-&gt;priv-&gt;order);
</span></pre>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">pwndbg&gt; p/x offset
</span><span style="color:#c0c5ce;">$3 = 0xffffffff
</span><span style="color:#c0c5ce;">pwndbg&gt; p/x offset+6+2
</span><span style="color:#c0c5ce;">$6 = 0x7
</span><span style="color:#c0c5ce;">pwndbg&gt; p/x ds
</span><span style="color:#c0c5ce;">$4 = 0xe
</span></pre>
<p>32位整数溢出 回环后绕过了检查，但后续传入函数的是地址 造成了越界 访问到不可访问地址
而<code>exif_get_short()</code>函数作用是从buf处获取16位整数 并按照对应字节序解析
定义如下</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">ExifSShort
</span><span style="color:#8fa1b3;">exif_get_sshort </span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">const unsigned char </span><span style="color:#c0c5ce;">*</span><span style="color:#bf616a;">buf</span><span style="color:#c0c5ce;">, ExifByteOrder </span><span style="color:#bf616a;">order</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(!buf) </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">switch </span><span style="color:#c0c5ce;">(order) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">case</span><span style="color:#c0c5ce;"> EXIF_BYTE_ORDER_MOTOROLA:
</span><span style="color:#c0c5ce;">                </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">((buf[</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">] &lt;&lt; </span><span style="color:#d08770;">8</span><span style="color:#c0c5ce;">) | buf[</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">]);
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">case</span><span style="color:#c0c5ce;"> EXIF_BYTE_ORDER_INTEL:
</span><span style="color:#c0c5ce;">                </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">((buf[</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">] &lt;&lt; </span><span style="color:#d08770;">8</span><span style="color:#c0c5ce;">) | buf[</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">]);
</span><span style="color:#c0c5ce;">        }
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">	</span><span style="color:#65737e;">/* Won&#39;t be reached */
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">}
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">ExifShort
</span><span style="color:#8fa1b3;">exif_get_short </span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">const unsigned char </span><span style="color:#c0c5ce;">*</span><span style="color:#bf616a;">buf</span><span style="color:#c0c5ce;">, ExifByteOrder </span><span style="color:#bf616a;">order</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">(</span><span style="color:#8fa1b3;">exif_get_sshort </span><span style="color:#c0c5ce;">(buf, order) &amp; </span><span style="color:#d08770;">0xffff</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">}
</span></pre>
<p>crash2 堆溢出</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">ayoung@ayoung:~/fuzzing_libexif$ cat out/default/simple/res2 
</span><span style="color:#c0c5ce;">00ExifII000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000����
</span></pre>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">pwndbg&gt; x/i $rip
</span><span style="color:#c0c5ce;">=&gt; 0x7f4437cd7398 &lt;__memmove_evex_unaligned_erms+1496&gt;: vmovdqu64 ymm20,YMMWORD PTR [rsi+0x1000]
</span><span style="color:#c0c5ce;">pwndbg&gt; x/10gx $rsi+0x1000
</span><span style="color:#c0c5ce;">0x556ed3c20946: Cannot access memory at address 0x556ed3c20946
</span><span style="color:#c0c5ce;">pwndbg&gt; vmmap 0x556ed3c1f946
</span><span style="color:#c0c5ce;">LEGEND: STACK | HEAP | CODE | DATA | WX | RODATA
</span><span style="color:#c0c5ce;">             Start                End Perm     Size Offset File
</span><span style="color:#c0c5ce;">    0x556eb4c19000     0x556eb4c1a000 rw-p     1000      0 [anon_556eb4c19]
</span><span style="color:#c0c5ce;">►   0x556ed3bff000     0x556ed3c20000 rw-p    21000      0 [heap] +0x20946
</span><span style="color:#c0c5ce;">    0x7f4337513000     0x7f4437514000 rw-p 100001000      0 [anon_7f4337513]
</span><span style="color:#c0c5ce;">pwndbg&gt; bt
</span><span style="color:#c0c5ce;">#0  __memmove_evex_unaligned_erms () at ../sysdeps/x86_64/multiarch/memmove-vec-unaligned-erms.S:872
</span><span style="color:#c0c5ce;">#1  0x0000556eb4bec3d9 in exif_data_load_data_thumbnail (data=0x556ed3c017b0, d=0x556ed3c038e6 &quot;II*&quot;, ds=814, offset=48, size=4294967295) at exif-data.c:292
</span><span style="color:#c0c5ce;">#2  0x0000556eb4bec8f8 in exif_data_load_data_content (data=0x556ed3c017b0, ifd=EXIF_IFD_0, d=0x556ed3c038e6 &quot;II*&quot;, ds=814, offset=10, recursion_depth=0) at exif-data.c:381
</span><span style="color:#c0c5ce;">#3  0x0000556eb4bedd8a in exif_data_load_data (data=0x556ed3c017b0, d_orig=0x556ed3c038e0 &quot;Exif&quot;, ds_orig=820) at exif-data.c:813
</span><span style="color:#c0c5ce;">#4  0x0000556eb4bf586f in exif_loader_get_data (loader=0x556ed3c01760) at exif-loader.c:387
</span><span style="color:#c0c5ce;">#5  0x0000556eb4be902c in main (argc=2, argv=0x7fff048b5848) at main.c:438
</span><span style="color:#c0c5ce;">#6  0x00007f4437b51d90 in __libc_start_call_main (main=main@entry=0x556eb4be8673 &lt;main&gt;, argc=argc@entry=2, argv=argv@entry=0x7fff048b5848) at ../sysdeps/nptl/libc_start_call_main.h:58
</span><span style="color:#c0c5ce;">#7  0x00007f4437b51e40 in __libc_start_main_impl (main=0x556eb4be8673 &lt;main&gt;, argc=2, argv=0x7fff048b5848, init=&lt;optimized out&gt;, fini=&lt;optimized out&gt;, rtld_fini=&lt;optimized out&gt;, stack_end=0x7fff048b5838) at ../csu/libc-start.c:392
</span><span style="color:#c0c5ce;">#8  0x0000556eb4be67a5 in _start ()
</span></pre>
<p>在往上找 发现溢出点</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;"> ► 0x55f1031843d4 &lt;exif_data_load_data_thumbnail+248&gt;    call   memcpy@plt                  &lt;memcpy@plt&gt;
</span><span style="color:#c0c5ce;">        dest: 0x7fe5dd12f010 ◂— 0
</span><span style="color:#c0c5ce;">        src: 0x55f13138b916 ◂— 0x3030303030303030 (&#39;00000000&#39;)
</span><span style="color:#c0c5ce;">        n: 0xffffffff
</span></pre>
<p>和crash1类似 都是进行边界检查的时候出现整数溢出 造成越界</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">static void
</span><span style="color:#8fa1b3;">exif_data_load_data_thumbnail </span><span style="color:#c0c5ce;">(ExifData *</span><span style="color:#bf616a;">data</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">const unsigned char </span><span style="color:#c0c5ce;">*</span><span style="color:#bf616a;">d</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">			       </span><span style="color:#b48ead;">unsigned int </span><span style="color:#bf616a;">ds</span><span style="color:#c0c5ce;">, ExifLong </span><span style="color:#bf616a;">offset</span><span style="color:#c0c5ce;">, ExifLong </span><span style="color:#bf616a;">size</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(ds &lt; offset + size) {
</span><span style="color:#c0c5ce;">		</span><span style="color:#8fa1b3;">exif_log </span><span style="color:#c0c5ce;">(data-&gt;priv-&gt;log, EXIF_LOG_CODE_DEBUG, &quot;</span><span style="color:#a3be8c;">ExifData</span><span style="color:#c0c5ce;">&quot;,
</span><span style="color:#c0c5ce;">			  &quot;</span><span style="color:#a3be8c;">Bogus thumbnail offset and size: </span><span style="color:#d08770;">%i</span><span style="color:#a3be8c;"> &lt; </span><span style="color:#d08770;">%i</span><span style="color:#a3be8c;"> + </span><span style="color:#d08770;">%i</span><span style="color:#a3be8c;">.</span><span style="color:#c0c5ce;">&quot;,
</span><span style="color:#c0c5ce;">			  (</span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">) ds, (</span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">) offset, (</span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">) size);
</span><span style="color:#c0c5ce;">		</span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">	}
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(data-&gt;data) 
</span><span style="color:#c0c5ce;">		</span><span style="color:#8fa1b3;">exif_mem_free </span><span style="color:#c0c5ce;">(data-&gt;priv-&gt;mem, data-&gt;data);
</span><span style="color:#c0c5ce;">	data-&gt;size = size;
</span><span style="color:#c0c5ce;">	data-&gt;data = </span><span style="color:#8fa1b3;">exif_data_alloc </span><span style="color:#c0c5ce;">(data, data-&gt;size);
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(!data-&gt;data) 
</span><span style="color:#c0c5ce;">		</span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">	</span><span style="color:#96b5b4;">memcpy </span><span style="color:#c0c5ce;">(data-&gt;data, d + offset, data-&gt;size);
</span><span style="color:#c0c5ce;">}
</span></pre>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">pwndbg&gt; p/x ds
</span><span style="color:#c0c5ce;">$10 = 0x32e
</span><span style="color:#c0c5ce;">pwndbg&gt; p/x offset
</span><span style="color:#c0c5ce;">$11 = 0x30
</span><span style="color:#c0c5ce;">pwndbg&gt; p/x size
</span><span style="color:#c0c5ce;">$12 = 0xffffffff
</span><span style="color:#c0c5ce;">pwndbg&gt; p/x size+offset
</span><span style="color:#c0c5ce;">$14 = 0x2f
</span></pre>
<p>从而发现 第一个if条件由于整数溢出 没有被判断出问题
后续memcpy长度过长，在拷贝源数据的过程中发生越界读取造成崩溃</p>
<h1 id="exercise3">exercise3</h1><p>本节学习：</p>
<ul>
<li>什么是运行时内存错误检测工具ASan</li>
<li>如何使用ASAN fuzz目标</li>
<li>使用ASan分类crash有多容易</li>
</ul>
<h2 id="fuzz">fuzz</h2><p>编译略</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">ayoung@ayoung:~/fuzzing_tcpdump/tcpdump-4.9.2$ $HOME/fuzzing_tcpdump/install/sbin/tcpdump -h
</span><span style="color:#c0c5ce;">tcpdump version 4.9.2
</span><span style="color:#c0c5ce;">libpcap version 1.8.0
</span><span style="color:#c0c5ce;">OpenSSL 3.0.2 15 Mar 2022
</span><span style="color:#c0c5ce;">Usage: tcpdump [-aAbdDefhHIJKlLnNOpqStuUvxX#] [ -B size ] [ -c count ]
</span><span style="color:#c0c5ce;">                [ -C file_size ] [ -E algo:secret ] [ -F file ] [ -G seconds ]
</span><span style="color:#c0c5ce;">                [ -i interface ] [ -j tstamptype ] [ -M secret ] [ --number ]
</span><span style="color:#c0c5ce;">                [ -Q in|out|inout ]
</span><span style="color:#c0c5ce;">                [ -r file ] [ -s snaplen ] [ --time-stamp-precision precision ]
</span><span style="color:#c0c5ce;">                [ --immediate-mode ] [ -T type ] [ --version ] [ -V file ]
</span><span style="color:#c0c5ce;">                [ -w file ] [ -W filecount ] [ -y datalinktype ] [ -z postrotate-command ]
</span><span style="color:#c0c5ce;">                [ -Z user ] [ expression ]
</span></pre>
<p>文件夹下有样例</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">ayoung@ayoung:~/fuzzing_tcpdump/tcpdump-4.9.2$ $HOME/fuzzing_tcpdump/install/sbin/tcpdump -vvvvXX -ee -nn -r ./tests/geneve.pcap
</span><span style="color:#c0c5ce;">reading from file ./tests/geneve.pcap, link-type EN10MB (Ethernet)
</span><span style="color:#c0c5ce;">22:04:33.817203 00:1b:21:3c:ab:64 &gt; 00:1b:21:3c:ac:30, ethertype IPv4 (0x0800), length 156: (tos 0x0, ttl 64, id 57261, offset 0, flags [DF], proto UDP (17), length 142)
</span><span style="color:#c0c5ce;">    20.0.0.1.12618 &gt; 20.0.0.2.6081: [no cksum] Geneve, Flags [C], vni 0xa, proto TEB (0x6558), options [class Standard (0x0) type 0x80(C) len 8 data 0000000c]
</span><span style="color:#c0c5ce;">        b6:9e:d2:49:51:48 &gt; fe:71:d8:83:72:4f, ethertype IPv4 (0x0800), length 98: (tos 0x0, ttl 64, id 48546, offset 0, flags [DF], proto ICMP (1), length 84)
</span><span style="color:#c0c5ce;">    30.0.0.1 &gt; 30.0.0.2: ICMP echo request, id 10578, seq 23, length 64
</span><span style="color:#c0c5ce;">        0x0000:  001b 213c ac30 001b 213c ab64 0800 4500  ..!&lt;.0..!&lt;.d..E.
</span><span style="color:#c0c5ce;">        0x0010:  008e dfad 4000 4011 32af 1400 0001 1400  ....@.@.2.......
</span><span style="color:#c0c5ce;">        0x0020:  0002 314a 17c1 007a 0000 0240 6558 0000  ..1J...z...@eX..
</span><span style="color:#c0c5ce;">        0x0030:  0a00 0000 8001 0000 000c fe71 d883 724f  ...........q..rO
</span><span style="color:#c0c5ce;">        0x0040:  b69e d249 5148 0800 4500 0054 bda2 4000  ...IQH..E..T..@.
</span><span style="color:#c0c5ce;">        0x0050:  4001 4104 1e00 0001 1e00 0002 0800 2c54  @.A...........,T
</span><span style="color:#c0c5ce;">        0x0060:  2952 0017 f1a2 ce54 0000 0000 1778 0c00  )R.....T.....x..
</span><span style="color:#c0c5ce;">        0x0070:  0000 0000 1011 1213 1415 1617 1819 1a1b  ................
</span><span style="color:#c0c5ce;">        0x0080:  1c1d 1e1f 2021 2223 2425 2627 2829 2a2b  .....!&quot;#$%&amp;&#39;()*+
</span><span style="color:#c0c5ce;">        0x0090:  2c2d 2e2f 3031 3233 3435 3637            ,-./01234567
</span><span style="color:#c0c5ce;">        ...
</span></pre>
<p>AddressSanitizer(ASan)是C和C++快速内存错误检测器 由编译器插桩模块和运行库组成，能够发现堆栈和全局对象越界访问，以及uaf、double free和内存泄露错误</p>
<p>接下来使用Asan编译</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">cd $HOME/fuzzing_tcpdump/libpcap-1.8.0/
</span><span style="color:#c0c5ce;">export LLVM_CONFIG=&quot;llvm-config-13&quot;
</span><span style="color:#c0c5ce;">CC=afl-clang-lto ./configure --enable-shared=no --prefix=&quot;$HOME/fuzzing_tcpdump/install/&quot;
</span><span style="color:#c0c5ce;">AFL_USE_ASAN=1 make
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">cd $HOME/fuzzing_tcpdump/tcpdump-4.9.2/
</span><span style="color:#c0c5ce;">AFL_USE_ASAN=1 CC=afl-clang-lto ./configure --prefix=&quot;$HOME/fuzzing_tcpdump/install/&quot;
</span><span style="color:#c0c5ce;">AFL_USE_ASAN=1 make
</span><span style="color:#c0c5ce;">AFL_USE_ASAN=1 make install
</span></pre>
<p>显示由ASan编译</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">ayoung@ayoung:~/fuzzing_tcpdump/tcpdump-4.9.2$ ./tcpdump -h
</span><span style="color:#c0c5ce;">tcpdump version 4.9.2
</span><span style="color:#c0c5ce;">libpcap version 1.8.0
</span><span style="color:#c0c5ce;">OpenSSL 3.0.2 15 Mar 2022
</span><span style="color:#c0c5ce;">Compiled with AddressSanitizer/CLang.
</span><span style="color:#c0c5ce;">Usage: tcpdump [-aAbdDefhHIJKlLnNOpqStuUvxX#] [ -B size ] [ -c count ]
</span><span style="color:#c0c5ce;">                [ -C file_size ] [ -E algo:secret ] [ -F file ] [ -G seconds ]
</span><span style="color:#c0c5ce;">                [ -i interface ] [ -j tstamptype ] [ -M secret ] [ --number ]
</span><span style="color:#c0c5ce;">                [ -Q in|out|inout ]
</span><span style="color:#c0c5ce;">                [ -r file ] [ -s snaplen ] [ --time-stamp-precision precision ]
</span><span style="color:#c0c5ce;">                [ --immediate-mode ] [ -T type ] [ --version ] [ -V file ]
</span><span style="color:#c0c5ce;">                [ -w file ] [ -W filecount ] [ -y datalinktype ] [ -z postrotate-command ]
</span><span style="color:#c0c5ce;">                [ -Z user ] [ expression ]
</span></pre>
<p>开始fuzz</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">afl-fuzz -m none -i tcpdump-4.9.2/tests/ -o out/ -s 123 -- $HOME/fuzzing_tcpdump/install/sbin/tcpdump -vvvvXX -ee -nn -r @@
</span></pre>
<h2 id="crashfen-xi">crash分析</h2><p>跑了将近一天跑出10个crash</p>
<p>先尝试使用alf-tmin简化crash时碰到一个报错：</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">ayoung@ayoung:~/fuzzing_tcpdump/out/default/crashes$ afl-tmin -i ./id\:000000\,sig\:06\,src\:007302\,time\:34124764\,execs\:6059862\,op\:flip1\,pos\:16 -o 1 -- $HOME/fuzzing_tcpdump/install/sbin/tcpdump -vvvvXX -ee -nn -r @@
</span><span style="color:#c0c5ce;">afl-tmin++4.32c by Michal Zalewski
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">[+] Read 5536 bytes from &#39;./id:000000,sig:06,src:007302,time:34124764,execs:6059862,op:flip1,pos:16&#39;.
</span><span style="color:#c0c5ce;">[*] Spinning up the fork server...
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">[-] PROGRAM ABORT : AFL_MAP_SIZE is not set and fuzzing target reports that the required size is very large. Solution: Run the fuzzing target stand-alone with the environment variable AFL_DUMP_MAP_SIZE=1 set the displayed value in the AFL_MAP_SIZE environment variable for afl-fuzz.
</span><span style="color:#c0c5ce;">         Location : report_error_and_exit(), src/afl-forkserver.c:495
</span></pre>
<p>错误表明AFL++的共享内存大小（<code>AFL_MAP_SIZE</code>）未设置，而目标程序tcpdump需要更大的内存空间来记录代码覆盖率
AFL_MAP_SIZE默认64KB，当目标程序检测到默认空间不足就需要增大AFL_MAP_SIZE</p>
<p>确定所需的空间大小：</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">ayoung@ayoung:~/fuzzing_tcpdump/out/default/crashes$ AFL_DUMP_MAP_SIZE=1 $HOME/fuzzing_tcpdump/install/sbin/tcpdump -vvvvXX -ee -nn -r /dev/null
</span><span style="color:#c0c5ce;">85601
</span></pre>
<p>之后运行afl-tmin时带上该环境变量，使用脚本批量简化</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">for i in id*
</span><span style="color:#c0c5ce;">do
</span><span style="color:#c0c5ce;">    AFL_MAP_SIZE=262144 afl-tmin -i $i -o tmin-$i -- $HOME/fuzzing_tcpdump/install/sbin/tcpdump -vvvvXX -ee -nn -r @@
</span><span style="color:#c0c5ce;">done
</span></pre>
<p>运行crash，ASAN报堆溢出错误</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">==2526776==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x61200000015b at pc 0x00000039dde6 bp 0x7ffc098f7200 sp 0x7ffc098f69a8
</span><span style="color:#c0c5ce;">READ of size 4 at 0x61200000015b thread T0
</span><span style="color:#c0c5ce;">    #0 0x39dde5 in MemcmpInterceptorCommon(void*, int (*)(void const*, void const*, unsigned long), void const*, void const*, unsigned long) crtstuff.c
</span><span style="color:#c0c5ce;">    #1 0x39e2d9 in memcmp (/home/ayoung/fuzzing_tcpdump/install/sbin/tcpdump+0x39e2d9)
</span><span style="color:#c0c5ce;">    #2 0x4af354 in bootp_print /home/ayoung/fuzzing_tcpdump/tcpdump-4.9.2/./print-bootp.c:382:6
</span><span style="color:#c0c5ce;">    #3 0x531f38 in ip_print_demux /home/ayoung/fuzzing_tcpdump/tcpdump-4.9.2/./print-ip.c:402:3
</span><span style="color:#c0c5ce;">    #4 0x535b7a in ip_print /home/ayoung/fuzzing_tcpdump/tcpdump-4.9.2/./print-ip.c:673:3
</span><span style="color:#c0c5ce;">    #5 0x4ebe1e in ethertype_print /home/ayoung/fuzzing_tcpdump/tcpdump-4.9.2/./print-ether.c:333:10
</span><span style="color:#c0c5ce;">    #6 0x4ea92e in ether_print /home/ayoung/fuzzing_tcpdump/tcpdump-4.9.2/./print-ether.c:236:7
</span><span style="color:#c0c5ce;">    #7 0x4482ca in pretty_print_packet /home/ayoung/fuzzing_tcpdump/tcpdump-4.9.2/./print.c:332:18
</span><span style="color:#c0c5ce;">    #8 0x4482ca in print_packet /home/ayoung/fuzzing_tcpdump/tcpdump-4.9.2/./tcpdump.c:2497:2
</span><span style="color:#c0c5ce;">    #9 0x818a4a in pcap_offline_read /home/ayoung/fuzzing_tcpdump/libpcap-1.8.0/./savefile.c:523:4
</span><span style="color:#c0c5ce;">    #10 0x441452 in pcap_loop /home/ayoung/fuzzing_tcpdump/libpcap-1.8.0/./pcap.c:904:8
</span><span style="color:#c0c5ce;">    #11 0x441452 in main /home/ayoung/fuzzing_tcpdump/tcpdump-4.9.2/./tcpdump.c:2000:12
</span><span style="color:#c0c5ce;">    #12 0x7f728571cd8f in __libc_start_call_main csu/../sysdeps/nptl/libc_start_call_main.h:58:16
</span><span style="color:#c0c5ce;">    #13 0x7f728571ce3f in __libc_start_main csu/../csu/libc-start.c:392:3
</span><span style="color:#c0c5ce;">    #14 0x385904 in _start (/home/ayoung/fuzzing_tcpdump/install/sbin/tcpdump+0x385904)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">0x61200000015b is located 0 bytes to the right of 283-byte region [0x612000000040,0x61200000015b)
</span><span style="color:#c0c5ce;">allocated by thread T0 here:
</span><span style="color:#c0c5ce;">    #0 0x4027ed in malloc (/home/ayoung/fuzzing_tcpdump/install/sbin/tcpdump+0x4027ed)
</span><span style="color:#c0c5ce;">    #1 0x81a0ea in pcap_check_header /home/ayoung/fuzzing_tcpdump/libpcap-1.8.0/./sf-pcap.c:401:14
</span><span style="color:#c0c5ce;">    #2 0x817d59 in pcap_fopen_offline_with_tstamp_precision /home/ayoung/fuzzing_tcpdump/libpcap-1.8.0/./savefile.c:396:7
</span><span style="color:#c0c5ce;">    #3 0x817a58 in pcap_open_offline_with_tstamp_precision /home/ayoung/fuzzing_tcpdump/libpcap-1.8.0/./savefile.c:303:6
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">SUMMARY: AddressSanitizer: heap-buffer-overflow crtstuff.c in MemcmpInterceptorCommon(void*, int (*)(void const*, void const*, unsigned long), void const*, void const*, unsigned long)
</span><span style="color:#c0c5ce;">Shadow bytes around the buggy address:
</span><span style="color:#c0c5ce;">  0x0c247fff7fd0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
</span><span style="color:#c0c5ce;">  0x0c247fff7fe0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
</span><span style="color:#c0c5ce;">  0x0c247fff7ff0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
</span><span style="color:#c0c5ce;">  0x0c247fff8000: fa fa fa fa fa fa fa fa 00 00 00 00 00 00 00 00
</span><span style="color:#c0c5ce;">  0x0c247fff8010: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
</span><span style="color:#c0c5ce;">=&gt;0x0c247fff8020: 00 00 00 00 00 00 00 00 00 00 00[03]fa fa fa fa
</span><span style="color:#c0c5ce;">  0x0c247fff8030: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span><span style="color:#c0c5ce;">  0x0c247fff8040: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span><span style="color:#c0c5ce;">  0x0c247fff8050: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span><span style="color:#c0c5ce;">  0x0c247fff8060: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span><span style="color:#c0c5ce;">  0x0c247fff8070: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span></pre>
<p><code>[03]</code>表示对应的8字节内存中只有前3字节是合法的
asan影子内存标记值及其含义如下 每个影子字节映射到应用程序8字节内存</p>
<table><thead><tr><th>​<strong>​Shadow Byte 值​</strong>​</th><th>​<strong>​内存状态​</strong>​</th><th>​<strong>​解释​</strong>​</th></tr></thead><tbody>
<tr><th><code>00</code></th><th>Addressable</th><th>内存可安全访问（完全初始化）</th></tr>
<tr><th><code>01-07</code></th><th>Partially addressable</th><th>仅部分字节可访问（如结构体中的未填充区域）</th></tr>
<tr><th><code>fa</code></th><th>Heap left redzone</th><th>堆内存左侧红区（用于检测溢出）</th></tr>
<tr><th><code>fd</code></th><th>Freed heap region</th><th>已释放的堆内存（检测"释放后使用"错误）</th></tr>
<tr><th><code>f1-f3</code></th><th>Stack redzones</th><th>栈内存保护区域（检测栈溢出）</th></tr>
<tr><th><code>f5</code></th><th>Stack after return</th><th>函数返回后的栈空间（检测"返回后使用"错误）</th></tr>
<tr><th><code>f8</code></th><th>Stack use after scope</th><th>作用域结束后的栈变量（检测"作用域外使用"错误）</th></tr>
<tr><th><code>f9</code></th><th>Global redzone</th><th>全局变量保护区域</th></tr>
<tr><th><code>fc</code></th><th>Container overflow</th><th>容器（如数组）溢出</th></tr>
<tr><th><code>ac</code></th><th>Array cookie</th><th>数组边界校验符</th></tr>
<tr><th><code>fe</code></th><th>ASan internal</th><th>ASan 内部使用的保留区域</th></tr>
</tbody></table>
<h1 id="exercise4">exercise4</h1><p>本节学习：</p>
<ul>
<li>如何使用LCOV测量代码覆盖率</li>
<li>如何使用代码覆盖率数据提高fuzz有效性</li>
</ul>
<h2 id="fuzz">fuzz</h2><p>同样带样例，带各种标志是为了提高代码覆盖率 增加发现bug机会</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">ayoung@ayoung:~/fuzzing_tiff/tiff-4.0.4$ $HOME/fuzzing_tiff/install/bin/tiffinfo -D -j -c -r -s -w $HOME/fuzzing_tiff/tiff-4.0.4/test/images/palette-1c-1b.tiff
</span><span style="color:#c0c5ce;">TIFF Directory at offset 0xbd4 (3028)
</span><span style="color:#c0c5ce;">  Image Width: 157 Image Length: 151
</span><span style="color:#c0c5ce;">  Bits/Sample: 1
</span><span style="color:#c0c5ce;">  Sample Format: unsigned integer
</span><span style="color:#c0c5ce;">  Compression Scheme: None
</span><span style="color:#c0c5ce;">  Photometric Interpretation: palette color (RGB from colormap)
</span><span style="color:#c0c5ce;">  Samples/Pixel: 1
</span><span style="color:#c0c5ce;">  Rows/Strip: 409
</span><span style="color:#c0c5ce;">  Planar Configuration: single image plane
</span><span style="color:#c0c5ce;">  Page Number: 0-1
</span><span style="color:#c0c5ce;">  Color Map: 
</span><span style="color:#c0c5ce;">       0:     0     0     0
</span><span style="color:#c0c5ce;">       1: 65535 65535 65535
</span><span style="color:#c0c5ce;">  DocumentName: palette-1c-1b.tiff
</span><span style="color:#c0c5ce;">  Software: GraphicsMagick 1.2 unreleased Q16 http://www.GraphicsMagick.org/
</span><span style="color:#c0c5ce;">  1 Strips:
</span><span style="color:#c0c5ce;">      0: [       8,     3020]
</span></pre>
<p>重新编译libTIFF 带<code>--coverage</code>标志（编译器和链接器）</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">rm -r $HOME/fuzzing_tiff/install
</span><span style="color:#c0c5ce;">cd $HOME/fuzzing_tiff/tiff-4.0.4/
</span><span style="color:#c0c5ce;">make clean
</span><span style="color:#c0c5ce;">  
</span><span style="color:#c0c5ce;">CFLAGS=&quot;--coverage&quot; LDFLAGS=&quot;--coverage&quot; ./configure --prefix=&quot;$HOME/fuzzing_tiff/install/&quot; --disable-shared
</span><span style="color:#c0c5ce;">make
</span><span style="color:#c0c5ce;">make install
</span></pre>
<p>通过下面代码收集代码覆盖率</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">cd $HOME/fuzzing_tiff/tiff-4.0.4/
</span><span style="color:#c0c5ce;">lcov --zerocounters --directory ./ # 重置以前的计数器
</span><span style="color:#c0c5ce;">lcov --capture --initial --directory ./ --output-file app.info # 返回&quot;baseline&quot;覆盖数据文件，包含每个检测行的零覆盖率
</span><span style="color:#c0c5ce;">$HOME/fuzzing_tiff/install/bin/tiffinfo -D -j -c -r -s -w $HOME/fuzzing_tiff/tiff-4.0.4/test/images/palette-1c-1b.tiff
</span><span style="color:#c0c5ce;">lcov --no-checksum --directory ./ --capture --output-file app2.info # 将当前覆盖状态保存到app2.info文件中
</span></pre>
<p>生成HTML输出</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">genhtml --highlight --legend -output-directory ./html-coverage/ ./app2.info
</span></pre>
<p><code>./html-coverage/index.html</code>
<img src="/images/Pasted%20image%2020250510163727.png" alt="" /></p>
<p>插桩编译</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">rm -r $HOME/fuzzing_tiff/install
</span><span style="color:#c0c5ce;">cd $HOME/fuzzing_tiff/tiff-4.0.4/
</span><span style="color:#c0c5ce;">make clean
</span><span style="color:#c0c5ce;">export LLVM_CONFIG=&quot;llvm-config-13&quot;
</span><span style="color:#c0c5ce;">CC=afl-clang-lto ./configure --prefix=&quot;$HOME/fuzzing_tiff/install/&quot; --disable-shared
</span><span style="color:#c0c5ce;">AFL_USE_ASAN=1 make -j4
</span><span style="color:#c0c5ce;">AFL_USE_ASAN=1 make install
</span></pre>
<p>开始fuzz</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">afl-fuzz -m none -i tiff-4.0.4/test/images/ -o out/ -s 123 -- $HOME/fuzzing_tiff/install/bin/tiffinfo -D -j -c -r -s -w @@
</span></pre>
<h2 id="crashfen-xi">crash分析</h2><p>tmin简化后</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">ayoung@ayoung:~/fuzzing_tiff/out/default/crashes$ cat tmin/tmin-id\:000000\,sig\:06\,src\:000000\,time\:17621\,execs\:6491\,op\:arith16\,pos\:55\,val\:-2 
</span><span style="color:#c0c5ce;">II*00000000
</span><span style="color:#c0c5ce;">           00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ayoung@ayoung:~/fuzzing_tiff/out/default/crashes$ cat tmin/tmin-id\:000000\,sig\:06\,src\:000000\,time\:17621\,execs\:6491\,op\:arith16\,pos\:55\,val\:-2  | xxd
</span><span style="color:#c0c5ce;">00000000: 4949 2a00 1000 0000 3030 3030 3030 3030  II*.....00000000
</span><span style="color:#c0c5ce;">00000010: 0b00 0001 0300 0100 0000 3030 3030 0101  ..........0000..
</span><span style="color:#c0c5ce;">00000020: 0300 0100 0000 3030 3030 3030 3030 3030  ......0000000000
</span><span style="color:#c0c5ce;">00000030: 3030 3030 3030 0330 0200 0100 0000 3030  000000.0......00
</span><span style="color:#c0c5ce;">00000040: 3030 3030 3030 3030 3030 3030 3030 1101  00000000000000..
</span><span style="color:#c0c5ce;">00000050: 0400 0100 0000 3030 3030 3030 3030 3030  ......0000000000
</span><span style="color:#c0c5ce;">00000060: 3030 3030 3030 3030 3030 3030 3030 3030  0000000000000000
</span><span style="color:#c0c5ce;">00000070: 3030 3030 3030 3030 3030 3030 3030 3030  0000000000000000
</span><span style="color:#c0c5ce;">00000080: 3030 3030 3030 3030 3030 3030 3030 3030  0000000000000000
</span><span style="color:#c0c5ce;">00000090: 3030 3030 3030                           000000
</span></pre>
<p>报错堆溢出
影子内存显示<code>[01]</code>只有第一字节合法 但程序试图读取2字节触发溢出</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">=================================================================
</span><span style="color:#c0c5ce;">==2650984==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x602000000051 at pc 0x0000002bec12 bp 0x7ffefba54570 sp 0x7ffefba53d30
</span><span style="color:#c0c5ce;">READ of size 2 at 0x602000000051 thread T0
</span><span style="color:#c0c5ce;">    #0 0x2bec11 in fputs (/home/ayoung/fuzzing_tiff/install/bin/tiffinfo+0x2bec11)
</span><span style="color:#c0c5ce;">    #1 0x4d39a8 in _TIFFPrintField /home/ayoung/fuzzing_tiff/tiff-4.0.4/libtiff/tif_print.c:127:4
</span><span style="color:#c0c5ce;">    #2 0x4d39a8 in TIFFPrintDirectory /home/ayoung/fuzzing_tiff/tiff-4.0.4/libtiff/tif_print.c:641:5
</span><span style="color:#c0c5ce;">    #3 0x358a27 in tiffinfo /home/ayoung/fuzzing_tiff/tiff-4.0.4/tools/tiffinfo.c:449:2
</span><span style="color:#c0c5ce;">    #4 0x358a27 in main /home/ayoung/fuzzing_tiff/tiff-4.0.4/tools/tiffinfo.c:152:6
</span><span style="color:#c0c5ce;">    #5 0x7f997818dd8f in __libc_start_call_main csu/../sysdeps/nptl/libc_start_call_main.h:58:16
</span><span style="color:#c0c5ce;">    #6 0x7f997818de3f in __libc_start_main csu/../csu/libc-start.c:392:3
</span><span style="color:#c0c5ce;">    #7 0x2a3d24 in _start (/home/ayoung/fuzzing_tiff/install/bin/tiffinfo+0x2a3d24)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">0x602000000051 is located 0 bytes to the right of 1-byte region [0x602000000050,0x602000000051)
</span><span style="color:#c0c5ce;">allocated by thread T0 here:
</span><span style="color:#c0c5ce;">    #0 0x320c0d in malloc (/home/ayoung/fuzzing_tiff/install/bin/tiffinfo+0x320c0d)
</span><span style="color:#c0c5ce;">    #1 0x370123 in _TIFFmalloc /home/ayoung/fuzzing_tiff/tiff-4.0.4/libtiff/tif_unix.c:283:10
</span><span style="color:#c0c5ce;">    #2 0x370123 in setByteArray /home/ayoung/fuzzing_tiff/tiff-4.0.4/libtiff/tif_dir.c:51:19
</span><span style="color:#c0c5ce;">    #3 0x370123 in _TIFFVSetField /home/ayoung/fuzzing_tiff/tiff-4.0.4/libtiff/tif_dir.c:539:4
</span><span style="color:#c0c5ce;">    #4 0x369c66 in TIFFVSetField /home/ayoung/fuzzing_tiff/tiff-4.0.4/libtiff/tif_dir.c:820:6
</span><span style="color:#c0c5ce;">    #5 0x369c66 in TIFFSetField /home/ayoung/fuzzing_tiff/tiff-4.0.4/libtiff/tif_dir.c:764:11
</span><span style="color:#c0c5ce;">    #6 0x3a8e15 in TIFFFetchNormalTag /home/ayoung/fuzzing_tiff/tiff-4.0.4/libtiff/tif_dirread.c:5164:8
</span><span style="color:#c0c5ce;">    #7 0x39abee in TIFFReadDirectory /home/ayoung/fuzzing_tiff/tiff-4.0.4/libtiff/tif_dirread.c:3810:12
</span><span style="color:#c0c5ce;">    #8 0x49cc3b in TIFFClientOpen /home/ayoung/fuzzing_tiff/tiff-4.0.4/libtiff/tif_open.c:466:8
</span><span style="color:#c0c5ce;">    #9 0x4effc2 in TIFFFdOpen /home/ayoung/fuzzing_tiff/tiff-4.0.4/libtiff/tif_unix.c:178:8
</span><span style="color:#c0c5ce;">    #10 0x4effc2 in TIFFOpen /home/ayoung/fuzzing_tiff/tiff-4.0.4/libtiff/tif_unix.c:217:8
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">SUMMARY: AddressSanitizer: heap-buffer-overflow (/home/ayoung/fuzzing_tiff/install/bin/tiffinfo+0x2bec11) in fputs
</span><span style="color:#c0c5ce;">Shadow bytes around the buggy address:
</span><span style="color:#c0c5ce;">  0x0c047fff7fb0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
</span><span style="color:#c0c5ce;">  0x0c047fff7fc0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
</span><span style="color:#c0c5ce;">  0x0c047fff7fd0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
</span><span style="color:#c0c5ce;">  0x0c047fff7fe0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
</span><span style="color:#c0c5ce;">  0x0c047fff7ff0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
</span><span style="color:#c0c5ce;">=&gt;0x0c047fff8000: fa fa 00 00 fa fa fd fa fa fa[01]fa fa fa fd fa
</span><span style="color:#c0c5ce;">  0x0c047fff8010: fa fa 00 fa fa fa 00 fa fa fa fa fa fa fa fa fa
</span><span style="color:#c0c5ce;">  0x0c047fff8020: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span><span style="color:#c0c5ce;">  0x0c047fff8030: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span><span style="color:#c0c5ce;">  0x0c047fff8040: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span><span style="color:#c0c5ce;">  0x0c047fff8050: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span></pre>
<p>把所有crash跑了一遍 看代码覆盖率
<img src="/images/Pasted%20image%2020250511150920.png" alt="" /></p>
<h1 id="exercise5">exercise5</h1><p>本节学习：</p>
<ul>
<li>使用自定义字典帮助fuzzer找到新路径</li>
<li>使用多核并行fuzzing提高效率</li>
</ul>
<h2 id="fuzz">fuzz</h2><p>参考文档安装</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">ayoung@ayoung:~/Fuzzing_libxml2/libxml2-2.9.4$ ./xmllint --memory ./test/wml.xml
</span><span style="color:#c0c5ce;">&lt;?xml version=&quot;1.0&quot;?&gt;
</span><span style="color:#c0c5ce;">&lt;!DOCTYPE wml PUBLIC &quot;-//WAPFORUM//DTD WML 1.1//EN&quot; &quot;http://www.wapforum.org/DTD/wml_1.1.xml&quot;&gt;
</span><span style="color:#c0c5ce;">&lt;wml&gt;
</span><span style="color:#c0c5ce;">  &lt;card id=&quot;card1&quot; title=&quot;Rubriques 75008&quot;&gt;
</span><span style="color:#c0c5ce;">        &lt;p&gt;
</span><span style="color:#c0c5ce;">                &lt;a href=&quot;rubmenu.asp?CP=75008&amp;amp;RB=01&quot;&gt;Cin&amp;#xE9;ma&lt;/a&gt;&lt;br/&gt;
</span><span style="color:#c0c5ce;">        &lt;/p&gt;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">&lt;/card&gt;
</span><span style="color:#c0c5ce;">&lt;/wml&gt;
</span></pre>
<p>下载xml示例和字典</p>
<p>SampleInput.xml</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">&lt;!</span><span style="color:#b48ead;">DOCTYPE </span><span style="color:#bf616a;">a </span><span style="color:#c0c5ce;">[]&gt;
</span></pre>
<p>字典</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">#
</span><span style="color:#c0c5ce;"># AFL dictionary for XML
</span><span style="color:#c0c5ce;"># ----------------------
</span><span style="color:#c0c5ce;">#
</span><span style="color:#c0c5ce;"># Several basic syntax elements and attributes, modeled on libxml2.
</span><span style="color:#c0c5ce;">#
</span><span style="color:#c0c5ce;"># Created by Michal Zalewski
</span><span style="color:#c0c5ce;">#
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">attr_encoding=&quot; encoding=\&quot;1\&quot;&quot;
</span><span style="color:#c0c5ce;">attr_generic=&quot; a=\&quot;1\&quot;&quot;
</span><span style="color:#c0c5ce;">attr_href=&quot; href=\&quot;1\&quot;&quot;
</span><span style="color:#c0c5ce;">attr_standalone=&quot; standalone=\&quot;no\&quot;&quot;
</span><span style="color:#c0c5ce;">attr_version=&quot; version=\&quot;1\&quot;&quot;
</span><span style="color:#c0c5ce;">attr_xml_base=&quot; xml:base=\&quot;1\&quot;&quot;
</span><span style="color:#c0c5ce;">attr_xml_id=&quot; xml:id=\&quot;1\&quot;&quot;
</span><span style="color:#c0c5ce;">attr_xml_lang=&quot; xml:lang=\&quot;1\&quot;&quot;
</span><span style="color:#c0c5ce;">attr_xml_space=&quot; xml:space=\&quot;1\&quot;&quot;
</span><span style="color:#c0c5ce;">attr_xmlns=&quot; xmlns=\&quot;1\&quot;&quot;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">entity_builtin=&quot;&amp;lt;&quot;
</span><span style="color:#c0c5ce;">entity_decimal=&quot;&amp;#1;&quot;
</span><span style="color:#c0c5ce;">entity_external=&quot;&amp;a;&quot;
</span><span style="color:#c0c5ce;">entity_hex=&quot;&amp;#x1;&quot;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">string_any=&quot;ANY&quot;
</span><span style="color:#c0c5ce;">string_brackets=&quot;[]&quot;
</span><span style="color:#c0c5ce;">string_cdata=&quot;CDATA&quot;
</span><span style="color:#c0c5ce;">string_col_fallback=&quot;:fallback&quot;
</span><span style="color:#c0c5ce;">string_col_generic=&quot;:a&quot;
</span><span style="color:#c0c5ce;">string_col_include=&quot;:include&quot;
</span><span style="color:#c0c5ce;">string_dashes=&quot;--&quot;
</span><span style="color:#c0c5ce;">string_empty=&quot;EMPTY&quot;
</span><span style="color:#c0c5ce;">string_empty_dblquotes=&quot;\&quot;\&quot;&quot;
</span><span style="color:#c0c5ce;">string_empty_quotes=&quot;&#39;&#39;&quot;
</span><span style="color:#c0c5ce;">string_entities=&quot;ENTITIES&quot;
</span><span style="color:#c0c5ce;">string_entity=&quot;ENTITY&quot;
</span><span style="color:#c0c5ce;">string_fixed=&quot;#FIXED&quot;
</span><span style="color:#c0c5ce;">string_id=&quot;ID&quot;
</span><span style="color:#c0c5ce;">string_idref=&quot;IDREF&quot;
</span><span style="color:#c0c5ce;">string_idrefs=&quot;IDREFS&quot;
</span><span style="color:#c0c5ce;">string_implied=&quot;#IMPLIED&quot;
</span><span style="color:#c0c5ce;">string_nmtoken=&quot;NMTOKEN&quot;
</span><span style="color:#c0c5ce;">string_nmtokens=&quot;NMTOKENS&quot;
</span><span style="color:#c0c5ce;">string_notation=&quot;NOTATION&quot;
</span><span style="color:#c0c5ce;">string_parentheses=&quot;()&quot;
</span><span style="color:#c0c5ce;">string_pcdata=&quot;#PCDATA&quot;
</span><span style="color:#c0c5ce;">string_percent=&quot;%a&quot;
</span><span style="color:#c0c5ce;">string_public=&quot;PUBLIC&quot;
</span><span style="color:#c0c5ce;">string_required=&quot;#REQUIRED&quot;
</span><span style="color:#c0c5ce;">string_schema=&quot;:schema&quot;
</span><span style="color:#c0c5ce;">string_system=&quot;SYSTEM&quot;
</span><span style="color:#c0c5ce;">string_ucs4=&quot;UCS-4&quot;
</span><span style="color:#c0c5ce;">string_utf16=&quot;UTF-16&quot;
</span><span style="color:#c0c5ce;">string_utf8=&quot;UTF-8&quot;
</span><span style="color:#c0c5ce;">string_xmlns=&quot;xmlns:&quot;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">tag_attlist=&quot;&lt;!ATTLIST&quot;
</span><span style="color:#c0c5ce;">tag_cdata=&quot;&lt;![CDATA[&quot;
</span><span style="color:#c0c5ce;">tag_close=&quot;&lt;/a&gt;&quot;
</span><span style="color:#c0c5ce;">tag_doctype=&quot;&lt;!DOCTYPE&quot;
</span><span style="color:#c0c5ce;">tag_element=&quot;&lt;!ELEMENT&quot;
</span><span style="color:#c0c5ce;">tag_entity=&quot;&lt;!ENTITY&quot;
</span><span style="color:#c0c5ce;">tag_ignore=&quot;&lt;![IGNORE[&quot;
</span><span style="color:#c0c5ce;">tag_include=&quot;&lt;![INCLUDE[&quot;
</span><span style="color:#c0c5ce;">tag_notation=&quot;&lt;!NOTATION&quot;
</span><span style="color:#c0c5ce;">tag_open=&quot;&lt;a&gt;&quot;
</span><span style="color:#c0c5ce;">tag_open_close=&quot;&lt;a /&gt;&quot;
</span><span style="color:#c0c5ce;">tag_open_exclamation=&quot;&lt;!&quot;
</span><span style="color:#c0c5ce;">tag_open_q=&quot;&lt;?&quot;
</span><span style="color:#c0c5ce;">tag_sq2_close=&quot;]]&gt;&quot;
</span><span style="color:#c0c5ce;">tag_xml_q=&quot;&lt;?xml?&gt;&quot;
</span></pre>
<p>关于fuzz参数的使用：</p>
<ul>
<li>-x：标记使用的字典</li>
<li>-D：表示启用了确定性突变</li>
<li>-M：表示主模糊器</li>
<li>-S：表示从模糊器</li>
<li>--valid：为捕获错误</li>
</ul>
<p>开始fuzz 配置并行fuzz 主节点和从节点协同工作提高效率</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">afl-fuzz -i afl_in/ -x dictionaries/xml.dict -o afl_out -D -M Master -- ./libxml2-2.9.4/xmllint --debug --recover --load-trace --nonet --postvalid --timing @@
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">afl-fuzz -i afl_in/ -x dictionaries/xml.dict -o afl_out -S slave1 -- ./libxml2-2.9.4/xmllint --debug  --recover --load-trace --nonet --postvalid --timing @@
</span><span style="color:#c0c5ce;">afl-fuzz -i afl_in/ -x dictionaries/xml.dict -o afl_out -S slave2 -- ./libxml2-2.9.4/xmllint --debug  --recover --load-trace --nonet --postvalid --timing @@
</span><span style="color:#c0c5ce;">afl-fuzz -i afl_in/ -x dictionaries/xml.dict -o afl_out -S slave3 -- ./libxml2-2.9.4/xmllint --debug  --recover --load-trace --nonet --postvalid --timing @@
</span></pre>
<p>参考官方和博客都没fuzz出东西
后面看了一下不知道为什么选项有点不一样。一开始没注意 选项一直报错 afl界面显示<code>last new find : none yet (odd, check syntax!)</code>，其实就是启动的有问题了。后面把无效选项去掉就好了。
<img src="/images/Pasted%20image%2020250513165413.png" alt="" /></p>
<p>然后问了下ai怎么去重做后续分析
先统一所有crash到一起</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">mkdir -p ./all_crashes
</span><span style="color:#c0c5ce;">find afl_out -type f -path &quot;*/crashes/*&quot; -exec cp {} ./all_crashes \;
</span></pre>
<p>使用alf-cmin去重（去掉了几十个重复的）</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">afl-cmin -i ./all_crashes -o ./unique_crashes -- ./libxml2-2.9.4/xmllint --debug  --recover --load-trace --nonet --postvalid --timing @@
</span></pre>
<p>执行其中一个crash样本 asan报堆溢出
尝试读取超出分配内存范围的 1 字节，程序分配了4字节 但尝试读取第五字节</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">ayoung@ayoung:~/Fuzzing_libxml2$ ./libxml2-2.9.4/xmllint --debug  --recover --load-trace --
</span><span style="color:#c0c5ce;">nonet --postvalid --timing all_crashes/id\:000000\,sig\:06\,src\:000763\,time\:264929\,exec
</span><span style="color:#c0c5ce;">s\:159395\,op\:int16\,pos\:26\,val\:+1000 
</span><span style="color:#c0c5ce;">...
</span><span style="color:#c0c5ce;">=================================================================
</span><span style="color:#c0c5ce;">==1436429==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x6020000001f4 at pc 0x0000003eb76e bp 0x7ffc7b473390 sp 0x7ffc7b473388
</span><span style="color:#c0c5ce;">READ of size 1 at 0x6020000001f4 thread T0
</span><span style="color:#c0c5ce;">    #0 0x3eb76d in xmlEncodeEntitiesInternal /home/ayoung/Fuzzing_libxml2/libxml2-2.9.4/entities.c:578:12
</span><span style="color:#c0c5ce;">    #1 0x53921c in xmlNodeListGetString /home/ayoung/Fuzzing_libxml2/libxml2-2.9.4/tree.c
</span><span style="color:#c0c5ce;">    #2 0x5cd3e5 in xmlValidateElement /home/ayoung/Fuzzing_libxml2/libxml2-2.9.4/valid.c:6401:14
</span><span style="color:#c0c5ce;">    #3 0x3d075e in xmlValidateDocument /home/ayoung/Fuzzing_libxml2/libxml2-2.9.4/valid.c:6857:12
</span><span style="color:#c0c5ce;">    #4 0x3d075e in parseAndPrintFile /home/ayoung/Fuzzing_libxml2/libxml2-2.9.4/xmllint.c:2819:7
</span><span style="color:#c0c5ce;">    #5 0x3b7b66 in main /home/ayoung/Fuzzing_libxml2/libxml2-2.9.4/xmllint.c:3767:7
</span><span style="color:#c0c5ce;">    #6 0x7fdb8f2f9d8f in __libc_start_call_main csu/../sysdeps/nptl/libc_start_call_main.h:58:16
</span><span style="color:#c0c5ce;">    #7 0x7fdb8f2f9e3f in __libc_start_main csu/../csu/libc-start.c:392:3
</span><span style="color:#c0c5ce;">    #8 0x2f81e4 in _start (/home/ayoung/Fuzzing_libxml2/libxml2-2.9.4/xmllint+0x2f81e4)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">0x6020000001f4 is located 0 bytes to the right of 4-byte region [0x6020000001f0,0x6020000001f4)
</span><span style="color:#c0c5ce;">allocated by thread T0 here:
</span><span style="color:#c0c5ce;">    #0 0x3750cd in malloc (/home/ayoung/Fuzzing_libxml2/libxml2-2.9.4/xmllint+0x3750cd)
</span><span style="color:#c0c5ce;">    #1 0x7484d7 in xmlBufResize /home/ayoung/Fuzzing_libxml2/libxml2-2.9.4/buf.c:827:26
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">SUMMARY: AddressSanitizer: heap-buffer-overflow /home/ayoung/Fuzzing_libxml2/libxml2-2.9.4/entities.c:578:12 in xmlEncodeEntitiesInternal
</span><span style="color:#c0c5ce;">Shadow bytes around the buggy address:
</span><span style="color:#c0c5ce;">  0x0c047fff7fe0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
</span><span style="color:#c0c5ce;">  0x0c047fff7ff0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
</span><span style="color:#c0c5ce;">  0x0c047fff8000: fa fa 06 fa fa fa 00 01 fa fa 00 01 fa fa 07 fa
</span><span style="color:#c0c5ce;">  0x0c047fff8010: fa fa 00 03 fa fa 06 fa fa fa 00 01 fa fa 05 fa
</span><span style="color:#c0c5ce;">  0x0c047fff8020: fa fa fd fd fa fa fd fa fa fa fd fd fa fa fd fa
</span><span style="color:#c0c5ce;">=&gt;0x0c047fff8030: fa fa 04 fa fa fa fd fa fa fa 02 fa fa fa[04]fa
</span><span style="color:#c0c5ce;">  0x0c047fff8040: fa fa fd fa fa fa fd fa fa fa 02 fa fa fa 02 fa
</span><span style="color:#c0c5ce;">  0x0c047fff8050: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span><span style="color:#c0c5ce;">  0x0c047fff8060: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span><span style="color:#c0c5ce;">  0x0c047fff8070: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span><span style="color:#c0c5ce;">  0x0c047fff8080: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span><span style="color:#c0c5ce;">...
</span></pre>
</main>
                <aside class="toc-sidebar">
                    <div class="toc-sticky-container">
                        <div class="toc-header">:: Contents ::</div>
                        <ul class="toc-list"><li class="toc-item toc-h2" data-level="2" style="margin-left:12px"><a href="#exercise1">exercise1</a></li><li class="toc-item toc-h3" data-level="3" style="margin-left:12px"><a href="#fuzz">fuzz</a></li><li class="toc-item toc-h3" data-level="3" style="margin-left:12px"><a href="#crashfen-xi">crash分析</a></li><li class="toc-item toc-h1" data-level="1" style="margin-left:12px"><a href="#exercise2">exercise2</a></li><li class="toc-item toc-h2" data-level="2" style="margin-left:12px"><a href="#fuzz">fuzz</a></li><li class="toc-item toc-h2" data-level="2" style="margin-left:12px"><a href="#crashfen-xi">crash分析</a></li><li class="toc-item toc-h1" data-level="1" style="margin-left:12px"><a href="#exercise3">exercise3</a></li><li class="toc-item toc-h2" data-level="2" style="margin-left:12px"><a href="#fuzz">fuzz</a></li><li class="toc-item toc-h2" data-level="2" style="margin-left:12px"><a href="#crashfen-xi">crash分析</a></li><li class="toc-item toc-h1" data-level="1" style="margin-left:12px"><a href="#exercise4">exercise4</a></li><li class="toc-item toc-h2" data-level="2" style="margin-left:12px"><a href="#fuzz">fuzz</a></li><li class="toc-item toc-h2" data-level="2" style="margin-left:12px"><a href="#crashfen-xi">crash分析</a></li><li class="toc-item toc-h1" data-level="1" style="margin-left:12px"><a href="#exercise5">exercise5</a></li><li class="toc-item toc-h2" data-level="2" style="margin-left:12px"><a href="#fuzz">fuzz</a></li></ul>
                    </div>
                </aside>
            </div> 
    <footer style="margin-top: 50px; border-top: 1px solid #333; padding-top: 20px; font-size: 0.8rem; color: #555; text-align: center;">
        Built with Rust. <span style="color: #66ed59;">EOF</span>
    </footer>
    <button id="back-to-top" aria-label="Back to Top">^TOP</button>
    <script src="/script.js"></script>
</body>
</html>